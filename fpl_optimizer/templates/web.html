<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FPL Optimizer</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0e1117; color: #e6e6e6; min-height: 100vh; overflow-x: hidden; }

  /* ==================== APP SHELL ==================== */
  .app-shell { display: flex; min-height: 100vh; }

  /* Sidebar */
  .sidebar { width: 260px; background: #13161f; border-right: 1px solid #2a2f3e; position: fixed; top: 0; left: 0; bottom: 0; z-index: 200; display: flex; flex-direction: column; overflow-y: auto; transition: transform 0.25s ease; }
  .sidebar-brand { padding: 1.2rem 1.2rem 0.8rem; border-bottom: 1px solid #2a2f3e; }
  .sidebar-brand h1 { color: #00ff87; font-size: 1.3rem; margin-bottom: 0.1rem; }
  .sidebar-brand .subtitle { color: #555; font-size: 0.72rem; }

  .sidebar-nav { flex: 1; padding: 0.6rem 0; }
  .sidebar-item { display: flex; align-items: center; gap: 0.7rem; padding: 0.6rem 1.2rem; color: #888; font-size: 0.88rem; cursor: pointer; transition: all 0.15s; border-left: 3px solid transparent; user-select: none; }
  .sidebar-item:hover { color: #e6e6e6; background: rgba(255,255,255,0.03); }
  .sidebar-item.active { color: #00ff87; border-left-color: #00ff87; background: rgba(0,255,135,0.05); }
  .sidebar-item .si-icon { font-size: 1.1rem; width: 1.4rem; text-align: center; flex-shrink: 0; }
  .sidebar-item .si-label { flex: 1; }
  .sidebar-item .si-arrow { font-size: 0.65rem; transition: transform 0.2s; }
  .sidebar-item .si-arrow.open { transform: rotate(90deg); }

  .sidebar-sub { overflow: hidden; max-height: 0; transition: max-height 0.25s ease; }
  .sidebar-sub.open { max-height: 300px; }
  .sidebar-sub-item { display: block; padding: 0.45rem 1.2rem 0.45rem 3.3rem; color: #666; font-size: 0.82rem; cursor: pointer; transition: all 0.15s; border-left: 3px solid transparent; }
  .sidebar-sub-item:hover { color: #e6e6e6; background: rgba(255,255,255,0.02); }
  .sidebar-sub-item.active { color: #00ff87; border-left-color: #00ff87; }

  .sidebar-divider { height: 1px; background: #2a2f3e; margin: 0.4rem 1.2rem; }

  /* Main content area */
  .main-content { margin-left: 260px; flex: 1; min-height: 100vh; }
  .container { max-width: 1100px; margin: 0 auto; padding: 1.2rem 1.2rem 2rem; }

  /* Mobile topbar & hamburger */
  .mobile-topbar { display: none; position: fixed; top: 0; left: 0; right: 0; height: 50px; background: #13161f; border-bottom: 1px solid #2a2f3e; z-index: 150; align-items: center; padding: 0 1rem; }
  .hamburger { background: none; border: none; color: #e6e6e6; font-size: 1.5rem; cursor: pointer; padding: 0.3rem; }
  .mobile-topbar .brand { color: #00ff87; font-weight: 700; font-size: 1.1rem; margin-left: 0.7rem; }
  .sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 190; }
  .sidebar-overlay.active { display: block; }

  @media (max-width: 768px) {
    .sidebar { transform: translateX(-100%); }
    .sidebar.open { transform: translateX(0); }
    .main-content { margin-left: 0; padding-top: 50px; }
    .mobile-topbar { display: flex; }
  }

  /* ==================== UTILITY ==================== */
  .hidden { display: none !important; }
  .right { text-align: right; }
  .pos { font-weight: bold; color: #4da6ff; }
  .score { color: #00ff87; font-weight: bold; }
  .cost { color: #ffd700; }
  .out { color: #ff6b6b; }
  .in { color: #51cf66; }

  /* Fields & Buttons */
  .field label { display: block; color: #888; font-size: 0.75rem; text-transform: uppercase; margin-bottom: 0.3rem; letter-spacing: 0.03em; }
  .field input, .field select { width: 100%; background: #0e1117; border: 1px solid #2a2f3e; color: #e6e6e6; border-radius: 6px; padding: 0.5rem 0.7rem; font-size: 0.9rem; }
  .field input:focus, .field select:focus { outline: none; border-color: #00ff87; }
  .slider-value { color: #00ff87; font-weight: bold; }
  input[type="range"] { -webkit-appearance: none; height: 6px; border-radius: 3px; background: #2a2f3e; border: none; padding: 0; }
  input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%; background: #00ff87; cursor: pointer; }

  .btn { background: #00ff87; color: #0e1117; border: none; border-radius: 6px; padding: 0.5rem 1.3rem; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: opacity 0.15s; white-space: nowrap; }
  .btn:hover { opacity: 0.85; }
  .btn:disabled { opacity: 0.4; cursor: not-allowed; }
  .btn-blue { background: #4da6ff; color: #0e1117; border: none; border-radius: 6px; padding: 0.5rem 1.3rem; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: opacity 0.15s; white-space: nowrap; }
  .btn-blue:hover { opacity: 0.85; }
  .btn-blue:disabled { opacity: 0.4; cursor: not-allowed; }
  .btn-sm { padding: 0.35rem 0.8rem; font-size: 0.8rem; }
  .btn-outline { background: transparent; border: 1px solid #2a2f3e; color: #e6e6e6; border-radius: 6px; padding: 0.35rem 0.8rem; font-size: 0.8rem; cursor: pointer; transition: all 0.15s; }
  .btn-outline:hover { border-color: #4da6ff; color: #4da6ff; }

  /* User bar (reused in settings) */
  .user-bar { background: #13161f; border-radius: 10px; padding: 1rem 1.2rem; margin-bottom: 1rem; }
  .user-bar-header { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.8rem; }
  .user-bar-header .title { color: #4da6ff; font-size: 0.85rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em; }
  .user-bar-row { display: flex; gap: 0.6rem; align-items: end; flex-wrap: wrap; }
  .user-bar-row .field { flex: 0 1 180px; min-width: 120px; }
  .user-info { display: none; margin-top: 0.8rem; padding: 0.6rem 0.8rem; background: #1a1f2e; border-radius: 6px; border-left: 3px solid #4da6ff; }
  .user-info.active { display: flex; align-items: center; gap: 1.5rem; flex-wrap: wrap; }
  .user-info .mgr { font-weight: 500; }
  .user-info .mgr span { color: #4da6ff; }
  .user-info .tm { color: #888; font-size: 0.85rem; }
  .user-error { display: none; margin-top: 0.5rem; color: #ff6b6b; font-size: 0.82rem; padding: 0.4rem 0.6rem; background: #2d1b1b; border-radius: 4px; }
  .user-error.active { display: block; }
  .help-text { color: #555; font-size: 0.72rem; margin-top: 0.2rem; }
  .inline-spinner { display: none; width: 16px; height: 16px; border: 2px solid #2a2f3e; border-top-color: #4da6ff; border-radius: 50%; animation: spin 0.8s linear infinite; }
  .inline-spinner.active { display: inline-block; }

  /* Leagues */
  .leagues-section { display: none; margin-top: 0.8rem; }
  .leagues-section.active { display: block; }
  .leagues-section .sec-title { color: #4da6ff; font-size: 0.75rem; text-transform: uppercase; margin-bottom: 0.4rem; font-weight: 600; }
  .league-list { display: flex; flex-wrap: wrap; gap: 0.4rem; }
  .league-chip { background: #1a1f2e; border: 1px solid #2a2f3e; border-radius: 6px; padding: 0.3rem 0.7rem; font-size: 0.8rem; cursor: pointer; transition: all 0.15s; }
  .league-chip:hover { border-color: #4da6ff; background: #1e2640; }
  .league-chip.active { border-color: #4da6ff; background: #1a2540; color: #4da6ff; }

  .league-standings { display: none; margin-top: 0.8rem; }
  .league-standings.active { display: block; }
  .league-standings .league-title { color: #4da6ff; font-size: 0.95rem; font-weight: 600; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; }

  /* Nav panels */
  .nav-panel { display: none; }
  .nav-panel.active { display: block; }

  /* Sections & cards */
  .section { background: #13161f; border-radius: 8px; padding: 1.2rem; margin-bottom: 1rem; }
  .section-title { color: #00ff87; font-size: 0.85rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em; margin-bottom: 0.8rem; }
  .section-title.blue { color: #4da6ff; }
  .stat-row { display: flex; gap: 0.6rem; flex-wrap: wrap; margin-bottom: 1rem; }
  .stat-card { background: #1a1f2e; border-radius: 8px; padding: 0.7rem 1rem; text-align: center; flex: 1; min-width: 100px; }
  .stat-card .label { color: #888; font-size: 0.7rem; text-transform: uppercase; }
  .stat-card .value { color: #00ff87; font-size: 1.2rem; font-weight: bold; margin-top: 0.15rem; }
  .stat-card .value.blue { color: #4da6ff; }
  .stat-card .value.red { color: #ff6b6b; }

  /* Tables */
  table { width: 100%; border-collapse: collapse; margin-bottom: 1rem; }
  th { background: #1a1f2e; color: #00ff87; text-align: left; padding: 0.5rem 0.6rem; font-size: 0.72rem; text-transform: uppercase; position: sticky; top: 0; }
  td { padding: 0.4rem 0.6rem; border-bottom: 1px solid #1a1f2e; font-size: 0.85rem; }
  tr:hover { background: rgba(26,31,46,0.5); }
  .table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }
  th.sortable { cursor: pointer; user-select: none; }
  th.sortable:hover { color: #e6e6e6; }
  th.sortable.sort-asc::after { content: " \u25B2"; font-size: 0.65rem; }
  th.sortable.sort-desc::after { content: " \u25BC"; font-size: 0.65rem; }

  /* Sub-tabs (used in optimizer) */
  .tabs { display: flex; gap: 0; border-bottom: 2px solid #2a2f3e; margin-bottom: 0.8rem; overflow-x: auto; }
  .tab { padding: 0.5rem 1rem; cursor: pointer; color: #888; font-size: 0.82rem; font-weight: 500; border-bottom: 2px solid transparent; margin-bottom: -2px; transition: all 0.15s; white-space: nowrap; flex-shrink: 0; }
  .tab:hover { color: #e6e6e6; }
  .tab.active { color: #00ff87; border-bottom-color: #00ff87; }
  .tab.user-tab.active { color: #4da6ff; border-bottom-color: #4da6ff; }
  .tab-content { display: none; }
  .tab-content.active { display: block; }

  /* Loader */
  .loader { display: none; text-align: center; padding: 2rem; }
  .loader.active { display: block; }
  .spinner { display: inline-block; width: 32px; height: 32px; border: 3px solid #2a2f3e; border-top-color: #00ff87; border-radius: 50%; animation: spin 0.8s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loader-text { color: #888; margin-top: 0.5rem; font-size: 0.82rem; }
  .error-msg { background: #2d1b1b; border: 1px solid #ff6b6b; color: #ff6b6b; border-radius: 8px; padding: 0.8rem 1.2rem; text-align: center; margin: 1rem 0; }

  /* Filters bar */
  .filters { display: flex; gap: 0.8rem; flex-wrap: wrap; margin-bottom: 1rem; align-items: end; }
  .filters .field { flex: 1; min-width: 120px; }
  .filters select, .filters input[type="text"] { width: 100%; background: #0e1117; border: 1px solid #2a2f3e; color: #e6e6e6; border-radius: 6px; padding: 0.5rem 0.7rem; font-size: 0.9rem; }

  /* Settings panel */
  .settings { background: #1a1f2e; border-radius: 10px; padding: 1rem 1.2rem; margin-bottom: 1rem; }
  .settings-grid { display: grid; grid-template-columns: 1fr 1fr auto; gap: 1rem; align-items: end; }

  /* FDR Heatmap */
  .fdr-grid { overflow-x: auto; -webkit-overflow-scrolling: touch; }
  .fdr-grid table { min-width: 600px; }
  .fdr-grid th, .fdr-grid td { text-align: center; padding: 0.35rem 0.3rem; font-size: 0.78rem; }
  .fdr-grid th { font-size: 0.7rem; }
  .fdr-grid .team-col { text-align: left; font-weight: 600; min-width: 50px; position: sticky; left: 0; background: #1a1f2e; z-index: 1; }
  .fdr-cell { border-radius: 4px; padding: 0.25rem 0.15rem; font-weight: 600; font-size: 0.75rem; line-height: 1.3; }
  .fdr-1 { background: #375523; color: #e6e6e6; }
  .fdr-2 { background: #01fc7a; color: #0e1117; }
  .fdr-3 { background: #888; color: #fff; }
  .fdr-4 { background: #ff6b6b; color: #fff; }
  .fdr-5 { background: #a01818; color: #fff; }
  .fdr-home { font-size: 0.65rem; }

  /* Radar chart (canvas) */
  .compare-container { display: flex; gap: 1rem; flex-wrap: wrap; align-items: start; }
  .compare-container canvas { flex: 0 0 280px; max-width: 100%; }
  .compare-table { flex: 1; min-width: 250px; }
  .compare-search { display: flex; gap: 0.5rem; align-items: end; flex-wrap: wrap; margin-bottom: 1rem; }
  .compare-search .field { flex: 1; min-width: 150px; }
  .compare-chips { display: flex; gap: 0.4rem; flex-wrap: wrap; margin-bottom: 0.8rem; min-height: 28px; }
  .compare-chip { background: #1a1f2e; border: 1px solid #4da6ff; border-radius: 6px; padding: 0.2rem 0.6rem; font-size: 0.8rem; color: #4da6ff; display: flex; align-items: center; gap: 0.3rem; }
  .compare-chip .remove { cursor: pointer; font-size: 1rem; line-height: 1; opacity: 0.7; }
  .compare-chip .remove:hover { opacity: 1; }
  .compare-results { display: flex; gap: 0.8rem; flex-wrap: wrap; margin-top: 0.5rem; }
  .compare-pick { background: #1a1f2e; border: 1px solid #2a2f3e; border-radius: 6px; padding: 0.3rem 0.6rem; font-size: 0.8rem; cursor: pointer; transition: all 0.15s; }
  .compare-pick:hover { border-color: #4da6ff; }

  /* Price changes */
  .price-card { display: flex; align-items: center; justify-content: space-between; background: #1a1f2e; border-radius: 6px; padding: 0.5rem 0.8rem; margin-bottom: 0.4rem; }
  .price-card .player-info { flex: 1; }
  .price-card .player-name { font-weight: 500; font-size: 0.85rem; }
  .price-card .player-meta { color: #888; font-size: 0.75rem; }
  .price-card .transfer-stat { text-align: right; min-width: 80px; }
  .price-card .net-positive { color: #51cf66; font-weight: bold; }
  .price-card .net-negative { color: #ff6b6b; font-weight: bold; }

  /* Pitch layout */
  .pitch { background: linear-gradient(180deg, #1a5c2a 0%, #1e6b31 10%, #1a5c2a 10%, #1a5c2a 20%, #1e6b31 20%, #1e6b31 30%, #1a5c2a 30%, #1a5c2a 40%, #1e6b31 40%, #1e6b31 50%, #1a5c2a 50%, #1a5c2a 60%, #1e6b31 60%, #1e6b31 70%, #1a5c2a 70%, #1a5c2a 80%, #1e6b31 80%, #1e6b31 90%, #1a5c2a 90%); border-radius: 10px; padding: 1.5rem 0.5rem; position: relative; overflow: hidden; }
  .pitch::before { content: ''; position: absolute; top: 50%; left: 10%; right: 10%; height: 1px; background: rgba(255,255,255,0.15); }
  .pitch::after { content: ''; position: absolute; top: 42%; left: 35%; right: 35%; bottom: 42%; border: 1px solid rgba(255,255,255,0.12); border-radius: 50%; }
  .pitch-row { display: flex; justify-content: center; gap: 0.3rem; padding: 0.6rem 0; position: relative; z-index: 1; }
  .pitch-row.bench-row { background: #13161f; border-radius: 0 0 10px 10px; margin: 0.8rem -0.5rem -1.5rem; padding: 0.8rem 0.5rem 0.6rem; }
  .pitch-row .bench-label { position: absolute; top: 0.2rem; left: 0.8rem; font-size: 0.65rem; color: #888; text-transform: uppercase; letter-spacing: 0.05em; }

  .live-card { background: rgba(14,17,23,0.85); border-radius: 8px; padding: 0.3rem; text-align: center; position: relative; width: 80px; flex-shrink: 0; cursor: grab; transition: opacity 0.2s, box-shadow 0.2s, transform 0.2s; border-top: 3px solid var(--team-color, #333); overflow: visible; }
  .live-card.bench { opacity: 0.7; }
  .live-card.dragging { opacity: 0.3; transform: scale(0.95); }
  .live-card.drag-over { box-shadow: 0 0 0 2px #00ff87, 0 0 12px rgba(0,255,135,0.4); transform: scale(1.05); }
  .live-card .lp-photo { width: 48px; height: 48px; border-radius: 50%; margin: 0 auto 0.2rem; overflow: hidden; background: #2a2f3e; display: flex; align-items: center; justify-content: center; }
  .live-card .lp-photo img { width: 100%; height: 100%; object-fit: cover; object-position: top; }
  .live-card .lp-photo .lp-placeholder { font-size: 1.2rem; color: #555; }
  .live-card .lp-name { font-weight: 600; font-size: 0.7rem; margin-bottom: 0.1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .live-card .lp-team { color: #aaa; font-size: 0.6rem; }
  .live-card .lp-pts { font-size: 1.1rem; font-weight: bold; color: #00ff87; margin-top: 0.15rem; }
  .live-card .lp-pts.zero { color: #888; }
  .live-card .lp-captain { position: absolute; top: 2px; right: 4px; font-size: 0.6rem; background: #ffd700; color: #0e1117; border-radius: 50%; width: 16px; height: 16px; line-height: 16px; font-weight: bold; }
  .live-card .lp-vice { position: absolute; top: 2px; right: 4px; font-size: 0.6rem; background: #888; color: #0e1117; border-radius: 50%; width: 16px; height: 16px; line-height: 16px; font-weight: bold; }
  .live-card .lp-detail { font-size: 0.6rem; color: #aaa; margin-top: 0.1rem; }

  /* Injury flag */
  .live-card .lp-injury { position: absolute; top: 3px; left: 4px; width: 10px; height: 10px; border-radius: 50%; z-index: 2; cursor: help; }
  .live-card .lp-injury.injury-red { background: #ff4444; box-shadow: 0 0 4px rgba(255,68,68,0.6); }
  .live-card .lp-injury.injury-yellow { background: #ffaa00; box-shadow: 0 0 4px rgba(255,170,0,0.6); }

  /* Bench order badge */
  .live-card .bench-order { position: absolute; bottom: 2px; right: 4px; font-size: 0.55rem; background: #444; color: #ccc; border-radius: 50%; width: 14px; height: 14px; line-height: 14px; text-align: center; font-weight: bold; }

  /* Captain selection mode */
  .live-card.captain-selectable { cursor: pointer; }
  .live-card.captain-selectable:hover { box-shadow: 0 0 0 2px #ffd700, 0 0 10px rgba(255,215,0,0.3); }
  .live-card.vice-selectable:hover { box-shadow: 0 0 0 2px #aaa, 0 0 10px rgba(170,170,170,0.3); }

  /* Captain mode bar */
  .captain-mode-bar { background: linear-gradient(135deg, #1a1f2e, #252b3b); border: 1px solid #ffd700; border-radius: 8px; padding: 0.5rem 1rem; margin-bottom: 0.8rem; display: flex; align-items: center; justify-content: space-between; font-size: 0.82rem; color: #ffd700; }
  .captain-mode-bar.vice-mode { border-color: #aaa; color: #aaa; }
  .captain-mode-bar button { background: #333; border: 1px solid #555; color: #ccc; border-radius: 6px; padding: 0.3rem 0.8rem; cursor: pointer; font-size: 0.75rem; }
  .captain-mode-bar button:hover { background: #444; }

  /* Formation badge */
  .formation-badge { display: inline-block; background: #1a1f2e; border: 1px solid #333; border-radius: 6px; padding: 0.2rem 0.6rem; font-size: 0.75rem; font-weight: 600; color: #00ff87; margin-left: 0.5rem; }
  .formation-badge.formation-invalid { border-color: #ff4444; color: #ff4444; }

  /* Action bar */
  .live-action-bar { display: flex; gap: 0.5rem; margin-bottom: 0.8rem; align-items: center; flex-wrap: wrap; }
  .live-action-bar button { background: #1a1f2e; border: 1px solid #333; color: #ccc; border-radius: 6px; padding: 0.35rem 0.7rem; cursor: pointer; font-size: 0.75rem; transition: background 0.2s, border-color 0.2s; }
  .live-action-bar button:hover { background: #252b3b; border-color: #555; }
  .live-action-bar .btn-captain { border-color: #ffd700; color: #ffd700; }
  .live-action-bar .btn-vice { border-color: #888; color: #aaa; }
  .live-save-indicator { font-size: 0.7rem; color: #00ff87; opacity: 0; transition: opacity 0.3s; margin-left: auto; }
  .live-save-indicator.visible { opacity: 1; }

  .live-card .lp-upcoming { margin-top: 0.2rem; display: flex; justify-content: center; gap: 1px; flex-wrap: nowrap; }
  .bench-grid { display: flex; justify-content: center; gap: 0.3rem; margin-top: 0.8rem; }

  @media (max-width: 480px) {
    .live-card { width: 68px; }
    .live-card .lp-photo { width: 40px; height: 40px; }
    .live-card .lp-name { font-size: 0.62rem; }
    .live-card .lp-pts { font-size: 0.95rem; }
    .pitch { padding: 1rem 0.3rem; }
  }

  /* Rival comparison */
  .rival-cols { display: grid; grid-template-columns: 1fr 1fr; gap: 0.8rem; margin-top: 0.8rem; }
  @media (max-width: 600px) { .rival-cols { grid-template-columns: 1fr; } }
  .rival-col .rival-header { font-weight: 600; font-size: 0.9rem; margin-bottom: 0.5rem; padding-bottom: 0.3rem; border-bottom: 1px solid #2a2f3e; }
  .rival-player { padding: 0.25rem 0; font-size: 0.82rem; display: flex; justify-content: space-between; }
  .shared-list { margin-top: 0.5rem; }
  .shared-list .shared-header { color: #888; font-size: 0.75rem; text-transform: uppercase; margin-bottom: 0.3rem; }

  /* Fixture cards */
  .fixture-card { background: #1a1f2e; border-radius: 8px; padding: 0.6rem 0.8rem; margin-bottom: 0.4rem; display: flex; align-items: center; justify-content: space-between; }
  .fixture-team { flex: 1; font-weight: 500; font-size: 0.85rem; }
  .fixture-team.home { text-align: right; padding-right: 0.8rem; }
  .fixture-team.away { text-align: left; padding-left: 0.8rem; }
  .fixture-score { font-size: 1.1rem; font-weight: bold; color: #00ff87; min-width: 50px; text-align: center; }
  .fixture-vs { font-size: 0.85rem; color: #888; min-width: 50px; text-align: center; }
  .difficulty { display: inline-block; width: 20px; height: 20px; border-radius: 4px; text-align: center; line-height: 20px; font-size: 0.65rem; font-weight: bold; color: #fff; margin-left: 0.3rem; }
  .difficulty.away-badge { margin-left: 0; margin-right: 0.3rem; }
  .diff-1 { background: #375523; } .diff-2 { background: #01fc7a; color: #0e1117; } .diff-3 { background: #888; } .diff-4 { background: #ff6b6b; } .diff-5 { background: #a01818; }
  .gw-header { color: #00ff87; font-size: 1rem; font-weight: 600; margin: 1.2rem 0 0.6rem; padding-bottom: 0.2rem; border-bottom: 1px solid #2a2f3e; }
  .gw-badge { font-size: 0.7rem; padding: 0.1rem 0.4rem; border-radius: 4px; margin-left: 0.4rem; font-weight: 500; }
  .gw-badge.current { background: #00ff87; color: #0e1117; } .gw-badge.next { background: #4da6ff; color: #0e1117; } .gw-badge.finished { background: #2a2f3e; color: #888; }

  /* Dashboard */
  .dash-welcome { margin-bottom: 1rem; }
  .dash-welcome h2 { color: #00ff87; font-size: 1.3rem; margin-bottom: 0.2rem; }
  .dash-welcome p { color: #888; font-size: 0.85rem; }

  /* Top stats bar */
  .dash-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.8rem; margin-bottom: 1.2rem; }
  .dash-stat { background: #13161f; border-radius: 10px; padding: 1rem; text-align: center; border: 1px solid #2a2f3e; position: relative; overflow: hidden; }
  .dash-stat .ds-value { font-size: 1.6rem; font-weight: bold; color: #00ff87; }
  .dash-stat .ds-value.blue { color: #4da6ff; }
  .dash-stat .ds-label { font-size: 0.7rem; color: #888; text-transform: uppercase; margin-top: 0.2rem; letter-spacing: 0.03em; }
  .dash-stat .ds-sub { font-size: 0.68rem; color: #555; margin-top: 0.15rem; }
  @media (max-width: 600px) { .dash-stats { grid-template-columns: repeat(2, 1fr); } }

  /* Dashboard main layout: 2-col on desktop */
  .dash-body { display: grid; grid-template-columns: 1fr 320px; gap: 1rem; margin-bottom: 1rem; }
  @media (max-width: 900px) { .dash-body { grid-template-columns: 1fr; } }

  /* Mid section: pitch + captain */
  .dash-mid { display: flex; flex-direction: column; gap: 1rem; }
  .dash-section { background: #13161f; border-radius: 10px; padding: 1rem 1.2rem; border: 1px solid #2a2f3e; }
  .dash-section-title { font-size: 0.78rem; font-weight: 600; text-transform: uppercase; color: #00ff87; margin-bottom: 0.7rem; letter-spacing: 0.03em; display: flex; align-items: center; justify-content: space-between; }
  .dash-section-title .ds-link { font-size: 0.72rem; color: #4da6ff; cursor: pointer; text-transform: none; font-weight: 500; }
  .dash-section-title .ds-link:hover { text-decoration: underline; }

  /* Captain highlight */
  .dash-captain { display: flex; align-items: center; gap: 1rem; padding: 0.6rem; background: linear-gradient(135deg, rgba(255,215,0,0.08), rgba(255,215,0,0.02)); border-radius: 8px; border: 1px solid rgba(255,215,0,0.15); }
  .dash-captain .dc-badge { width: 48px; height: 48px; border-radius: 50%; background: #ffd700; color: #0e1117; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.1rem; flex-shrink: 0; }
  .dash-captain .dc-info { flex: 1; }
  .dash-captain .dc-name { font-weight: 600; font-size: 0.95rem; }
  .dash-captain .dc-meta { color: #888; font-size: 0.78rem; }
  .dash-captain .dc-pts { font-size: 1.3rem; font-weight: bold; color: #ffd700; text-align: right; min-width: 50px; }

  /* Bonus tracker */
  .dash-bonus { display: flex; gap: 0.5rem; flex-wrap: wrap; }
  .bonus-item { background: #1a1f2e; border-radius: 6px; padding: 0.35rem 0.6rem; font-size: 0.78rem; display: flex; align-items: center; gap: 0.4rem; }
  .bonus-item .bi-pts { color: #ffd700; font-weight: bold; }

  /* Right rail */
  .dash-rail { display: flex; flex-direction: column; gap: 1rem; }
  .dash-rail-list { max-height: 240px; overflow-y: auto; }
  .dash-rail-list::-webkit-scrollbar { width: 4px; }
  .dash-rail-list::-webkit-scrollbar-thumb { background: #2a2f3e; border-radius: 2px; }

  /* News/injury items */
  .dash-news-item { display: flex; align-items: center; gap: 0.6rem; padding: 0.4rem 0; border-bottom: 1px solid #1a1f2e; font-size: 0.8rem; }
  .dash-news-item:last-child { border-bottom: none; }
  .dash-news-item .ni-status { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
  .dash-news-item .ni-status.red { background: #ff6b6b; }
  .dash-news-item .ni-status.yellow { background: #ffd700; }
  .dash-news-item .ni-status.green { background: #51cf66; }
  .dash-news-item .ni-info { flex: 1; min-width: 0; }
  .dash-news-item .ni-name { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .dash-news-item .ni-text { color: #888; font-size: 0.72rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .dash-news-item .ni-chance { font-size: 0.72rem; font-weight: 600; flex-shrink: 0; min-width: 32px; text-align: right; }

  /* Price change items in rail */
  .dash-price-item { display: flex; align-items: center; justify-content: space-between; padding: 0.35rem 0; border-bottom: 1px solid #1a1f2e; font-size: 0.8rem; }
  .dash-price-item:last-child { border-bottom: none; }
  .dash-price-item .pi-name { font-weight: 500; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-right: 0.5rem; }
  .dash-price-item .pi-change { font-weight: 600; font-size: 0.78rem; flex-shrink: 0; }
  .dash-price-item .pi-change.up { color: #51cf66; }
  .dash-price-item .pi-change.down { color: #ff6b6b; }

  /* Bottom section */
  .dash-bottom { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem; }
  @media (max-width: 700px) { .dash-bottom { grid-template-columns: 1fr; } }

  /* Bench mini cards */
  .dash-bench { display: flex; gap: 0.5rem; flex-wrap: wrap; }
  .bench-mini { background: #1a1f2e; border-radius: 8px; padding: 0.5rem 0.7rem; flex: 1; min-width: 100px; display: flex; align-items: center; gap: 0.5rem; }
  .bench-mini .bm-name { font-size: 0.8rem; font-weight: 500; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .bench-mini .bm-pts { font-size: 0.9rem; font-weight: bold; color: #888; }
  .bench-mini .bm-pos { font-size: 0.68rem; color: #4da6ff; font-weight: 600; min-width: 26px; }

  /* Fixture mini cards */
  .dash-fixture { display: flex; align-items: center; justify-content: space-between; padding: 0.4rem 0.6rem; background: #1a1f2e; border-radius: 6px; margin-bottom: 0.3rem; font-size: 0.8rem; }
  .dash-fixture .df-teams { flex: 1; }
  .dash-fixture .df-time { color: #888; font-size: 0.72rem; flex-shrink: 0; }
  .dash-fixture .df-score { color: #00ff87; font-weight: bold; flex-shrink: 0; min-width: 40px; text-align: center; }

  /* Mini pitch on dashboard */
  .dash-pitch { position: relative; }
  .dash-pitch .pitch { padding: 1rem 0.3rem; }
  .dash-pitch .live-card { width: 66px; }
  .dash-pitch .live-card .lp-photo { width: 36px; height: 36px; }
  .dash-pitch .live-card .lp-name { font-size: 0.6rem; }
  .dash-pitch .live-card .lp-pts { font-size: 0.9rem; }
  .dash-pitch .live-card .lp-detail { display: none; }
  .dash-pitch .live-card .lp-upcoming { display: none; }
  .dash-pitch .pitch-row.bench-row { display: none; }

  /* Dash empty state */
  .dash-empty { text-align: center; padding: 2rem 1rem; color: #555; }
  .dash-empty .de-icon { font-size: 2.5rem; margin-bottom: 0.8rem; }
  .dash-empty .de-text { font-size: 0.85rem; margin-bottom: 0.8rem; }

  /* Quick links grid (shown when no user) */
  .dash-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; margin-bottom: 1rem; }
  .dash-card { background: #13161f; border-radius: 10px; padding: 1.2rem; cursor: pointer; transition: all 0.15s; border: 1px solid #2a2f3e; }
  .dash-card:hover { border-color: #00ff87; background: #161b24; }
  .dash-card .dc-icon { font-size: 1.5rem; margin-bottom: 0.5rem; }
  .dash-card .dc-title { font-weight: 600; font-size: 0.9rem; margin-bottom: 0.3rem; }
  .dash-card .dc-desc { color: #888; font-size: 0.78rem; }

  /* Coming soon placeholder */
  .coming-soon { text-align: center; padding: 3rem 1rem; }
  .coming-soon .cs-icon { font-size: 3rem; margin-bottom: 1rem; }
  .coming-soon .cs-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 0.4rem; }
  .coming-soon .cs-text { color: #888; font-size: 0.85rem; }

  /* Responsive */
  @media (max-width: 768px) {
    .container { padding: 0.5rem 0.5rem 2rem; }
    .settings-grid { grid-template-columns: 1fr 1fr; }
    .stat-card { min-width: 80px; padding: 0.5rem; }
    .stat-card .value { font-size: 1rem; }
    td { font-size: 0.78rem; padding: 0.35rem 0.4rem; }
    th { font-size: 0.68rem; padding: 0.4rem; }
    .section { padding: 0.8rem; }
  }
  @media (max-width: 480px) {
    .settings-grid { grid-template-columns: 1fr; }
  }

  /* ==================== TRANSFER PLANNER ==================== */
  .tp-layout { display: grid; grid-template-columns: 1fr 320px; gap: 1rem; }
  @media (max-width: 900px) { .tp-layout { grid-template-columns: 1fr; } }

  .tp-budget-bar { display: flex; gap: 0.8rem; flex-wrap: wrap; margin-bottom: 1rem; }
  .tp-budget-card { background: #1a1f2e; border-radius: 8px; padding: 0.6rem 1rem; text-align: center; flex: 1; min-width: 90px; }
  .tp-budget-card .tp-label { color: #888; font-size: 0.68rem; text-transform: uppercase; }
  .tp-budget-card .tp-val { font-size: 1.1rem; font-weight: bold; color: #00ff87; margin-top: 0.1rem; }
  .tp-budget-card .tp-val.blue { color: #4da6ff; }
  .tp-budget-card .tp-val.red { color: #ff6b6b; }
  .tp-budget-card .tp-val.gold { color: #ffd700; }

  .tp-squad-list { margin-bottom: 1rem; }
  .tp-player { display: flex; align-items: center; gap: 0.6rem; padding: 0.5rem 0.6rem; border-bottom: 1px solid #1a1f2e; transition: background 0.15s; }
  .tp-player:hover { background: rgba(26,31,46,0.5); }
  .tp-player .tp-photo { width: 36px; height: 36px; border-radius: 50%; overflow: hidden; background: #2a2f3e; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
  .tp-player .tp-photo img { width: 100%; height: 100%; object-fit: cover; object-position: top; }
  .tp-player .tp-info { flex: 1; min-width: 0; }
  .tp-player .tp-name { font-weight: 500; font-size: 0.85rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .tp-player .tp-meta { color: #888; font-size: 0.72rem; }
  .tp-player .tp-stats { display: flex; gap: 0.6rem; flex-shrink: 0; font-size: 0.78rem; }
  .tp-player .tp-sell-btn { background: #ff6b6b; color: #fff; border: none; border-radius: 4px; padding: 0.25rem 0.5rem; font-size: 0.72rem; cursor: pointer; font-weight: 600; flex-shrink: 0; }
  .tp-player .tp-sell-btn:hover { opacity: 0.85; }
  .tp-player .tp-undo-btn { background: #4da6ff; color: #fff; border: none; border-radius: 4px; padding: 0.25rem 0.5rem; font-size: 0.72rem; cursor: pointer; font-weight: 600; flex-shrink: 0; }
  .tp-player .tp-undo-btn:hover { opacity: 0.85; }
  .tp-player.tp-sold { opacity: 0.4; }
  .tp-player.tp-new { border-left: 3px solid #51cf66; background: rgba(81,207,102,0.05); }

  .tp-replacement-panel { display: none; background: #13161f; border-radius: 8px; padding: 0.8rem; margin-bottom: 1rem; border: 1px solid #2a2f3e; }
  .tp-replacement-panel.active { display: block; }
  .tp-replacement-panel .tp-rp-title { color: #4da6ff; font-size: 0.82rem; font-weight: 600; margin-bottom: 0.6rem; display: flex; align-items: center; justify-content: space-between; }
  .tp-replacement-panel .tp-rp-close { cursor: pointer; color: #888; font-size: 1.1rem; }
  .tp-replacement-panel .tp-rp-close:hover { color: #e6e6e6; }
  .tp-rp-filters { display: flex; gap: 0.5rem; margin-bottom: 0.5rem; flex-wrap: wrap; }
  .tp-rp-filters input, .tp-rp-filters select { background: #0e1117; border: 1px solid #2a2f3e; color: #e6e6e6; border-radius: 4px; padding: 0.35rem 0.5rem; font-size: 0.78rem; }
  .tp-rp-list { max-height: 300px; overflow-y: auto; }
  .tp-rp-list::-webkit-scrollbar { width: 4px; }
  .tp-rp-list::-webkit-scrollbar-thumb { background: #2a2f3e; border-radius: 2px; }

  .tp-buy-row { display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem 0.5rem; border-bottom: 1px solid #1a1f2e; font-size: 0.8rem; transition: background 0.15s; cursor: pointer; }
  .tp-buy-row:hover { background: rgba(81,207,102,0.08); }
  .tp-buy-row .tp-buy-name { flex: 1; font-weight: 500; }
  .tp-buy-row .tp-buy-meta { color: #888; font-size: 0.72rem; margin-right: 0.5rem; }
  .tp-buy-row .tp-buy-btn { background: #51cf66; color: #0e1117; border: none; border-radius: 4px; padding: 0.2rem 0.5rem; font-size: 0.72rem; cursor: pointer; font-weight: 600; }
  .tp-buy-row .tp-buy-btn:hover { opacity: 0.85; }

  .tp-price-indicator { font-size: 0.65rem; font-weight: 600; padding: 0.1rem 0.3rem; border-radius: 3px; }
  .tp-price-up { background: rgba(81,207,102,0.15); color: #51cf66; }
  .tp-price-down { background: rgba(255,107,107,0.15); color: #ff6b6b; }

  .tp-transfer-summary { margin-bottom: 1rem; }
  .tp-transfer-item { display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem 0.6rem; background: #1a1f2e; border-radius: 6px; margin-bottom: 0.3rem; font-size: 0.82rem; }
  .tp-transfer-item .tp-arrow { color: #00ff87; font-weight: bold; margin: 0 0.2rem; }

  .tp-intel-section { margin-bottom: 1rem; }
  .tp-intel-title { color: #00ff87; font-size: 0.78rem; font-weight: 600; text-transform: uppercase; margin-bottom: 0.5rem; }
  .tp-intel-item { display: flex; align-items: center; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #1a1f2e; font-size: 0.78rem; }
  .tp-intel-item:last-child { border-bottom: none; }
  .tp-intel-item .tp-intel-name { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-right: 0.5rem; }
  .tp-intel-item .tp-intel-val { font-weight: 600; flex-shrink: 0; }

  /* Confirm modal */
  .tp-modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 500; align-items: center; justify-content: center; }
  .tp-modal-overlay.active { display: flex; }
  .tp-modal { background: #13161f; border: 1px solid #2a2f3e; border-radius: 12px; padding: 1.5rem; max-width: 480px; width: 90%; max-height: 80vh; overflow-y: auto; }
  .tp-modal h3 { color: #00ff87; margin-bottom: 1rem; font-size: 1rem; }
  .tp-modal .tp-modal-transfers { margin-bottom: 1rem; }
  .tp-modal .tp-modal-cost { background: #1a1f2e; border-radius: 8px; padding: 0.8rem; margin-bottom: 1rem; }
  .tp-modal .tp-modal-row { display: flex; justify-content: space-between; padding: 0.2rem 0; font-size: 0.85rem; }
  .tp-modal .tp-modal-row.total { border-top: 1px solid #2a2f3e; margin-top: 0.3rem; padding-top: 0.4rem; font-weight: 600; }
  .tp-modal .tp-modal-actions { display: flex; gap: 0.6rem; justify-content: flex-end; }
  .tp-modal .tp-modal-actions .btn-cancel { background: #2a2f3e; color: #e6e6e6; border: none; border-radius: 6px; padding: 0.5rem 1rem; cursor: pointer; font-size: 0.85rem; }
</style>
</head>
<body>

<!-- Mobile top bar -->
<div class="mobile-topbar">
  <button class="hamburger" onclick="toggleSidebar()">&#9776;</button>
  <span class="brand">FPL Optimizer</span>
</div>
<div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>

<div class="app-shell">

  <!-- ==================== SIDEBAR ==================== -->
  <nav class="sidebar" id="sidebar">
    <div class="sidebar-brand">
      <h1>FPL Optimizer</h1>
      <div class="subtitle">Fantasy Premier League analytics</div>
    </div>

    <div class="sidebar-nav">
      <!-- Dashboard -->
      <div class="sidebar-item active" data-nav="nav-dashboard" onclick="switchNav('nav-dashboard')">
        <span class="si-icon">&#9733;</span>
        <span class="si-label">Dashboard</span>
      </div>

      <!-- Team Management -->
      <div class="sidebar-item" onclick="toggleSidebarSub('sub-team', this)">
        <span class="si-icon">&#9917;</span>
        <span class="si-label">Team Management</span>
        <span class="si-arrow">&#9654;</span>
      </div>
      <div class="sidebar-sub" id="sub-team">
        <div class="sidebar-sub-item" data-nav="nav-team-live" onclick="switchNav('nav-team-live')">Live GW</div>
        <div class="sidebar-sub-item" data-nav="nav-team-myteam" onclick="switchNav('nav-team-myteam')">My Team</div>
      </div>

      <!-- Transfers -->
      <div class="sidebar-item" onclick="toggleSidebarSub('sub-transfers', this)">
        <span class="si-icon">&#8644;</span>
        <span class="si-label">Transfers</span>
        <span class="si-arrow">&#9654;</span>
      </div>
      <div class="sidebar-sub" id="sub-transfers">
        <div class="sidebar-sub-item" data-nav="nav-transfers-planner" onclick="switchNav('nav-transfers-planner')">Transfer Planner</div>
        <div class="sidebar-sub-item" data-nav="nav-transfers-suggestions" onclick="switchNav('nav-transfers-suggestions')">Suggestions</div>
        <div class="sidebar-sub-item" data-nav="nav-transfers-optimizer" onclick="switchNav('nav-transfers-optimizer')">Squad Optimizer</div>
      </div>

      <!-- Leagues -->
      <div class="sidebar-item" onclick="toggleSidebarSub('sub-leagues', this)">
        <span class="si-icon">&#127942;</span>
        <span class="si-label">Leagues</span>
        <span class="si-arrow">&#9654;</span>
      </div>
      <div class="sidebar-sub" id="sub-leagues">
        <div class="sidebar-sub-item" data-nav="nav-leagues-standings" onclick="switchNav('nav-leagues-standings')">Standings</div>
        <div class="sidebar-sub-item" data-nav="nav-leagues-rival" onclick="switchNav('nav-leagues-rival')">Rival Comparison</div>
      </div>

      <!-- Fixtures -->
      <div class="sidebar-item" onclick="toggleSidebarSub('sub-fixtures', this)">
        <span class="si-icon">&#128197;</span>
        <span class="si-label">Fixtures</span>
        <span class="si-arrow">&#9654;</span>
      </div>
      <div class="sidebar-sub" id="sub-fixtures">
        <div class="sidebar-sub-item" data-nav="nav-fixtures-fdr" onclick="switchNav('nav-fixtures-fdr')">FDR Heatmap</div>
        <div class="sidebar-sub-item" data-nav="nav-fixtures-list" onclick="switchNav('nav-fixtures-list')">Fixture List</div>
      </div>

      <!-- Player Stats -->
      <div class="sidebar-item" onclick="toggleSidebarSub('sub-playerstats', this)">
        <span class="si-icon">&#128202;</span>
        <span class="si-label">Player Stats</span>
        <span class="si-arrow">&#9654;</span>
      </div>
      <div class="sidebar-sub" id="sub-playerstats">
        <div class="sidebar-sub-item" data-nav="nav-playerstats-table" onclick="switchNav('nav-playerstats-table')">Player Search</div>
        <div class="sidebar-sub-item" data-nav="nav-playerstats-compare" onclick="switchNav('nav-playerstats-compare')">Compare</div>
      </div>

      <!-- News & Updates -->
      <div class="sidebar-item" onclick="toggleSidebarSub('sub-news', this)">
        <span class="si-icon">&#128240;</span>
        <span class="si-label">News &amp; Updates</span>
        <span class="si-arrow">&#9654;</span>
      </div>
      <div class="sidebar-sub" id="sub-news">
        <div class="sidebar-sub-item" data-nav="nav-news-captain" onclick="switchNav('nav-news-captain')">Captain Picks</div>
        <div class="sidebar-sub-item" data-nav="nav-news-prices" onclick="switchNav('nav-news-prices')">Price Changes</div>
        <div class="sidebar-sub-item" data-nav="nav-news-differentials" onclick="switchNav('nav-news-differentials')">Differentials</div>
      </div>

      <!-- Draft / Waivers -->
      <div class="sidebar-item" data-nav="nav-draft" onclick="switchNav('nav-draft')">
        <span class="si-icon">&#128221;</span>
        <span class="si-label">Draft / Waivers</span>
      </div>

      <div class="sidebar-divider"></div>

      <!-- Settings -->
      <div class="sidebar-item" data-nav="nav-settings" onclick="switchNav('nav-settings')">
        <span class="si-icon">&#9881;</span>
        <span class="si-label">Settings</span>
      </div>
    </div>
  </nav>

  <!-- ==================== MAIN CONTENT ==================== -->
  <div class="main-content">
    <div class="container">

      <!-- ==================== DASHBOARD ==================== -->
      <div class="nav-panel active" id="nav-dashboard">

        <!-- Welcome -->
        <div class="dash-welcome">
          <h2 id="dash-title">Dashboard</h2>
          <p id="dash-subtitle">Load your FPL ID in <a href="#" onclick="switchNav('nav-settings');return false" style="color:#4da6ff">Settings</a> to see your live overview.</p>
        </div>

        <!-- Top stats -->
        <div class="dash-stats" id="dash-stats">
          <div class="dash-stat">
            <div class="ds-value" id="dash-total">--</div>
            <div class="ds-label">Total Points</div>
            <div class="ds-sub" id="dash-total-sub"></div>
          </div>
          <div class="dash-stat">
            <div class="ds-value blue" id="dash-gw-pts">--</div>
            <div class="ds-label" id="dash-gw-label">GW Points</div>
            <div class="ds-sub" id="dash-hits-sub"></div>
          </div>
          <div class="dash-stat">
            <div class="ds-value" id="dash-rank">--</div>
            <div class="ds-label">Overall Rank</div>
            <div class="ds-sub" id="dash-rank-sub"></div>
          </div>
          <div class="dash-stat">
            <div class="ds-value blue" id="dash-league-rank">--</div>
            <div class="ds-label">League Rank</div>
            <div class="ds-sub" id="dash-league-sub"></div>
          </div>
        </div>

        <!-- Empty state: quick links (visible when no user loaded) -->
        <div id="dash-empty-state">
          <div class="dash-grid">
            <div class="dash-card" onclick="switchNav('nav-transfers-optimizer')">
              <div class="dc-icon">&#9889;</div>
              <div class="dc-title">Squad Optimizer</div>
              <div class="dc-desc">Find the optimal 15-man squad</div>
            </div>
            <div class="dash-card" onclick="switchNav('nav-news-captain')">
              <div class="dc-icon">&#169;</div>
              <div class="dc-title">Captain Picks</div>
              <div class="dc-desc">Best captain choices for next GW</div>
            </div>
            <div class="dash-card" onclick="switchNav('nav-fixtures-fdr')">
              <div class="dc-icon">&#128197;</div>
              <div class="dc-title">FDR Heatmap</div>
              <div class="dc-desc">Fixture difficulty at a glance</div>
            </div>
            <div class="dash-card" onclick="switchNav('nav-playerstats-table')">
              <div class="dc-icon">&#128202;</div>
              <div class="dc-title">Player Stats</div>
              <div class="dc-desc">Search and filter all players</div>
            </div>
            <div class="dash-card" onclick="switchNav('nav-news-prices')">
              <div class="dc-icon">&#128176;</div>
              <div class="dc-title">Price Changes</div>
              <div class="dc-desc">Track risers and fallers</div>
            </div>
            <div class="dash-card" onclick="switchNav('nav-settings')">
              <div class="dc-icon">&#9881;</div>
              <div class="dc-title">Settings</div>
              <div class="dc-desc">Load your FPL ID to unlock all features</div>
            </div>
          </div>
        </div>

        <!-- Live dashboard (hidden until user loaded) -->
        <div id="dash-live" class="hidden">
          <div class="loader" id="dash-loader"><div class="spinner"></div><div class="loader-text">Loading dashboard...</div></div>

          <!-- Mid section: pitch + right rail -->
          <div class="dash-body">
            <div class="dash-mid">

              <!-- Captain highlight -->
              <div class="dash-section">
                <div class="dash-section-title">Captain <span class="ds-link" onclick="switchNav('nav-news-captain')">Captain picks &#8250;</span></div>
                <div id="dash-captain-slot">
                  <div style="color:#555;font-size:0.82rem;">No captain data yet</div>
                </div>
              </div>

              <!-- Starting XI mini pitch -->
              <div class="dash-section">
                <div class="dash-section-title">Starting XI <span class="ds-link" onclick="switchNav('nav-team-live')">Full view &#8250;</span></div>
                <div class="dash-pitch" id="dash-pitch-slot"></div>
              </div>

              <!-- Bonus tracking -->
              <div class="dash-section">
                <div class="dash-section-title">Bonus Points</div>
                <div class="dash-bonus" id="dash-bonus-slot">
                  <div style="color:#555;font-size:0.82rem;">No bonus data yet</div>
                </div>
              </div>

            </div>

            <!-- Right rail -->
            <div class="dash-rail">

              <!-- Injuries / Suspensions -->
              <div class="dash-section">
                <div class="dash-section-title" style="color:#ff6b6b;">Injuries &amp; News</div>
                <div class="dash-rail-list" id="dash-injuries-slot">
                  <div style="color:#555;font-size:0.82rem;">Loading...</div>
                </div>
              </div>

              <!-- Price changes -->
              <div class="dash-section">
                <div class="dash-section-title" style="color:#51cf66;">Price Changes <span class="ds-link" onclick="switchNav('nav-news-prices')">All &#8250;</span></div>
                <div class="dash-rail-list" id="dash-prices-slot">
                  <div style="color:#555;font-size:0.82rem;">Loading...</div>
                </div>
              </div>

            </div>
          </div>

          <!-- Bottom: bench + fixtures -->
          <div class="dash-bottom">
            <div class="dash-section">
              <div class="dash-section-title">Bench</div>
              <div class="dash-bench" id="dash-bench-slot">
                <div style="color:#555;font-size:0.82rem;">No bench data</div>
              </div>
            </div>
            <div class="dash-section">
              <div class="dash-section-title">Upcoming Fixtures <span class="ds-link" onclick="switchNav('nav-fixtures-list')">All &#8250;</span></div>
              <div id="dash-fixtures-slot">
                <div style="color:#555;font-size:0.82rem;">Loading...</div>
              </div>
            </div>
          </div>
        </div>

      </div>

      <!-- ==================== TEAM: LIVE GW ==================== -->
      <div class="nav-panel" id="nav-team-live">
        <div class="section">
          <div class="section-title blue">Live Gameweek Points</div>
          <p id="live-no-user" style="color:#888;font-size:0.85rem;">Load your FPL User ID in <a href="#" onclick="switchNav('nav-settings');return false" style="color:#4da6ff">Settings</a> to see live points.</p>
          <div id="live-content" class="hidden">
            <div class="stat-row" id="live-stats"></div>
            <div id="live-captain-bar"></div>
            <div class="live-action-bar" id="live-action-bar">
              <button class="btn-captain" onclick="enterCaptainMode('captain')">Set Captain</button>
              <button class="btn-vice" onclick="enterCaptainMode('vice')">Set Vice</button>
              <span id="live-formation-badge" class="formation-badge"></span>
              <span id="live-save-indicator" class="live-save-indicator">Saved</span>
            </div>
            <div class="pitch" id="live-pitch"></div>
          </div>
          <div class="loader" id="live-loader"><div class="spinner"></div><div class="loader-text">Loading live data...</div></div>
        </div>
      </div>

      <!-- ==================== TEAM: MY TEAM ==================== -->
      <div class="nav-panel" id="nav-team-myteam">
        <div id="myteam-no-data">
          <div class="section">
            <p style="color:#888;font-size:0.85rem;">Run the <a href="#" onclick="switchNav('nav-transfers-optimizer');return false" style="color:#4da6ff">Squad Optimizer</a> with your FPL ID loaded to see your team here.</p>
          </div>
        </div>
        <div id="myteam-content" class="hidden">
          <div class="stat-row" id="user-summary"></div>
          <div class="section">
            <div class="section-title blue">My Starting XI</div>
            <div class="table-wrap">
              <table><thead><tr><th>Pos</th><th>Player</th><th>Team</th><th class="right">Cost</th><th class="right">Form</th><th class="right">PPG</th><th class="right">xG</th><th class="right">xA</th><th class="right">Score</th></tr></thead>
              <tbody id="user-starting-body"></tbody></table>
            </div>
          </div>
          <div class="section">
            <div class="section-title blue">My Bench</div>
            <div class="table-wrap">
              <table><thead><tr><th>Pos</th><th>Player</th><th>Team</th><th class="right">Cost</th><th class="right">Score</th></tr></thead>
              <tbody id="user-bench-body"></tbody></table>
            </div>
          </div>
          <div class="section hidden" id="user-transfers-section">
            <div class="section-title blue">Suggested Transfers</div>
            <div class="table-wrap">
              <table><thead><tr><th>#</th><th>Out</th><th>In</th><th class="right">Gain</th><th class="right">Cost</th></tr></thead>
              <tbody id="user-transfers-body"></tbody></table>
            </div>
          </div>
        </div>
      </div>

      <!-- ==================== TRANSFERS: PLANNER ==================== -->
      <div class="nav-panel" id="nav-transfers-planner">
        <div class="section">
          <div class="section-title">Transfer Planner</div>
          <p id="tp-no-user" style="color:#888;font-size:0.85rem;">Load your FPL User ID in <a href="#" onclick="switchNav('nav-settings');return false" style="color:#4da6ff">Settings</a> to plan transfers.</p>
          <div id="tp-content" class="hidden">
            <div class="tp-budget-bar" id="tp-budget-bar">
              <div class="tp-budget-card"><div class="tp-label">Bank</div><div class="tp-val" id="tp-bank">0.0</div></div>
              <div class="tp-budget-card"><div class="tp-label">Selling</div><div class="tp-val blue" id="tp-selling">0.0</div></div>
              <div class="tp-budget-card"><div class="tp-label">Buying</div><div class="tp-val red" id="tp-buying">0.0</div></div>
              <div class="tp-budget-card"><div class="tp-label">Remaining</div><div class="tp-val gold" id="tp-remaining">0.0</div></div>
              <div class="tp-budget-card"><div class="tp-label">Hits</div><div class="tp-val red" id="tp-hits">0</div></div>
            </div>

            <div class="tp-transfer-summary" id="tp-transfer-summary"></div>

            <div style="display:flex;gap:0.5rem;margin-bottom:1rem;flex-wrap:wrap;">
              <button class="btn" id="tp-confirm-btn" onclick="showTransferModal()" disabled>Confirm Transfers</button>
              <button class="btn-outline" onclick="resetTransfers()">Reset All</button>
              <span id="tp-free-label" style="color:#888;font-size:0.78rem;align-self:center;"></span>
            </div>

            <div class="tp-layout">
              <div>
                <!-- Squad -->
                <div class="section" style="padding:0.8rem;">
                  <div class="section-title blue" style="margin-bottom:0.4rem;">Your Squad</div>
                  <div class="tp-squad-list" id="tp-squad"></div>
                </div>

                <!-- Replacement picker -->
                <div class="tp-replacement-panel" id="tp-replacement-panel">
                  <div class="tp-rp-title">
                    <span id="tp-rp-label">Pick a replacement</span>
                    <span class="tp-rp-close" onclick="closeReplacementPanel()">&times;</span>
                  </div>
                  <div class="tp-rp-filters">
                    <input type="text" id="tp-rp-search" placeholder="Search..." oninput="filterReplacements()">
                    <select id="tp-rp-sort" onchange="filterReplacements()">
                      <option value="composite_score">Score</option>
                      <option value="form">Form</option>
                      <option value="total_points">Points</option>
                      <option value="cost">Cost (low)</option>
                      <option value="selected_by_percent">Ownership</option>
                    </select>
                  </div>
                  <div class="tp-rp-list" id="tp-rp-list"></div>
                </div>
              </div>

              <!-- Intelligence Rail -->
              <div>
                <div class="section" style="padding:0.8rem;">
                  <div class="tp-intel-section">
                    <div class="tp-intel-title">Most Transferred In</div>
                    <div id="tp-intel-in"></div>
                  </div>
                  <div class="tp-intel-section">
                    <div class="tp-intel-title" style="color:#ff6b6b;">Most Transferred Out</div>
                    <div id="tp-intel-out"></div>
                  </div>
                  <div class="tp-intel-section">
                    <div class="tp-intel-title" style="color:#4da6ff;">Form Ranking (Your Squad)</div>
                    <div id="tp-intel-form"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="loader" id="tp-loader"><div class="spinner"></div><div class="loader-text">Loading transfer data...</div></div>
        </div>

        <!-- Confirm Modal -->
        <div class="tp-modal-overlay" id="tp-modal-overlay" onclick="if(event.target===this)closeTransferModal()">
          <div class="tp-modal">
            <h3>Confirm Transfers</h3>
            <div class="tp-modal-transfers" id="tp-modal-transfers"></div>
            <div class="tp-modal-cost" id="tp-modal-cost"></div>
            <div class="tp-modal-actions">
              <button class="btn-cancel" onclick="closeTransferModal()">Cancel</button>
              <button class="btn" onclick="confirmTransfers()">Confirm</button>
            </div>
          </div>
        </div>
      </div>

      <!-- ==================== TRANSFERS: SUGGESTIONS ==================== -->
      <div class="nav-panel" id="nav-transfers-suggestions">
        <div id="suggestions-no-data">
          <div class="section">
            <p style="color:#888;font-size:0.85rem;">Run the <a href="#" onclick="switchNav('nav-transfers-optimizer');return false" style="color:#4da6ff">Squad Optimizer</a> with your FPL ID to see transfer suggestions.</p>
          </div>
        </div>
        <div id="suggestions-content" class="hidden">
          <div class="section" id="transfers-section">
            <div class="section-title">Transfer Suggestions</div>
            <div class="table-wrap">
              <table><thead><tr><th>#</th><th>Out</th><th>In</th><th class="right">Gain</th><th class="right">Cost</th></tr></thead>
              <tbody id="transfers-body"></tbody></table>
            </div>
          </div>
        </div>
      </div>

      <!-- ==================== TRANSFERS: OPTIMIZER ==================== -->
      <div class="nav-panel" id="nav-transfers-optimizer">
        <div class="settings">
          <div class="section-title">Optimizer Settings</div>
          <div class="settings-grid">
            <div class="field">
              <label>Budget: <span class="slider-value" id="budget-display">100.0</span>M</label>
              <input type="range" id="budget" min="80" max="105" step="0.5" value="100">
            </div>
            <div class="field">
              <label>Fixture Lookahead</label>
              <select id="lookahead">
                <option value="3">3 GWs</option>
                <option value="5" selected>5 GWs</option>
                <option value="8">8 GWs</option>
                <option value="10">10 GWs</option>
              </select>
            </div>
            <button class="btn" id="run-btn" onclick="runOptimizer()">Optimize</button>
          </div>
        </div>

        <div class="loader" id="loader">
          <div class="spinner"></div>
          <div class="loader-text">Fetching data & optimizing squad...</div>
        </div>
        <div id="error"></div>

        <div id="results" class="hidden">
          <div class="tabs" id="tab-bar">
            <div class="tab active" data-tab="optimal" onclick="switchTab('optimal')">Optimal Squad</div>
            <div class="tab" data-tab="top-players" onclick="switchTab('top-players')">Top Players</div>
          </div>

          <div class="tab-content active" id="tab-optimal">
            <div class="stat-row" id="summary"></div>
            <div class="section">
              <div class="section-title">Starting XI</div>
              <div class="table-wrap">
                <table><thead><tr><th>Pos</th><th>Player</th><th>Team</th><th class="right">Cost</th><th class="right">Form</th><th class="right">PPG</th><th class="right">xG</th><th class="right">xA</th><th class="right">Score</th></tr></thead>
                <tbody id="starting-body"></tbody></table>
              </div>
            </div>
            <div class="section">
              <div class="section-title">Bench</div>
              <div class="table-wrap">
                <table><thead><tr><th>Pos</th><th>Player</th><th>Team</th><th class="right">Cost</th><th class="right">Score</th></tr></thead>
                <tbody id="bench-body"></tbody></table>
              </div>
            </div>
          </div>

          <div class="tab-content" id="tab-top-players">
            <div id="top-players-container"></div>
          </div>
        </div>
      </div>

      <!-- ==================== LEAGUES: STANDINGS ==================== -->
      <div class="nav-panel" id="nav-leagues-standings">
        <div class="section">
          <div class="section-title blue">League Standings</div>
          <div id="leagues-no-user" style="color:#888;font-size:0.85rem;">Load your FPL User ID in <a href="#" onclick="switchNav('nav-settings');return false" style="color:#4da6ff">Settings</a> to see your leagues.</div>
          <div class="leagues-section" id="leagues-section">
            <div class="sec-title">Your Leagues</div>
            <div class="league-list" id="league-list"></div>
          </div>
          <div class="league-standings" id="league-standings">
            <div class="league-title"><span id="league-title-text"></span> <span class="inline-spinner" id="league-spinner"></span></div>
            <div class="table-wrap">
              <table id="league-table" class="hidden">
                <thead><tr><th>#</th><th>Manager</th><th>Team</th><th class="right">GW</th><th class="right">Total</th><th></th></tr></thead>
                <tbody id="league-body"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- ==================== LEAGUES: RIVAL ==================== -->
      <div class="nav-panel" id="nav-leagues-rival">
        <div class="section">
          <div class="section-title blue">Rival Comparison</div>
          <p id="rival-no-user" style="color:#888;font-size:0.85rem;">Select a rival from <a href="#" onclick="switchNav('nav-leagues-standings');return false" style="color:#4da6ff">League Standings</a> to compare squads, or enter a rival ID below.</p>
          <div style="display:flex;gap:0.6rem;align-items:end;flex-wrap:wrap;margin-top:1rem;">
            <div class="field" style="flex:0 1 180px;">
              <label>Rival FPL ID</label>
              <input type="text" id="rival-id-input" placeholder="e.g. 1234567" onkeydown="if(event.key==='Enter')loadRivalDirect()">
            </div>
            <button class="btn-blue btn-sm" onclick="loadRivalDirect()">Compare</button>
          </div>
          <div id="rival-output" style="margin-top:1rem;"></div>
        </div>
      </div>

      <!-- ==================== FIXTURES: FDR ==================== -->
      <div class="nav-panel" id="nav-fixtures-fdr">
        <div class="section">
          <div class="section-title">Fixture Difficulty Rating</div>
          <div style="margin-bottom:0.8rem;display:flex;gap:0.5rem;align-items:center;flex-wrap:wrap;">
            <span style="font-size:0.75rem;color:#888;">KEY:</span>
            <span class="fdr-cell fdr-1" style="padding:0.2rem 0.5rem;font-size:0.72rem;">1</span>
            <span class="fdr-cell fdr-2" style="padding:0.2rem 0.5rem;font-size:0.72rem;">2</span>
            <span class="fdr-cell fdr-3" style="padding:0.2rem 0.5rem;font-size:0.72rem;">3</span>
            <span class="fdr-cell fdr-4" style="padding:0.2rem 0.5rem;font-size:0.72rem;">4</span>
            <span class="fdr-cell fdr-5" style="padding:0.2rem 0.5rem;font-size:0.72rem;">5</span>
            <span style="font-size:0.72rem;color:#888;margin-left:0.5rem;">(H) = Home</span>
          </div>
          <div class="loader" id="fdr-loader"><div class="spinner"></div><div class="loader-text">Loading FDR...</div></div>
          <div class="fdr-grid" id="fdr-container"></div>
        </div>
      </div>

      <!-- ==================== FIXTURES: LIST ==================== -->
      <div class="nav-panel" id="nav-fixtures-list">
        <div class="section">
          <div style="margin-bottom:0.8rem;">
            <label style="color:#888;font-size:0.75rem;text-transform:uppercase;margin-right:0.5rem;">Gameweek</label>
            <select id="gw-filter" onchange="renderFixtures()" style="background:#0e1117;border:1px solid #2a2f3e;color:#e6e6e6;border-radius:6px;padding:0.5rem;font-size:0.9rem;min-width:180px;">
              <option value="current">Current / Next</option>
            </select>
          </div>
          <div class="loader" id="fixtures-loader"><div class="spinner"></div><div class="loader-text">Loading fixtures...</div></div>
          <div id="fixtures-container"></div>
        </div>
      </div>

      <!-- ==================== PLAYER STATS: TABLE ==================== -->
      <div class="nav-panel" id="nav-playerstats-table">
        <div class="section">
          <div class="filters">
            <div class="field" style="flex:2">
              <label>Search</label>
              <input type="text" id="player-search" placeholder="Player name..." oninput="debouncedLoadPlayers()">
            </div>
            <div class="field">
              <label>Position</label>
              <select id="player-pos-filter" onchange="loadPlayers()">
                <option value="">All</option>
                <option value="GK">GK</option>
                <option value="DEF">DEF</option>
                <option value="MID">MID</option>
                <option value="FWD">FWD</option>
              </select>
            </div>
            <div class="field">
              <label>Team</label>
              <select id="player-team-filter" onchange="loadPlayers()">
                <option value="">All</option>
              </select>
            </div>
          </div>
          <div class="loader" id="players-loader"><div class="spinner"></div><div class="loader-text">Loading players...</div></div>
          <div class="table-wrap">
            <table id="players-table" class="hidden">
              <thead><tr>
                <th class="sortable sort-desc" data-sort="total_points" onclick="sortPlayers(this)">Pts</th>
                <th>Pos</th>
                <th class="sortable" data-sort="name" onclick="sortPlayers(this)">Player</th>
                <th>Team</th>
                <th class="sortable right" data-sort="cost" onclick="sortPlayers(this)">Cost</th>
                <th class="sortable right" data-sort="form" onclick="sortPlayers(this)">Form</th>
                <th class="sortable right" data-sort="points_per_game" onclick="sortPlayers(this)">PPG</th>
                <th class="sortable right" data-sort="xG" onclick="sortPlayers(this)">xG</th>
                <th class="sortable right" data-sort="xA" onclick="sortPlayers(this)">xA</th>
                <th class="sortable right" data-sort="ict_index" onclick="sortPlayers(this)">ICT</th>
                <th class="sortable right" data-sort="minutes" onclick="sortPlayers(this)">Min</th>
              </tr></thead>
              <tbody id="players-body"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ==================== PLAYER STATS: COMPARE ==================== -->
      <div class="nav-panel" id="nav-playerstats-compare">
        <div class="section">
          <div class="section-title">Player Comparison</div>
          <div class="compare-search">
            <div class="field">
              <label>Search player</label>
              <input type="text" id="compare-input" placeholder="Type a name..." oninput="debouncedCompareSearch()">
            </div>
          </div>
          <div class="compare-results" id="compare-results"></div>
          <div class="compare-chips" id="compare-chips"></div>
          <div id="compare-output"></div>
        </div>
      </div>

      <!-- ==================== NEWS: CAPTAIN ==================== -->
      <div class="nav-panel" id="nav-news-captain">
        <div class="section">
          <div class="section-title">Captain Picks  Next GW</div>
          <div class="loader" id="captain-loader"><div class="spinner"></div><div class="loader-text">Analyzing captain picks...</div></div>
          <div class="table-wrap">
            <table id="captain-table" class="hidden">
              <thead><tr><th>#</th><th>Player</th><th>Team</th><th>Pos</th><th class="right">Form</th><th class="right">PPG</th><th class="right">xG</th><th class="right">xA</th><th class="right">Fixture</th><th class="right">Score</th></tr></thead>
              <tbody id="captain-body"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ==================== NEWS: PRICES ==================== -->
      <div class="nav-panel" id="nav-news-prices">
        <div class="section">
          <div class="section-title" style="color:#51cf66">Price Risers</div>
          <div class="loader" id="prices-loader"><div class="spinner"></div><div class="loader-text">Loading transfer data...</div></div>
          <div id="risers-container"></div>
          <div class="section-title" style="color:#ff6b6b;margin-top:1.5rem;">Price Fallers</div>
          <div id="fallers-container"></div>
        </div>
      </div>

      <!-- ==================== NEWS: DIFFERENTIALS ==================== -->
      <div class="nav-panel" id="nav-news-differentials">
        <div class="section">
          <div class="section-title">Differential Finder</div>
          <div style="margin-bottom:1rem;display:flex;gap:0.8rem;align-items:end;flex-wrap:wrap;">
            <div class="field" style="max-width:160px;">
              <label>Max Ownership %</label>
              <select id="diff-ownership" onchange="loadDifferentials()">
                <option value="5">5%</option>
                <option value="10" selected>10%</option>
                <option value="15">15%</option>
                <option value="20">20%</option>
              </select>
            </div>
          </div>
          <div class="loader" id="diff-loader"><div class="spinner"></div><div class="loader-text">Finding differentials...</div></div>
          <div class="table-wrap">
            <table id="diff-table" class="hidden">
              <thead><tr><th>#</th><th>Player</th><th>Team</th><th>Pos</th><th class="right">Cost</th><th class="right">Pts</th><th class="right">Form</th><th class="right">PPG</th><th class="right">Own%</th><th class="right">Score</th></tr></thead>
              <tbody id="diff-body"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ==================== DRAFT / WAIVERS ==================== -->
      <div class="nav-panel" id="nav-draft">
        <div class="coming-soon">
          <div class="cs-icon">&#128221;</div>
          <div class="cs-title">Draft &amp; Waivers</div>
          <div class="cs-text">Draft league support is coming soon.<br>Stay tuned for waiver wire tools and draft rankings.</div>
        </div>
      </div>

      <!-- ==================== SETTINGS ==================== -->
      <div class="nav-panel" id="nav-settings">
        <h2 style="color:#00ff87;margin-bottom:1rem;font-size:1.2rem;">Settings</h2>

        <!-- FPL Account -->
        <div class="user-bar">
          <div class="user-bar-header">
            <span class="title">FPL Account</span>
            <span class="inline-spinner" id="user-spinner"></span>
          </div>
          <div class="user-bar-row">
            <div class="field">
              <label>FPL User ID</label>
              <input type="text" id="user-id" placeholder="e.g. 1234567" onkeydown="if(event.key==='Enter')loadUser()">
              <div class="help-text">Find your ID in the FPL website URL</div>
            </div>
            <button class="btn-blue" id="load-user-btn" onclick="loadUser()">Load</button>
          </div>
          <div class="user-error" id="user-error"></div>
          <div class="user-info" id="user-info">
            <div class="mgr">Manager: <span id="manager-name"></span></div>
            <div class="tm">Team: <span id="team-name"></span></div>
          </div>
        </div>

        <!-- Optimizer defaults -->
        <div class="section">
          <div class="section-title">Optimizer Defaults</div>
          <p style="color:#888;font-size:0.82rem;margin-bottom:0.8rem;">These are also configurable on the Squad Optimizer page.</p>
          <div class="settings-grid">
            <div class="field">
              <label>Default Budget</label>
              <input type="text" id="settings-budget" value="100.0" style="max-width:120px;" readonly>
              <div class="help-text">Adjust on Optimizer page</div>
            </div>
            <div class="field">
              <label>Default Lookahead</label>
              <input type="text" id="settings-lookahead" value="5 GWs" style="max-width:120px;" readonly>
              <div class="help-text">Adjust on Optimizer page</div>
            </div>
          </div>
        </div>
      </div>

    </div><!-- /container -->
  </div><!-- /main-content -->

</div><!-- /app-shell -->

<script>
const $ = id => document.getElementById(id);
let teamsMap = {};
let playersSort = { col: 'total_points', dir: 'desc' };
let fixturesData = null;
let playersLoaded = false;
let fixturesLoaded = false;
let debounceTimer = null;
let compareTimer = null;
let loadedUserId = null;
let compareIds = [];
let allPlayersCache = null;

// ==================== SIDEBAR NAV ====================
function toggleSidebar() {
  const sidebar = $('sidebar');
  const overlay = $('sidebar-overlay');
  sidebar.classList.toggle('open');
  overlay.classList.toggle('active');
}

function toggleSidebarSub(subId, parentItem) {
  const sub = $(subId);
  const arrow = parentItem.querySelector('.si-arrow');
  const isOpen = sub.classList.contains('open');

  // Close all other subs
  document.querySelectorAll('.sidebar-sub').forEach(s => s.classList.remove('open'));
  document.querySelectorAll('.si-arrow').forEach(a => a.classList.remove('open'));

  if (!isOpen) {
    sub.classList.add('open');
    if (arrow) arrow.classList.add('open');
  }
}

function switchNav(panelId) {
  // Hide all panels
  document.querySelectorAll('.nav-panel').forEach(p => p.classList.remove('active'));

  // Show target panel
  const panel = $(panelId);
  if (panel) panel.classList.add('active');

  // Update sidebar active state
  document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
  document.querySelectorAll('.sidebar-sub-item').forEach(i => i.classList.remove('active'));

  // Activate the matching sidebar item or sub-item
  const subItem = document.querySelector(`.sidebar-sub-item[data-nav="${panelId}"]`);
  if (subItem) {
    subItem.classList.add('active');
    // Also highlight parent group and ensure sub is open
    const subContainer = subItem.closest('.sidebar-sub');
    if (subContainer) {
      subContainer.classList.add('open');
      const parentItem = subContainer.previousElementSibling;
      if (parentItem && parentItem.classList.contains('sidebar-item')) {
        parentItem.classList.add('active');
        const arrow = parentItem.querySelector('.si-arrow');
        if (arrow) arrow.classList.add('open');
      }
    }
  } else {
    const sidebarItem = document.querySelector(`.sidebar-item[data-nav="${panelId}"]`);
    if (sidebarItem) sidebarItem.classList.add('active');
  }

  // Close mobile sidebar
  $('sidebar').classList.remove('open');
  $('sidebar-overlay').classList.remove('active');

  // Lazy load data
  if (panelId === 'nav-playerstats-table' && !playersLoaded) loadMetadata().then(() => loadPlayers());
  if (panelId === 'nav-fixtures-list' && !fixturesLoaded) loadMetadata().then(() => loadFixtures());
  if (panelId === 'nav-fixtures-fdr') loadFDR();
  if (panelId === 'nav-news-captain') loadCaptainPicks();
  if (panelId === 'nav-news-prices') loadPriceChanges();
  if (panelId === 'nav-news-differentials') loadDifferentials();
  if (panelId === 'nav-team-live') loadLive();
  if (panelId === 'nav-transfers-planner') loadTransferPlanner();
  if (panelId === 'nav-dashboard') loadDashboard();
}

// ==================== DASHBOARD ====================
let dashLoaded = false;

function loadDashboard() {
  if (!loadedUserId) return;

  // Show live dash, hide empty state
  $('dash-empty-state').classList.add('hidden');
  $('dash-live').classList.remove('hidden');

  // Avoid re-fetching if already loaded this session
  if (dashLoaded) return;

  const loader = $('dash-loader');
  loader.classList.add('active');

  // Fire all requests in parallel
  Promise.all([
    fetch(`/api/live/${loadedUserId}`).then(r => r.json()),
    fetch('/api/price-changes').then(r => r.json()),
    fetch('/api/players?sort=total_points&dir=desc').then(r => r.json()),
    fetch('/api/fixtures').then(r => r.json()),
  ]).then(([liveData, priceData, playersData, fixturesResp]) => {

    // ---- TOP STATS ----
    if (!liveData.error) {
      $('dash-gw-pts').textContent = liveData.total_live_points ?? '--';
      $('dash-gw-label').textContent = liveData.gameweek_name || 'GW Points';
      $('dash-hits-sub').textContent = liveData.hits ? `(-${liveData.hits} hits)` : '';
      $('dash-rank').textContent = liveData.overall_rank ? liveData.overall_rank.toLocaleString() : '--';
      $('dash-total').textContent = liveData.total_points ? liveData.total_points.toLocaleString() : '--';
      $('dash-total-sub').textContent = liveData.team_value ? `Value: ${(liveData.team_value / 10).toFixed(1)}M` : '';
      $('dash-rank-sub').textContent = liveData.points_on_bench ? `${liveData.points_on_bench} on bench` : '';

      // ---- CAPTAIN ----
      const captain = liveData.picks.find(p => p.is_captain);
      if (captain) {
        const photoUrl = captain.photo ? `${PHOTO_BASE}${captain.photo}.png` : '';
        const photoHtml = photoUrl
          ? `<img src="${photoUrl}" alt="" style="width:100%;height:100%;object-fit:cover;object-position:top;border-radius:50%;" onerror="this.parentElement.innerHTML='C'">`
          : 'C';
        $('dash-captain-slot').innerHTML = `<div class="dash-captain">
          <div class="dc-badge">${photoHtml}</div>
          <div class="dc-info">
            <div class="dc-name">${captain.name}</div>
            <div class="dc-meta">${captain.team_name} &middot; ${captain.position_name} &middot; ${captain.multiplier}x</div>
          </div>
          <div class="dc-pts">${captain.live_points}</div>
        </div>`;
      }

      // ---- STARTING XI MINI PITCH ----
      const starting = liveData.picks.filter(p => p.multiplier > 0);
      const bench = liveData.picks.filter(p => p.multiplier === 0);
      const byPos = { 4: [], 3: [], 2: [], 1: [] };
      starting.forEach(p => { if (byPos[p.position]) byPos[p.position].push(p); });

      let pitchHtml = '<div class="pitch">';
      for (const pos of [4, 3, 2, 1]) {
        if (byPos[pos].length === 0) continue;
        pitchHtml += `<div class="pitch-row">${byPos[pos].map(p => liveCard(p, false)).join('')}</div>`;
      }
      pitchHtml += '</div>';
      $('dash-pitch-slot').innerHTML = pitchHtml;

      // ---- BONUS TRACKING ----
      const withBonus = liveData.picks.filter(p => p.bonus > 0).sort((a, b) => b.bonus - a.bonus);
      if (withBonus.length > 0) {
        $('dash-bonus-slot').innerHTML = withBonus.map(p =>
          `<div class="bonus-item"><span class="bi-pts">${p.bonus}B</span> ${p.name}</div>`
        ).join('');
      } else {
        $('dash-bonus-slot').innerHTML = '<div style="color:#555;font-size:0.82rem;">No bonus points yet this GW</div>';
      }

      // ---- BENCH ----
      if (bench.length > 0) {
        $('dash-bench-slot').innerHTML = bench.map(p => `<div class="bench-mini">
          <span class="bm-pos">${p.position_name}</span>
          <span class="bm-name">${p.name}</span>
          <span class="bm-pts">${p.live_points}</span>
        </div>`).join('');
      }
    }

    // ---- LEAGUE RANK ----
    // Fetch first league if available
    loadDashLeagueRank();

    // ---- INJURIES & NEWS (from players in user's squad) ----
    if (!liveData.error && playersData.players) {
      const myPlayerIds = new Set(liveData.picks.map(p => p.id));
      const injuredPlayers = playersData.players.filter(p =>
        myPlayerIds.has(p.id) && p.news && p.news.trim() !== ''
      );

      // Also show top flagged players not in squad
      const otherFlagged = playersData.players.filter(p =>
        !myPlayerIds.has(p.id) && p.news && p.news.trim() !== '' && p.chance_of_playing !== null && p.chance_of_playing < 100
      ).slice(0, 5);

      const allNews = [...injuredPlayers, ...otherFlagged].slice(0, 10);

      if (allNews.length > 0) {
        $('dash-injuries-slot').innerHTML = allNews.map(p => {
          const chance = p.chance_of_playing;
          let statusClass = 'red';
          let chanceText = '0%';
          if (chance === null || chance === undefined) { statusClass = 'yellow'; chanceText = '?'; }
          else if (chance >= 75) { statusClass = 'green'; chanceText = chance + '%'; }
          else if (chance >= 25) { statusClass = 'yellow'; chanceText = chance + '%'; }
          else { statusClass = 'red'; chanceText = chance + '%'; }
          const inSquad = myPlayerIds.has(p.id);
          return `<div class="dash-news-item">
            <div class="ni-status ${statusClass}"></div>
            <div class="ni-info">
              <div class="ni-name">${p.name}${inSquad ? ' <span style="color:#4da6ff;font-size:0.65rem;">MY TEAM</span>' : ''}</div>
              <div class="ni-text">${p.news}</div>
            </div>
            <div class="ni-chance" style="color:${statusClass === 'red' ? '#ff6b6b' : statusClass === 'yellow' ? '#ffd700' : '#51cf66'}">${chanceText}</div>
          </div>`;
        }).join('');
      } else {
        $('dash-injuries-slot').innerHTML = '<div style="color:#555;font-size:0.82rem;">No injuries in your squad</div>';
      }
    }

    // ---- PRICE CHANGES (top 5 risers + fallers) ----
    if (!priceData.error) {
      const topRisers = (priceData.risers || []).slice(0, 4);
      const topFallers = (priceData.fallers || []).slice(0, 4);
      let priceHtml = '';
      topRisers.forEach(p => {
        const change = p.cost_change_event !== 0 ? (p.cost_change_event / 10).toFixed(1) : '+?';
        priceHtml += `<div class="dash-price-item">
          <span class="pi-name">${p.name}</span>
          <span class="pi-change up">${change > 0 ? '+' : ''}${change}</span>
        </div>`;
      });
      topFallers.forEach(p => {
        const change = p.cost_change_event !== 0 ? (p.cost_change_event / 10).toFixed(1) : '-?';
        priceHtml += `<div class="dash-price-item">
          <span class="pi-name">${p.name}</span>
          <span class="pi-change down">${change}</span>
        </div>`;
      });
      $('dash-prices-slot').innerHTML = priceHtml || '<div style="color:#555;font-size:0.82rem;">No price changes</div>';
    }

    // ---- UPCOMING FIXTURES ----
    if (!fixturesResp.error && fixturesResp.gameweeks) {
      const upcoming = fixturesResp.gameweeks.filter(gw => gw.is_current || gw.is_next);
      const gw = upcoming[0];
      if (gw && gw.fixtures) {
        const fxHtml = gw.fixtures.slice(0, 6).map(f => {
          const mid = f.finished && f.home_score !== null
            ? `<span class="df-score">${f.home_score}-${f.away_score}</span>`
            : `<span class="df-time">vs</span>`;
          return `<div class="dash-fixture">
            <span class="df-teams">${f.home_team_name} ${mid} ${f.away_team_name}</span>
          </div>`;
        }).join('');
        $('dash-fixtures-slot').innerHTML = fxHtml;
      } else {
        $('dash-fixtures-slot').innerHTML = '<div style="color:#555;font-size:0.82rem;">No upcoming fixtures</div>';
      }
    }

    dashLoaded = true;
  }).catch(err => {
    console.error('Dashboard load error:', err);
  }).finally(() => {
    loader.classList.remove('active');
  });
}

function loadDashLeagueRank() {
  if (!loadedUserId) return;
  fetch(`/api/user/${loadedUserId}`).then(r => r.json()).then(data => {
    if (data.error || !data.leagues || data.leagues.length === 0) return;
    const league = data.leagues[0];
    $('dash-league-sub').textContent = league.name;
    fetch(`/api/league/${league.id}`).then(r => r.json()).then(lg => {
      if (lg.error) return;
      // Match user by entry ID
      const me = lg.standings.find(s => s.entry === loadedUserId);
      if (me) {
        $('dash-league-rank').textContent = '#' + me.rank;
      } else if (lg.standings.length > 0) {
        // Fallback: show '--' if user not found in top results
        $('dash-league-rank').textContent = '--';
      }
    }).catch(() => {});
  }).catch(() => {});
}

// ==================== PERSIST USER ID ====================
(function restoreUser() {
  const saved = localStorage.getItem('fpl_user_id');
  if (saved) {
    $('user-id').value = saved;
    setTimeout(() => loadUser(), 100);
  }
})();

// ==================== USER LOOKUP ====================
async function loadUser() {
  const idInput = $('user-id');
  const rawId = idInput.value.trim();
  if (!rawId) { idInput.focus(); return; }
  const uid = parseInt(rawId);
  if (isNaN(uid) || uid <= 0) {
    showUserError('Please enter a valid numeric FPL User ID.');
    return;
  }

  const btn = $('load-user-btn');
  const spinner = $('user-spinner');
  btn.disabled = true;
  spinner.classList.add('active');
  hideUserError();
  $('user-info').classList.remove('active');
  $('leagues-section').classList.remove('active');
  $('league-standings').classList.remove('active');

  try {
    const resp = await fetch(`/api/user/${uid}`);
    const data = await resp.json();
    if (!resp.ok) { showUserError(data.error || 'Failed to load user'); return; }

    loadedUserId = uid;
    dashLoaded = false; // Reset so dashboard reloads with new user
    localStorage.setItem('fpl_user_id', String(uid));
    $('manager-name').textContent = data.manager_name;
    $('team-name').textContent = data.team_name;
    $('user-info').classList.add('active');

    // Update dashboard welcome
    $('dash-title').textContent = `Welcome, ${data.manager_name}`;
    $('dash-subtitle').textContent = data.team_name;

    if (data.leagues && data.leagues.length > 0) {
      $('league-list').innerHTML = data.leagues.map(lg =>
        `<div class="league-chip" data-id="${lg.id}" onclick="loadLeague(${lg.id}, this)">${lg.name}</div>`
      ).join('');
      $('leagues-section').classList.add('active');
    }

    // Hide "no user" messages
    $('live-no-user').classList.add('hidden');
    const leaguesNoUser = $('leagues-no-user');
    if (leaguesNoUser) leaguesNoUser.classList.add('hidden');

    // Load dashboard stats
    loadDashboard();
  } catch (err) {
    showUserError('Network error: ' + err.message);
  } finally {
    btn.disabled = false;
    spinner.classList.remove('active');
  }
}

function showUserError(msg) { const el = $('user-error'); el.textContent = msg; el.classList.add('active'); }
function hideUserError() { $('user-error').classList.remove('active'); }

async function loadLeague(leagueId, chipEl) {
  document.querySelectorAll('.league-chip').forEach(c => c.classList.remove('active'));
  if (chipEl) chipEl.classList.add('active');

  const standings = $('league-standings');
  const spinnerEl = $('league-spinner');
  const tableEl = $('league-table');
  standings.classList.add('active');
  spinnerEl.classList.add('active');
  tableEl.classList.add('hidden');
  $('league-title-text').textContent = 'Loading...';

  try {
    const resp = await fetch(`/api/league/${leagueId}`);
    const data = await resp.json();
    if (!resp.ok) { $('league-title-text').textContent = data.error || 'Failed'; return; }

    $('league-title-text').textContent = data.league_name;
    $('league-body').innerHTML = data.standings.map(s => `<tr>
      <td>${s.rank}</td>
      <td>${s.manager_name}</td>
      <td>${s.team_name}</td>
      <td class="right">${s.gw_points}</td>
      <td class="right score">${s.total_points}</td>
      <td>${loadedUserId ? `<span class="btn-outline" onclick="loadRival(${s.rank}, '${s.manager_name.replace(/'/g, "\\'")}', event)" style="font-size:0.7rem;padding:0.15rem 0.4rem;">vs</span>` : ''}</td>
    </tr>`).join('');
    tableEl.classList.remove('hidden');
  } catch (err) {
    $('league-title-text').textContent = 'Network error';
  } finally {
    spinnerEl.classList.remove('active');
  }
}

// ==================== METADATA ====================
let metadataLoaded = false, metadataPromise = null;
function loadMetadata() {
  if (metadataLoaded) return Promise.resolve();
  if (metadataPromise) return metadataPromise;
  metadataPromise = fetch('/api/data').then(r => r.json()).then(data => {
    if (data.error) throw new Error(data.error);
    const sel = $('player-team-filter');
    data.teams.forEach(t => { const o = document.createElement('option'); o.value = t.id; o.textContent = t.name; sel.appendChild(o); });
    data.teams.forEach(t => { teamsMap[t.id] = t; });
    metadataLoaded = true;
  }).catch(err => { metadataPromise = null; console.error(err); });
  return metadataPromise;
}

// ==================== LIVE GW ====================
let liveLoaded = false;
let livePicksData = []; // Store picks data for captain/vice changes
let liveGameweek = null;
let captainMode = null; // null, 'captain', or 'vice'
const PHOTO_BASE = 'https://resources.premierleague.com/premierleague/photos/players/110x140/p';

const TEAM_COLORS = {
  'ARS': '#EF0107', 'AVL': '#670E36', 'BOU': '#DA291C', 'BRE': '#e30613',
  'BHA': '#0057B8', 'CHE': '#034694', 'CRY': '#1B458F', 'EVE': '#003399',
  'FUL': '#000000', 'IPS': '#0044AA', 'LEI': '#003090', 'LIV': '#C8102E',
  'MCI': '#6CABDD', 'MUN': '#DA291C', 'NEW': '#241F20', 'NFO': '#E53233',
  'SOU': '#D71920', 'TOT': '#132257', 'WHU': '#7A263A', 'WOL': '#FDB913',
};

const VALID_FORMATIONS = ['3-4-3','3-5-2','4-3-3','4-4-2','4-5-1','5-3-2','5-4-1','5-2-3','3-3-4','4-2-4'];

function getFormation() {
  const cards = document.querySelectorAll('#live-pitch .live-card:not(.bench)');
  let def = 0, mid = 0, fwd = 0;
  cards.forEach(c => {
    const pos = parseInt(c.dataset.position);
    if (pos === 2) def++;
    else if (pos === 3) mid++;
    else if (pos === 4) fwd++;
  });
  return `${def}-${mid}-${fwd}`;
}

function validateFormation() {
  const formation = getFormation();
  const badge = $('live-formation-badge');
  if (!badge) return;
  badge.textContent = formation;
  if (VALID_FORMATIONS.includes(formation)) {
    badge.classList.remove('formation-invalid');
  } else {
    badge.classList.add('formation-invalid');
  }
}

function saveLineup() {
  if (!loadedUserId || !liveGameweek) return;
  const cards = document.querySelectorAll('#live-pitch .live-card');
  const lineup = [];
  let benchIdx = 0;
  cards.forEach(c => {
    const isBench = c.dataset.isBench === 'true';
    lineup.push({
      id: parseInt(c.dataset.playerId),
      isBench: isBench,
      benchOrder: isBench ? ++benchIdx : 0,
      isCaptain: c.dataset.isCaptain === 'true',
      isVice: c.dataset.isVice === 'true',
    });
  });
  localStorage.setItem(`fpl_lineup_${loadedUserId}_${liveGameweek}`, JSON.stringify(lineup));
  // Flash saved indicator
  const ind = $('live-save-indicator');
  if (ind) { ind.classList.add('visible'); setTimeout(() => ind.classList.remove('visible'), 1500); }
}

function loadSavedLineup(picks) {
  if (!loadedUserId || !liveGameweek) return picks;
  const saved = localStorage.getItem(`fpl_lineup_${loadedUserId}_${liveGameweek}`);
  if (!saved) return picks;
  try {
    const lineup = JSON.parse(saved);
    const lineupMap = {};
    lineup.forEach(l => { lineupMap[l.id] = l; });
    // Only apply if all pick IDs match
    const pickIds = new Set(picks.map(p => p.id));
    const savedIds = new Set(lineup.map(l => l.id));
    if (pickIds.size !== savedIds.size || ![...pickIds].every(id => savedIds.has(id))) return picks;
    // Apply saved state
    picks.forEach(p => {
      const s = lineupMap[p.id];
      if (s) {
        p.multiplier = s.isBench ? 0 : (s.isCaptain ? 2 : 1);
        p.is_captain = s.isCaptain;
        p.is_vice_captain = s.isVice;
        p._benchOrder = s.benchOrder;
      }
    });
    // Sort bench by saved order
    const starting = picks.filter(p => p.multiplier > 0);
    const bench = picks.filter(p => p.multiplier === 0);
    bench.sort((a, b) => (a._benchOrder || 0) - (b._benchOrder || 0));
    return [...starting, ...bench];
  } catch { return picks; }
}

function enterCaptainMode(type) {
  if (captainMode) { exitCaptainMode(); return; }
  captainMode = type;
  const bar = $('live-captain-bar');
  const isVice = type === 'vice';
  bar.innerHTML = `<div class="captain-mode-bar${isVice ? ' vice-mode' : ''}">
    <span>Tap a starting player to set as ${isVice ? 'Vice Captain' : 'Captain'}</span>
    <button onclick="exitCaptainMode()">Cancel</button>
  </div>`;
  // Make starting cards clickable
  const cards = document.querySelectorAll('#live-pitch .live-card:not(.bench)');
  cards.forEach(c => {
    c.classList.add(isVice ? 'vice-selectable' : 'captain-selectable');
    c.setAttribute('draggable', 'false');
  });
}

function exitCaptainMode() {
  captainMode = null;
  $('live-captain-bar').innerHTML = '';
  const cards = document.querySelectorAll('#live-pitch .live-card');
  cards.forEach(c => {
    c.classList.remove('captain-selectable', 'vice-selectable');
    c.setAttribute('draggable', 'true');
  });
}

function handleCaptainClick(playerId) {
  if (!captainMode) return;
  const type = captainMode;
  const cards = document.querySelectorAll('#live-pitch .live-card');
  cards.forEach(c => {
    const pid = parseInt(c.dataset.playerId);
    if (type === 'captain') {
      if (pid === playerId) {
        c.dataset.isCaptain = 'true';
        // If this was vice captain, remove vice
        if (c.dataset.isVice === 'true') c.dataset.isVice = 'false';
      } else {
        c.dataset.isCaptain = 'false';
      }
    } else {
      if (pid === playerId) {
        c.dataset.isVice = 'true';
        // If this was captain, remove captain
        if (c.dataset.isCaptain === 'true') c.dataset.isCaptain = 'false';
      } else {
        c.dataset.isVice = 'false';
      }
    }
    // Update badge display
    const oldBadge = c.querySelector('.lp-captain, .lp-vice');
    if (oldBadge) oldBadge.remove();
    if (c.dataset.isCaptain === 'true') {
      c.insertAdjacentHTML('afterbegin', '<div class="lp-captain">C</div>');
    } else if (c.dataset.isVice === 'true') {
      c.insertAdjacentHTML('afterbegin', '<div class="lp-vice">V</div>');
    }
  });
  exitCaptainMode();
  saveLineup();
}

async function loadLive() {
  if (!loadedUserId) { $('live-no-user').classList.remove('hidden'); $('live-content').classList.add('hidden'); return; }
  $('live-no-user').classList.add('hidden');
  const loader = $('live-loader');
  loader.classList.add('active');
  $('live-content').classList.add('hidden');

  try {
    const resp = await fetch(`/api/live/${loadedUserId}`);
    const data = await resp.json();
    if (!resp.ok) { $('live-content').innerHTML = `<div class="error-msg">${data.error}</div>`; $('live-content').classList.remove('hidden'); return; }

    liveGameweek = data.gameweek;
    // Apply saved lineup if any
    data.picks = loadSavedLineup(data.picks);
    livePicksData = data.picks;

    // Recalculate bench points after applying saved lineup
    const benchPts = data.picks.filter(p => p.multiplier === 0).reduce((s, p) => s + p.raw_points, 0);
    const startPts = data.picks.filter(p => p.multiplier > 0).reduce((s, p) => s + p.raw_points * p.multiplier, 0);

    $('live-stats').innerHTML = `
      <div class="stat-card"><div class="label">${data.gameweek_name}</div><div class="value blue">${startPts}${data.hits ? `<span style="font-size:0.7rem;color:#ff6b6b"> (-${data.hits})</span>` : ''}</div></div>
      <div class="stat-card"><div class="label">On Bench</div><div class="value red">${benchPts}</div></div>
      ${data.overall_rank ? `<div class="stat-card"><div class="label">Overall Rank</div><div class="value">${data.overall_rank.toLocaleString()}</div></div>` : ''}
    `;

    const starting = data.picks.filter(p => p.multiplier > 0);
    const bench = data.picks.filter(p => p.multiplier === 0);

    const byPos = { 4: [], 3: [], 2: [], 1: [] };
    starting.forEach(p => { if (byPos[p.position]) byPos[p.position].push(p); });

    let pitchHtml = '';
    for (const pos of [4, 3, 2, 1]) {
      if (byPos[pos].length === 0) continue;
      pitchHtml += `<div class="pitch-row">${byPos[pos].map(p => liveCard(p, false)).join('')}</div>`;
    }
    pitchHtml += `<div class="pitch-row bench-row"><span class="bench-label">Bench</span>${bench.map((p, i) => liveCard(p, true, i + 1)).join('')}</div>`;

    $('live-pitch').innerHTML = pitchHtml;
    initLiveDragDrop();
    validateFormation();
    $('live-content').classList.remove('hidden');
    liveLoaded = true;
  } catch (err) {
    $('live-content').innerHTML = `<div class="error-msg">Failed to load: ${err.message}</div>`;
    $('live-content').classList.remove('hidden');
  } finally {
    loader.classList.remove('active');
  }
}

function liveCard(p, isBench, benchOrder) {
  let badge = '';
  if (p.is_captain) badge = '<div class="lp-captain">C</div>';
  else if (p.is_vice_captain) badge = '<div class="lp-vice">V</div>';
  const details = [];
  if (p.minutes > 0) details.push(`${p.minutes}'`);
  if (p.goals > 0) details.push(`${p.goals}G`);
  if (p.assists > 0) details.push(`${p.assists}A`);
  if (p.bonus > 0) details.push(`${p.bonus}B`);

  const photoUrl = p.photo ? `${PHOTO_BASE}${p.photo}.png` : '';
  const photoHtml = photoUrl
    ? `<img src="${photoUrl}" alt="${p.name}" onerror="this.parentElement.innerHTML='<span class=\\'lp-placeholder\\'>&#9917;</span>'">`
    : '<span class="lp-placeholder">&#9917;</span>';

  let upcomingHtml = '';
  if (p.upcoming && p.upcoming.length > 0) {
    upcomingHtml = '<div class="lp-upcoming">' + p.upcoming.map(fx =>
      `<span class="fdr-cell fdr-${fx.difficulty}" style="font-size:0.55rem;padding:0.1rem 0.2rem;margin:0 1px;" title="GW${fx.gw}: ${fx.opponent}${fx.is_home ? ' (H)' : ' (A)'}">${fx.opponent}</span>`
    ).join('') + '</div>';
  }

  // Injury flag
  let injuryHtml = '';
  const cop = p.chance_of_playing;
  if (p.news || (cop !== null && cop !== undefined && cop < 100)) {
    let injuryClass = 'injury-yellow';
    if (cop !== null && cop !== undefined && cop <= 25) injuryClass = 'injury-red';
    else if (p.news && (cop === null || cop === undefined)) injuryClass = 'injury-red';
    const tooltip = p.news || `${cop}% chance of playing`;
    injuryHtml = `<div class="lp-injury ${injuryClass}" title="${tooltip}"></div>`;
  }

  // Team color
  const teamColor = TEAM_COLORS[p.team_name] || '#333';

  // Bench order badge
  const benchBadge = isBench && benchOrder ? `<div class="bench-order">${benchOrder}</div>` : '';

  // Position name map for data attribute
  const posNames = {1:'GK', 2:'DEF', 3:'MID', 4:'FWD'};

  return `<div class="live-card${isBench ? ' bench' : ''}" draggable="true" data-player-id="${p.id}" data-is-bench="${isBench}" data-position="${p.position}" data-team="${p.team_name}" data-is-captain="${!!p.is_captain}" data-is-vice="${!!p.is_vice_captain}" style="--team-color:${teamColor}" onclick="handleCaptainClick(${p.id})">
    ${badge}${injuryHtml}
    <div class="lp-photo">${photoHtml}</div>
    <div class="lp-name">${p.name}</div>
    <div class="lp-pts${p.live_points === 0 ? ' zero' : ''}">${p.live_points}</div>
    ${details.length ? `<div class="lp-detail">${details.join(' &middot; ')}</div>` : ''}
    ${upcomingHtml}${benchBadge}
  </div>`;
}

function updateBenchOrders() {
  const benchCards = document.querySelectorAll('#live-pitch .live-card.bench');
  benchCards.forEach((c, i) => {
    let badge = c.querySelector('.bench-order');
    if (!badge) {
      c.insertAdjacentHTML('beforeend', `<div class="bench-order">${i + 1}</div>`);
    } else {
      badge.textContent = i + 1;
    }
  });
  // Remove bench-order from non-bench cards
  document.querySelectorAll('#live-pitch .live-card:not(.bench) .bench-order').forEach(b => b.remove());
}

function initLiveDragDrop() {
  let draggedCard = null;
  const pitch = $('live-pitch');
  if (!pitch) return;

  // Touch drag support
  let touchStartX, touchStartY, touchClone, touchTarget;

  pitch.addEventListener('dragstart', e => {
    const card = e.target.closest('.live-card');
    if (!card || captainMode) { e.preventDefault(); return; }
    draggedCard = card;
    card.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
  });

  pitch.addEventListener('dragend', e => {
    if (draggedCard) draggedCard.classList.remove('dragging');
    draggedCard = null;
    pitch.querySelectorAll('.live-card').forEach(c => c.classList.remove('drag-over'));
  });

  pitch.addEventListener('dragover', e => {
    const card = e.target.closest('.live-card');
    if (!draggedCard || !card || draggedCard === card) return;

    const fromBench = draggedCard.dataset.isBench === 'true';
    const toBench = card.dataset.isBench === 'true';

    // Allow: bench<->starting, bench<->bench, starting<->starting
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    card.classList.add('drag-over');
  });

  pitch.addEventListener('dragleave', e => {
    const card = e.target.closest('.live-card');
    if (card) card.classList.remove('drag-over');
  });

  pitch.addEventListener('drop', e => {
    e.preventDefault();
    const card = e.target.closest('.live-card');
    if (!card) return;
    card.classList.remove('drag-over');
    if (!draggedCard || draggedCard === card) return;

    const fromBench = draggedCard.dataset.isBench === 'true';
    const toBench = card.dataset.isBench === 'true';

    // Swap the DOM positions
    const parentA = draggedCard.parentNode;
    const parentB = card.parentNode;
    const placeholderA = document.createElement('div');
    const placeholderB = document.createElement('div');
    parentA.insertBefore(placeholderA, draggedCard);
    parentB.insertBefore(placeholderB, card);
    parentB.insertBefore(draggedCard, placeholderB);
    parentA.insertBefore(card, placeholderA);
    placeholderA.remove();
    placeholderB.remove();

    // Update bench/starting status
    if (fromBench !== toBench) {
      if (fromBench) {
        draggedCard.classList.remove('bench');
        draggedCard.dataset.isBench = 'false';
        card.classList.add('bench');
        card.dataset.isBench = 'true';
      } else {
        card.classList.remove('bench');
        card.dataset.isBench = 'false';
        draggedCard.classList.add('bench');
        draggedCard.dataset.isBench = 'true';
      }
    }
    // If both bench, it's just a reorder (DOM positions already swapped)

    draggedCard = null;
    updateBenchOrders();
    validateFormation();
    saveLineup();
  });

  // --- Touch support for mobile ---
  pitch.addEventListener('touchstart', e => {
    const card = e.target.closest('.live-card');
    if (!card || captainMode) return;
    draggedCard = card;
    const touch = e.touches[0];
    touchStartX = touch.clientX;
    touchStartY = touch.clientY;
    touchClone = card.cloneNode(true);
    touchClone.style.cssText = 'position:fixed;z-index:9999;opacity:0.8;pointer-events:none;width:80px;';
    touchClone.style.left = (touch.clientX - 40) + 'px';
    touchClone.style.top = (touch.clientY - 40) + 'px';
    document.body.appendChild(touchClone);
    card.classList.add('dragging');
  }, { passive: true });

  pitch.addEventListener('touchmove', e => {
    if (!draggedCard || !touchClone) return;
    e.preventDefault();
    const touch = e.touches[0];
    touchClone.style.left = (touch.clientX - 40) + 'px';
    touchClone.style.top = (touch.clientY - 40) + 'px';
    // Highlight drop target
    pitch.querySelectorAll('.live-card').forEach(c => c.classList.remove('drag-over'));
    const el = document.elementFromPoint(touch.clientX, touch.clientY);
    const target = el ? el.closest('.live-card') : null;
    if (target && target !== draggedCard) target.classList.add('drag-over');
    touchTarget = target;
  }, { passive: false });

  pitch.addEventListener('touchend', e => {
    if (touchClone) { touchClone.remove(); touchClone = null; }
    if (!draggedCard) return;
    draggedCard.classList.remove('dragging');
    pitch.querySelectorAll('.live-card').forEach(c => c.classList.remove('drag-over'));

    if (touchTarget && touchTarget !== draggedCard) {
      const fromBench = draggedCard.dataset.isBench === 'true';
      const toBench = touchTarget.dataset.isBench === 'true';

      const parentA = draggedCard.parentNode;
      const parentB = touchTarget.parentNode;
      const placeholderA = document.createElement('div');
      const placeholderB = document.createElement('div');
      parentA.insertBefore(placeholderA, draggedCard);
      parentB.insertBefore(placeholderB, touchTarget);
      parentB.insertBefore(draggedCard, placeholderB);
      parentA.insertBefore(touchTarget, placeholderA);
      placeholderA.remove();
      placeholderB.remove();

      if (fromBench !== toBench) {
        if (fromBench) {
          draggedCard.classList.remove('bench');
          draggedCard.dataset.isBench = 'false';
          touchTarget.classList.add('bench');
          touchTarget.dataset.isBench = 'true';
        } else {
          touchTarget.classList.remove('bench');
          touchTarget.dataset.isBench = 'false';
          draggedCard.classList.add('bench');
          draggedCard.dataset.isBench = 'true';
        }
      }

      updateBenchOrders();
      validateFormation();
      saveLineup();
    }
    draggedCard = null;
    touchTarget = null;
  });
}

// ==================== FDR HEATMAP ====================
let fdrLoaded = false;
async function loadFDR() {
  if (fdrLoaded) return;
  const loader = $('fdr-loader');
  loader.classList.add('active');

  try {
    const resp = await fetch('/api/fdr?lookahead=8');
    const data = await resp.json();
    if (data.error) throw new Error(data.error);

    let html = '<table><thead><tr><th class="team-col">Team</th>';
    data.gw_ids.forEach(gw => { html += `<th>GW${gw}</th>`; });
    html += '</tr></thead><tbody>';

    data.rows.forEach(row => {
      html += `<tr><td class="team-col">${row.team_name}</td>`;
      row.gws.forEach(fxList => {
        if (fxList.length === 0) {
          html += '<td>-</td>';
        } else {
          const cells = fxList.map(fx => {
            const home = fx.is_home ? '<span class="fdr-home">(H)</span>' : '';
            return `<div class="fdr-cell fdr-${fx.difficulty}">${fx.opponent} ${home}</div>`;
          }).join('');
          html += `<td>${cells}</td>`;
        }
      });
      html += '</tr>';
    });
    html += '</tbody></table>';

    $('fdr-container').innerHTML = html;
    fdrLoaded = true;
  } catch (err) {
    $('fdr-container').innerHTML = `<div class="error-msg">${err.message}</div>`;
  } finally {
    loader.classList.remove('active');
  }
}

// ==================== CAPTAIN PICKS ====================
let captainLoaded = false;
async function loadCaptainPicks() {
  if (captainLoaded) return;
  const loader = $('captain-loader');
  loader.classList.add('active');

  try {
    const resp = await fetch('/api/captain-picks');
    const data = await resp.json();
    if (data.error) throw new Error(data.error);

    $('captain-body').innerHTML = data.picks.map((p, i) => `<tr${i === 0 ? ' style="background:#1a2a1a"' : ''}>
      <td>${i === 0 ? '<span style="color:#ffd700;font-weight:bold">1</span>' : i + 1}</td>
      <td><strong>${p.name}</strong></td>
      <td>${p.team_name}</td>
      <td class="pos">${p.position_name}</td>
      <td class="right">${p.form.toFixed(1)}</td>
      <td class="right">${p.points_per_game.toFixed(1)}</td>
      <td class="right">${p.xG.toFixed(2)}</td>
      <td class="right">${p.xA.toFixed(2)}</td>
      <td class="right"><span class="fdr-cell fdr-${Math.round((1 - p.fixture_difficulty) * 4) + 1}" style="padding:0.15rem 0.4rem;">${p.fixture_difficulty.toFixed(2)}</span></td>
      <td class="right score">${p.composite_score.toFixed(3)}</td>
    </tr>`).join('');
    $('captain-table').classList.remove('hidden');
    captainLoaded = true;
  } catch (err) {
    $('captain-table').parentElement.innerHTML += `<div class="error-msg">${err.message}</div>`;
  } finally {
    loader.classList.remove('active');
  }
}

// ==================== PRICE CHANGES ====================
let pricesLoaded = false;
async function loadPriceChanges() {
  if (pricesLoaded) return;
  const loader = $('prices-loader');
  loader.classList.add('active');

  try {
    const resp = await fetch('/api/price-changes');
    const data = await resp.json();
    if (data.error) throw new Error(data.error);

    $('risers-container').innerHTML = data.risers.map(p => priceCard(p, true)).join('');
    $('fallers-container').innerHTML = data.fallers.map(p => priceCard(p, false)).join('');
    pricesLoaded = true;
  } catch (err) {
    $('risers-container').innerHTML = `<div class="error-msg">${err.message}</div>`;
  } finally {
    loader.classList.remove('active');
  }
}

function priceCard(p, isRiser) {
  const net = p.net_transfers;
  const cls = net > 0 ? 'net-positive' : (net < 0 ? 'net-negative' : '');
  const changed = p.cost_change_event !== 0;
  return `<div class="price-card">
    <div class="player-info">
      <div class="player-name">${p.name}${changed ? ` <span style="font-size:0.75rem;color:${p.cost_change_event > 0 ? '#51cf66' : '#ff6b6b'}">(${p.cost_change_event > 0 ? '+' : ''}${(p.cost_change_event / 10).toFixed(1)})</span>` : ''}</div>
      <div class="player-meta">${p.team_name} &middot; ${p.position_name} &middot; ${p.cost.toFixed(1)}M &middot; ${p.selected_by_percent}%</div>
    </div>
    <div class="transfer-stat">
      <div class="${cls}" style="font-size:0.9rem;">${net > 0 ? '+' : ''}${net.toLocaleString()}</div>
      <div style="font-size:0.68rem;color:#888;">${isRiser ? `+${p.transfers_in.toLocaleString()} in` : `${p.transfers_out.toLocaleString()} out`}</div>
    </div>
  </div>`;
}

// ==================== DIFFERENTIALS ====================
let diffLoaded = false;
async function loadDifferentials() {
  const loader = $('diff-loader');
  loader.classList.add('active');
  $('diff-table').classList.add('hidden');
  diffLoaded = false;

  try {
    const own = $('diff-ownership').value;
    const resp = await fetch(`/api/differentials?max_ownership=${own}`);
    const data = await resp.json();
    if (data.error) throw new Error(data.error);

    $('diff-body').innerHTML = data.differentials.map((p, i) => `<tr>
      <td>${i + 1}</td>
      <td><strong>${p.name}</strong></td>
      <td>${p.team_name}</td>
      <td class="pos">${p.position_name}</td>
      <td class="right cost">${p.cost.toFixed(1)}</td>
      <td class="right">${p.total_points}</td>
      <td class="right">${p.form.toFixed(1)}</td>
      <td class="right">${p.points_per_game.toFixed(1)}</td>
      <td class="right" style="color:#4da6ff">${p.selected_by_percent}%</td>
      <td class="right score">${p.composite_score.toFixed(3)}</td>
    </tr>`).join('');
    $('diff-table').classList.remove('hidden');
    diffLoaded = true;
  } catch (err) {
    $('diff-table').parentElement.innerHTML += `<div class="error-msg">${err.message}</div>`;
  } finally {
    loader.classList.remove('active');
  }
}

// ==================== PLAYER COMPARISON ====================
function debouncedCompareSearch() {
  clearTimeout(compareTimer);
  compareTimer = setTimeout(compareSearch, 300);
}

async function compareSearch() {
  const q = $('compare-input').value.trim();
  if (q.length < 2) { $('compare-results').innerHTML = ''; return; }

  if (!allPlayersCache) {
    const resp = await fetch('/api/players?sort=total_points&dir=desc');
    const data = await resp.json();
    allPlayersCache = data.players;
  }

  const lower = q.toLowerCase();
  const matches = allPlayersCache.filter(p => p.name.toLowerCase().includes(lower)).slice(0, 8);
  $('compare-results').innerHTML = matches.map(p =>
    `<div class="compare-pick" onclick="addCompare(${p.id}, '${p.name.replace(/'/g, "\\'")}')">${p.name} <span style="color:#888;font-size:0.72rem;">${p.team_name} ${p.position_name}</span></div>`
  ).join('');
}

function addCompare(pid, name) {
  if (compareIds.length >= 3 || compareIds.includes(pid)) return;
  compareIds.push(pid);
  renderCompareChips();
  $('compare-input').value = '';
  $('compare-results').innerHTML = '';
  if (compareIds.length >= 2) runComparison();
}

function removeCompare(pid) {
  compareIds = compareIds.filter(id => id !== pid);
  renderCompareChips();
  if (compareIds.length >= 2) runComparison();
  else $('compare-output').innerHTML = '';
}

function renderCompareChips() {
  if (!allPlayersCache) return;
  $('compare-chips').innerHTML = compareIds.map(pid => {
    const p = allPlayersCache.find(pl => pl.id === pid);
    return `<div class="compare-chip">${p ? p.name : pid} <span class="remove" onclick="removeCompare(${pid})">&times;</span></div>`;
  }).join('');
}

async function runComparison() {
  try {
    const resp = await fetch('/api/compare', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ player_ids: compareIds }),
    });
    const data = await resp.json();
    if (!resp.ok || data.error) { $('compare-output').innerHTML = `<div class="error-msg">${data.error}</div>`; return; }

    const ps = data.players;
    const colors = ['#00ff87', '#4da6ff', '#ffd700'];

    const stats = ['form', 'points_per_game', 'xG', 'xA', 'ict_index', 'composite_score'];
    const labels = ['Form', 'PPG', 'xG', 'xA', 'ICT', 'Score'];
    const maxes = stats.map(s => Math.max(...ps.map(p => p[s])) || 1);

    let html = '<div class="compare-container">';
    html += `<canvas id="radar-canvas" width="280" height="280"></canvas>`;
    html += '<div class="compare-table"><div class="table-wrap"><table><thead><tr><th>Stat</th>';
    ps.forEach((p, i) => { html += `<th style="color:${colors[i]}">${p.name}</th>`; });
    html += '</tr></thead><tbody>';

    const rows = [
      ['Position', ps.map(p => p.position_name)],
      ['Team', ps.map(p => p.team_name)],
      ['Cost', ps.map(p => p.cost.toFixed(1) + 'M')],
      ['Total Pts', ps.map(p => String(p.total_points))],
      ['Form', ps.map(p => p.form.toFixed(1))],
      ['PPG', ps.map(p => p.points_per_game.toFixed(1))],
      ['xG', ps.map(p => p.xG.toFixed(2))],
      ['xA', ps.map(p => p.xA.toFixed(2))],
      ['Goals', ps.map(p => String(p.goals))],
      ['Assists', ps.map(p => String(p.assists))],
      ['ICT', ps.map(p => p.ict_index.toFixed(1))],
      ['Ownership', ps.map(p => p.selected_by_percent + '%')],
      ['Score', ps.map(p => p.composite_score.toFixed(3))],
    ];

    rows.forEach(([label, vals]) => {
      html += `<tr><td style="color:#888">${label}</td>`;
      vals.forEach(v => { html += `<td class="right">${v}</td>`; });
      html += '</tr>';
    });

    html += '</tbody></table></div></div></div>';
    $('compare-output').innerHTML = html;

    drawRadar(ps, stats, labels, maxes, colors);
  } catch (err) {
    $('compare-output').innerHTML = `<div class="error-msg">${err.message}</div>`;
  }
}

function drawRadar(players, stats, labels, maxes, colors) {
  const canvas = $('radar-canvas');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const cx = 140, cy = 140, r = 110;
  const n = stats.length;
  ctx.clearRect(0, 0, 280, 280);

  for (let ring = 1; ring <= 4; ring++) {
    ctx.beginPath();
    const rr = r * ring / 4;
    for (let i = 0; i <= n; i++) {
      const angle = (Math.PI * 2 * i / n) - Math.PI / 2;
      const x = cx + rr * Math.cos(angle);
      const y = cy + rr * Math.sin(angle);
      i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
    }
    ctx.strokeStyle = '#2a2f3e';
    ctx.stroke();
  }

  for (let i = 0; i < n; i++) {
    const angle = (Math.PI * 2 * i / n) - Math.PI / 2;
    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.lineTo(cx + r * Math.cos(angle), cy + r * Math.sin(angle));
    ctx.strokeStyle = '#2a2f3e';
    ctx.stroke();

    const lx = cx + (r + 15) * Math.cos(angle);
    const ly = cy + (r + 15) * Math.sin(angle);
    ctx.fillStyle = '#888';
    ctx.font = '10px sans-serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(labels[i], lx, ly);
  }

  players.forEach((p, pi) => {
    ctx.beginPath();
    for (let i = 0; i <= n; i++) {
      const si = i % n;
      const val = maxes[si] > 0 ? p[stats[si]] / maxes[si] : 0;
      const angle = (Math.PI * 2 * si / n) - Math.PI / 2;
      const x = cx + r * val * Math.cos(angle);
      const y = cy + r * val * Math.sin(angle);
      i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
    }
    ctx.closePath();
    ctx.strokeStyle = colors[pi];
    ctx.lineWidth = 2;
    ctx.stroke();
    ctx.fillStyle = colors[pi] + '22';
    ctx.fill();
  });
}

// ==================== RIVAL COMPARISON ====================
async function loadRival(rank, name, event) {
  event.stopPropagation();
  if (!loadedUserId) return;

  const rivalId = prompt(`Enter FPL User ID for "${name}" to compare squads:`);
  if (!rivalId) return;
  const rid = parseInt(rivalId);
  if (isNaN(rid)) return;

  // Switch to rival panel
  switchNav('nav-leagues-rival');
  $('rival-output').innerHTML = '<div class="loader active"><div class="spinner"></div><div class="loader-text">Loading rival comparison...</div></div>';

  try {
    const resp = await fetch(`/api/rival/${rid}?user_id=${loadedUserId}`);
    const data = await resp.json();
    if (!resp.ok) { $('rival-output').innerHTML = `<div class="error-msg">${data.error}</div>`; return; }

    renderRivalOutput(data);
  } catch (err) {
    $('rival-output').innerHTML = `<div class="error-msg">${err.message}</div>`;
  }
}

async function loadRivalDirect() {
  if (!loadedUserId) {
    $('rival-output').innerHTML = '<div class="error-msg">Load your FPL ID in Settings first.</div>';
    return;
  }
  const rivalId = $('rival-id-input').value.trim();
  if (!rivalId) return;
  const rid = parseInt(rivalId);
  if (isNaN(rid)) return;

  $('rival-output').innerHTML = '<div class="loader active"><div class="spinner"></div><div class="loader-text">Loading rival comparison...</div></div>';

  try {
    const resp = await fetch(`/api/rival/${rid}?user_id=${loadedUserId}`);
    const data = await resp.json();
    if (!resp.ok) { $('rival-output').innerHTML = `<div class="error-msg">${data.error}</div>`; return; }

    renderRivalOutput(data);
  } catch (err) {
    $('rival-output').innerHTML = `<div class="error-msg">${err.message}</div>`;
  }
}

function renderRivalOutput(data) {
  let html = '<div class="section-title blue">Squad Comparison</div>';
  html += '<div class="stat-row">';
  html += `<div class="stat-card"><div class="label">${data.my_manager}</div><div class="value blue">${data.my_total_points}</div></div>`;
  html += `<div class="stat-card"><div class="label">${data.rival_manager}</div><div class="value" style="color:#ffd700">${data.rival_total_points}</div></div>`;
  html += `<div class="stat-card"><div class="label">Shared</div><div class="value">${data.shared.length}</div></div>`;
  html += '</div>';

  html += '<div class="rival-cols">';
  html += '<div class="rival-col"><div class="rival-header" style="color:#4da6ff">Only in My Team</div>';
  data.only_mine.forEach(p => { html += `<div class="rival-player"><span>${p.name} <span class="pos">${p.position_name}</span></span><span class="cost">${p.cost.toFixed(1)}</span></div>`; });
  html += '</div>';
  html += '<div class="rival-col"><div class="rival-header" style="color:#ffd700">Only in Rival\'s Team</div>';
  data.only_rival.forEach(p => { html += `<div class="rival-player"><span>${p.name} <span class="pos">${p.position_name}</span></span><span class="cost">${p.cost.toFixed(1)}</span></div>`; });
  html += '</div></div>';

  if (data.shared.length > 0) {
    html += '<div class="shared-list"><div class="shared-header">Shared Players</div>';
    data.shared.forEach(p => { html += `<div class="rival-player"><span>${p.name} <span class="pos">${p.position_name}</span></span><span class="score">${p.total_points}pts</span></div>`; });
    html += '</div>';
  }

  $('rival-output').innerHTML = html;
}

// ==================== PLAYERS TAB ====================
function debouncedLoadPlayers() {
  clearTimeout(debounceTimer);
  debounceTimer = setTimeout(loadPlayers, 300);
}

function loadPlayers() {
  const loader = $('players-loader');
  const table = $('players-table');
  loader.classList.add('active');
  table.classList.add('hidden');

  const params = new URLSearchParams();
  const search = $('player-search').value.trim();
  const pos = $('player-pos-filter').value;
  const team = $('player-team-filter').value;
  if (search) params.set('search', search);
  if (pos) params.set('position', pos);
  if (team) params.set('team', team);
  params.set('sort', playersSort.col);
  params.set('dir', playersSort.dir);

  fetch('/api/players?' + params.toString())
    .then(r => r.json())
    .then(data => {
      if (data.error) throw new Error(data.error);
      $('players-body').innerHTML = data.players.map(p => `<tr>
        <td class="score">${p.total_points}</td>
        <td class="pos">${p.position_name}</td>
        <td>${p.name}</td>
        <td>${p.team_name}</td>
        <td class="right cost">${p.cost.toFixed(1)}</td>
        <td class="right">${p.form.toFixed(1)}</td>
        <td class="right">${p.points_per_game.toFixed(1)}</td>
        <td class="right">${p.xG.toFixed(1)}</td>
        <td class="right">${p.xA.toFixed(1)}</td>
        <td class="right">${p.ict_index.toFixed(1)}</td>
        <td class="right">${p.minutes}</td>
      </tr>`).join('');
      table.classList.remove('hidden');
      playersLoaded = true;
    })
    .catch(err => {
      $('players-body').innerHTML = `<tr><td colspan="11" style="text-align:center;color:#ff6b6b">${err.message}</td></tr>`;
      table.classList.remove('hidden');
    })
    .finally(() => loader.classList.remove('active'));
}

function sortPlayers(th) {
  const col = th.dataset.sort;
  if (playersSort.col === col) playersSort.dir = playersSort.dir === 'desc' ? 'asc' : 'desc';
  else { playersSort.col = col; playersSort.dir = col === 'name' ? 'asc' : 'desc'; }
  document.querySelectorAll('#players-table th.sortable').forEach(h => h.classList.remove('sort-asc', 'sort-desc'));
  th.classList.add(playersSort.dir === 'asc' ? 'sort-asc' : 'sort-desc');
  loadPlayers();
}

// ==================== FIXTURES TAB ====================
function loadFixtures() {
  const loader = $('fixtures-loader');
  loader.classList.add('active');
  $('fixtures-container').innerHTML = '';

  fetch('/api/fixtures').then(r => r.json()).then(data => {
    if (data.error) throw new Error(data.error);
    fixturesData = data.gameweeks;
    const sel = $('gw-filter');
    sel.innerHTML = '<option value="current">Current / Next</option>';
    fixturesData.forEach(gw => {
      const opt = document.createElement('option');
      opt.value = gw.gameweek;
      let label = gw.name;
      if (gw.is_current) label += ' (Current)';
      else if (gw.is_next) label += ' (Next)';
      else if (gw.finished) label += ' (Finished)';
      opt.textContent = label;
      sel.appendChild(opt);
    });
    fixturesLoaded = true;
    renderFixtures();
  }).catch(err => {
    $('fixtures-container').innerHTML = `<div class="error-msg">${err.message}</div>`;
  }).finally(() => loader.classList.remove('active'));
}

function diffBadge(diff, extra) {
  return `<span class="difficulty diff-${diff} ${extra || ''}">${diff}</span>`;
}

function renderFixtures() {
  if (!fixturesData) return;
  const filter = $('gw-filter').value;
  const container = $('fixtures-container');

  let gwsToShow;
  if (filter === 'current') {
    gwsToShow = fixturesData.filter(gw => gw.is_current || gw.is_next);
    if (!gwsToShow.length) gwsToShow = fixturesData.filter(gw => !gw.finished).slice(0, 1);
  } else {
    gwsToShow = fixturesData.filter(gw => gw.gameweek === parseInt(filter));
  }

  if (!gwsToShow.length) { container.innerHTML = '<p style="color:#888;text-align:center;padding:2rem;">No fixtures.</p>'; return; }

  let html = '';
  for (const gw of gwsToShow) {
    let badge = gw.is_current ? '<span class="gw-badge current">Current</span>' : gw.is_next ? '<span class="gw-badge next">Next</span>' : gw.finished ? '<span class="gw-badge finished">Finished</span>' : '';
    html += `<div class="gw-header">${gw.name}${badge}</div>`;
    for (const f of gw.fixtures) {
      const mid = f.finished && f.home_score !== null
        ? `<div class="fixture-score">${f.home_score} - ${f.away_score}</div>`
        : '<div class="fixture-vs">vs</div>';
      html += `<div class="fixture-card">
        <div class="fixture-team home">${f.home_team_name} ${diffBadge(f.home_difficulty)}</div>
        ${mid}
        <div class="fixture-team away">${diffBadge(f.away_difficulty, 'away-badge')} ${f.away_team_name}</div>
      </div>`;
    }
  }
  container.innerHTML = html;
}

// ==================== OPTIMIZER ====================
$('budget').addEventListener('input', e => {
  $('budget-display').textContent = parseFloat(e.target.value).toFixed(1);
});

function switchTab(tab) {
  document.querySelectorAll('#tab-bar .tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('#nav-transfers-optimizer .tab-content').forEach(t => t.classList.remove('active'));
  document.querySelector(`#tab-bar .tab[data-tab="${tab}"]`).classList.add('active');
  $('tab-' + tab).classList.add('active');
}

function teamName(id) { const t = teamsMap[id]; return t ? t.short_name : id; }

function playerRow(p, full) {
  if (full) return `<tr><td class="pos">${p.position_name}</td><td>${p.name}</td><td>${teamName(p.team)}</td><td class="right cost">${p.cost.toFixed(1)}</td><td class="right">${p.form.toFixed(1)}</td><td class="right">${p.points_per_game.toFixed(1)}</td><td class="right">${p.xG.toFixed(1)}</td><td class="right">${p.xA.toFixed(1)}</td><td class="right score">${p.composite_score.toFixed(3)}</td></tr>`;
  return `<tr><td class="pos">${p.position_name}</td><td>${p.name}</td><td>${teamName(p.team)}</td><td class="right cost">${p.cost.toFixed(1)}</td><td class="right score">${p.composite_score.toFixed(3)}</td></tr>`;
}

function transferRow(t, i) {
  return `<tr><td>${i+1}</td><td class="out">${t.player_out.name} (${t.player_out.cost.toFixed(1)})</td><td class="in">${t.player_in.name} (${t.player_in.cost.toFixed(1)})</td><td class="right score">+${t.score_gain.toFixed(3)}</td><td class="right">${t.cost_change >= 0 ? '+' : ''}${t.cost_change.toFixed(1)}</td></tr>`;
}

function renderSummary(el, sq) {
  el.innerHTML = `<div class="stat-card"><div class="label">Cost</div><div class="value">${sq.total_cost.toFixed(1)}M</div></div>
    <div class="stat-card"><div class="label">Remaining</div><div class="value">${sq.budget_remaining.toFixed(1)}M</div></div>
    <div class="stat-card"><div class="label">Score</div><div class="value">${sq.total_score.toFixed(3)}</div></div>`;
}

function renderSquad(sEl, bEl, sq) {
  sEl.innerHTML = sq.starting.map(p => playerRow(p, true)).join('');
  bEl.innerHTML = sq.bench.map(p => playerRow(p, false)).join('');
}

function renderTransfers(sec, body, tf) {
  if (tf && tf.length > 0) { sec.classList.remove('hidden'); body.innerHTML = tf.map((t,i) => transferRow(t,i)).join(''); }
  else sec.classList.add('hidden');
}

async function runOptimizer() {
  const btn = $('run-btn');
  const loader = $('loader');
  const results = $('results');
  const errorEl = $('error');
  const userId = loadedUserId ? String(loadedUserId) : $('user-id').value.trim();

  btn.disabled = true;
  loader.classList.add('active');
  results.classList.add('hidden');
  errorEl.innerHTML = '';

  try {
    const resp = await fetch('/api/optimize', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ budget: parseFloat($('budget').value), lookahead: parseInt($('lookahead').value), user_id: userId || null }),
    });
    const data = await resp.json();
    if (!resp.ok) { errorEl.innerHTML = `<div class="error-msg">${data.error || 'Error'}</div>`; return; }

    for (const [tid, t] of Object.entries(data.teams)) teamsMap[tid] = t;

    renderSummary($('summary'), data.squad);
    renderSquad($('starting-body'), $('bench-body'), data.squad);

    // Render transfers in optimizer panel and suggestions panel
    if (data.transfers && data.transfers.length > 0) {
      $('transfers-body').innerHTML = data.transfers.map((t,i) => transferRow(t,i)).join('');
      $('suggestions-content').classList.remove('hidden');
      $('suggestions-no-data').classList.add('hidden');
    }

    // Handle My Team tab in optimizer
    const myTeamTab = document.querySelector('#tab-bar .tab[data-tab="my-team"]');
    if (data.user_team && !data.user_team.error) {
      if (!myTeamTab) {
        const tab = document.createElement('div');
        tab.className = 'tab user-tab';
        tab.dataset.tab = 'my-team';
        tab.onclick = () => switchTab('my-team');
        tab.textContent = 'My Team';
        $('tab-bar').insertBefore(tab, document.querySelector('#tab-bar .tab[data-tab="top-players"]'));
      }

      // Also populate the dedicated My Team panel
      renderSummary($('user-summary'), data.user_team.squad);
      renderSquad($('user-starting-body'), $('user-bench-body'), data.user_team.squad);
      renderTransfers($('user-transfers-section'), $('user-transfers-body'), data.user_team.transfers);
      $('myteam-content').classList.remove('hidden');
      $('myteam-no-data').classList.add('hidden');
    } else if (myTeamTab) myTeamTab.remove();

    const tpc = $('top-players-container');
    tpc.innerHTML = '';
    for (const [posName, players] of Object.entries(data.top_by_position)) {
      tpc.innerHTML += `<div class="section"><div class="section-title">Top 10 ${posName}</div><div class="table-wrap"><table>
        <thead><tr><th>#</th><th>Player</th><th>Team</th><th class="right">Cost</th><th class="right">Form</th><th class="right">xG</th><th class="right">xA</th><th class="right">Score</th></tr></thead>
        <tbody>${players.map((p,i) => `<tr><td>${i+1}</td><td>${p.name}</td><td>${teamName(p.team)}</td><td class="right cost">${p.cost.toFixed(1)}</td><td class="right">${p.form.toFixed(1)}</td><td class="right">${p.xG.toFixed(1)}</td><td class="right">${p.xA.toFixed(1)}</td><td class="right score">${p.composite_score.toFixed(3)}</td></tr>`).join('')}</tbody>
        </table></div></div>`;
    }

    results.classList.remove('hidden');
    switchTab('optimal');
  } catch (err) {
    errorEl.innerHTML = `<div class="error-msg">Network error: ${err.message}</div>`;
  } finally {
    btn.disabled = false;
    loader.classList.remove('active');
  }
}

// ==================== TRANSFER PLANNER ====================
let tpData = null;  // raw API data
let tpTransfers = [];  // [{out: playerObj, in: playerObj}]
let tpSellingPlayer = null;  // player being sold (awaiting replacement pick)
let tpLoaded = false;

async function loadTransferPlanner() {
  if (!loadedUserId) { $('tp-no-user').classList.remove('hidden'); $('tp-content').classList.add('hidden'); return; }
  $('tp-no-user').classList.add('hidden');

  if (tpLoaded) { $('tp-content').classList.remove('hidden'); return; }

  const loader = $('tp-loader');
  loader.classList.add('active');
  $('tp-content').classList.add('hidden');

  try {
    const resp = await fetch(`/api/transfer-planner/${loadedUserId}`);
    const data = await resp.json();
    if (!resp.ok) { $('tp-content').innerHTML = `<div class="error-msg">${data.error}</div>`; $('tp-content').classList.remove('hidden'); return; }

    tpData = data;
    tpTransfers = [];
    tpSellingPlayer = null;
    renderTransferPlanner();
    $('tp-content').classList.remove('hidden');
    tpLoaded = true;
  } catch (err) {
    $('tp-content').innerHTML = `<div class="error-msg">Failed: ${err.message}</div>`;
    $('tp-content').classList.remove('hidden');
  } finally {
    loader.classList.remove('active');
  }
}

function renderTransferPlanner() {
  if (!tpData) return;

  const freeTransfers = tpData.free_transfers || 1;
  const numTransfers = tpTransfers.length;
  const hits = Math.max(0, numTransfers - freeTransfers) * 4;

  // Calculate budget
  let sellingTotal = 0;
  let buyingTotal = 0;
  tpTransfers.forEach(t => {
    sellingTotal += t.out.selling_price || t.out.cost;
    buyingTotal += t.in.cost;
  });
  const bank = tpData.bank;
  const remaining = bank + sellingTotal - buyingTotal;

  $('tp-bank').textContent = bank.toFixed(1) + 'M';
  $('tp-selling').textContent = sellingTotal.toFixed(1) + 'M';
  $('tp-buying').textContent = buyingTotal.toFixed(1) + 'M';
  $('tp-remaining').textContent = remaining.toFixed(1) + 'M';
  $('tp-remaining').style.color = remaining < 0 ? '#ff6b6b' : '#ffd700';
  $('tp-hits').textContent = hits > 0 ? `-${hits}` : '0';
  $('tp-hits').style.color = hits > 0 ? '#ff6b6b' : '#00ff87';
  $('tp-free-label').textContent = `Free transfers: ${freeTransfers} | Used: ${numTransfers}`;

  // Enable/disable confirm button
  $('tp-confirm-btn').disabled = tpTransfers.length === 0 || remaining < 0;

  // Render transfer summary
  if (tpTransfers.length > 0) {
    $('tp-transfer-summary').innerHTML = tpTransfers.map((t, i) => `
      <div class="tp-transfer-item">
        <span class="out">${t.out.name} (${(t.out.selling_price || t.out.cost).toFixed(1)}M)</span>
        <span class="tp-arrow">&#8594;</span>
        <span class="in">${t.in.name} (${t.in.cost.toFixed(1)}M)</span>
        <span style="margin-left:auto;cursor:pointer;color:#ff6b6b;font-size:0.9rem;" onclick="undoTransfer(${i})" title="Remove">&times;</span>
      </div>
    `).join('');
  } else {
    $('tp-transfer-summary').innerHTML = '';
  }

  // Build current squad view (original minus sold, plus bought)
  const soldIds = new Set(tpTransfers.map(t => t.out.id));
  const boughtPlayers = tpTransfers.map(t => t.in);

  // Group by position
  const posOrder = [1, 2, 3, 4];
  const posNames = {1: 'GK', 2: 'DEF', 3: 'MID', 4: 'FWD'};

  let squadHtml = '';
  for (const pos of posOrder) {
    const origPlayers = tpData.squad.filter(p => p.position === pos);
    const newPlayers = boughtPlayers.filter(p => p.position === pos);

    squadHtml += `<div style="font-size:0.7rem;color:#888;text-transform:uppercase;padding:0.3rem 0.6rem;margin-top:0.3rem;">${posNames[pos]}</div>`;

    for (const p of origPlayers) {
      const isSold = soldIds.has(p.id);
      const photoUrl = p.photo ? `${PHOTO_BASE}${p.photo}.png` : '';
      const photoHtml = photoUrl
        ? `<img src="${photoUrl}" onerror="this.parentElement.innerHTML='&#9917;'" style="width:100%;height:100%;object-fit:cover;object-position:top;">`
        : '&#9917;';

      let priceIndicator = '';
      if (p.cost_change_event && p.cost_change_event > 0) priceIndicator = '<span class="tp-price-indicator tp-price-up">&#9650;</span>';
      else if (p.cost_change_event && p.cost_change_event < 0) priceIndicator = '<span class="tp-price-indicator tp-price-down">&#9660;</span>';

      let injuryFlag = '';
      if (p.news || (p.chance_of_playing !== null && p.chance_of_playing !== undefined && p.chance_of_playing < 100)) {
        const cop = p.chance_of_playing;
        const color = (cop !== null && cop !== undefined && cop <= 25) ? '#ff6b6b' : '#ffaa00';
        injuryFlag = `<span style="color:${color};font-size:0.65rem;font-weight:bold;" title="${p.news || cop + '% chance'}">!</span>`;
      }

      const btn = isSold
        ? `<button class="tp-undo-btn" onclick="undoSell(${p.id})">Undo</button>`
        : `<button class="tp-sell-btn" onclick="startSell(${p.id})">Sell</button>`;

      squadHtml += `<div class="tp-player${isSold ? ' tp-sold' : ''}">
        <div class="tp-photo">${photoHtml}</div>
        <div class="tp-info">
          <div class="tp-name">${p.name} ${injuryFlag} ${priceIndicator}</div>
          <div class="tp-meta">${p.team_name} &middot; ${p.cost.toFixed(1)}M &middot; ${p.selected_by_percent}% own &middot; Form: ${p.form}</div>
        </div>
        <div class="tp-stats">
          <span class="score">${p.composite_score}</span>
        </div>
        ${btn}
      </div>`;
    }

    // Show bought players for this position
    for (const p of newPlayers) {
      squadHtml += `<div class="tp-player tp-new">
        <div class="tp-photo">${p.photo ? `<img src="${PHOTO_BASE}${p.photo}.png" onerror="this.parentElement.innerHTML='&#9917;'" style="width:100%;height:100%;object-fit:cover;object-position:top;">` : '&#9917;'}</div>
        <div class="tp-info">
          <div class="tp-name">${p.name} <span style="color:#51cf66;font-size:0.65rem;">NEW</span></div>
          <div class="tp-meta">${p.team_name} &middot; ${p.cost.toFixed(1)}M &middot; ${p.selected_by_percent}% own &middot; Form: ${p.form}</div>
        </div>
        <div class="tp-stats"><span class="score">${p.composite_score}</span></div>
      </div>`;
    }
  }
  $('tp-squad').innerHTML = squadHtml;

  // Intelligence rail
  renderTransferIntel();
}

function renderTransferIntel() {
  if (!tpData) return;

  // Most transferred in
  $('tp-intel-in').innerHTML = tpData.most_transferred_in.map(p => {
    let priceInd = '';
    if (p.cost_change_event > 0) priceInd = '<span class="tp-price-indicator tp-price-up">&#9650;</span>';
    return `<div class="tp-intel-item">
      <span class="tp-intel-name">${p.name} ${priceInd}</span>
      <span class="tp-intel-val" style="color:#51cf66">+${p.transfers_in_event.toLocaleString()}</span>
    </div>`;
  }).join('');

  // Most transferred out
  $('tp-intel-out').innerHTML = tpData.most_transferred_out.map(p => {
    let priceInd = '';
    if (p.cost_change_event < 0) priceInd = '<span class="tp-price-indicator tp-price-down">&#9660;</span>';
    return `<div class="tp-intel-item">
      <span class="tp-intel-name">${p.name} ${priceInd}</span>
      <span class="tp-intel-val" style="color:#ff6b6b">${p.transfers_out_event.toLocaleString()}</span>
    </div>`;
  }).join('');

  // Form ranking of current squad
  const soldIds = new Set(tpTransfers.map(t => t.out.id));
  const currentSquad = [...tpData.squad.filter(p => !soldIds.has(p.id)), ...tpTransfers.map(t => t.in)];
  const byForm = [...currentSquad].sort((a, b) => b.form - a.form);
  $('tp-intel-form').innerHTML = byForm.map(p => {
    const isNew = tpTransfers.some(t => t.in.id === p.id);
    return `<div class="tp-intel-item">
      <span class="tp-intel-name">${p.name}${isNew ? ' <span style="color:#51cf66;font-size:0.6rem;">NEW</span>' : ''}</span>
      <span class="tp-intel-val" style="color:#4da6ff">${p.form}</span>
    </div>`;
  }).join('');
}

function startSell(playerId) {
  const player = tpData.squad.find(p => p.id === playerId);
  if (!player) return;

  // Check if already sold
  if (tpTransfers.some(t => t.out.id === playerId)) return;

  tpSellingPlayer = player;
  const posName = player.position_name;

  $('tp-rp-label').textContent = `Replace ${player.name} (${posName} - ${player.cost.toFixed(1)}M)`;
  $('tp-rp-search').value = '';

  const panel = $('tp-replacement-panel');
  panel.classList.add('active');

  filterReplacements();
  panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function filterReplacements() {
  if (!tpSellingPlayer || !tpData) return;

  const pos = tpSellingPlayer.position_name;
  let candidates = tpData.replacements[pos] || [];

  // Exclude already-bought players and current squad
  const squadIds = new Set(tpData.squad.map(p => p.id));
  const boughtIds = new Set(tpTransfers.map(t => t.in.id));
  candidates = candidates.filter(p => !squadIds.has(p.id) && !boughtIds.has(p.id));

  // Search filter
  const search = ($('tp-rp-search').value || '').trim().toLowerCase();
  if (search) {
    candidates = candidates.filter(p => p.name.toLowerCase().includes(search) || p.team_name.toLowerCase().includes(search));
  }

  // Sort
  const sortBy = $('tp-rp-sort').value;
  if (sortBy === 'cost') {
    candidates.sort((a, b) => a.cost - b.cost);
  } else {
    candidates.sort((a, b) => (b[sortBy] || 0) - (a[sortBy] || 0));
  }

  // Calculate available budget for this position
  const bank = tpData.bank;
  let sellingTotal = (tpSellingPlayer.selling_price || tpSellingPlayer.cost);
  tpTransfers.forEach(t => {
    sellingTotal += (t.out.selling_price || t.out.cost);
    sellingTotal -= t.in.cost;
  });
  const maxBudget = bank + sellingTotal;

  // Store candidates for click handler
  window._tpCandidates = candidates;

  $('tp-rp-list').innerHTML = candidates.map((p, idx) => {
    const affordable = p.cost <= maxBudget;
    let priceInd = '';
    if (p.cost_change_event > 0) priceInd = '<span class="tp-price-indicator tp-price-up" style="margin-left:0.3rem;">&#9650;</span>';
    else if (p.cost_change_event < 0) priceInd = '<span class="tp-price-indicator tp-price-down" style="margin-left:0.3rem;">&#9660;</span>';

    const netTransfers = p.transfers_in_event - p.transfers_out_event;
    const netColor = netTransfers > 0 ? '#51cf66' : netTransfers < 0 ? '#ff6b6b' : '#888';

    return `<div class="tp-buy-row" style="${affordable ? '' : 'opacity:0.4;'}">
      <span class="tp-buy-name">${p.name}${priceInd}</span>
      <span class="tp-buy-meta">${p.team_name} &middot; <span class="cost">${p.cost.toFixed(1)}M</span> &middot; ${p.selected_by_percent}% &middot; F:${p.form} &middot; <span style="color:${netColor}">${netTransfers > 0 ? '+' : ''}${netTransfers.toLocaleString()}</span></span>
      <span style="color:#00ff87;font-size:0.72rem;font-weight:600;min-width:35px;text-align:right;">${p.composite_score}</span>
      ${affordable ? `<button class="tp-buy-btn" onclick="buyPlayerByIdx(${idx})">Buy</button>` : '<span style="color:#ff6b6b;font-size:0.68rem;">$$</span>'}
    </div>`;
  }).join('');
}

function buyPlayerByIdx(idx) {
  if (!window._tpCandidates || !window._tpCandidates[idx]) return;
  buyPlayer(window._tpCandidates[idx]);
}

function buyPlayer(player) {
  if (!tpSellingPlayer) return;

  tpTransfers.push({
    out: tpSellingPlayer,
    in: player,
  });

  tpSellingPlayer = null;
  closeReplacementPanel();
  renderTransferPlanner();
}

function closeReplacementPanel() {
  $('tp-replacement-panel').classList.remove('active');
  tpSellingPlayer = null;
}

function undoSell(playerId) {
  tpTransfers = tpTransfers.filter(t => t.out.id !== playerId);
  renderTransferPlanner();
}

function undoTransfer(index) {
  tpTransfers.splice(index, 1);
  renderTransferPlanner();
}

function resetTransfers() {
  tpTransfers = [];
  tpSellingPlayer = null;
  closeReplacementPanel();
  renderTransferPlanner();
}

function showTransferModal() {
  if (tpTransfers.length === 0) return;

  const freeTransfers = tpData.free_transfers || 1;
  const hits = Math.max(0, tpTransfers.length - freeTransfers) * 4;
  let sellingTotal = 0, buyingTotal = 0;
  tpTransfers.forEach(t => {
    sellingTotal += t.out.selling_price || t.out.cost;
    buyingTotal += t.in.cost;
  });
  const remaining = tpData.bank + sellingTotal - buyingTotal;

  $('tp-modal-transfers').innerHTML = tpTransfers.map(t => `
    <div class="tp-transfer-item">
      <span class="out">${t.out.name} (${(t.out.selling_price || t.out.cost).toFixed(1)}M)</span>
      <span class="tp-arrow">&#8594;</span>
      <span class="in">${t.in.name} (${t.in.cost.toFixed(1)}M)</span>
    </div>
  `).join('');

  $('tp-modal-cost').innerHTML = `
    <div class="tp-modal-row"><span>Bank before</span><span>${tpData.bank.toFixed(1)}M</span></div>
    <div class="tp-modal-row"><span>Total selling</span><span style="color:#51cf66">+${sellingTotal.toFixed(1)}M</span></div>
    <div class="tp-modal-row"><span>Total buying</span><span style="color:#ff6b6b">-${buyingTotal.toFixed(1)}M</span></div>
    ${hits > 0 ? `<div class="tp-modal-row"><span>Transfer hits</span><span style="color:#ff6b6b">-${hits} pts</span></div>` : ''}
    <div class="tp-modal-row total"><span>Bank after</span><span style="color:#ffd700">${remaining.toFixed(1)}M</span></div>
  `;

  $('tp-modal-overlay').classList.add('active');
}

function closeTransferModal() {
  $('tp-modal-overlay').classList.remove('active');
}

function confirmTransfers() {
  // This is a planning tool - save to localStorage for reference
  const plan = tpTransfers.map(t => ({
    out: { id: t.out.id, name: t.out.name, cost: t.out.selling_price || t.out.cost },
    in: { id: t.in.id, name: t.in.name, cost: t.in.cost },
  }));
  localStorage.setItem(`fpl_transfer_plan_${loadedUserId}`, JSON.stringify(plan));
  closeTransferModal();

  // Show confirmation message
  $('tp-transfer-summary').innerHTML += `<div style="color:#51cf66;font-size:0.82rem;margin-top:0.5rem;padding:0.5rem;background:#1a2a1a;border-radius:6px;">Transfer plan saved! Go to the FPL website to make these transfers.</div>`;
}
</script>
</body>
</html>
