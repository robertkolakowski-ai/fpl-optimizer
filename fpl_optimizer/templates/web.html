<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FPL Optimizer</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;600;700&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background: #0D1B2A; color: #F0F0F0; min-height: 100vh; overflow-x: hidden; }

  /* ==================== BRAND TYPOGRAPHY ==================== */
  h1, h2, h3, .sidebar-brand h1, .section-title, .dash-section-title, .dc-title, .dash-stat .ds-label,
  .gw-header { font-family: 'Space Grotesk', sans-serif; }
  .stat-card .value, .ds-value, .lp-pts, .price-value, td .monospace,
  .stat-card .value.blue, .pt-value, .captain-2x { font-family: 'JetBrains Mono', monospace; }
  td { font-variant-numeric: tabular-nums; }

  /* ==================== APP SHELL ==================== */
  .app-shell { display: flex; min-height: 100vh; }

  /* Sidebar */
  .sidebar { width: 260px; background: linear-gradient(180deg, #0D1B2A 0%, #1B2D45 100%); border-right: 1px solid rgba(255,255,255,0.08); position: fixed; top: 0; left: 0; bottom: 0; z-index: 200; display: flex; flex-direction: column; overflow-y: auto; transition: transform 0.25s ease; }
  .sidebar-brand { padding: 1.2rem 1.2rem 0.8rem; border-bottom: 1px solid rgba(255,255,255,0.08); background: linear-gradient(135deg, rgba(0,230,118,0.03), transparent); }
  .sidebar-brand h1 { font-family: 'Space Grotesk', sans-serif; color: #00E676; font-size: 1.3rem; margin-bottom: 0.1rem; text-shadow: 0 0 20px rgba(0,230,118,0.15); }
  .sidebar-brand .subtitle { color: #667788; font-size: 0.72rem; }

  /* ==================== LOGO MONOGRAM ==================== */
  .logo-monogram { display: flex; align-items: center; gap: 0.15rem; }
  .logo-fpl { font-family: 'Space Grotesk', sans-serif; font-weight: 700; color: #F0F0F0; font-size: 1.45rem; letter-spacing: -0.5px; line-height: 1; }
  .logo-o { width: 32px; height: 32px; flex-shrink: 0; filter: drop-shadow(0 0 6px rgba(0,230,118,0.25)); }
  .logo-sub { font-family: 'Space Grotesk', sans-serif; font-weight: 500; color: #8899AA; font-size: 1.1rem; letter-spacing: -0.3px; line-height: 1; margin-left: -0.1rem; }
  .mobile-topbar .logo-monogram { gap: 0.1rem; }
  .mobile-topbar .logo-fpl { font-size: 1.15rem; }
  .mobile-topbar .logo-o { width: 24px; height: 24px; }
  .mobile-topbar .logo-sub { font-size: 0.88rem; }

  .sidebar-nav { flex: 1; padding: 0.6rem 0; }
  .sidebar-item { display: flex; align-items: center; gap: 0.7rem; padding: 0.6rem 1.2rem; color: #8899AA; font-size: 0.88rem; cursor: pointer; transition: all 0.15s; border-left: 3px solid transparent; user-select: none; }
  .sidebar-item:hover { color: #F0F0F0; background: rgba(255,255,255,0.03); }
  .sidebar-item.active { color: #00E676; border-left-color: #00E676; background: rgba(0,230,118,0.05); }
  .sidebar-item .si-icon { font-size: 1.1rem; width: 1.4rem; text-align: center; flex-shrink: 0; }
  .sidebar-item .si-label { flex: 1; }
  .sidebar-item .si-arrow { font-size: 0.65rem; transition: transform 0.2s; }
  .sidebar-item .si-arrow.open { transform: rotate(90deg); }

  .sidebar-sub { overflow: hidden; max-height: 0; transition: max-height 0.25s ease; }
  .sidebar-sub.open { max-height: 300px; }
  .sidebar-sub-item { display: block; padding: 0.45rem 1.2rem 0.45rem 3.3rem; color: #666; font-size: 0.82rem; cursor: pointer; transition: all 0.15s; border-left: 3px solid transparent; }
  .sidebar-sub-item:hover { color: #F0F0F0; background: rgba(255,255,255,0.02); }
  .sidebar-sub-item.active { color: #00E676; border-left-color: #00E676; }

  .sidebar-divider { height: 1px; background: rgba(255,255,255,0.1); margin: 0.4rem 1.2rem; }

  /* Main content area */
  .main-content { margin-left: 260px; flex: 1; min-height: 100vh; }
  .container { max-width: 1100px; margin: 0 auto; padding: 1.2rem 1.2rem 2rem; }

  /* Fixture Ticker */
  .fixture-ticker { background: #0a0d14; border-bottom: 1px solid rgba(255,255,255,0.1); padding: 0.45rem 0; overflow: hidden; position: sticky; top: 0; z-index: 100; }
  .ticker-track { display: flex; gap: 1.2rem; overflow-x: auto; scrollbar-width: none; padding: 0 1rem; scroll-behavior: smooth; align-items: center; }
  .ticker-track::-webkit-scrollbar { display: none; }
  .ticker-gw { color: #4da6ff; font-weight: 700; font-size: 0.78rem; flex-shrink: 0; white-space: nowrap; padding-right: 0.4rem; border-right: 1px solid rgba(255,255,255,0.1); margin-right: 0.2rem; }
  .ticker-item { flex-shrink: 0; display: flex; align-items: center; gap: 0.35rem; font-size: 0.76rem; color: #8899AA; white-space: nowrap; }
  .ticker-item .team-abbr { color: #AABBCC; font-weight: 600; }
  .ticker-item .score-live { color: #00E676; font-weight: 700; }
  .ticker-item .score-ft { color: #8899AA; font-weight: 600; }
  .ticker-item .kickoff { color: #4da6ff; font-size: 0.7rem; }
  .ticker-item .live-pulse { display: inline-block; width: 6px; height: 6px; background: #00E676; border-radius: 50%; margin-right: 2px; animation: pulse 1.5s infinite; }
  @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

  /* Mobile topbar & hamburger */
  .mobile-topbar { display: none; position: fixed; top: 0; left: 0; right: 0; height: 50px; background: #1B2D45; border-bottom: 1px solid rgba(255,255,255,0.1); z-index: 150; align-items: center; padding: 0 1rem; }
  .hamburger { background: none; border: none; color: #F0F0F0; font-size: 1.5rem; cursor: pointer; padding: 0.3rem; }
  .mobile-topbar .brand { color: #00E676; font-weight: 700; font-size: 1.1rem; margin-left: 0.7rem; }
  .sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 190; }
  .sidebar-overlay.active { display: block; }

  @media (max-width: 768px) {
    .sidebar { transform: translateX(-100%); }
    .sidebar.open { transform: translateX(0); }
    .main-content { margin-left: 0; padding-top: 50px; padding-bottom: 68px; overflow-x: hidden; }
    .container { overflow-x: hidden; }
    .mobile-topbar { display: flex; }
    .hamburger { display: none; }
    .fixture-ticker { top: 50px; }

    /* User header bar: horizontal scroll on mobile */
    .user-header-bar { gap: 0.6rem; overflow-x: auto; flex-wrap: nowrap; -webkit-overflow-scrolling: touch; scrollbar-width: none; padding: 0.45rem 0.8rem; }
    .user-header-bar::-webkit-scrollbar { display: none; }
    .user-header-bar .uhb-name { white-space: nowrap; max-width: 100px; overflow: hidden; text-overflow: ellipsis; font-size: 0.78rem; }
    .user-header-bar .uhb-item { flex-shrink: 0; }
    .user-header-bar .uhb-value { white-space: nowrap; font-size: 0.72rem; }
    .user-header-bar .uhb-label { font-size: 0.58rem; }

    /* Dashboard: prevent overflow */
    .dash-welcome h2 { font-size: 1.1rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .dash-stats { gap: 0.5rem; }
    .dash-stat { padding: 0.7rem 0.5rem; min-width: 0; }
    .dash-stat .ds-value { font-size: 1.2rem; word-break: break-all; }
    .dash-stat .ds-label { font-size: 0.62rem; }
    .dash-stat .ds-sub { font-size: 0.6rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .dash-section { overflow: hidden; }
    .dash-captain .dc-name { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .section { overflow: hidden; }
    .nav-panel { overflow-x: hidden; }
  }

  /* ==================== UTILITY ==================== */
  .hidden { display: none !important; }
  .right { text-align: right; }
  .pos { font-weight: bold; color: #4da6ff; }
  .score { color: #00E676; font-weight: bold; }
  .cost { color: #FFB800; }
  .out { color: #FF5252; }
  .in { color: #51cf66; }

  /* Fields & Buttons */
  .field label { display: block; color: #8899AA; font-size: 0.75rem; text-transform: uppercase; margin-bottom: 0.3rem; letter-spacing: 0.03em; }
  .field input, .field select { width: 100%; background: #0D1B2A; border: 1px solid rgba(255,255,255,0.1); color: #F0F0F0; border-radius: 6px; padding: 0.5rem 0.7rem; font-size: 0.9rem; }
  .field input:focus, .field select:focus { outline: none; border-color: #00E676; }
  .slider-value { color: #00E676; font-weight: bold; }
  input[type="range"] { -webkit-appearance: none; height: 6px; border-radius: 3px; background: rgba(255,255,255,0.1); border: none; padding: 0; }
  input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%; background: #00E676; cursor: pointer; }

  .btn { background: linear-gradient(135deg, #00E676, #00C853); color: #0D1B2A; border: none; border-radius: 8px; padding: 0.5rem 1.3rem; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.2s; white-space: nowrap; box-shadow: 0 2px 8px rgba(0,230,118,0.2); }
  .btn:hover { transform: translateY(-1px); box-shadow: 0 4px 14px rgba(0,230,118,0.3); }
  .btn:active { transform: translateY(0); }
  .btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; box-shadow: none; }
  .btn-blue { background: linear-gradient(135deg, #4da6ff, #3a8edb); color: #0D1B2A; border: none; border-radius: 8px; padding: 0.5rem 1.3rem; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.2s; white-space: nowrap; box-shadow: 0 2px 8px rgba(77,166,255,0.2); }
  .btn-blue:hover { transform: translateY(-1px); box-shadow: 0 4px 14px rgba(77,166,255,0.3); }
  .btn-blue:active { transform: translateY(0); }
  .btn-blue:disabled { opacity: 0.4; cursor: not-allowed; transform: none; box-shadow: none; }
  .btn-sm { padding: 0.35rem 0.8rem; font-size: 0.8rem; }
  .btn-outline { background: transparent; border: 1px solid rgba(255,255,255,0.1); color: #F0F0F0; border-radius: 6px; padding: 0.35rem 0.8rem; font-size: 0.8rem; cursor: pointer; transition: all 0.15s; }
  .btn-outline:hover { border-color: #4da6ff; color: #4da6ff; }

  /* User bar (reused in settings) */
  .user-bar { background: rgba(27,45,69,0.7); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-radius: 14px; padding: 1rem 1.2rem; margin-bottom: 1rem; border: 1px solid rgba(255,255,255,0.08); box-shadow: 0 2px 12px rgba(0,0,0,0.2); }
  .user-bar-header { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.8rem; }
  .user-bar-header .title { color: #4da6ff; font-size: 0.85rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em; }
  .user-bar-row { display: flex; gap: 0.6rem; align-items: end; flex-wrap: wrap; }
  .user-bar-row .field { flex: 0 1 180px; min-width: 120px; }
  .user-info { display: none; margin-top: 0.8rem; padding: 0.6rem 0.8rem; background: #1B2D45; border-radius: 6px; border-left: 3px solid #4da6ff; }
  .user-info.active { display: flex; align-items: center; gap: 1.5rem; flex-wrap: wrap; }
  .user-info .mgr { font-weight: 500; }
  .user-info .mgr span { color: #4da6ff; }
  .user-info .tm { color: #8899AA; font-size: 0.85rem; }
  .user-error { display: none; margin-top: 0.5rem; color: #FF5252; font-size: 0.82rem; padding: 0.4rem 0.6rem; background: #2d1b1b; border-radius: 4px; }
  .user-error.active { display: block; }
  .help-text { color: #667788; font-size: 0.72rem; margin-top: 0.2rem; }

  /* Recent users dropdown */
  .recent-users { margin-top: 0.6rem; }
  .recent-users .sec-title { color: #8899AA; font-size: 0.72rem; text-transform: uppercase; margin-bottom: 0.35rem; letter-spacing: 0.03em; }
  .recent-user-list { display: flex; flex-direction: column; gap: 0.25rem; }
  .recent-user-item { display: flex; align-items: center; gap: 0.6rem; padding: 0.45rem 0.7rem; background: #1B2D45; border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; cursor: pointer; transition: all 0.15s; }
  .recent-user-item:hover { border-color: #4da6ff; background: #1e2640; }
  .recent-user-item.current { border-color: #00E676; background: rgba(0,230,118,0.06); }
  .recent-user-item .ru-name { flex: 1; font-size: 0.85rem; font-weight: 500; }
  .recent-user-item .ru-team { color: #8899AA; font-size: 0.78rem; }
  .recent-user-item .ru-id { color: #667788; font-size: 0.72rem; font-family: monospace; }
  .recent-user-item .ru-remove { color: #667788; font-size: 0.85rem; padding: 0 0.3rem; cursor: pointer; transition: color 0.15s; }
  .recent-user-item .ru-remove:hover { color: #FF5252; }
  .inline-spinner { display: none; width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.1); border-top-color: #4da6ff; border-radius: 50%; animation: spin 0.8s linear infinite; }
  .inline-spinner.active { display: inline-block; }

  /* Persistent user header bar (KPI strip) */
  .user-header-bar { display: none; background: linear-gradient(90deg, #0D1B2A 0%, #1B2D45 50%, #0D1B2A 100%); border-bottom: 1px solid rgba(255,255,255,0.08); padding: 0.5rem 1rem; align-items: center; gap: 1.2rem; font-size: 0.78rem; flex-wrap: wrap; position: relative; }
  .user-header-bar::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 1px; background: linear-gradient(90deg, transparent, rgba(0,230,118,0.2), rgba(77,166,255,0.2), transparent); }
  .user-header-bar.active { display: flex; }
  .user-header-bar .uhb-item { display: flex; flex-direction: column; align-items: center; gap: 0.1rem; }
  .user-header-bar .uhb-label { color: #667788; font-size: 0.65rem; text-transform: uppercase; }
  .user-header-bar .uhb-value { color: #F0F0F0; font-weight: 600; }
  .user-header-bar .uhb-value.green { color: #00E676; }
  .user-header-bar .uhb-value.blue { color: #4da6ff; }
  .user-header-bar .uhb-value.gold { color: #FFB800; }
  .user-header-bar .uhb-name { color: #00E676; font-weight: 600; font-size: 0.85rem; }
  .user-header-bar .uhb-sync { background: none; border: 1px solid rgba(255,255,255,0.1); color: #4da6ff; border-radius: 4px; padding: 0.2rem 0.5rem; font-size: 0.72rem; cursor: pointer; margin-left: auto; transition: all 0.15s; }
  .user-header-bar .uhb-sync:hover { border-color: #4da6ff; background: rgba(77,166,255,0.1); }
  .chip-badge { display: inline-block; padding: 0.15rem 0.4rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600; margin: 0.1rem; }
  .chip-badge.available { background: rgba(0,230,118,0.12); color: #00E676; border: 1px solid rgba(0,230,118,0.3); }
  .chip-badge.used { background: rgba(136,136,136,0.12); color: #667788; border: 1px solid rgba(255,255,255,0.1); text-decoration: line-through; }

  /* Leagues */
  .leagues-section { display: none; margin-top: 0.8rem; }
  .leagues-section.active { display: block; }
  .leagues-section .sec-title { color: #4da6ff; font-size: 0.75rem; text-transform: uppercase; margin-bottom: 0.4rem; font-weight: 600; }
  .league-list { display: flex; flex-wrap: wrap; gap: 0.4rem; }
  .league-chip { background: #1B2D45; border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; padding: 0.3rem 0.7rem; font-size: 0.8rem; cursor: pointer; transition: all 0.15s; }
  .league-chip:hover { border-color: #4da6ff; background: #1e2640; }
  .league-chip.active { border-color: #4da6ff; background: #1a2540; color: #4da6ff; }

  .league-standings { display: none; margin-top: 0.8rem; }
  .league-standings.active { display: block; }
  .league-standings .league-title { color: #4da6ff; font-size: 0.95rem; font-weight: 600; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; }

  /* Nav panels */
  .nav-panel { display: none; }
  .nav-panel.active { display: block; }

  /* Sections & cards */
  .section { background: rgba(27,45,69,0.7); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-radius: 14px; padding: 1.2rem; margin-bottom: 1rem; border: 1px solid rgba(255,255,255,0.08); box-shadow: 0 2px 12px rgba(0,0,0,0.25); transition: box-shadow 0.2s, transform 0.2s; }
  .section:hover { box-shadow: 0 4px 20px rgba(0,0,0,0.35); }
  .section-title { color: #00E676; font-size: 0.85rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em; margin-bottom: 0.8rem; }
  .section-title.blue { color: #4da6ff; }
  .stat-row { display: flex; gap: 0.6rem; flex-wrap: wrap; margin-bottom: 1rem; }
  .stat-card { background: rgba(27,45,69,0.7); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-radius: 12px; padding: 0.8rem 1rem; text-align: center; flex: 1; min-width: 100px; border: 1px solid rgba(255,255,255,0.08); transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s; }
  .stat-card:hover { transform: translateY(-2px); box-shadow: 0 4px 16px rgba(0,0,0,0.3); border-color: rgba(255,255,255,0.12); }
  .stat-card .label { color: #8899AA; font-size: 0.7rem; text-transform: uppercase; }
  .stat-card .value { color: #00E676; font-size: 1.2rem; font-weight: bold; margin-top: 0.15rem; }
  .stat-card .value.blue { color: #4da6ff; }
  .stat-card .value.red { color: #FF5252; }

  /* Tables */
  table { width: 100%; border-collapse: collapse; margin-bottom: 1rem; }
  th { background: #1B2D45; color: #00E676; font-family: 'Space Grotesk', sans-serif; text-align: left; padding: 0.55rem 0.6rem; font-size: 0.72rem; text-transform: uppercase; position: sticky; top: 0; border-bottom: 2px solid rgba(255,255,255,0.08); }
  td { padding: 0.45rem 0.6rem; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.85rem; font-variant-numeric: tabular-nums; transition: background 0.15s; }
  tr:nth-child(even) { background: rgba(27,45,69,0.3); }
  tr:hover { background: rgba(0,230,118,0.04); }
  .table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }
  th.sortable { cursor: pointer; user-select: none; }
  th.sortable:hover { color: #F0F0F0; }
  th.sortable.sort-asc::after { content: " \u25B2"; font-size: 0.65rem; }
  th.sortable.sort-desc::after { content: " \u25BC"; font-size: 0.65rem; }

  /* Sub-tabs (used in optimizer) */
  .tabs { display: flex; gap: 0; border-bottom: 2px solid rgba(255,255,255,0.1); margin-bottom: 0.8rem; overflow-x: auto; }
  .tab { padding: 0.5rem 1rem; cursor: pointer; color: #8899AA; font-size: 0.82rem; font-weight: 500; border-bottom: 2px solid transparent; margin-bottom: -2px; transition: all 0.15s; white-space: nowrap; flex-shrink: 0; }
  .tab:hover { color: #F0F0F0; }
  .tab.active { color: #00E676; border-bottom-color: #00E676; }
  .tab.user-tab.active { color: #4da6ff; border-bottom-color: #4da6ff; }
  .tab-content { display: none; }
  .tab-content.active { display: block; }

  /* Loader */
  .loader { display: none; text-align: center; padding: 2rem; }
  .loader.active { display: block; }
  .spinner { display: inline-block; width: 32px; height: 32px; border: 3px solid rgba(255,255,255,0.1); border-top-color: #00E676; border-radius: 50%; animation: spin 0.8s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loader-text { color: #8899AA; margin-top: 0.5rem; font-size: 0.82rem; }

  /* Skeleton loading shimmer */
  .skeleton { background: linear-gradient(90deg, #1B2D45 25%, #233a56 50%, #1B2D45 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 6px; min-height: 1em; }
  @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
  .skeleton-row { display: flex; gap: 0.6rem; margin-bottom: 0.6rem; }
  .skeleton-row .skeleton { height: 14px; flex: 1; }
  .skeleton-row .skeleton:first-child { max-width: 40%; }
  .skeleton-card { background: rgba(27,45,69,0.5); border-radius: 12px; padding: 1rem; margin-bottom: 0.6rem; }
  .skeleton-card .skeleton { margin-bottom: 0.5rem; height: 12px; }
  .skeleton-card .skeleton:first-child { width: 60%; height: 16px; }
  .error-msg { background: #2d1b1b; border: 1px solid #FF5252; color: #FF5252; border-radius: 8px; padding: 0.8rem 1.2rem; text-align: center; margin: 1rem 0; }

  /* Filters bar */
  .filters { display: flex; gap: 0.8rem; flex-wrap: wrap; margin-bottom: 1rem; align-items: end; }
  .filters .field { flex: 1; min-width: 120px; }
  .filters select, .filters input[type="text"] { width: 100%; background: #0D1B2A; border: 1px solid rgba(255,255,255,0.1); color: #F0F0F0; border-radius: 6px; padding: 0.5rem 0.7rem; font-size: 0.9rem; }

  /* Settings panel */
  .settings { background: #1B2D45; border-radius: 10px; padding: 1rem 1.2rem; margin-bottom: 1rem; }
  .settings-grid { display: grid; grid-template-columns: 1fr 1fr auto; gap: 1rem; align-items: end; }

  /* FDR Heatmap */
  .fdr-grid { overflow-x: auto; -webkit-overflow-scrolling: touch; }
  .fdr-grid table { min-width: 600px; }
  .fdr-grid th, .fdr-grid td { text-align: center; padding: 0.35rem 0.3rem; font-size: 0.78rem; }
  .fdr-grid th { font-size: 0.7rem; }
  .fdr-grid .team-col { text-align: left; font-weight: 600; min-width: 50px; position: sticky; left: 0; background: #1B2D45; z-index: 1; }
  .fdr-cell { border-radius: 6px; padding: 0.3rem 0.2rem; font-weight: 600; font-size: 0.75rem; line-height: 1.3; transition: transform 0.15s; }
  .fdr-cell:hover { transform: scale(1.08); }
  .fdr-1 { background: linear-gradient(135deg, #1a6b2a, #238636); color: #F0F0F0; box-shadow: inset 0 1px 0 rgba(255,255,255,0.1); }
  .fdr-2 { background: linear-gradient(135deg, #01d468, #01fc7a); color: #0D1B2A; box-shadow: inset 0 1px 0 rgba(255,255,255,0.15); }
  .fdr-3 { background: linear-gradient(135deg, #8a8a2a, #b5a642); color: #fff; box-shadow: inset 0 1px 0 rgba(255,255,255,0.1); }
  .fdr-4 { background: linear-gradient(135deg, #d45500, #FFB800); color: #fff; box-shadow: inset 0 1px 0 rgba(255,255,255,0.1); }
  .fdr-5 { background: linear-gradient(135deg, #8b0000, #d42020); color: #fff; box-shadow: inset 0 1px 0 rgba(255,255,255,0.05); }
  .fdr-home { font-size: 0.65rem; }

  /* Radar chart (canvas) */
  .compare-container { display: flex; gap: 1rem; flex-wrap: wrap; align-items: start; }
  .compare-container canvas { flex: 0 0 auto; max-width: 100%; }
  .compare-legend { width: 100%; display: flex; flex-wrap: wrap; gap: 0.3rem; margin: 0.5rem 0; }
  .compare-table { flex: 1; min-width: 250px; }
  .compare-search { display: flex; gap: 0.5rem; align-items: end; flex-wrap: wrap; margin-bottom: 1rem; }
  .compare-search .field { flex: 1; min-width: 150px; }
  .compare-chips { display: flex; gap: 0.4rem; flex-wrap: wrap; margin-bottom: 0.8rem; min-height: 28px; }
  .compare-chip { background: #1B2D45; border: 1px solid #4da6ff; border-radius: 6px; padding: 0.2rem 0.6rem; font-size: 0.8rem; color: #4da6ff; display: flex; align-items: center; gap: 0.3rem; }
  .compare-chip .remove { cursor: pointer; font-size: 1rem; line-height: 1; opacity: 0.7; }
  .compare-chip .remove:hover { opacity: 1; }
  .compare-results { display: flex; gap: 0.8rem; flex-wrap: wrap; margin-top: 0.5rem; }
  .compare-pick { background: #1B2D45; border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; padding: 0.3rem 0.6rem; font-size: 0.8rem; cursor: pointer; transition: all 0.15s; }
  .compare-pick:hover { border-color: #4da6ff; }

  /* Price changes */
  .price-card { display: flex; align-items: center; justify-content: space-between; background: #1B2D45; border-radius: 6px; padding: 0.5rem 0.8rem; margin-bottom: 0.4rem; }
  .price-card .player-info { flex: 1; }
  .price-card .player-name { font-weight: 500; font-size: 0.85rem; }
  .price-card .player-meta { color: #8899AA; font-size: 0.75rem; }
  .price-card .transfer-stat { text-align: right; min-width: 80px; }
  .price-card .net-positive { color: #51cf66; font-weight: bold; }
  .price-card .net-negative { color: #FF5252; font-weight: bold; }

  /* Pitch layout */
  .pitch { background: linear-gradient(180deg, #1a5c2a 0%, #1e6b31 10%, #1a5c2a 10%, #1a5c2a 20%, #1e6b31 20%, #1e6b31 30%, #1a5c2a 30%, #1a5c2a 40%, #1e6b31 40%, #1e6b31 50%, #1a5c2a 50%, #1a5c2a 60%, #1e6b31 60%, #1e6b31 70%, #1a5c2a 70%, #1a5c2a 80%, #1e6b31 80%, #1e6b31 90%, #1a5c2a 90%); border-radius: 14px; padding: 1.5rem 0.5rem; position: relative; overflow: hidden; box-shadow: inset 0 0 40px rgba(0,0,0,0.3), 0 4px 20px rgba(0,0,0,0.3); border: 2px solid rgba(255,255,255,0.06); }
  .pitch::before { content: ''; position: absolute; top: 50%; left: 10%; right: 10%; height: 1px; background: rgba(255,255,255,0.18); }
  .pitch::after { content: ''; position: absolute; top: 42%; left: 35%; right: 35%; bottom: 42%; border: 1px solid rgba(255,255,255,0.14); border-radius: 50%; }
  .pitch-row { display: flex; justify-content: center; gap: 0.3rem; padding: 0.6rem 0; position: relative; z-index: 1; }
  .pitch-row.bench-row { background: #1B2D45; border-radius: 0 0 10px 10px; margin: 0.8rem -0.5rem -1.5rem; padding: 0.8rem 0.5rem 0.6rem; }
  .pitch-row .bench-label { position: absolute; top: 0.2rem; left: 0.8rem; font-size: 0.65rem; color: #8899AA; text-transform: uppercase; letter-spacing: 0.05em; }

  .live-card { background: rgba(13,27,42,0.9); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); border-radius: 10px; padding: 0.3rem; text-align: center; position: relative; width: 80px; flex-shrink: 0; cursor: grab; transition: opacity 0.2s, box-shadow 0.3s, transform 0.3s; overflow: visible; border: 1px solid rgba(255,255,255,0.08); border-top: 3px solid var(--team-color, #333); }
  .live-card:hover { transform: translateY(-3px) scale(1.02); box-shadow: 0 6px 20px rgba(0,0,0,0.4); }
  .live-card.bench { opacity: 0.7; }
  .live-card.dragging { opacity: 0.3; transform: scale(0.95); }
  .live-card.drag-invalid { animation: shake 0.35s ease; border-color: #FF5252 !important; }
  @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-5px)} 75%{transform:translateX(5px)} }
  .live-card.drag-over { box-shadow: 0 0 0 2px #00E676, 0 0 12px rgba(0,230,118,0.4); transform: scale(1.05); }
  .live-card .lp-photo { width: 48px; height: 48px; border-radius: 50%; margin: 0 auto 0.2rem; overflow: hidden; background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; }
  .live-card .lp-photo img { width: 100%; height: 100%; object-fit: cover; object-position: top; }
  .live-card .lp-photo .lp-placeholder { font-size: 1.2rem; color: #667788; }
  .live-card .lp-name { font-weight: 600; font-size: 0.7rem; margin-bottom: 0.1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .live-card .lp-team { color: #8899AA; font-size: 0.6rem; }
  .live-card .lp-pts { font-size: 1.1rem; font-weight: bold; color: #00E676; margin-top: 0.15rem; }
  .live-card .lp-pts.zero { color: #8899AA; }
  .live-card .lp-captain { position: absolute; top: 2px; right: 4px; font-size: 0.6rem; background: linear-gradient(135deg, #FFB800, #E5A600); color: #0D1B2A; border-radius: 50%; width: 18px; height: 18px; line-height: 18px; font-weight: bold; box-shadow: 0 0 8px rgba(255,184,0,0.5), 0 0 16px rgba(255,184,0,0.2); animation: captainGlow 2s ease-in-out infinite; }
  @keyframes captainGlow { 0%,100% { box-shadow: 0 0 8px rgba(255,184,0,0.5); } 50% { box-shadow: 0 0 14px rgba(255,184,0,0.8), 0 0 24px rgba(255,184,0,0.3); } }
  .live-card .lp-vice { position: absolute; top: 2px; right: 4px; font-size: 0.6rem; background: #8899AA; color: #0D1B2A; border-radius: 50%; width: 16px; height: 16px; line-height: 16px; font-weight: bold; }
  .live-card .lp-detail { font-size: 0.6rem; color: #8899AA; margin-top: 0.1rem; }

  /* Injury flag */
  .live-card .lp-injury { position: absolute; top: 3px; left: 4px; width: 10px; height: 10px; border-radius: 50%; z-index: 2; cursor: help; }
  .live-card .lp-injury.injury-red { background: #FF5252; box-shadow: 0 0 4px rgba(255,68,68,0.6); }
  .live-card .lp-injury.injury-yellow { background: #E5A600; box-shadow: 0 0 4px rgba(255,170,0,0.6); }

  /* Bench order badge */
  .live-card .bench-order { position: absolute; bottom: 2px; right: 4px; font-size: 0.55rem; background: #444; color: #AABBCC; border-radius: 50%; width: 14px; height: 14px; line-height: 14px; text-align: center; font-weight: bold; }

  /* Captain selection mode */
  .live-card.captain-selectable { cursor: pointer; }
  .live-card.captain-selectable:hover { box-shadow: 0 0 0 2px #FFB800, 0 0 10px rgba(255,184,0,0.3); }
  .live-card.vice-selectable:hover { box-shadow: 0 0 0 2px #aaa, 0 0 10px rgba(170,170,170,0.3); }

  /* Captain mode bar */
  .captain-mode-bar { background: linear-gradient(135deg, #1B2D45, #252b3b); border: 1px solid #FFB800; border-radius: 8px; padding: 0.5rem 1rem; margin-bottom: 0.8rem; display: flex; align-items: center; justify-content: space-between; font-size: 0.82rem; color: #FFB800; }
  .captain-mode-bar.vice-mode { border-color: #8899AA; color: #8899AA; }
  .captain-mode-bar button { background: #333; border: 1px solid #555; color: #AABBCC; border-radius: 6px; padding: 0.3rem 0.8rem; cursor: pointer; font-size: 0.75rem; }
  .captain-mode-bar button:hover { background: #444; }

  /* Formation badge */
  .formation-badge { display: inline-block; background: #1B2D45; border: 1px solid #333; border-radius: 6px; padding: 0.2rem 0.6rem; font-size: 0.75rem; font-weight: 600; color: #00E676; margin-left: 0.5rem; }
  .formation-badge.formation-invalid { border-color: #FF5252; color: #FF5252; }

  /* Action bar */
  .live-action-bar { display: flex; gap: 0.5rem; margin-bottom: 0.8rem; align-items: center; flex-wrap: wrap; }
  .live-action-bar button { background: #1B2D45; border: 1px solid #333; color: #AABBCC; border-radius: 6px; padding: 0.35rem 0.7rem; cursor: pointer; font-size: 0.75rem; transition: background 0.2s, border-color 0.2s; }
  .live-action-bar button:hover { background: #252b3b; border-color: #667788; }
  .live-action-bar .btn-captain { border-color: #FFB800; color: #FFB800; }
  .live-action-bar .btn-vice { border-color: #8899AA; color: #8899AA; }
  .live-save-indicator { font-size: 0.7rem; color: #00E676; opacity: 0; transition: opacity 0.3s; margin-left: auto; }
  .live-save-indicator.visible { opacity: 1; }

  .live-card .lp-upcoming { margin-top: 0.2rem; display: flex; justify-content: center; gap: 1px; flex-wrap: nowrap; }
  .bench-grid { display: flex; justify-content: center; gap: 0.3rem; margin-top: 0.8rem; }

  @media (max-width: 480px) {
    .live-card { width: 68px; }
    .live-card .lp-photo { width: 40px; height: 40px; }
    .live-card .lp-name { font-size: 0.62rem; }
    .live-card .lp-pts { font-size: 0.95rem; }
    .pitch { padding: 1rem 0.3rem; }
  }

  /* Rival comparison */
  .rival-cols { display: grid; grid-template-columns: 1fr 1fr; gap: 0.8rem; margin-top: 0.8rem; }
  @media (max-width: 600px) { .rival-cols { grid-template-columns: 1fr; } }
  .rival-col .rival-header { font-weight: 600; font-size: 0.9rem; margin-bottom: 0.5rem; padding-bottom: 0.3rem; border-bottom: 1px solid rgba(255,255,255,0.1); }
  .rival-player { padding: 0.25rem 0; font-size: 0.82rem; display: flex; justify-content: space-between; }
  .shared-list { margin-top: 0.5rem; }
  .shared-list .shared-header { color: #8899AA; font-size: 0.75rem; text-transform: uppercase; margin-bottom: 0.3rem; }

  /* Fixture cards */
  .fixture-card { background: #1B2D45; border-radius: 8px; padding: 0.6rem 0.8rem; margin-bottom: 0.4rem; display: flex; align-items: center; justify-content: space-between; }
  .fixture-team { flex: 1; font-weight: 500; font-size: 0.85rem; }
  .fixture-team.home { text-align: right; padding-right: 0.8rem; }
  .fixture-team.away { text-align: left; padding-left: 0.8rem; }
  .fixture-score { font-size: 1.1rem; font-weight: bold; color: #00E676; min-width: 50px; text-align: center; }
  .fixture-vs { font-size: 0.85rem; color: #8899AA; min-width: 50px; text-align: center; }
  .difficulty { display: inline-block; width: 20px; height: 20px; border-radius: 4px; text-align: center; line-height: 20px; font-size: 0.65rem; font-weight: bold; color: #fff; margin-left: 0.3rem; }
  .difficulty.away-badge { margin-left: 0; margin-right: 0.3rem; }
  .diff-1 { background: linear-gradient(135deg, #1a6b2a, #238636); } .diff-2 { background: linear-gradient(135deg, #01d468, #01fc7a); color: #0D1B2A; } .diff-3 { background: linear-gradient(135deg, #8a8a2a, #b5a642); } .diff-4 { background: linear-gradient(135deg, #d45500, #FFB800); } .diff-5 { background: linear-gradient(135deg, #8b0000, #d42020); }
  .gw-header { color: #00E676; font-size: 1rem; font-weight: 600; margin: 1.2rem 0 0.6rem; padding-bottom: 0.2rem; border-bottom: 1px solid rgba(255,255,255,0.1); }
  .gw-badge { font-size: 0.7rem; padding: 0.1rem 0.4rem; border-radius: 4px; margin-left: 0.4rem; font-weight: 500; }
  .gw-badge.current { background: #00E676; color: #0D1B2A; } .gw-badge.next { background: #4da6ff; color: #0D1B2A; } .gw-badge.finished { background: rgba(255,255,255,0.1); color: #8899AA; }

  /* Dashboard */
  .dash-welcome { margin-bottom: 1rem; }
  .dash-welcome h2 { color: #00E676; font-size: 1.3rem; margin-bottom: 0.2rem; }
  .dash-welcome p { color: #8899AA; font-size: 0.85rem; }

  /* Top stats bar */
  .dash-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.8rem; margin-bottom: 1.2rem; }
  .dash-stat { background: rgba(27,45,69,0.7); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-radius: 14px; padding: 1rem; text-align: center; border: 1px solid rgba(255,255,255,0.08); position: relative; overflow: hidden; transition: transform 0.2s, box-shadow 0.2s; }
  .dash-stat:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.3); }
  .dash-stat::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, #00E676, #4da6ff); opacity: 0.4; }
  .dash-stat .ds-value { font-size: 1.6rem; font-weight: bold; color: #00E676; text-shadow: 0 0 20px rgba(0,230,118,0.15); }
  .dash-stat .ds-value.blue { color: #4da6ff; text-shadow: 0 0 20px rgba(77,166,255,0.15); }
  .dash-stat .ds-label { font-size: 0.7rem; color: #8899AA; text-transform: uppercase; margin-top: 0.2rem; letter-spacing: 0.03em; }
  .dash-stat .ds-sub { font-size: 0.68rem; color: #667788; margin-top: 0.15rem; }
  @media (max-width: 600px) { .dash-stats { grid-template-columns: repeat(2, 1fr); gap: 0.5rem; } }

  /* Dashboard main layout: 2-col on desktop */
  .dash-body { display: grid; grid-template-columns: 1fr 320px; gap: 1rem; margin-bottom: 1rem; }
  @media (max-width: 900px) { .dash-body { grid-template-columns: 1fr; } }

  /* Mid section: pitch + captain */
  .dash-mid { display: flex; flex-direction: column; gap: 1rem; }
  .dash-section { background: rgba(27,45,69,0.7); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-radius: 14px; padding: 1rem 1.2rem; border: 1px solid rgba(255,255,255,0.08); box-shadow: 0 2px 12px rgba(0,0,0,0.2); transition: box-shadow 0.2s; }
  .dash-section:hover { box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
  .dash-section-title { font-size: 0.78rem; font-weight: 600; text-transform: uppercase; color: #00E676; margin-bottom: 0.7rem; letter-spacing: 0.03em; display: flex; align-items: center; justify-content: space-between; }
  .dash-section-title .ds-link { font-size: 0.72rem; color: #4da6ff; cursor: pointer; text-transform: none; font-weight: 500; }
  .dash-section-title .ds-link:hover { text-decoration: underline; }

  /* Captain highlight */
  .dash-captain { display: flex; align-items: center; gap: 1rem; padding: 0.8rem; background: linear-gradient(135deg, rgba(255,184,0,0.08), rgba(255,184,0,0.02)); border-radius: 12px; border: 1px solid rgba(255,184,0,0.2); position: relative; overflow: hidden; }
  .dash-captain::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, transparent, #FFB800, transparent); }
  .dash-captain .dc-badge { width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, #FFB800, #E5A600); color: #0D1B2A; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.1rem; flex-shrink: 0; box-shadow: 0 0 12px rgba(255,184,0,0.3); }
  .dash-captain .dc-info { flex: 1; }
  .dash-captain .dc-name { font-weight: 600; font-size: 0.95rem; }
  .dash-captain .dc-meta { color: #8899AA; font-size: 0.78rem; }
  .dash-captain .dc-pts { font-size: 1.3rem; font-weight: bold; color: #FFB800; text-align: right; min-width: 50px; }

  /* Bonus tracker */
  .dash-bonus { display: flex; gap: 0.5rem; flex-wrap: wrap; }
  .bonus-item { background: #1B2D45; border-radius: 6px; padding: 0.35rem 0.6rem; font-size: 0.78rem; display: flex; align-items: center; gap: 0.4rem; }
  .bonus-item .bi-pts { color: #FFB800; font-weight: bold; }

  /* Right rail */
  .dash-rail { display: flex; flex-direction: column; gap: 1rem; }
  .dash-rail-list { max-height: 240px; overflow-y: auto; }
  .dash-rail-list::-webkit-scrollbar { width: 4px; }
  .dash-rail-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 2px; }

  /* News/injury items */
  .dash-news-item { display: flex; align-items: center; gap: 0.6rem; padding: 0.4rem 0; border-bottom: 1px solid #1B2D45; font-size: 0.8rem; }
  .dash-news-item:last-child { border-bottom: none; }
  .dash-news-item .ni-status { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
  .dash-news-item .ni-status.red { background: #FF5252; }
  .dash-news-item .ni-status.yellow { background: #FFB800; }
  .dash-news-item .ni-status.green { background: #51cf66; }
  .dash-news-item .ni-info { flex: 1; min-width: 0; }
  .dash-news-item .ni-name { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .dash-news-item .ni-text { color: #8899AA; font-size: 0.72rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .dash-news-item .ni-chance { font-size: 0.72rem; font-weight: 600; flex-shrink: 0; min-width: 32px; text-align: right; }

  /* Price change items in rail */
  .dash-price-item { display: flex; align-items: center; justify-content: space-between; padding: 0.35rem 0; border-bottom: 1px solid #1B2D45; font-size: 0.8rem; }
  .dash-price-item:last-child { border-bottom: none; }
  .dash-price-item .pi-name { font-weight: 500; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-right: 0.5rem; }
  .dash-price-item .pi-change { font-weight: 600; font-size: 0.78rem; flex-shrink: 0; }
  .dash-price-item .pi-change.up { color: #51cf66; }
  .dash-price-item .pi-change.down { color: #FF5252; }

  /* Bottom section */
  .dash-bottom { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem; }
  @media (max-width: 700px) { .dash-bottom { grid-template-columns: 1fr; } }

  /* Bench mini cards */
  .dash-bench { display: flex; gap: 0.5rem; flex-wrap: wrap; }
  .bench-mini { background: #1B2D45; border-radius: 8px; padding: 0.5rem 0.7rem; flex: 1; min-width: 100px; display: flex; align-items: center; gap: 0.5rem; }
  .bench-mini .bm-name { font-size: 0.8rem; font-weight: 500; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .bench-mini .bm-pts { font-size: 0.9rem; font-weight: bold; color: #8899AA; }
  .bench-mini .bm-pos { font-size: 0.68rem; color: #4da6ff; font-weight: 600; min-width: 26px; }

  /* Fixture mini cards */
  .dash-fixture { display: flex; align-items: center; justify-content: space-between; padding: 0.4rem 0.6rem; background: #1B2D45; border-radius: 6px; margin-bottom: 0.3rem; font-size: 0.8rem; }
  .dash-fixture .df-teams { flex: 1; }
  .dash-fixture .df-time { color: #8899AA; font-size: 0.72rem; flex-shrink: 0; }
  .dash-fixture .df-score { color: #00E676; font-weight: bold; flex-shrink: 0; min-width: 40px; text-align: center; }

  /* Mini pitch on dashboard */
  .dash-pitch { position: relative; }
  .dash-pitch .pitch { padding: 1rem 0.3rem; }
  .dash-pitch .live-card { width: 66px; }
  .dash-pitch .live-card .lp-photo { width: 36px; height: 36px; }
  .dash-pitch .live-card .lp-name { font-size: 0.6rem; }
  .dash-pitch .live-card .lp-pts { font-size: 0.9rem; }
  .dash-pitch .live-card .lp-detail { display: none; }
  .dash-pitch .live-card .lp-upcoming { display: none; }
  .dash-pitch .pitch-row.bench-row { display: none; }

  /* Dash empty state */
  .dash-empty { text-align: center; padding: 2rem 1rem; color: #667788; }
  .dash-empty .de-icon { font-size: 2.5rem; margin-bottom: 0.8rem; }
  .dash-empty .de-text { font-size: 0.85rem; margin-bottom: 0.8rem; }

  /* Quick links grid (shown when no user) */
  .dash-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; margin-bottom: 1rem; }
  .dash-card { background: rgba(27,45,69,0.7); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-radius: 14px; padding: 1.2rem; cursor: pointer; transition: all 0.25s; border: 1px solid rgba(255,255,255,0.08); box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
  .dash-card:hover { border-color: #00E676; background: #1e3148; transform: translateY(-3px); box-shadow: 0 8px 24px rgba(0,230,118,0.08); }
  .dash-card .dc-icon { font-size: 1.5rem; margin-bottom: 0.5rem; }
  .dash-card .dc-title { font-weight: 600; font-size: 0.9rem; margin-bottom: 0.3rem; }
  .dash-card .dc-desc { color: #8899AA; font-size: 0.78rem; }

  /* Onboarding card */
  .onboarding-card { background: rgba(27,45,69,0.8); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border-radius: 16px; padding: 2rem; border: 1px solid rgba(0,230,118,0.2); text-align: center; max-width: 520px; margin: 0 auto 0.5rem; }
  .ob-icon { font-size: 2.5rem; margin-bottom: 0.8rem; }
  .ob-title { font-family: 'Space Grotesk', sans-serif; font-size: 1.15rem; font-weight: 700; margin-bottom: 1.2rem; color: #F0F0F0; }
  .ob-benefits { text-align: left; margin: 0 auto 1.5rem; display: inline-block; }
  .ob-benefit { display: flex; align-items: center; gap: 0.6rem; margin-bottom: 0.6rem; font-size: 0.88rem; color: #AABBCC; }
  .ob-check { color: #00E676; font-weight: 700; font-size: 1rem; flex-shrink: 0; }
  .ob-actions { display: flex; flex-direction: column; align-items: center; gap: 0.6rem; }
  .ob-demo-link { color: #8899AA; font-size: 0.82rem; text-decoration: underline; }
  .ob-demo-link:hover { color: #4da6ff; }

  /* Player cards for mobile My Team (Item 6) */
  .player-card-list { display: none; flex-direction: column; gap: 0.4rem; }
  .player-card {
    background: rgba(27,45,69,0.7); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
    border-radius: 12px; padding: 0.6rem 0.8rem; border: 1px solid rgba(255,255,255,0.08);
    display: flex; align-items: center; gap: 0.6rem; cursor: pointer; transition: border-color 0.2s;
  }
  .player-card:hover { border-color: rgba(0,230,118,0.3); }
  .player-card .pc-kit { width: 28px; flex-shrink: 0; text-align: center; }
  .player-card .pc-main { flex: 1; min-width: 0; }
  .player-card .pc-name { font-weight: 600; font-size: 0.85rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .player-card .pc-meta { color: #8899AA; font-size: 0.72rem; }
  .player-card .pc-stats { display: flex; gap: 0.5rem; font-size: 0.72rem; margin-top: 0.2rem; flex-wrap: wrap; }
  .player-card .pc-expand { display: none; width: 100%; margin-top: 0.4rem; padding-top: 0.4rem; border-top: 1px solid rgba(255,255,255,0.05); font-size: 0.72rem; color: #8899AA; }
  .player-card .pc-expand.open { display: block; }
  .player-card .pc-score { text-align: right; font-weight: 700; color: #00E676; font-size: 1rem; font-family: 'JetBrains Mono', monospace; flex-shrink: 0; }

  /* Coming soon placeholder */
  .coming-soon { text-align: center; padding: 3rem 1rem; }
  .coming-soon .cs-icon { font-size: 3rem; margin-bottom: 1rem; }
  .coming-soon .cs-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 0.4rem; }
  .coming-soon .cs-text { color: #8899AA; font-size: 0.85rem; }

  /* Draft / Waivers */
  .draft-header { display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap; }
  .draft-header h2 { color: #00E676; font-size: 1.15rem; margin: 0; }
  .draft-header .draft-badge { background: #1a2540; color: #4da6ff; font-size: 0.72rem; padding: 0.2rem 0.6rem; border-radius: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em; }
  .waiver-top { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 0.6rem; margin-bottom: 1.2rem; }
  .waiver-card { background: #1B2D45; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 0.8rem 1rem; transition: border-color 0.15s; }
  .waiver-card:hover { border-color: #4da6ff; }
  .waiver-card .wc-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.4rem; }
  .waiver-card .wc-name { font-weight: 600; font-size: 0.92rem; }
  .waiver-card .wc-pos { font-size: 0.72rem; font-weight: 700; }
  .waiver-card .wc-pos.gk { color: #f5a623; } .waiver-card .wc-pos.def { color: #4da6ff; }
  .waiver-card .wc-pos.mid { color: #00E676; } .waiver-card .wc-pos.fwd { color: #FF5252; }
  .waiver-card .wc-meta { color: #8899AA; font-size: 0.78rem; margin-bottom: 0.5rem; }
  .waiver-card .wc-stats { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.3rem; }
  .waiver-card .wc-stat { text-align: center; }
  .waiver-card .wc-stat .label { color: #667788; font-size: 0.65rem; text-transform: uppercase; }
  .waiver-card .wc-stat .val { color: #F0F0F0; font-size: 0.85rem; font-weight: 600; }
  .waiver-card .wc-stat .val.green { color: #00E676; }
  .waiver-card .wc-score { margin-top: 0.5rem; text-align: right; }
  .waiver-card .wc-score .val { color: #00E676; font-size: 0.78rem; font-weight: 700; }

  .roster-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 0.5rem; margin-bottom: 1rem; }
  .roster-player { background: #1B2D45; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 0.65rem 0.9rem; display: flex; align-items: center; gap: 0.6rem; }
  .roster-player .rp-pos { font-weight: 700; font-size: 0.75rem; width: 2rem; text-align: center; border-radius: 4px; padding: 0.15rem 0; }
  .roster-player .rp-pos.gk { background: rgba(245,166,35,0.15); color: #f5a623; }
  .roster-player .rp-pos.def { background: rgba(77,166,255,0.15); color: #4da6ff; }
  .roster-player .rp-pos.mid { background: rgba(0,230,118,0.15); color: #00E676; }
  .roster-player .rp-pos.fwd { background: rgba(255,82,82,0.15); color: #FF5252; }
  .roster-player .rp-info { flex: 1; }
  .roster-player .rp-name { font-size: 0.88rem; font-weight: 500; }
  .roster-player .rp-team { color: #8899AA; font-size: 0.75rem; }
  .roster-player .rp-score { color: #00E676; font-weight: 700; font-size: 0.85rem; }
  .roster-player .rp-remove { color: #667788; cursor: pointer; font-size: 1rem; padding: 0 0.3rem; }
  .roster-player .rp-remove:hover { color: #FF5252; }

  .roster-summary { display: flex; gap: 0.6rem; flex-wrap: wrap; margin-bottom: 1rem; }
  .roster-summary .rs-item { background: #1B2D45; border-radius: 8px; padding: 0.6rem 1rem; text-align: center; flex: 1; min-width: 90px; }
  .roster-summary .rs-label { color: #8899AA; font-size: 0.68rem; text-transform: uppercase; }
  .roster-summary .rs-value { color: #00E676; font-size: 1.1rem; font-weight: 700; margin-top: 0.1rem; }
  .roster-summary .rs-value.warn { color: #FF5252; }

  /* Responsive */
  @media (max-width: 768px) {
    .container { padding: 0.5rem 0.5rem 2rem; }
    .settings-grid { grid-template-columns: 1fr 1fr; }
    .stat-card { min-width: 80px; padding: 0.5rem; }
    .stat-card .value { font-size: 1rem; }
    td { font-size: 0.78rem; padding: 0.35rem 0.4rem; min-height: 44px; }
    th { font-size: 0.68rem; padding: 0.4rem; }
    th.sortable { min-height: 44px; cursor: pointer; }
    .section { padding: 0.8rem; }
    /* Touch targets: 44px minimum */
    .sidebar-sub-item { min-height: 44px; display: flex; align-items: center; }
    .btn, .btn-blue, .btn-sm, .btn-outline { min-height: 44px; }
    .league-chip { min-height: 44px; }
    /* Prevent iOS auto-zoom on input focus */
    .field input, .field select { font-size: 16px; }
    .tp-rp-filters input, .tp-rp-filters select { font-size: 16px; }
    .filters input, .filters select { font-size: 16px; }
    select, input[type="text"], input[type="number"] { font-size: 16px; }
    /* Larger slider thumb on mobile */
    input[type="range"]::-webkit-slider-thumb { width: 24px; height: 24px; }
    input[type="range"]::-moz-range-thumb { width: 24px; height: 24px; }
    /* Spacing between tappable elements */
    .filters { gap: 8px; }
    .tp-budget-bar { gap: 8px; }
  }
  @media (max-width: 480px) {
    .settings-grid { grid-template-columns: 1fr; }
  }

  /* ==================== TRANSFER PLANNER ==================== */
  .tp-layout { display: grid; grid-template-columns: 1fr 320px; gap: 1rem; }
  @media (max-width: 900px) { .tp-layout { grid-template-columns: 1fr; } }

  .tp-budget-bar { display: flex; gap: 0.8rem; flex-wrap: wrap; margin-bottom: 1rem; }
  .tp-budget-card { background: #1B2D45; border-radius: 8px; padding: 0.6rem 1rem; text-align: center; flex: 1; min-width: 90px; }
  .tp-budget-card .tp-label { color: #8899AA; font-size: 0.68rem; text-transform: uppercase; }
  .tp-budget-card .tp-val { font-size: 1.1rem; font-weight: bold; color: #00E676; margin-top: 0.1rem; }
  .tp-budget-card .tp-val.blue { color: #4da6ff; }
  .tp-budget-card .tp-val.red { color: #FF5252; }
  .tp-budget-card .tp-val.gold { color: #FFB800; }

  .tp-squad-list { margin-bottom: 1rem; }
  .tp-player { display: flex; align-items: center; gap: 0.6rem; padding: 0.5rem 0.6rem; border-bottom: 1px solid #1B2D45; transition: background 0.15s; }
  .tp-player:hover { background: rgba(26,31,46,0.5); }
  .tp-player .tp-photo { width: 36px; height: 36px; border-radius: 50%; overflow: hidden; background: rgba(255,255,255,0.1); flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
  .tp-player .tp-photo img { width: 100%; height: 100%; object-fit: cover; object-position: top; }
  .tp-player .tp-info { flex: 1; min-width: 0; }
  .tp-player .tp-name { font-weight: 500; font-size: 0.85rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .tp-player .tp-meta { color: #8899AA; font-size: 0.72rem; }
  .tp-player .tp-stats { display: flex; gap: 0.6rem; flex-shrink: 0; font-size: 0.78rem; }
  .tp-player .tp-sell-btn { background: #FF5252; color: #fff; border: none; border-radius: 4px; padding: 0.25rem 0.5rem; font-size: 0.72rem; cursor: pointer; font-weight: 600; flex-shrink: 0; }
  .tp-player .tp-sell-btn:hover { opacity: 0.85; }
  .tp-player .tp-undo-btn { background: #4da6ff; color: #fff; border: none; border-radius: 4px; padding: 0.25rem 0.5rem; font-size: 0.72rem; cursor: pointer; font-weight: 600; flex-shrink: 0; }
  .tp-player .tp-undo-btn:hover { opacity: 0.85; }
  .tp-player.tp-sold { opacity: 0.4; }
  .tp-player.tp-new { border-left: 3px solid #51cf66; background: rgba(81,207,102,0.05); }

  .tp-replacement-panel { display: none; background: #1B2D45; border-radius: 8px; padding: 0.8rem; margin-bottom: 1rem; border: 1px solid rgba(255,255,255,0.1); }
  .tp-replacement-panel.active { display: block; }
  .tp-replacement-panel .tp-rp-title { color: #4da6ff; font-size: 0.82rem; font-weight: 600; margin-bottom: 0.6rem; display: flex; align-items: center; justify-content: space-between; }
  .tp-replacement-panel .tp-rp-close { cursor: pointer; color: #8899AA; font-size: 1.1rem; }
  .tp-replacement-panel .tp-rp-close:hover { color: #F0F0F0; }
  .tp-rp-filters { display: flex; gap: 0.5rem; margin-bottom: 0.5rem; flex-wrap: wrap; }
  .tp-rp-filters input, .tp-rp-filters select { background: #0D1B2A; border: 1px solid rgba(255,255,255,0.1); color: #F0F0F0; border-radius: 4px; padding: 0.35rem 0.5rem; font-size: 0.78rem; }
  .tp-rp-list { max-height: 300px; overflow-y: auto; }
  .tp-rp-list::-webkit-scrollbar { width: 4px; }
  .tp-rp-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 2px; }

  .tp-buy-row { display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem 0.5rem; border-bottom: 1px solid #1B2D45; font-size: 0.8rem; transition: background 0.15s; cursor: pointer; }
  .tp-buy-row:hover { background: rgba(81,207,102,0.08); }
  .tp-buy-row .tp-buy-name { flex: 1; font-weight: 500; }
  .tp-buy-row .tp-buy-meta { color: #8899AA; font-size: 0.72rem; margin-right: 0.5rem; }
  .tp-buy-row .tp-buy-btn { background: #51cf66; color: #0D1B2A; border: none; border-radius: 4px; padding: 0.2rem 0.5rem; font-size: 0.72rem; cursor: pointer; font-weight: 600; }
  .tp-buy-row .tp-buy-btn:hover { opacity: 0.85; }

  .tp-price-indicator { font-size: 0.65rem; font-weight: 600; padding: 0.1rem 0.3rem; border-radius: 3px; }
  .tp-price-up { background: rgba(81,207,102,0.15); color: #51cf66; }
  .tp-price-down { background: rgba(255,82,82,0.15); color: #FF5252; }

  .tp-transfer-summary { margin-bottom: 1rem; }
  .tp-transfer-item { display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem 0.6rem; background: #1B2D45; border-radius: 6px; margin-bottom: 0.3rem; font-size: 0.82rem; }
  .tp-transfer-item .tp-arrow { color: #00E676; font-weight: bold; margin: 0 0.2rem; }

  .tp-intel-section { margin-bottom: 1rem; }
  .tp-intel-title { color: #00E676; font-size: 0.78rem; font-weight: 600; text-transform: uppercase; margin-bottom: 0.5rem; }
  .tp-intel-item { display: flex; align-items: center; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #1B2D45; font-size: 0.78rem; }
  .tp-intel-item:last-child { border-bottom: none; }
  .tp-intel-item .tp-intel-name { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-right: 0.5rem; }
  .tp-intel-item .tp-intel-val { font-weight: 600; flex-shrink: 0; }

  /* Confirm modal */
  .tp-modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 500; align-items: center; justify-content: center; }
  .tp-modal-overlay.active { display: flex; }
  .tp-modal { background: #1B2D45; border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 1.5rem; max-width: 480px; width: 90%; max-height: 80vh; overflow-y: auto; }
  .tp-modal h3 { color: #00E676; margin-bottom: 1rem; font-size: 1rem; }
  .tp-modal .tp-modal-transfers { margin-bottom: 1rem; }
  .tp-modal .tp-modal-cost { background: #1B2D45; border-radius: 8px; padding: 0.8rem; margin-bottom: 1rem; }
  .tp-modal .tp-modal-row { display: flex; justify-content: space-between; padding: 0.2rem 0; font-size: 0.85rem; }
  .tp-modal .tp-modal-row.total { border-top: 1px solid rgba(255,255,255,0.1); margin-top: 0.3rem; padding-top: 0.4rem; font-weight: 600; }
  .tp-modal .tp-modal-actions { display: flex; gap: 0.6rem; justify-content: flex-end; }
  .tp-modal .tp-modal-actions .btn-cancel { background: rgba(255,255,255,0.1); color: #F0F0F0; border: none; border-radius: 6px; padding: 0.5rem 1rem; cursor: pointer; font-size: 0.85rem; }

  /* BPS badge on live cards */
  .live-card .lp-bps { position: absolute; bottom: 2px; left: 4px; font-size: 0.55rem; background: #4da6ff; color: #fff; border-radius: 3px; padding: 0.05rem 0.25rem; font-weight: 600; }

  /* BPS ranking section */
  .bps-ranking { margin-top: 1rem; }
  .bps-ranking-item { display: flex; align-items: center; gap: 0.5rem; padding: 0.3rem 0.5rem; border-bottom: 1px solid #1B2D45; font-size: 0.82rem; }
  .bps-ranking-item .bps-rank { width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.7rem; flex-shrink: 0; }
  .bps-ranking-item .bps-rank.gold { background: #FFB800; color: #0D1B2A; }
  .bps-ranking-item .bps-rank.silver { background: #c0c0c0; color: #0D1B2A; }
  .bps-ranking-item .bps-rank.bronze { background: #cd7f32; color: #fff; }
  .bps-ranking-item .bps-rank.none { background: rgba(255,255,255,0.1); color: #8899AA; }
  .bps-ranking-item .bps-name { flex: 1; }
  .bps-ranking-item .bps-score { color: #4da6ff; font-weight: 600; min-width: 40px; text-align: right; }
  .bps-ranking-item .bps-bonus { color: #FFB800; font-weight: bold; min-width: 24px; text-align: right; }

  /* Opta stat highlight colors */
  .opta-high { color: #00E676; font-weight: 600; }
  .opta-mid { color: #4da6ff; }
  .opta-low { color: #8899AA; }

  /* ==================== SCHEDULE GRID ==================== */
  .sched-controls { display: flex; gap: 0.8rem; flex-wrap: wrap; align-items: end; margin-bottom: 1rem; }
  .sched-controls .field { min-width: 120px; }

  .sched-grid { overflow-x: auto; -webkit-overflow-scrolling: touch; }
  .sched-grid table { min-width: 700px; border-collapse: separate; border-spacing: 0; }
  .sched-grid th, .sched-grid td { text-align: center; padding: 0; font-size: 0.72rem; border: 1px solid #1B2D45; }
  .sched-grid th { font-size: 0.65rem; padding: 0.3rem 0.15rem; background: #1B2D45; color: #8899AA; position: sticky; top: 0; z-index: 2; }
  .sched-grid th.sched-gw-current { color: #00E676; }
  .sched-grid th.sched-gw-next { color: #4da6ff; }
  .sched-grid th .gw-tag { display: block; font-size: 0.55rem; font-weight: 400; }
  .sched-grid th .gw-tag.double { color: #FFB800; }
  .sched-grid th .gw-tag.blank { color: #FF5252; }

  .sched-grid .team-col { text-align: left; font-weight: 600; min-width: 55px; padding: 0.25rem 0.4rem; position: sticky; left: 0; background: #1B2D45; z-index: 1; white-space: nowrap; border-right: 2px solid rgba(255,255,255,0.1); }
  .sched-grid .team-col .cs-rate { font-size: 0.6rem; color: #8899AA; font-weight: 400; }

  .sched-cell { padding: 0.2rem 0.1rem; min-width: 52px; cursor: default; position: relative; }
  .sched-cell.blank-gw { background: repeating-linear-gradient(45deg, #1B2D45, #1B2D45 3px, #1B2D45 3px, #1B2D45 6px); }
  .sched-cell.double-gw { border: 1px solid rgba(255,184,0,0.3); }

  .sched-fx { border-radius: 3px; padding: 0.15rem 0.1rem; margin: 1px 2px; font-weight: 600; font-size: 0.7rem; line-height: 1.3; position: relative; }
  .sched-fx .sched-opp { display: block; }
  .sched-fx .sched-ha { font-size: 0.55rem; font-weight: 400; opacity: 0.8; }
  .sched-fx .sched-date { display: none; font-size: 0.55rem; color: rgba(255,255,255,0.6); }
  .sched-cell:hover .sched-fx .sched-date { display: block; }
  .sched-fx .sched-cs { display: none; font-size: 0.55rem; }
  .sched-cell:hover .sched-fx .sched-cs { display: block; }

  /* FDR colors for schedule */
  .sched-fx.fdr-1 { background: #375523; color: #F0F0F0; }
  .sched-fx.fdr-2 { background: #01fc7a; color: #0D1B2A; }
  .sched-fx.fdr-3 { background: #8899AA; color: #fff; }
  .sched-fx.fdr-4 { background: #FF5252; color: #fff; }
  .sched-fx.fdr-5 { background: #d42020; color: #fff; }

  .sched-blank-text { color: #667788; font-size: 0.6rem; font-style: italic; }

  /* Legend */
  .sched-legend { display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 0.8rem; font-size: 0.72rem; align-items: center; }
  .sched-legend-item { display: flex; align-items: center; gap: 0.3rem; }
  .sched-legend-swatch { width: 16px; height: 12px; border-radius: 2px; display: inline-block; }

  /* Team filter highlight */
  .sched-grid tr.sched-highlight { outline: 2px solid #4da6ff; outline-offset: -1px; }

  /* Score overlay for finished */
  .sched-fx .sched-score { font-size: 0.6rem; font-weight: bold; color: rgba(255,255,255,0.9); }

  @media (max-width: 768px) {
    .sched-cell { min-width: 44px; }
    .sched-fx { font-size: 0.62rem; }
    .sched-grid .team-col { min-width: 42px; font-size: 0.65rem; }
  }

  /* ==================== VISUAL UPGRADE: Tags & Badges ==================== */
  .tag { display: inline-flex; align-items: center; gap: 0.25rem; padding: 0.15rem 0.45rem; border-radius: 6px; font-size: 0.68rem; font-weight: 600; white-space: nowrap; }
  .tag-form { background: rgba(255,107,0,0.12); color: #FFB800; border: 1px solid rgba(255,107,0,0.25); }
  .tag-form.hot { background: rgba(255,68,68,0.12); color: #FF5252; border: 1px solid rgba(255,68,68,0.25); animation: tagPulse 2s ease-in-out infinite; }
  .tag-rotation { background: rgba(255,170,0,0.12); color: #E5A600; border: 1px solid rgba(255,170,0,0.25); }
  .tag-rising { background: rgba(81,207,102,0.12); color: #51cf66; border: 1px solid rgba(81,207,102,0.25); }
  .tag-falling { background: rgba(255,82,82,0.12); color: #FF5252; border: 1px solid rgba(255,82,82,0.25); }
  .tag-captain { background: rgba(255,184,0,0.12); color: #FFB800; border: 1px solid rgba(255,184,0,0.25); }
  .tag-differential { background: rgba(77,166,255,0.12); color: #4da6ff; border: 1px solid rgba(77,166,255,0.25); }
  @keyframes tagPulse { 0%,100% { opacity: 1; } 50% { opacity: 0.7; } }

  /* Captain 2x badge */
  .captain-2x { display: inline-flex; align-items: center; gap: 0.2rem; background: linear-gradient(135deg, rgba(255,184,0,0.15), rgba(255,170,0,0.08)); border: 1px solid rgba(255,184,0,0.3); border-radius: 8px; padding: 0.2rem 0.5rem; font-size: 0.72rem; font-weight: 700; color: #FFB800; }
  .captain-2x .crown { font-size: 0.8rem; }

  /* Captain probability bar */
  .captain-prob-bar { width: 100%; height: 6px; background: #1B2D45; border-radius: 3px; overflow: hidden; margin-top: 0.3rem; }
  .captain-prob-fill { height: 100%; background: linear-gradient(90deg, #FFB800, #FFB800); border-radius: 3px; transition: width 0.5s ease; }

  /* Player tile (card variant) */
  .player-tile { display: flex; align-items: center; gap: 0.7rem; background: rgba(27,45,69,0.7); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-radius: 12px; padding: 0.6rem 0.8rem; border: 1px solid rgba(255,255,255,0.08); transition: all 0.2s; margin-bottom: 0.4rem; }
  .player-tile:hover { transform: translateX(3px); border-color: rgba(255,255,255,0.12); box-shadow: 0 2px 12px rgba(0,0,0,0.2); }
  .player-tile .pt-photo { width: 40px; height: 40px; border-radius: 50%; overflow: hidden; background: rgba(255,255,255,0.1); flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
  .player-tile .pt-photo img { width: 100%; height: 100%; object-fit: cover; object-position: top; }
  .player-tile .pt-info { flex: 1; min-width: 0; }
  .player-tile .pt-name { font-weight: 600; font-size: 0.88rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .player-tile .pt-meta { display: flex; gap: 0.5rem; align-items: center; margin-top: 0.15rem; }
  .player-tile .pt-team { color: #8899AA; font-size: 0.75rem; }
  .player-tile .pt-badges { display: flex; gap: 0.3rem; flex-wrap: wrap; }
  .player-tile .pt-cost { background: linear-gradient(135deg, rgba(255,184,0,0.1), rgba(255,184,0,0.05)); color: #FFB800; font-weight: 700; font-size: 0.72rem; padding: 0.1rem 0.4rem; border-radius: 6px; border: 1px solid rgba(255,184,0,0.2); }
  .player-tile .pt-own { color: #8899AA; font-size: 0.72rem; }
  .player-tile .pt-value { font-weight: 700; font-size: 1rem; flex-shrink: 0; }

  /* Gradient text utility */
  .gradient-text { background: linear-gradient(135deg, #00E676, #4da6ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }

  /* Glow effects */
  .glow-green { text-shadow: 0 0 10px rgba(0,230,118,0.3); }
  .glow-blue { text-shadow: 0 0 10px rgba(77,166,255,0.3); }
  .glow-gold { text-shadow: 0 0 10px rgba(255,184,0,0.3); }

  /* Smooth page transitions */
  .nav-panel { animation: panelFadeIn 0.3s ease; }
  @keyframes panelFadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

  /* Scrollbar styling */
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: #0D1B2A; }
  ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.15); }

  /* Input focus glow */
  .field input:focus, .field select:focus { box-shadow: 0 0 0 2px rgba(0,230,118,0.15); }

  /* Draft badge upgrade */
  .draft-badge { background: linear-gradient(135deg, #1a2540, #1e3050); }

  /* Fixture card upgrade */
  .fixture-card { background: rgba(27,45,69,0.7); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-radius: 12px; border: 1px solid rgba(255,255,255,0.08); transition: transform 0.15s, box-shadow 0.15s; }
  .fixture-card:hover { transform: translateX(2px); box-shadow: 0 2px 10px rgba(0,0,0,0.2); }

  /* Price card upgrade */
  .price-card { background: rgba(27,45,69,0.7); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-radius: 12px; border: 1px solid rgba(255,255,255,0.08); transition: transform 0.15s; }
  .price-card:hover { transform: translateX(2px); }

  /* League chip hover glow */
  .league-chip { transition: all 0.2s; }
  .league-chip:hover { box-shadow: 0 2px 10px rgba(77,166,255,0.15); }

  /* Waiver card upgrade */
  .waiver-card { background: rgba(27,45,69,0.7); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-radius: 12px; transition: transform 0.2s, border-color 0.15s, box-shadow 0.2s; }
  .waiver-card:hover { border-color: #4da6ff; transform: translateY(-2px); box-shadow: 0 4px 16px rgba(0,0,0,0.3); }

  /* ==================== DEMO BANNER ==================== */
  .demo-banner { background: linear-gradient(90deg, rgba(77,166,255,0.1), rgba(0,230,118,0.06)); border: 1px solid rgba(77,166,255,0.25); border-radius: 12px; padding: 0.6rem 1rem; margin-bottom: 1rem; }
  .demo-banner.hidden { display: none; }
  .demo-banner-content { display: flex; align-items: center; gap: 0.8rem; flex-wrap: wrap; }
  .demo-badge { background: linear-gradient(135deg, #00E676, #00C853); color: #0D1B2A; font-family: 'Space Grotesk', sans-serif; font-weight: 700; font-size: 0.68rem; padding: 0.15rem 0.5rem; border-radius: 5px; letter-spacing: 0.06em; flex-shrink: 0; }
  .demo-banner .demo-text { color: #8899AA; font-size: 0.82rem; flex: 1; }
  .demo-banner .btn { font-size: 0.78rem; padding: 0.35rem 1rem; }
  .demo-dismiss { color: #667788; font-size: 1.2rem; cursor: pointer; padding: 0 0.3rem; line-height: 1; }
  .demo-dismiss:hover { color: #FF5252; }
  .demo-inline-notice { background: linear-gradient(90deg, rgba(77,166,255,0.08), rgba(0,230,118,0.04)); border: 1px solid rgba(77,166,255,0.2); border-radius: 8px; padding: 0.4rem 0.8rem; margin-bottom: 0.8rem; font-size: 0.8rem; color: #8899AA; display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; }
  .demo-inline-notice .demo-badge { font-size: 0.6rem; }

  /* ==================== BOTTOM NAVIGATION (MOBILE) ==================== */
  .bottom-nav { display: none; }
  .more-menu-mobile { display: none; }
  .more-menu-overlay { display: none; }

  @media (max-width: 768px) {
    .bottom-nav {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      position: fixed;
      bottom: 0; left: 0; right: 0;
      height: 60px;
      background: linear-gradient(180deg, #1B2D45 0%, #0D1B2A 100%);
      border-top: 1px solid rgba(255,255,255,0.08);
      z-index: 300;
    }
    .bottom-nav button {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      gap: 2px; background: none; border: none; color: #667788;
      cursor: pointer; padding: 6px 0; transition: color 0.15s;
      -webkit-tap-highlight-color: transparent;
    }
    .bottom-nav button.active { color: #00E676; }
    .bn-icon { font-size: 1.3rem; line-height: 1; }
    .bn-label { font-size: 0.62rem; font-weight: 600; letter-spacing: 0.02em; text-transform: uppercase; }

    /* More menu slide-up */
    .more-menu-overlay.active { display: block; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 280; }
    .more-menu-mobile.active {
      display: block; position: fixed; bottom: 60px; left: 0; right: 0;
      max-height: 55vh; background: #1B2D45;
      border-top: 1px solid rgba(255,255,255,0.1);
      border-radius: 16px 16px 0 0; z-index: 290;
      overflow-y: auto; padding: 0.8rem 0;
      box-shadow: 0 -4px 24px rgba(0,0,0,0.4);
      animation: mmSlideUp 0.25s ease;
      -webkit-overflow-scrolling: touch;
    }
    @keyframes mmSlideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .mm-header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 0 1rem 0.6rem; border-bottom: 1px solid rgba(255,255,255,0.08); margin-bottom: 0.4rem;
    }
    .mm-header span { color: #8899AA; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em; }
    .mm-close { background: none; border: none; color: #667788; font-size: 1.3rem; cursor: pointer; padding: 0.2rem; }
    .mm-close:hover { color: #FF5252; }
    .mm-group-title { color: #667788; font-size: 0.68rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em; padding: 0.5rem 1rem 0.2rem; }
    .mm-item {
      display: flex; align-items: center; gap: 0.7rem;
      padding: 0.65rem 1rem; color: #8899AA; font-size: 0.88rem;
      cursor: pointer; transition: all 0.15s; min-height: 44px;
      -webkit-tap-highlight-color: transparent;
    }
    .mm-item:hover, .mm-item:active { color: #F0F0F0; background: rgba(255,255,255,0.04); }
    .mm-item .mm-icon { font-size: 1rem; width: 1.4rem; text-align: center; flex-shrink: 0; }
    .mm-divider { height: 1px; background: rgba(255,255,255,0.06); margin: 0.3rem 1rem; }

    /* ==================== TABLE CARD-MODE (MOBILE) ==================== */
    .table-wrap.card-mode table,
    .table-wrap.card-mode thead,
    .table-wrap.card-mode tbody,
    .table-wrap.card-mode tr,
    .table-wrap.card-mode td { display: block; }
    .table-wrap.card-mode thead { display: none; }
    .table-wrap.card-mode table { min-width: 0; }
    .table-wrap.card-mode tr {
      background: rgba(27,45,69,0.7);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 12px;
      padding: 0.8rem;
      margin-bottom: 0.6rem;
    }
    .table-wrap.card-mode td {
      display: flex; justify-content: space-between; align-items: center;
      padding: 0.2rem 0; border: none; text-align: right;
    }
    .table-wrap.card-mode td::before {
      content: attr(data-label);
      color: #8899AA; font-size: 0.72rem; font-weight: 600;
      text-align: left; margin-right: 0.5rem; flex-shrink: 0;
    }
    /* First td in card = player name, make it prominent */
    .table-wrap.card-mode tr td:first-child {
      font-size: 0.95rem; font-weight: 600; border-bottom: 1px solid rgba(255,255,255,0.06);
      padding-bottom: 0.4rem; margin-bottom: 0.2rem;
    }

    /* ==================== FROZEN COLUMN SHADOW (MOBILE) ==================== */
    .fdr-grid .team-col,
    .sched-grid .team-col { box-shadow: 4px 0 8px rgba(0,0,0,0.3); }

    /* ==================== MOBILE CONTENT PRIORITIZATION ==================== */
    /* Dashboard: secondary sections behind accordion */
    .dash-rail .dash-section { border: 1px solid rgba(255,255,255,0.06); border-radius: 10px; margin-bottom: 0.5rem; }
    .dash-rail .dash-section-title {
      cursor: pointer; padding: 0.7rem; margin: 0;
      display: flex; align-items: center; justify-content: space-between;
    }
    .dash-rail .dash-section-title::after { content: '\25BC'; font-size: 0.6rem; color: #667788; transition: transform 0.2s; }
    .dash-rail .dash-section-title.collapsed::after { transform: rotate(-90deg); }
    .dash-rail .dash-section .dash-rail-list { padding: 0 0.7rem 0.7rem; }
    .dash-rail .dash-section .dash-rail-list.collapsed { display: none; }

    /* Quick links: full-width stack */
    .dash-bottom-grid { grid-template-columns: 1fr !important; }

    /* Sticky optimize CTA */
    .sticky-connect-cta {
      display: none; position: fixed; bottom: 60px; left: 0; right: 0;
      background: linear-gradient(135deg, #1B2D45, #0D1B2A); border-top: 1px solid rgba(0,230,118,0.3);
      padding: 0.5rem 1rem; z-index: 240; align-items: center; justify-content: space-between;
      gap: 0.5rem; font-size: 0.8rem; color: #8899AA;
    }
    .sticky-connect-cta.visible { display: flex; }
    .sticky-connect-cta .btn { flex-shrink: 0; }
    .sticky-optimize {
      position: fixed; bottom: 68px; left: 0; right: 0;
      padding: 0.6rem 1rem; background: linear-gradient(180deg, transparent, #0D1B2A 30%);
      z-index: 250; display: none;
    }
    .sticky-optimize.visible { display: block; }
    .sticky-optimize .btn { width: 100%; padding: 0.75rem; font-size: 1rem; }
    /* Mobile: show cards, hide tables in My Team */
    .myteam-mobile-cards { display: flex !important; }
    .myteam-desktop-table { display: none !important; }
  }
  @media (min-width: 769px) {
    .myteam-mobile-cards { display: none !important; }
  }

  /* Item 15: Sticky headers + frozen columns */
  .table-wrap { max-height: 70vh; overflow: auto; }
  .table-wrap th { position: sticky; top: 0; z-index: 2; background: #1B2D45; }
  .table-freeze td:first-child, .table-freeze th:first-child {
    position: sticky; left: 0; z-index: 2; background: #1B2D45;
  }
  .table-freeze th:first-child { z-index: 3; }

  /* Item 16: Column selector */
  .column-selector { position: relative; display: inline-block; margin-bottom: 0.5rem; }
  .column-popover {
    position: absolute; top: 100%; left: 0; z-index: 50;
    background: #1B2D45; border: 1px solid rgba(255,255,255,0.1);
    border-radius: 8px; padding: 0.6rem; min-width: 200px;
    max-height: 300px; overflow-y: auto;
    box-shadow: 0 4px 20px rgba(0,0,0,0.4); display: none;
  }
  .column-popover.open { display: block; }
  .column-popover label { display: block; padding: 0.25rem 0; font-size: 0.8rem; color: #AABBCC; cursor: pointer; }
  .column-popover label:hover { color: #F0F0F0; }
  .column-popover input[type="checkbox"] { margin-right: 0.4rem; accent-color: #00E676; }

  /* Player drilldown modal (Item 17) */
  .player-modal-overlay {
    position: fixed; inset: 0; z-index: 500;
    background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; padding: 1rem;
  }
  .player-modal-overlay.hidden { display: none; }
  .player-modal {
    background: #1B2D45; border-radius: 16px; max-width: 480px; width: 100%;
    max-height: 85vh; overflow-y: auto; padding: 1.5rem;
    border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 8px 40px rgba(0,0,0,0.5);
    position: relative;
  }
  .modal-close {
    position: absolute; top: 0.6rem; right: 0.8rem;
    background: none; border: none; color: #8899AA; font-size: 1.5rem; cursor: pointer; z-index: 1;
  }
  .modal-close:hover { color: #FF5252; }
  .pm-header { display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; }
  .pm-photo { width: 56px; height: 56px; border-radius: 50%; overflow: hidden; background: rgba(255,255,255,0.06); flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
  .pm-photo img { width: 100%; height: 100%; object-fit: cover; object-position: top; }
  .pm-name { font-size: 1.1rem; font-weight: 700; }
  .pm-meta { color: #8899AA; font-size: 0.82rem; }
  .pm-fixtures { display: flex; gap: 0.3rem; margin-bottom: 1rem; flex-wrap: wrap; }
  .pm-fixture { text-align: center; padding: 0.3rem 0.5rem; border-radius: 6px; font-size: 0.72rem; line-height: 1.3; }
  .pm-fixture .gw-label { font-size: 0.6rem; opacity: 0.7; display: block; }
  .pm-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.4rem; margin-bottom: 1rem; }
  .pm-stat { background: rgba(13,27,42,0.5); border-radius: 8px; padding: 0.5rem; text-align: center; }
  .pm-stat .label { font-size: 0.65rem; color: #8899AA; margin-bottom: 0.2rem; }
  .pm-stat .value { font-size: 0.95rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
  .pm-breakdown { margin-top: 0.8rem; }
  .pm-breakdown-row { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.3rem; font-size: 0.78rem; }
  .pm-breakdown-label { width: 100px; color: #8899AA; flex-shrink: 0; }
  .pm-breakdown-bar { flex: 1; height: 6px; background: rgba(255,255,255,0.06); border-radius: 3px; overflow: hidden; }
  .pm-breakdown-fill { height: 100%; border-radius: 3px; background: #00E676; transition: width 0.3s; }
  .pm-breakdown-val { width: 40px; text-align: right; font-family: 'JetBrains Mono', monospace; }
</style>
</head>
<body>

<!-- Mobile top bar -->
<div class="mobile-topbar">
  <button class="hamburger" onclick="toggleSidebar()">&#9776;</button>
  <div class="logo-monogram">
    <span class="logo-fpl">FPL</span>
    <svg class="logo-o" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
      <circle cx="20" cy="20" r="16" stroke="#00E676" stroke-width="2.5" opacity="0.9"/>
      <line x1="20" y1="20" x2="20" y2="4" stroke="rgba(255,255,255,0.15)" stroke-width="0.7"/>
      <line x1="20" y1="20" x2="35.2" y2="15.1" stroke="rgba(255,255,255,0.15)" stroke-width="0.7"/>
      <line x1="20" y1="20" x2="29.4" y2="32.9" stroke="rgba(255,255,255,0.15)" stroke-width="0.7"/>
      <line x1="20" y1="20" x2="10.6" y2="32.9" stroke="rgba(255,255,255,0.15)" stroke-width="0.7"/>
      <line x1="20" y1="20" x2="4.8" y2="15.1" stroke="rgba(255,255,255,0.15)" stroke-width="0.7"/>
      <polygon points="20,6.4 28.4,17.3 28.9,32.3 16.2,25.2 9.4,16.5" fill="rgba(0,230,118,0.2)" stroke="#00E676" stroke-width="1.3" stroke-linejoin="round"/>
      <circle cx="20" cy="6.4" r="1.5" fill="#00E676"/>
      <circle cx="28.4" cy="17.3" r="1.5" fill="#00E676"/>
      <circle cx="28.9" cy="32.3" r="1.5" fill="#00E676"/>
      <circle cx="16.2" cy="25.2" r="1.5" fill="#00E676"/>
      <circle cx="9.4" cy="16.5" r="1.5" fill="#00E676"/>
    </svg>
    <span class="logo-sub">ptimizer</span>
  </div>
</div>
<div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>

<div class="app-shell">

  <!-- ==================== SIDEBAR ==================== -->
  <nav class="sidebar" id="sidebar">
    <div class="sidebar-brand">
      <h1>
        <div class="logo-monogram">
          <span class="logo-fpl">FPL</span>
          <svg class="logo-o" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <circle cx="20" cy="20" r="16" stroke="#00E676" stroke-width="2.5" opacity="0.9"/>
            <line x1="20" y1="20" x2="20" y2="4" stroke="rgba(255,255,255,0.15)" stroke-width="0.7"/>
            <line x1="20" y1="20" x2="35.2" y2="15.1" stroke="rgba(255,255,255,0.15)" stroke-width="0.7"/>
            <line x1="20" y1="20" x2="29.4" y2="32.9" stroke="rgba(255,255,255,0.15)" stroke-width="0.7"/>
            <line x1="20" y1="20" x2="10.6" y2="32.9" stroke="rgba(255,255,255,0.15)" stroke-width="0.7"/>
            <line x1="20" y1="20" x2="4.8" y2="15.1" stroke="rgba(255,255,255,0.15)" stroke-width="0.7"/>
            <polygon points="20,6.4 28.4,17.3 28.9,32.3 16.2,25.2 9.4,16.5" fill="rgba(0,230,118,0.2)" stroke="#00E676" stroke-width="1.3" stroke-linejoin="round"/>
            <circle cx="20" cy="6.4" r="1.5" fill="#00E676"/>
            <circle cx="28.4" cy="17.3" r="1.5" fill="#00E676"/>
            <circle cx="28.9" cy="32.3" r="1.5" fill="#00E676"/>
            <circle cx="16.2" cy="25.2" r="1.5" fill="#00E676"/>
            <circle cx="9.4" cy="16.5" r="1.5" fill="#00E676"/>
          </svg>
          <span class="logo-sub">ptimizer</span>
        </div>
      </h1>
      <div class="subtitle">Fantasy Premier League analytics</div>
    </div>

    <div class="sidebar-nav">
      <!-- Dashboard -->
      <div class="sidebar-item active" data-nav="nav-dashboard" onclick="switchNav('nav-dashboard')">
        <span class="si-icon">&#9733;</span>
        <span class="si-label">Dashboard</span>
      </div>

      <!-- Team Management -->
      <div class="sidebar-item" onclick="toggleSidebarSub('sub-team', this)">
        <span class="si-icon">&#9917;</span>
        <span class="si-label">Team Management</span>
        <span class="si-arrow">&#9654;</span>
      </div>
      <div class="sidebar-sub" id="sub-team">
        <div class="sidebar-sub-item" data-nav="nav-team-live" onclick="switchNav('nav-team-live')">Live GW</div>
        <div class="sidebar-sub-item" data-nav="nav-team-myteam" onclick="switchNav('nav-team-myteam')">My Team</div>
      </div>

      <!-- Transfers -->
      <div class="sidebar-item" onclick="toggleSidebarSub('sub-transfers', this)">
        <span class="si-icon">&#8644;</span>
        <span class="si-label">Transfers</span>
        <span class="si-arrow">&#9654;</span>
      </div>
      <div class="sidebar-sub" id="sub-transfers">
        <div class="sidebar-sub-item" data-nav="nav-transfers-planner" onclick="switchNav('nav-transfers-planner')">Transfer Planner</div>
        <div class="sidebar-sub-item" data-nav="nav-transfers-suggestions" onclick="switchNav('nav-transfers-suggestions')">Suggestions</div>
        <div class="sidebar-sub-item" data-nav="nav-transfers-optimizer" onclick="switchNav('nav-transfers-optimizer')">Squad Optimizer</div>
        <div class="sidebar-sub-item" data-nav="nav-transfers-multigw" onclick="switchNav('nav-transfers-multigw')">Multi-GW Planner</div>
        <div class="sidebar-sub-item" data-nav="nav-transfers-chips" onclick="switchNav('nav-transfers-chips')">Chip Strategy</div>
        <div class="sidebar-sub-item" data-nav="nav-transfers-gain" onclick="switchNav('nav-transfers-gain')">Gain vs Hit</div>
      </div>

      <!-- Leagues -->
      <div class="sidebar-item" onclick="toggleSidebarSub('sub-leagues', this)">
        <span class="si-icon">&#127942;</span>
        <span class="si-label">Leagues</span>
        <span class="si-arrow">&#9654;</span>
      </div>
      <div class="sidebar-sub" id="sub-leagues">
        <div class="sidebar-sub-item" data-nav="nav-leagues-standings" onclick="switchNav('nav-leagues-standings')">Standings</div>
        <div class="sidebar-sub-item" data-nav="nav-leagues-rival" onclick="switchNav('nav-leagues-rival')">Rival Comparison</div>
      </div>

      <!-- Fixtures -->
      <div class="sidebar-item" onclick="toggleSidebarSub('sub-fixtures', this)">
        <span class="si-icon">&#128197;</span>
        <span class="si-label">Fixtures</span>
        <span class="si-arrow">&#9654;</span>
      </div>
      <div class="sidebar-sub" id="sub-fixtures">
        <div class="sidebar-sub-item" data-nav="nav-fixtures-schedule" onclick="switchNav('nav-fixtures-schedule')">Schedule & CS%</div>
        <div class="sidebar-sub-item" data-nav="nav-fixtures-fdr" onclick="switchNav('nav-fixtures-fdr')">FDR Heatmap</div>
        <div class="sidebar-sub-item" data-nav="nav-fixtures-list" onclick="switchNav('nav-fixtures-list')">Fixture List</div>
        <div class="sidebar-sub-item" data-nav="nav-fixtures-swing" onclick="switchNav('nav-fixtures-swing')">Swing & Rotation</div>
      </div>

      <!-- Player Stats -->
      <div class="sidebar-item" onclick="toggleSidebarSub('sub-playerstats', this)">
        <span class="si-icon">&#128202;</span>
        <span class="si-label">Player Stats</span>
        <span class="si-arrow">&#9654;</span>
      </div>
      <div class="sidebar-sub" id="sub-playerstats">
        <div class="sidebar-sub-item" data-nav="nav-playerstats-table" onclick="switchNav('nav-playerstats-table')">Player Search</div>
        <div class="sidebar-sub-item" data-nav="nav-playerstats-opta" onclick="switchNav('nav-playerstats-opta')">Opta Stats & BPS</div>
        <div class="sidebar-sub-item" data-nav="nav-playerstats-compare" onclick="switchNav('nav-playerstats-compare')">Compare</div>
      </div>

      <!-- News & Updates -->
      <div class="sidebar-item" onclick="toggleSidebarSub('sub-news', this)">
        <span class="si-icon">&#128240;</span>
        <span class="si-label">News &amp; Updates</span>
        <span class="si-arrow">&#9654;</span>
      </div>
      <div class="sidebar-sub" id="sub-news">
        <div class="sidebar-sub-item" data-nav="nav-news-captain" onclick="switchNav('nav-news-captain')">Captain Picks</div>
        <div class="sidebar-sub-item" data-nav="nav-news-prices" onclick="switchNav('nav-news-prices')">Price Changes</div>
        <div class="sidebar-sub-item" data-nav="nav-news-differentials" onclick="switchNav('nav-news-differentials')">Differentials</div>
        <div class="sidebar-sub-item" data-nav="nav-news-rotation" onclick="switchNav('nav-news-rotation')">Rotation Risk</div>
        <div class="sidebar-sub-item" data-nav="nav-news-ownership" onclick="switchNav('nav-news-ownership')">Ownership & EO</div>
        <div class="sidebar-sub-item" data-nav="nav-news-ranksim" onclick="switchNav('nav-news-ranksim')">Rank Simulator</div>
      </div>

      <!-- Draft / Waivers -->
      <div class="sidebar-item" onclick="toggleSidebarSub('sub-draft', this)">
        <span class="si-icon">&#128221;</span>
        <span class="si-label">Draft / Waivers</span>
        <span class="si-arrow">&#9654;</span>
      </div>
      <div class="sidebar-sub" id="sub-draft">
        <div class="sidebar-sub-item" data-nav="nav-draft-rankings" onclick="switchNav('nav-draft-rankings')">Draft Rankings</div>
        <div class="sidebar-sub-item" data-nav="nav-draft-waiver" onclick="switchNav('nav-draft-waiver')">Waiver Wire</div>
        <div class="sidebar-sub-item" data-nav="nav-draft-roster" onclick="switchNav('nav-draft-roster')">My Roster</div>
      </div>

      <div class="sidebar-divider"></div>

      <!-- Settings -->
      <div class="sidebar-item" data-nav="nav-settings" onclick="switchNav('nav-settings')">
        <span class="si-icon">&#9881;</span>
        <span class="si-label">Settings</span>
      </div>
    </div>
  </nav>

  <!-- ==================== MAIN CONTENT ==================== -->
  <div class="main-content">
    <div class="fixture-ticker" id="fixture-ticker">
      <div class="ticker-track" id="ticker-track"><span style="color:#555;font-size:0.75rem;">Loading fixtures...</span></div>
    </div>
    <!-- Persistent User Header Bar -->
    <div class="user-header-bar" id="user-header-bar">
      <span class="uhb-name" id="uhb-name"></span>
      <div class="uhb-item"><span class="uhb-label">Rank</span><span class="uhb-value blue" id="uhb-rank">-</span></div>
      <div class="uhb-item"><span class="uhb-label">Points</span><span class="uhb-value green" id="uhb-points">-</span></div>
      <div class="uhb-item"><span class="uhb-label">GW Pts</span><span class="uhb-value" id="uhb-gw-pts">-</span></div>
      <div class="uhb-item"><span class="uhb-label">Value</span><span class="uhb-value gold" id="uhb-value">-</span></div>
      <div class="uhb-item"><span class="uhb-label">Bank</span><span class="uhb-value gold" id="uhb-bank">-</span></div>
      <div class="uhb-item"><span class="uhb-label">FTs</span><span class="uhb-value" id="uhb-fts">-</span></div>
      <div class="uhb-item" id="uhb-chips-wrap"><span class="uhb-label">Chips</span><span id="uhb-chips"></span></div>
      <button class="uhb-sync" onclick="syncUser()" id="uhb-sync-btn">&#x21bb; Sync</button>
      <span class="inline-spinner" id="uhb-sync-spinner"></span>
      <span style="color:#555;font-size:0.65rem;" id="uhb-last-sync"></span>
    </div>
    <div class="container">

      <!-- ==================== DASHBOARD ==================== -->
      <div class="nav-panel active" id="nav-dashboard">

        <!-- Welcome -->
        <div class="dash-welcome">
          <h2 id="dash-title">Dashboard</h2>
          <p id="dash-subtitle">Load your FPL ID in <a href="#" onclick="switchNav('nav-settings');return false" style="color:#4da6ff">Settings</a> to see your live overview.</p>
        </div>

        <!-- Top stats -->
        <div class="dash-stats" id="dash-stats">
          <div class="dash-stat">
            <div class="ds-value" id="dash-total">--</div>
            <div class="ds-label">Total Points</div>
            <div class="ds-sub" id="dash-total-sub"></div>
          </div>
          <div class="dash-stat">
            <div class="ds-value blue" id="dash-gw-pts">--</div>
            <div class="ds-label" id="dash-gw-label">GW Points</div>
            <div class="ds-sub" id="dash-hits-sub"></div>
          </div>
          <div class="dash-stat">
            <div class="ds-value" id="dash-rank">--</div>
            <div class="ds-label">Overall Rank</div>
            <div class="ds-sub" id="dash-rank-sub"></div>
          </div>
          <div class="dash-stat">
            <div class="ds-value blue" id="dash-league-rank">--</div>
            <div class="ds-label">League Rank</div>
            <div class="ds-sub" id="dash-league-sub"></div>
          </div>
        </div>

        <!-- Demo banner -->
        <div id="demo-banner" class="demo-banner hidden">
          <div class="demo-banner-content">
            <span class="demo-badge">DEMO</span>
            <span class="demo-text">You're viewing sample data  this is not your real team.</span>
            <button class="btn btn-sm" onclick="switchNav('nav-settings');setTimeout(()=>$('user-id').focus(),100);">Connect your team &rarr;</button>
          </div>
        </div>

        <!-- Onboarding: shown when no user connected -->
        <div id="dash-empty-state">
          <div class="onboarding-card">
            <div class="ob-icon">&#9917;</div>
            <h3 class="ob-title">Connect your FPL team to unlock your dashboard</h3>
            <div class="ob-benefits">
              <div class="ob-benefit"><span class="ob-check">&#10003;</span> See your live squad and points in real time</div>
              <div class="ob-benefit"><span class="ob-check">&#10003;</span> Get personalized transfer suggestions with expected points gain</div>
              <div class="ob-benefit"><span class="ob-check">&#10003;</span> Track your rank, league position and chip strategy</div>
            </div>
            <div class="ob-actions">
              <button class="btn" onclick="switchNav('nav-settings');setTimeout(()=>$('user-id').focus(),100);">Connect My Team</button>
              <a href="#" class="ob-demo-link" onclick="activateDemo();return false;">or try with demo data</a>
            </div>
          </div>
          <div class="dash-grid" style="margin-top:1rem;">
            <div class="dash-card" onclick="switchNav('nav-transfers-optimizer')">
              <div class="dc-icon">&#9889;</div>
              <div class="dc-title">Squad Optimizer</div>
              <div class="dc-desc">Find the optimal 15-man squad</div>
            </div>
            <div class="dash-card" onclick="switchNav('nav-news-captain')">
              <div class="dc-icon">&#169;</div>
              <div class="dc-title">Captain Picks</div>
              <div class="dc-desc">Best captain choices for next GW</div>
            </div>
            <div class="dash-card" onclick="switchNav('nav-fixtures-fdr')">
              <div class="dc-icon">&#128197;</div>
              <div class="dc-title">FDR Heatmap</div>
              <div class="dc-desc">Fixture difficulty at a glance</div>
            </div>
            <div class="dash-card" onclick="switchNav('nav-playerstats-table')">
              <div class="dc-icon">&#128202;</div>
              <div class="dc-title">Player Stats</div>
              <div class="dc-desc">Search and filter all players</div>
            </div>
          </div>
        </div>

        <!-- Live dashboard (hidden until user loaded) -->
        <div id="dash-live" class="hidden">
          <div class="loader" id="dash-loader"><div class="spinner"></div><div class="loader-text">Loading dashboard...</div></div>

          <!-- Mid section: pitch + right rail -->
          <div class="dash-body">
            <div class="dash-mid">

              <!-- Captain highlight -->
              <div class="dash-section">
                <div class="dash-section-title">Captain <span class="ds-link" onclick="switchNav('nav-news-captain')">Captain picks &#8250;</span></div>
                <div id="dash-captain-slot">
                  <div style="color:#555;font-size:0.82rem;">No captain data yet</div>
                </div>
              </div>

              <!-- Starting XI mini pitch -->
              <div class="dash-section">
                <div class="dash-section-title">Starting XI <span class="ds-link" onclick="switchNav('nav-team-live')">Full view &#8250;</span></div>
                <div class="dash-pitch" id="dash-pitch-slot"></div>
              </div>

              <!-- Bonus tracking -->
              <div class="dash-section">
                <div class="dash-section-title">Bonus Points</div>
                <div class="dash-bonus" id="dash-bonus-slot">
                  <div style="color:#555;font-size:0.82rem;">No bonus data yet</div>
                </div>
              </div>

            </div>

            <!-- Right rail -->
            <div class="dash-rail">

              <!-- Injuries / Suspensions -->
              <div class="dash-section">
                <div class="dash-section-title" style="color:#FF5252;">Injuries &amp; News</div>
                <div class="dash-rail-list" id="dash-injuries-slot">
                  <div style="color:#555;font-size:0.82rem;">Loading...</div>
                </div>
              </div>

              <!-- Price changes -->
              <div class="dash-section">
                <div class="dash-section-title" style="color:#51cf66;">Price Changes <span class="ds-link" onclick="switchNav('nav-news-prices')">All &#8250;</span></div>
                <div class="dash-rail-list" id="dash-prices-slot">
                  <div style="color:#555;font-size:0.82rem;">Loading...</div>
                </div>
              </div>

            </div>
          </div>

          <!-- Bottom: bench + fixtures -->
          <div class="dash-bottom">
            <div class="dash-section">
              <div class="dash-section-title">Bench</div>
              <div class="dash-bench" id="dash-bench-slot">
                <div style="color:#555;font-size:0.82rem;">No bench data</div>
              </div>
            </div>
            <div class="dash-section">
              <div class="dash-section-title">Upcoming Fixtures <span class="ds-link" onclick="switchNav('nav-fixtures-list')">All &#8250;</span></div>
              <div id="dash-fixtures-slot">
                <div style="color:#555;font-size:0.82rem;">Loading...</div>
              </div>
            </div>
          </div>
        </div>

      </div>

      <!-- ==================== TEAM: LIVE GW ==================== -->
      <div class="nav-panel" id="nav-team-live">
        <div class="section">
          <div class="section-title blue">Live Gameweek Points</div>
          <p id="live-no-user" style="color:#8899AA;font-size:0.85rem;">Load your FPL User ID in <a href="#" onclick="switchNav('nav-settings');return false" style="color:#4da6ff">Settings</a> to see live points.</p>
          <div id="live-content" class="hidden">
            <div class="stat-row" id="live-stats"></div>
            <div id="live-captain-bar"></div>
            <div class="live-action-bar" id="live-action-bar">
              <button class="btn-captain" onclick="enterCaptainMode('captain')">Set Captain</button>
              <button class="btn-vice" onclick="enterCaptainMode('vice')">Set Vice</button>
              <span id="live-formation-badge" class="formation-badge"></span>
              <span id="live-save-indicator" class="live-save-indicator">Saved</span>
            </div>
            <div class="pitch" id="live-pitch"></div>
            <div class="bps-ranking" id="live-bps-ranking"></div>
          </div>
          <div class="loader" id="live-loader"><div class="spinner"></div><div class="loader-text">Loading live data...</div></div>
        </div>
      </div>

      <!-- ==================== TEAM: MY TEAM ==================== -->
      <div class="nav-panel" id="nav-team-myteam">
        <div id="myteam-no-data">
          <div class="section">
            <p style="color:#8899AA;font-size:0.85rem;">Run the <a href="#" onclick="switchNav('nav-transfers-optimizer');return false" style="color:#4da6ff">Squad Optimizer</a> with your FPL ID loaded to see your team here.</p>
          </div>
        </div>
        <div id="myteam-content" class="hidden">
          <!-- Squad analysis summary (Item 3) -->
          <div id="squad-analysis" class="hidden">
            <div class="section" style="border-left: 3px solid #00E676;">
              <div style="display:flex;align-items:center;gap:1rem;flex-wrap:wrap;">
                <div id="squad-score-display" style="text-align:center;min-width:70px;">
                  <div style="font-size:2rem;font-weight:800;font-family:'JetBrains Mono',monospace;" id="squad-score-value">--</div>
                  <div style="font-size:0.7rem;color:#8899AA;">Squad Score</div>
                </div>
                <div style="flex:1;min-width:200px;">
                  <div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.4rem;">
                    <span style="font-size:0.8rem;font-weight:600;">Fixture Outlook:</span>
                    <span id="squad-fixture-badge" class="chip-badge"></span>
                  </div>
                  <div id="squad-weaknesses"></div>
                  <div id="squad-strengths"></div>
                </div>
              </div>
            </div>
          </div>
          <div class="stat-row" id="user-summary"></div>
          <div class="section">
            <div class="section-title blue">My Starting XI</div>
            <div class="table-wrap myteam-desktop-table">
              <table class="table-freeze"><thead><tr><th>Pos</th><th>Player</th><th>Team</th><th class="right">Cost</th><th class="right">Form</th><th class="right">PPG</th><th class="right">xG</th><th class="right">xA</th><th class="right">Score</th></tr></thead>
              <tbody id="user-starting-body"></tbody></table>
            </div>
            <div class="player-card-list myteam-mobile-cards" id="user-starting-cards"></div>
          </div>
          <div class="section">
            <div class="section-title blue">My Bench</div>
            <div class="table-wrap myteam-desktop-table">
              <table><thead><tr><th>Pos</th><th>Player</th><th>Team</th><th class="right">Cost</th><th class="right">Score</th></tr></thead>
              <tbody id="user-bench-body"></tbody></table>
            </div>
            <div class="player-card-list myteam-mobile-cards" id="user-bench-cards"></div>
          </div>
          <div class="section hidden" id="user-transfers-section">
            <div class="section-title blue">Suggested Transfers</div>
            <div class="table-wrap">
              <table><thead><tr><th>#</th><th>Out</th><th>In</th><th class="right">Gain</th><th class="right" title="Expected points gain next GW">EP Gain</th><th class="right">Cost</th></tr></thead>
              <tbody id="user-transfers-body"></tbody></table>
            </div>
          </div>
        </div>
      </div>

      <!-- ==================== TRANSFERS: PLANNER ==================== -->
      <div class="nav-panel" id="nav-transfers-planner">
        <div class="section">
          <div class="section-title">Transfer Planner</div>
          <p id="tp-no-user" style="color:#8899AA;font-size:0.85rem;">Load your FPL User ID in <a href="#" onclick="switchNav('nav-settings');return false" style="color:#4da6ff">Settings</a> to plan transfers.</p>
          <div id="tp-content" class="hidden">
            <div class="tp-budget-bar" id="tp-budget-bar">
              <div class="tp-budget-card"><div class="tp-label">Bank</div><div class="tp-val" id="tp-bank">0.0</div></div>
              <div class="tp-budget-card"><div class="tp-label">Selling</div><div class="tp-val blue" id="tp-selling">0.0</div></div>
              <div class="tp-budget-card"><div class="tp-label">Buying</div><div class="tp-val red" id="tp-buying">0.0</div></div>
              <div class="tp-budget-card"><div class="tp-label">Remaining</div><div class="tp-val gold" id="tp-remaining">0.0</div></div>
              <div class="tp-budget-card"><div class="tp-label">Hits</div><div class="tp-val red" id="tp-hits">0</div></div>
            </div>

            <div class="tp-transfer-summary" id="tp-transfer-summary"></div>

            <div style="display:flex;gap:0.5rem;margin-bottom:1rem;flex-wrap:wrap;">
              <button class="btn" id="tp-confirm-btn" onclick="showTransferModal()" disabled>Confirm Transfers</button>
              <button class="btn-outline" onclick="resetTransfers()">Reset All</button>
              <span id="tp-free-label" style="color:#8899AA;font-size:0.78rem;align-self:center;"></span>
            </div>

            <div class="tp-layout">
              <div>
                <!-- Squad -->
                <div class="section" style="padding:0.8rem;">
                  <div class="section-title blue" style="margin-bottom:0.4rem;">Your Squad</div>
                  <div class="tp-squad-list" id="tp-squad"></div>
                </div>

                <!-- Replacement picker -->
                <div class="tp-replacement-panel" id="tp-replacement-panel">
                  <div class="tp-rp-title">
                    <span id="tp-rp-label">Pick a replacement</span>
                    <span class="tp-rp-close" onclick="closeReplacementPanel()">&times;</span>
                  </div>
                  <div class="tp-rp-filters">
                    <input type="text" id="tp-rp-search" placeholder="Search..." oninput="filterReplacements()">
                    <select id="tp-rp-sort" onchange="filterReplacements()">
                      <option value="composite_score">Score</option>
                      <option value="form">Form</option>
                      <option value="total_points">Points</option>
                      <option value="cost">Cost (low)</option>
                      <option value="selected_by_percent">Ownership</option>
                    </select>
                  </div>
                  <div class="tp-rp-list" id="tp-rp-list"></div>
                </div>
              </div>

              <!-- Intelligence Rail -->
              <div>
                <div class="section" style="padding:0.8rem;">
                  <div class="tp-intel-section">
                    <div class="tp-intel-title">Most Transferred In</div>
                    <div id="tp-intel-in"></div>
                  </div>
                  <div class="tp-intel-section">
                    <div class="tp-intel-title" style="color:#FF5252;">Most Transferred Out</div>
                    <div id="tp-intel-out"></div>
                  </div>
                  <div class="tp-intel-section">
                    <div class="tp-intel-title" style="color:#4da6ff;">Form Ranking (Your Squad)</div>
                    <div id="tp-intel-form"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="loader" id="tp-loader"><div class="spinner"></div><div class="loader-text">Loading transfer data...</div></div>
        </div>

        <!-- Confirm Modal -->
        <div class="tp-modal-overlay" id="tp-modal-overlay" onclick="if(event.target===this)closeTransferModal()">
          <div class="tp-modal">
            <h3>Confirm Transfers</h3>
            <div class="tp-modal-transfers" id="tp-modal-transfers"></div>
            <div class="tp-modal-cost" id="tp-modal-cost"></div>
            <div class="tp-modal-actions">
              <button class="btn-cancel" onclick="closeTransferModal()">Cancel</button>
              <button class="btn" onclick="confirmTransfers()">Confirm</button>
            </div>
          </div>
        </div>
      </div>

      <!-- ==================== TRANSFERS: SUGGESTIONS ==================== -->
      <div class="nav-panel" id="nav-transfers-suggestions">
        <div id="suggestions-no-data">
          <div class="section">
            <p style="color:#8899AA;font-size:0.85rem;">Run the <a href="#" onclick="switchNav('nav-transfers-optimizer');return false" style="color:#4da6ff">Squad Optimizer</a> with your FPL ID to see transfer suggestions.</p>
          </div>
        </div>
        <div id="suggestions-content" class="hidden">
          <div class="section" id="transfers-section">
            <div class="section-title">Transfer Suggestions</div>
            <div class="table-wrap">
              <table><thead><tr><th>#</th><th>Out</th><th>In</th><th class="right">Gain</th><th class="right">Cost</th></tr></thead>
              <tbody id="transfers-body"></tbody></table>
            </div>
          </div>
        </div>
      </div>

      <!-- ==================== TRANSFERS: OPTIMIZER ==================== -->
      <div class="nav-panel" id="nav-transfers-optimizer">
        <div class="settings">
          <div class="section-title">Optimizer Settings</div>
          <div class="settings-grid">
            <div class="field">
              <label>Budget: <span class="slider-value" id="budget-display">100.0</span>M</label>
              <input type="range" id="budget" min="80" max="105" step="0.5" value="100">
            </div>
            <div class="field">
              <label>Fixture Lookahead</label>
              <select id="lookahead">
                <option value="3">3 GWs</option>
                <option value="5" selected>5 GWs</option>
                <option value="8">8 GWs</option>
                <option value="10">10 GWs</option>
              </select>
            </div>
            <div class="field">
              <label>Strategy</label>
              <select id="risk-mode">
                <option value="balanced" selected>Balanced</option>
                <option value="safe">Safe (high floor)</option>
                <option value="aggressive">Aggressive (differentials)</option>
              </select>
            </div>
            <button class="btn" id="run-btn" onclick="runOptimizer()">Optimize</button>
          </div>
        </div>

        <div class="loader" id="loader">
          <div class="spinner"></div>
          <div class="loader-text">Fetching data & optimizing squad...</div>
        </div>
        <div id="error"></div>

        <div id="results" class="hidden">
          <div class="tabs" id="tab-bar">
            <div class="tab active" data-tab="optimal" onclick="switchTab('optimal')">Optimal Squad</div>
            <div class="tab" data-tab="top-players" onclick="switchTab('top-players')">Top Players</div>
          </div>

          <div class="tab-content active" id="tab-optimal">
            <div class="stat-row" id="summary"></div>
            <div class="section">
              <div class="section-title">Starting XI</div>
              <div class="table-wrap">
                <table><thead><tr><th>Pos</th><th>Player</th><th>Team</th><th class="right">Cost</th><th class="right">Form</th><th class="right">PPG</th><th class="right">xG</th><th class="right">xA</th><th class="right">Score</th></tr></thead>
                <tbody id="starting-body"></tbody></table>
              </div>
            </div>
            <div class="section">
              <div class="section-title">Bench</div>
              <div class="table-wrap">
                <table><thead><tr><th>Pos</th><th>Player</th><th>Team</th><th class="right">Cost</th><th class="right">Score</th></tr></thead>
                <tbody id="bench-body"></tbody></table>
              </div>
            </div>
          </div>

          <div class="tab-content" id="tab-top-players">
            <div id="top-players-container"></div>
          </div>
        </div>
      </div>

      <!-- ==================== TRANSFERS: MULTI-GW PLANNER ==================== -->
      <div class="nav-panel" id="nav-transfers-multigw">
        <div class="draft-header">
          <h2>Multi-GW Transfer Planner</h2>
          <span class="draft-badge">36 GW Horizon</span>
        </div>
        <p style="color:#8899AA;font-size:0.82rem;margin-bottom:1rem;">Optimal transfer path across multiple gameweeks, accounting for hits, budget, and squad structure.</p>
        <div class="filters">
          <div class="field" style="max-width:160px;">
            <label>Horizon</label>
            <select id="multigw-horizon">
              <option value="3">3 GWs</option>
              <option value="4">4 GWs</option>
              <option value="5">5 GWs</option>
              <option value="6" selected>6 GWs</option>
            </select>
          </div>
          <div class="field" style="flex:0 0 auto;"><label>&nbsp;</label><button class="btn" onclick="loadMultiGW()">Plan</button></div>
        </div>
        <div class="loader" id="multigw-loader"><div class="spinner"></div><div class="loader-text">Planning transfers...</div></div>
        <div id="multigw-error"></div>
        <div id="multigw-content" style="display:none;">
          <div class="stat-row" id="multigw-summary"></div>
          <div class="section">
            <div class="table-wrap">
              <table>
                <thead><tr><th>GW</th><th>FT</th><th>Transfer Out</th><th>Transfer In</th><th class="right">Gain</th><th class="right">Hit</th><th class="right">Cumulative</th></tr></thead>
                <tbody id="multigw-body"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- ==================== TRANSFERS: CHIP STRATEGY ==================== -->
      <div class="nav-panel" id="nav-transfers-chips">
        <div class="draft-header">
          <h2>Chip Strategy Optimizer</h2>
          <span class="draft-badge">Strategic Planning</span>
        </div>
        <p style="color:#8899AA;font-size:0.82rem;margin-bottom:1rem;">Optimal timing for Wildcard, Bench Boost, Triple Captain, and Free Hit based on DGW/BGW patterns and fixture swings.</p>
        <div class="filters">
          <div class="field" style="flex:0 0 auto;"><label>&nbsp;</label><button class="btn" onclick="loadChipStrategy()">Analyse Chips</button></div>
        </div>
        <div class="loader" id="chips-loader"><div class="spinner"></div><div class="loader-text">Calculating chip strategy...</div></div>
        <div id="chips-error"></div>
        <div id="chips-content" style="display:none;">
          <div class="waiver-top" id="chips-cards"></div>
        </div>
      </div>

      <!-- ==================== TRANSFERS: GAIN VS HIT ==================== -->
      <div class="nav-panel" id="nav-transfers-gain">
        <div class="draft-header">
          <h2>Transfer Gain vs Hit</h2>
          <span class="draft-badge">Breakeven Analysis</span>
        </div>
        <p style="color:#8899AA;font-size:0.82rem;margin-bottom:1rem;">Visualise expected point gain vs the 4-point hit cost. See how many GWs until a hit pays off.</p>
        <div class="loader" id="gain-loader"><div class="spinner"></div><div class="loader-text">Evaluating transfers...</div></div>
        <div id="gain-error"></div>
        <div id="gain-content" style="display:none;">
          <div class="section">
            <canvas id="gain-chart" width="700" height="300" style="max-width:100%;margin-bottom:1rem;"></canvas>
          </div>
          <div class="section">
            <div class="section-title">Top Transfers</div>
            <div class="table-wrap">
              <table>
                <thead><tr><th>Out</th><th>In</th><th>Pos</th><th class="right">EP Gain</th><th class="right">Free</th><th class="right">After Hit</th><th class="right">Breakeven</th><th class="right">Worth?</th></tr></thead>
                <tbody id="gain-body"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- ==================== FIXTURE SWING & ROTATION ==================== -->
      <div class="nav-panel" id="nav-fixtures-swing">
        <div class="draft-header">
          <h2>Fixture Swing & Rotation</h2>
          <span class="draft-badge">Rotation Planner</span>
        </div>
        <p style="color:#8899AA;font-size:0.82rem;margin-bottom:1rem;">Fixture difficulty over time per team. Identifies rotation pairs with complementary fixtures.</p>
        <div class="loader" id="swing-loader"><div class="spinner"></div><div class="loader-text">Analysing fixtures...</div></div>
        <div id="swing-error"></div>
        <div id="swing-content" style="display:none;">
          <div class="section">
            <div class="section-title">Best Rotation Pairs</div>
            <div class="waiver-top" id="swing-pairs"></div>
          </div>
          <div class="section">
            <div class="section-title">Team Fixture Difficulty</div>
            <div class="table-wrap">
              <table>
                <thead id="swing-thead"></thead>
                <tbody id="swing-body"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- ==================== OWNERSHIP & EO ==================== -->
      <div class="nav-panel" id="nav-news-ownership">
        <div class="draft-header">
          <h2>Ownership & EO</h2>
          <span class="draft-badge">Effective Ownership</span>
        </div>
        <p style="color:#8899AA;font-size:0.82rem;margin-bottom:1rem;">Effective ownership with estimated captaincy rates. See point swing impact of owning or missing popular players.</p>

        <!-- Shield vs Attack (shown when user loaded) -->
        <div id="eo-personal" style="display:none;margin-bottom:1rem;">
          <div class="stat-row" id="eo-risk-cards"></div>
          <div class="section" style="padding:0.8rem;">
            <div style="display:flex;gap:1rem;align-items:center;flex-wrap:wrap;">
              <button class="btn" id="eo-shield-btn" onclick="toggleEoMode('shield')" style="background:#4da6ff;color:#0D1B2A;font-size:0.8rem;padding:0.35rem 0.8rem;">Shield Mode</button>
              <button class="btn-outline" id="eo-attack-btn" onclick="toggleEoMode('attack')" style="font-size:0.8rem;padding:0.35rem 0.8rem;">Attack Mode</button>
              <span id="eo-mode-text" style="color:#8899AA;font-size:0.82rem;flex:1;"></span>
            </div>
          </div>
        </div>

        <!-- Captain EO Chart -->
        <div class="section" id="eo-chart-section" style="display:none;">
          <div class="section-title blue">Captain EO Breakdown</div>
          <canvas id="eo-captain-chart" width="700" height="280" style="max-width:100%;"></canvas>
        </div>

        <!-- League comparison -->
        <div class="section" id="eo-league-section" style="display:none;">
          <div class="section-title blue">Mini-League EO Comparison</div>
          <div class="table-wrap">
            <table>
              <thead><tr><th>Player</th><th class="right">Global EO%</th><th class="right">Rivals Owning</th><th class="right">League Own%</th></tr></thead>
              <tbody id="eo-league-body"></tbody>
            </table>
          </div>
        </div>

        <div class="loader" id="eo-loader"><div class="spinner"></div><div class="loader-text">Modelling ownership...</div></div>
        <div id="eo-error"></div>
        <div id="eo-content" style="display:none;">
          <div class="section">
            <div class="table-wrap">
              <table>
                <thead><tr><th>#</th><th>Player</th><th>Team</th><th>Pos</th><th class="right">Own%</th><th class="right">Capt%</th><th class="right">EO%</th><th class="right">EP</th><th class="right" style="color:#51cf66">Haul+</th><th class="right" style="color:#FF5252">Miss-</th><th>Status</th></tr></thead>
                <tbody id="eo-body"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- ==================== RANK SIMULATOR ==================== -->
      <div class="nav-panel" id="nav-news-ranksim">
        <div class="draft-header">
          <h2>Rank Simulator</h2>
          <span class="draft-badge">Monte Carlo</span>
        </div>
        <p style="color:#8899AA;font-size:0.82rem;margin-bottom:1rem;">Simulate your expected rank based on per-player variance, EO, and captain choice. Compare decisions before deadline.</p>
        <div class="filters">
          <div class="field" style="max-width:120px;">
            <label>Horizon</label>
            <select id="ranksim-horizon">
              <option value="3">3 GWs</option>
              <option value="5" selected>5 GWs</option>
              <option value="8">8 GWs</option>
            </select>
          </div>
          <div class="field" style="max-width:150px;">
            <label>Captain</label>
            <select id="ranksim-captain"><option value="">Auto (best EP)</option></select>
          </div>
          <div class="field" style="max-width:150px;">
            <label>Compare vs</label>
            <select id="ranksim-alt-captain"><option value="">None</option></select>
          </div>
          <div class="field" style="max-width:80px;">
            <label>Hits</label>
            <select id="ranksim-hits">
              <option value="0">0</option>
              <option value="1">-4</option>
              <option value="2">-8</option>
              <option value="3">-12</option>
            </select>
          </div>
          <div class="field" style="flex:0 0 auto;"><label>&nbsp;</label><button class="btn" onclick="loadRankSim()">Simulate</button></div>
        </div>
        <div class="loader" id="ranksim-loader"><div class="spinner"></div><div class="loader-text">Running simulations...</div></div>
        <div id="ranksim-error"></div>
        <div id="ranksim-content" style="display:none;">
          <!-- Scenario cards -->
          <div class="stat-row" id="ranksim-scenarios"></div>
          <!-- Summary stats -->
          <div class="stat-row" id="ranksim-summary"></div>
          <!-- Decision comparison -->
          <div class="section" id="ranksim-comparison" style="display:none;">
            <div class="section-title blue">Decision Comparison</div>
            <div id="ranksim-comparison-content"></div>
          </div>
          <!-- Histogram -->
          <div class="section">
            <div class="section-title blue">Points Distribution</div>
            <canvas id="ranksim-chart" width="700" height="260" style="max-width:100%;"></canvas>
          </div>
          <!-- Player contributions -->
          <div class="section">
            <div class="section-title">Player Contributions</div>
            <div class="table-wrap">
              <table>
                <thead><tr><th>Player</th><th>Team</th><th>Pos</th><th class="right">EP/GW</th><th class="right">Contribution</th><th class="right">EO%</th><th></th></tr></thead>
                <tbody id="ranksim-players"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- ==================== LEAGUES: STANDINGS ==================== -->
      <div class="nav-panel" id="nav-leagues-standings">
        <div class="section">
          <div class="section-title blue">League Standings</div>
          <div id="leagues-no-user" style="color:#8899AA;font-size:0.85rem;">Load your FPL User ID in <a href="#" onclick="switchNav('nav-settings');return false" style="color:#4da6ff">Settings</a> to see your leagues.</div>
          <div class="leagues-section" id="leagues-section">
            <div class="sec-title">Your Leagues</div>
            <div class="league-list" id="league-list"></div>
          </div>
          <div class="league-standings" id="league-standings">
            <div class="league-title"><span id="league-title-text"></span> <span class="inline-spinner" id="league-spinner"></span></div>
            <div class="table-wrap">
              <table id="league-table" class="hidden">
                <thead><tr><th>#</th><th>Manager</th><th>Team</th><th class="right">GW</th><th class="right">Total</th><th></th></tr></thead>
                <tbody id="league-body"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- ==================== LEAGUES: RIVAL ==================== -->
      <div class="nav-panel" id="nav-leagues-rival">
        <div class="section">
          <div class="section-title blue">Rival Comparison</div>
          <p id="rival-no-user" style="color:#8899AA;font-size:0.85rem;">Select a rival from <a href="#" onclick="switchNav('nav-leagues-standings');return false" style="color:#4da6ff">League Standings</a> to compare squads, or enter a rival ID below.</p>
          <div style="display:flex;gap:0.6rem;align-items:end;flex-wrap:wrap;margin-top:1rem;">
            <div class="field" style="flex:0 1 180px;">
              <label>Rival FPL ID</label>
              <input type="text" id="rival-id-input" placeholder="e.g. 1234567" onkeydown="if(event.key==='Enter')loadRivalDirect()">
            </div>
            <button class="btn-blue btn-sm" onclick="loadRivalDirect()">Compare</button>
          </div>
          <div id="rival-output" style="margin-top:1rem;"></div>
        </div>
      </div>

      <!-- ==================== FIXTURES: SCHEDULE ==================== -->
      <div class="nav-panel" id="nav-fixtures-schedule">
        <div class="section">
          <div class="section-title">Fixture Schedule</div>

          <div class="sched-controls">
            <div class="field">
              <label>GW Range</label>
              <select id="sched-range" onchange="renderSchedule()">
                <option value="next6">Next 6 GWs</option>
                <option value="next10" selected>Next 10 GWs</option>
                <option value="all">All Remaining</option>
                <option value="full">Full Season</option>
              </select>
            </div>
            <div class="field">
              <label>Highlight Team</label>
              <select id="sched-team" onchange="renderSchedule()">
                <option value="">None</option>
              </select>
            </div>
            <div class="field">
              <label style="display:flex;align-items:center;gap:0.3rem;">
                <input type="checkbox" id="sched-show-cs" onchange="renderSchedule()" checked style="width:auto;">
                Show CS%
              </label>
            </div>
          </div>

          <div class="sched-legend">
            <span style="color:#8899AA;">Difficulty:</span>
            <div class="sched-legend-item"><span class="sched-legend-swatch" style="background:#375523"></span> 1</div>
            <div class="sched-legend-item"><span class="sched-legend-swatch" style="background:#01fc7a"></span> 2</div>
            <div class="sched-legend-item"><span class="sched-legend-swatch" style="background:#8899AA"></span> 3</div>
            <div class="sched-legend-item"><span class="sched-legend-swatch" style="background:#FF5252"></span> 4</div>
            <div class="sched-legend-item"><span class="sched-legend-swatch" style="background:#d42020"></span> 5</div>
            <span style="color:#8899AA;margin-left:0.5rem;">(H) = Home</span>
            <span style="color:#FFB800;">DGW = Double</span>
            <span style="color:#FF5252;">BGW = Blank</span>
            <span style="color:#8899AA;">Hover for date & CS%</span>
          </div>

          <div class="loader" id="sched-loader"><div class="spinner"></div><div class="loader-text">Loading schedule...</div></div>
          <div class="sched-grid" id="sched-container"></div>
        </div>
      </div>

      <!-- ==================== FIXTURES: FDR ==================== -->
      <div class="nav-panel" id="nav-fixtures-fdr">
        <div class="section">
          <div class="section-title">Fixture Difficulty Rating</div>
          <div style="margin-bottom:0.8rem;display:flex;gap:0.5rem;align-items:center;flex-wrap:wrap;">
            <span style="font-size:0.75rem;color:#8899AA;">KEY:</span>
            <span class="fdr-cell fdr-1" style="padding:0.2rem 0.5rem;font-size:0.72rem;">1</span>
            <span class="fdr-cell fdr-2" style="padding:0.2rem 0.5rem;font-size:0.72rem;">2</span>
            <span class="fdr-cell fdr-3" style="padding:0.2rem 0.5rem;font-size:0.72rem;">3</span>
            <span class="fdr-cell fdr-4" style="padding:0.2rem 0.5rem;font-size:0.72rem;">4</span>
            <span class="fdr-cell fdr-5" style="padding:0.2rem 0.5rem;font-size:0.72rem;">5</span>
            <span style="font-size:0.72rem;color:#8899AA;margin-left:0.5rem;">(H) = Home</span>
          </div>
          <div class="loader" id="fdr-loader"><div class="spinner"></div><div class="loader-text">Loading FDR...</div></div>
          <div class="fdr-grid" id="fdr-container"></div>
        </div>
      </div>

      <!-- ==================== FIXTURES: LIST ==================== -->
      <div class="nav-panel" id="nav-fixtures-list">
        <div class="section">
          <div style="margin-bottom:0.8rem;">
            <label style="color:#8899AA;font-size:0.75rem;text-transform:uppercase;margin-right:0.5rem;">Gameweek</label>
            <select id="gw-filter" onchange="renderFixtures()" style="background:#0D1B2A;border:1px solid rgba(255,255,255,0.1);color:#F0F0F0;border-radius:6px;padding:0.5rem;font-size:0.9rem;min-width:180px;">
              <option value="current">Current / Next</option>
            </select>
          </div>
          <div class="loader" id="fixtures-loader"><div class="spinner"></div><div class="loader-text">Loading fixtures...</div></div>
          <div id="fixtures-container"></div>
        </div>
      </div>

      <!-- ==================== PLAYER STATS: TABLE ==================== -->
      <div class="nav-panel" id="nav-playerstats-table">
        <div class="section">
          <div class="filters">
            <div class="field" style="flex:2">
              <label>Search</label>
              <input type="text" id="player-search" placeholder="Player name..." oninput="debouncedLoadPlayers()">
            </div>
            <div class="field">
              <label>Position</label>
              <select id="player-pos-filter" onchange="loadPlayers()">
                <option value="">All</option>
                <option value="GK">GK</option>
                <option value="DEF">DEF</option>
                <option value="MID">MID</option>
                <option value="FWD">FWD</option>
              </select>
            </div>
            <div class="field">
              <label>Team</label>
              <select id="player-team-filter" onchange="loadPlayers()">
                <option value="">All</option>
              </select>
            </div>
          </div>
          <div class="filters" style="margin-top:0.4rem;">
            <div class="field">
              <label>Price Min</label>
              <input type="number" id="player-price-min" placeholder="3.5" step="0.5" min="3.5" max="15" style="width:70px" onchange="loadPlayers()">
            </div>
            <div class="field">
              <label>Price Max</label>
              <input type="number" id="player-price-max" placeholder="15.0" step="0.5" min="3.5" max="15" style="width:70px" onchange="loadPlayers()">
            </div>
            <div class="field">
              <label>Form &ge;</label>
              <input type="number" id="player-form-min" placeholder="0" step="0.5" min="0" max="15" style="width:60px" onchange="loadPlayers()">
            </div>
            <div class="field">
              <label>Own% &le;</label>
              <input type="number" id="player-own-max" placeholder="100" step="5" min="0" max="100" style="width:65px" onchange="loadPlayers()">
            </div>
            <div class="field">
              <label>View</label>
              <select id="player-view-mode" onchange="switchPlayerView()">
                <option value="baseline">Baseline</option>
                <option value="advanced">Advanced</option>
              </select>
            </div>
          </div>
          <div class="loader" id="players-loader"><div class="spinner"></div><div class="loader-text">Loading players...</div></div>
          <div id="players-column-selector"></div>
          <div class="table-wrap">
            <table id="players-table" class="hidden table-freeze">
              <thead id="players-thead"><tr>
                <th class="sortable sort-desc" data-sort="total_points" onclick="sortPlayers(this)">Pts</th>
                <th>Pos</th>
                <th class="sortable" data-sort="name" onclick="sortPlayers(this)">Player</th>
                <th>Team</th>
                <th class="sortable right" data-sort="cost" onclick="sortPlayers(this)">Cost</th>
                <th class="sortable right" data-sort="form" onclick="sortPlayers(this)">Form</th>
                <th class="sortable right" data-sort="goals" onclick="sortPlayers(this)">G</th>
                <th class="sortable right" data-sort="assists" onclick="sortPlayers(this)">A</th>
                <th class="sortable right" data-sort="clean_sheets" onclick="sortPlayers(this)">CS</th>
                <th class="sortable right" data-sort="bonus" onclick="sortPlayers(this)">Bonus</th>
                <th class="sortable right" data-sort="points_per_game" onclick="sortPlayers(this)">PPG</th>
                <th class="sortable right" data-sort="minutes" onclick="sortPlayers(this)">Min</th>
                <th class="sortable right" data-sort="selected_by_percent" onclick="sortPlayers(this)">Own%</th>
              </tr></thead>
              <tbody id="players-body"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ==================== PLAYER STATS: COMPARE ==================== -->
      <div class="nav-panel" id="nav-playerstats-compare">
        <div class="section">
          <div class="section-title">Player Comparison <span style="color:#8899AA;font-size:0.75rem;font-weight:normal;">(2-4 players)</span></div>
          <div class="compare-search">
            <div class="field" style="flex:2">
              <label>Search player</label>
              <input type="text" id="compare-input" placeholder="Type a name..." oninput="debouncedCompareSearch()">
            </div>
            <div class="field">
              <label>Chart</label>
              <select id="compare-chart-mode" onchange="if(compareIds.length>=2) runComparison()">
                <option value="radar">Radar</option>
                <option value="bar">Bar Chart</option>
              </select>
            </div>
          </div>
          <div class="compare-results" id="compare-results"></div>
          <div class="compare-chips" id="compare-chips"></div>
          <div id="compare-output"></div>
        </div>
      </div>

      <!-- ==================== PLAYER STATS: OPTA & BPS ==================== -->
      <div class="nav-panel" id="nav-playerstats-opta">
        <div class="section">
          <div class="section-title">Opta Statistics & BPS</div>
          <div class="filters" style="margin-bottom:0.8rem;">
            <div class="field" style="flex:2">
              <label>Search</label>
              <input type="text" id="opta-search" placeholder="Player name..." oninput="debouncedLoadOpta()">
            </div>
            <div class="field">
              <label>Position</label>
              <select id="opta-pos" onchange="loadOptaStats()">
                <option value="">All</option>
                <option value="GK">GK</option>
                <option value="DEF">DEF</option>
                <option value="MID">MID</option>
                <option value="FWD">FWD</option>
              </select>
            </div>
            <div class="field">
              <label>View</label>
              <select id="opta-view" onchange="loadOptaStats()">
                <option value="xpts">xPts (Expected Points)</option>
                <option value="bps">BPS Leaders</option>
                <option value="ict">ICT Breakdown</option>
                <option value="expected">Expected Stats (xG/xA/xGI)</option>
                <option value="per90">Per 90 Minutes</option>
                <option value="defensive">Defensive</option>
                <option value="discipline">Discipline</option>
              </select>
            </div>
          </div>
          <div class="loader" id="opta-loader"><div class="spinner"></div><div class="loader-text">Loading Opta stats...</div></div>
          <div class="table-wrap">
            <table id="opta-table" class="hidden">
              <thead id="opta-thead"></thead>
              <tbody id="opta-body"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ==================== NEWS: CAPTAIN ==================== -->
      <div class="nav-panel" id="nav-news-captain">
        <div class="section">
          <div class="section-title">Captain Picks  Next GW</div>
          <div class="loader" id="captain-loader"><div class="spinner"></div><div class="loader-text">Analyzing captain picks...</div></div>
          <div class="table-wrap">
            <table id="captain-table" class="hidden">
              <thead><tr><th>#</th><th>Player</th><th>Team</th><th>Pos</th><th class="right">Form</th><th class="right">PPG</th><th class="right">xG</th><th class="right">xA</th><th class="right">xPts</th><th class="right">Fixture</th><th class="right">Score</th></tr></thead>
              <tbody id="captain-body"></tbody>
            </table>
          </div>
          <div style="margin-top:1.2rem;" id="captain-ev-section" class="hidden">
            <div class="section-title blue">Captain Expected Value (2x)</div>
            <canvas id="captain-ev-canvas" width="600" height="260" style="max-width:100%;"></canvas>
          </div>
        </div>
      </div>

      <!-- ==================== NEWS: PRICES ==================== -->
      <div class="nav-panel" id="nav-news-prices">
        <div class="section">
          <div class="section-title" style="color:#51cf66">Price Risers</div>
          <div class="loader" id="prices-loader"><div class="spinner"></div><div class="loader-text">Loading transfer data...</div></div>
          <div id="risers-container"></div>
          <div class="section-title" style="color:#FF5252;margin-top:1.5rem;">Price Fallers</div>
          <div id="fallers-container"></div>
        </div>
      </div>

      <!-- ==================== NEWS: DIFFERENTIALS ==================== -->
      <div class="nav-panel" id="nav-news-differentials">
        <div class="section">
          <div class="section-title">Differential Finder</div>
          <div style="margin-bottom:1rem;display:flex;gap:0.8rem;align-items:end;flex-wrap:wrap;">
            <div class="field" style="max-width:160px;">
              <label>Max Ownership %</label>
              <select id="diff-ownership" onchange="loadDifferentials()">
                <option value="5">5%</option>
                <option value="10" selected>10%</option>
                <option value="15">15%</option>
                <option value="20">20%</option>
              </select>
            </div>
          </div>
          <div class="loader" id="diff-loader"><div class="spinner"></div><div class="loader-text">Finding differentials...</div></div>
          <div class="table-wrap">
            <table id="diff-table" class="hidden">
              <thead><tr><th>#</th><th>Player</th><th>Team</th><th>Pos</th><th class="right">Cost</th><th class="right">Pts</th><th class="right">Form</th><th class="right">PPG</th><th class="right">Own%</th><th class="right">Score</th></tr></thead>
              <tbody id="diff-body"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ==================== NEWS: ROTATION / MINUTES ==================== -->
      <div class="nav-panel" id="nav-news-rotation">
        <div class="section">
          <div class="section-title" style="color:#FF5252;">Rotation Risk Flags</div>
          <p style="color:#8899AA;font-size:0.78rem;margin-bottom:0.8rem;">Players flagged based on start ratio, European competition, injury news, and chance of playing.</p>
          <div class="loader" id="rotation-loader"><div class="spinner"></div><div class="loader-text">Analyzing rotation risks...</div></div>
          <div class="table-wrap">
            <table id="rotation-table" class="hidden">
              <thead><tr>
                <th>Player</th><th>Team</th><th>Pos</th>
                <th class="right">Risk</th><th class="right">Starts</th><th class="right">Mins</th>
                <th class="right">CoP%</th><th class="right">Form</th><th class="right">Pts</th>
                <th>News</th>
              </tr></thead>
              <tbody id="rotation-body"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ==================== DRAFT / WAIVERS ==================== -->
      <!-- ==================== DRAFT: RANKINGS ==================== -->
      <div class="nav-panel" id="nav-draft-rankings">
        <div class="draft-header">
          <h2>Draft Rankings</h2>
          <span class="draft-badge">Cost-Agnostic</span>
        </div>
        <p style="color:#8899AA;font-size:0.82rem;margin-bottom:1rem;">Rankings based purely on player quality, form, fixtures, and output  price is irrelevant in draft format.</p>

        <div class="filters">
          <div class="field">
            <label>Position</label>
            <select id="draft-rank-pos" onchange="loadDraftRankings()">
              <option value="">All positions</option>
              <option value="GK">GK</option>
              <option value="DEF">DEF</option>
              <option value="MID">MID</option>
              <option value="FWD">FWD</option>
            </select>
          </div>
          <div class="field" style="flex:0 0 auto;">
            <label>&nbsp;</label>
            <button class="btn" onclick="loadDraftRankings()">Refresh</button>
          </div>
        </div>

        <div class="loader" id="draft-rank-loader"><div class="spinner"></div><div class="loader-text">Loading draft rankings...</div></div>
        <div id="draft-rank-error"></div>

        <div class="section" id="draft-rank-section" style="display:none;">
          <div class="table-wrap">
            <table>
              <thead><tr>
                <th>#</th><th>Player</th><th>Team</th><th>Pos</th>
                <th class="right">Pts</th><th class="right">Form</th><th class="right">PPG</th>
                <th class="right">xG</th><th class="right">xA</th><th class="right">ICT</th>
                <th class="right">Fix.</th><th class="right">Min&#x0302;</th><th class="right">Rot%</th>
                <th class="right score">Score</th>
              </tr></thead>
              <tbody id="draft-rank-body"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ==================== DRAFT: WAIVER WIRE ==================== -->
      <div class="nav-panel" id="nav-draft-waiver">
        <div class="draft-header">
          <h2>Waiver Wire</h2>
          <span class="draft-badge">Short-term value</span>
        </div>
        <p style="color:#8899AA;font-size:0.82rem;margin-bottom:1rem;">Best available pickups ranked by recent form, fixture ease, and expected points  optimised for the next 3 GWs.</p>

        <div class="filters">
          <div class="field" style="flex:0 0 auto;">
            <label>&nbsp;</label>
            <button class="btn" onclick="loadWaiverWire()">Load Waiver Wire</button>
          </div>
        </div>

        <div class="loader" id="waiver-loader"><div class="spinner"></div><div class="loader-text">Analysing waiver wire...</div></div>
        <div id="waiver-error"></div>

        <div id="waiver-content" style="display:none;">
          <div class="section">
            <div class="section-title">Top Picks  All Positions</div>
            <div class="waiver-top" id="waiver-top-cards"></div>
          </div>

          <div class="tabs" id="waiver-pos-tabs">
            <div class="tab active" onclick="switchWaiverPos('GK', this)">GK</div>
            <div class="tab" onclick="switchWaiverPos('DEF', this)">DEF</div>
            <div class="tab" onclick="switchWaiverPos('MID', this)">MID</div>
            <div class="tab" onclick="switchWaiverPos('FWD', this)">FWD</div>
          </div>
          <div class="section">
            <div class="table-wrap">
              <table>
                <thead><tr>
                  <th>Player</th><th>Team</th><th class="right">Form</th><th class="right">PPG</th>
                  <th class="right">EP</th><th class="right">xG</th><th class="right">xA</th>
                  <th class="right">Fix.</th><th class="right">Min&#x0302;</th><th class="right">Rot%</th>
                  <th class="right score">Waiver</th>
                </tr></thead>
                <tbody id="waiver-pos-body"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- ==================== DRAFT: MY ROSTER ==================== -->
      <div class="nav-panel" id="nav-draft-roster">
        <div class="draft-header">
          <h2>My Draft Roster</h2>
          <span class="draft-badge">Roster Analysis</span>
        </div>
        <p style="color:#8899AA;font-size:0.82rem;margin-bottom:1rem;">Build your draft roster to see analysis, strengths, and weaknesses. Search and add players below.</p>

        <div class="section">
          <div class="compare-search">
            <div class="field">
              <label>Search Player</label>
              <input type="text" id="roster-search" placeholder="Type player name..." oninput="searchRosterPlayer(this.value)">
            </div>
          </div>
          <div class="compare-results" id="roster-search-results"></div>
        </div>

        <div id="roster-analysis" style="display:none;">
          <div class="roster-summary" id="roster-summary"></div>

          <div class="section">
            <div class="section-title">Roster</div>
            <div class="roster-grid" id="roster-player-grid"></div>
          </div>

          <div class="section" id="roster-weakness-section">
            <div class="section-title" style="color:#FF5252;">Weakest Position</div>
            <p id="roster-weakness-text" style="color:#8899AA;font-size:0.85rem;"></p>
          </div>
        </div>
      </div>

      <!-- ==================== SETTINGS ==================== -->
      <div class="nav-panel" id="nav-settings">
        <h2 style="color:#00E676;margin-bottom:1rem;font-size:1.2rem;">Settings</h2>

        <!-- FPL Account -->
        <div class="user-bar">
          <div class="user-bar-header">
            <span class="title">FPL Account</span>
            <span class="inline-spinner" id="user-spinner"></span>
          </div>
          <div class="user-bar-row">
            <div class="field">
              <label>FPL User ID or Profile URL</label>
              <input type="text" id="user-id" placeholder="e.g. 1234567 or paste FPL URL" onkeydown="if(event.key==='Enter')loadUser()" oninput="autoDetectFplId(this)">
              <div class="help-text">Paste your FPL URL or enter your ID  we'll detect it automatically</div>
              <div id="user-id-help" style="color:#00E676;font-size:0.75rem;margin-top:0.2rem;min-height:1em;"></div>
            </div>
            <button class="btn-blue" id="load-user-btn" onclick="loadUser()">Load</button>
          </div>
          <div class="user-error" id="user-error"></div>
          <div class="user-info" id="user-info">
            <div class="mgr">Manager: <span id="manager-name"></span></div>
            <div class="tm">Team: <span id="team-name"></span></div>
            <div style="display:flex;gap:0.8rem;flex-wrap:wrap;margin-top:0.5rem;">
              <span style="color:#8899AA;font-size:0.82rem;">Rank: <strong id="settings-rank" style="color:#4da6ff">-</strong></span>
              <span style="color:#8899AA;font-size:0.82rem;">Points: <strong id="settings-points" style="color:#00E676">-</strong></span>
              <span style="color:#8899AA;font-size:0.82rem;">Value: <strong id="settings-value" style="color:#FFB800">-</strong></span>
              <span style="color:#8899AA;font-size:0.82rem;">Bank: <strong id="settings-bank" style="color:#FFB800">-</strong></span>
              <span style="color:#8899AA;font-size:0.82rem;">FTs: <strong id="settings-fts">-</strong></span>
            </div>
            <div id="settings-chips" style="margin-top:0.4rem;"></div>
          </div>
          <div class="recent-users" id="recent-users">
            <div class="sec-title">Recent managers</div>
            <div class="recent-user-list" id="recent-user-list"></div>
          </div>
        </div>

        <!-- Optimizer defaults -->
        <div class="section">
          <div class="section-title">Optimizer Defaults</div>
          <p style="color:#8899AA;font-size:0.82rem;margin-bottom:0.8rem;">These are also configurable on the Squad Optimizer page.</p>
          <div class="settings-grid">
            <div class="field">
              <label>Default Budget</label>
              <input type="text" id="settings-budget" value="100.0" style="max-width:120px;" readonly>
              <div class="help-text">Adjust on Optimizer page</div>
            </div>
            <div class="field">
              <label>Default Lookahead</label>
              <input type="text" id="settings-lookahead" value="5 GWs" style="max-width:120px;" readonly>
              <div class="help-text">Adjust on Optimizer page</div>
            </div>
          </div>
        </div>
      </div>

    </div><!-- /container -->
  </div><!-- /main-content -->

</div><!-- /app-shell -->

<script>
const $ = id => document.getElementById(id);

// ==================== CENTRALIZED APP STATE ====================
const AppState = {
  userId: null,
  AppState.isDemoMode: false,
  userData: null,       // cached /api/user response
  teamData: null,       // cached /api/data response (teams, gameweeks)
  _loaded: { dash: false, players: false, fixtures: false, draftRank: false, captain: false, prices: false },
};

/** Return current user ID or null. Optionally show error in container. */
function requireUser(errorContainerId) {
  if (AppState.userId) return AppState.userId;
  if (errorContainerId) {
    const el = $(errorContainerId);
    if (el) el.innerHTML = '<div class="error-msg">Load your FPL ID in Settings first.</div>';
  }
  return null;
}

/** Return demo-notice HTML if in demo mode, otherwise empty string. */
function demoNotice() {
  if (!AppState.AppState.isDemoMode) return '';
  return '<div class="demo-inline-notice"><span class="demo-badge">DEMO</span> Viewing sample data &mdash; <a href="#" onclick="switchNav(\'nav-settings\');return false" style="color:#4da6ff">connect your team</a></div>';
}

let teamsMap = {};
let playersSort = { col: 'total_points', dir: 'desc' };
let fixturesData = null;
let debounceTimer = null;
let compareTimer = null;
let compareIds = [];
let allPlayersCache = null;

// ==================== SIDEBAR NAV ====================
function toggleSidebar() {
  const sidebar = $('sidebar');
  const overlay = $('sidebar-overlay');
  sidebar.classList.toggle('open');
  overlay.classList.toggle('active');
}

function toggleMoreMenu() {
  const menu = $('more-menu');
  const overlay = $('more-menu-overlay');
  const btn = $('bn-more-btn');
  const isOpen = menu.classList.contains('active');
  if (isOpen) {
    menu.classList.remove('active');
    overlay.classList.remove('active');
    if (btn) btn.classList.remove('active');
  } else {
    menu.classList.add('active');
    overlay.classList.add('active');
    if (btn) btn.classList.add('active');
  }
}

function toggleSidebarSub(subId, parentItem) {
  const sub = $(subId);
  const arrow = parentItem.querySelector('.si-arrow');
  const isOpen = sub.classList.contains('open');

  // Close all other subs
  document.querySelectorAll('.sidebar-sub').forEach(s => s.classList.remove('open'));
  document.querySelectorAll('.si-arrow').forEach(a => a.classList.remove('open'));

  if (!isOpen) {
    sub.classList.add('open');
    if (arrow) arrow.classList.add('open');
  }
}

// Card-mode: add data-label attributes to table cells for mobile card layout
function applyCardLabels(tableEl) {
  if (!tableEl) return;
  const wrap = tableEl.closest('.table-wrap');
  if (wrap) wrap.classList.add('card-mode');
  const headers = Array.from(tableEl.querySelectorAll('thead th')).map(th => th.textContent.trim());
  tableEl.querySelectorAll('tbody tr').forEach(tr => {
    tr.querySelectorAll('td').forEach((td, i) => {
      if (headers[i]) td.setAttribute('data-label', headers[i]);
    });
  });
}

// Skeleton loading: generate placeholder rows
function showSkeleton(containerId, count) {
  const el = $(containerId);
  if (!el) return;
  el.innerHTML = Array.from({length: count}, () =>
    `<div class="skeleton-card"><div class="skeleton" style="width:60%;height:16px"></div><div class="skeleton" style="width:90%"></div><div class="skeleton" style="width:75%"></div></div>`
  ).join('');
}
function showSkeletonTable(containerId, rows, cols) {
  const el = $(containerId);
  if (!el) return;
  el.innerHTML = Array.from({length: rows}, () =>
    `<tr>${Array.from({length: cols}, (_, j) => `<td><div class="skeleton" style="height:14px;width:${j === 0 ? '40' : '60'}%"></div></td>`).join('')}</tr>`
  ).join('');
}
function showSkeletonStats(containerId, count) {
  const el = $(containerId);
  if (!el) return;
  el.innerHTML = Array.from({length: count}, () =>
    `<div class="stat-card"><div class="skeleton" style="height:12px;width:60%;margin:0 auto 0.3rem"></div><div class="skeleton" style="height:22px;width:40%;margin:0 auto"></div></div>`
  ).join('');
}

// Dashboard accordion for mobile rail sections
function initDashAccordions() {
  if (window.innerWidth > 768) return;
  document.querySelectorAll('.dash-rail .dash-section-title').forEach(title => {
    if (title._accordionInit) return;
    title._accordionInit = true;
    title.classList.add('collapsed');
    const list = title.nextElementSibling;
    if (list) list.classList.add('collapsed');
    title.addEventListener('click', () => {
      title.classList.toggle('collapsed');
      if (list) list.classList.toggle('collapsed');
    });
  });
}

function switchNav(panelId) {
  // Hide all panels
  document.querySelectorAll('.nav-panel').forEach(p => p.classList.remove('active'));

  // Show target panel
  const panel = $(panelId);
  if (panel) panel.classList.add('active');

  // Update sidebar active state
  document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
  document.querySelectorAll('.sidebar-sub-item').forEach(i => i.classList.remove('active'));

  // Activate the matching sidebar item or sub-item
  const subItem = document.querySelector(`.sidebar-sub-item[data-nav="${panelId}"]`);
  if (subItem) {
    subItem.classList.add('active');
    // Also highlight parent group and ensure sub is open
    const subContainer = subItem.closest('.sidebar-sub');
    if (subContainer) {
      subContainer.classList.add('open');
      const parentItem = subContainer.previousElementSibling;
      if (parentItem && parentItem.classList.contains('sidebar-item')) {
        parentItem.classList.add('active');
        const arrow = parentItem.querySelector('.si-arrow');
        if (arrow) arrow.classList.add('open');
      }
    }
  } else {
    const sidebarItem = document.querySelector(`.sidebar-item[data-nav="${panelId}"]`);
    if (sidebarItem) sidebarItem.classList.add('active');
  }

  // Close mobile sidebar & more menu
  $('sidebar').classList.remove('open');
  $('sidebar-overlay').classList.remove('active');
  const moreMenu = $('more-menu');
  if (moreMenu && moreMenu.classList.contains('active')) {
    moreMenu.classList.remove('active');
    $('more-menu-overlay').classList.remove('active');
    const moreBtn = $('bn-more-btn');
    if (moreBtn) moreBtn.classList.remove('active');
  }

  // Update bottom nav active state  map sub-pages to parent tab
  const bnMap = {
    'nav-dashboard': 'nav-dashboard',
    'nav-team-live': 'nav-dashboard', 'nav-team-myteam': 'nav-dashboard',
    'nav-transfers-planner': 'nav-transfers-planner', 'nav-transfers-suggestions': 'nav-transfers-planner',
    'nav-transfers-optimizer': 'nav-transfers-planner', 'nav-transfers-multigw': 'nav-transfers-planner',
    'nav-transfers-chips': 'nav-transfers-planner', 'nav-transfers-gain': 'nav-transfers-planner',
    'nav-fixtures-fdr': 'nav-fixtures-fdr', 'nav-fixtures-schedule': 'nav-fixtures-fdr',
    'nav-fixtures-list': 'nav-fixtures-fdr', 'nav-fixtures-swing': 'nav-fixtures-fdr',
    'nav-playerstats-table': 'nav-playerstats-table', 'nav-playerstats-opta': 'nav-playerstats-table',
    'nav-playerstats-compare': 'nav-playerstats-table',
  };
  document.querySelectorAll('.bottom-nav button').forEach(b => b.classList.remove('active'));
  const bnTarget = bnMap[panelId];
  if (bnTarget) {
    const bnBtn = document.querySelector(`.bottom-nav button[data-nav="${bnTarget}"]`);
    if (bnBtn) bnBtn.classList.add('active');
  }

  // Lazy load data
  if (panelId === 'nav-playerstats-table' && !AppState._loaded.players) loadMetadata().then(() => loadPlayers());
  if (panelId === 'nav-fixtures-list' && !AppState._loaded.fixtures) loadMetadata().then(() => loadFixtures());
  if (panelId === 'nav-fixtures-schedule') loadSchedule();
  if (panelId === 'nav-fixtures-fdr') loadFDR();
  if (panelId === 'nav-news-captain') loadCaptainPicks();
  if (panelId === 'nav-news-rotation') loadRotationRisk();
  if (panelId === 'nav-news-prices') loadPriceChanges();
  if (panelId === 'nav-news-differentials') loadDifferentials();
  if (panelId === 'nav-team-live') loadLive();
  if (panelId === 'nav-team-myteam') loadSquadAnalysis();
  if (panelId === 'nav-transfers-planner') loadTransferPlanner();
  if (panelId === 'nav-playerstats-opta') loadOptaStats();
  if (panelId === 'nav-dashboard') loadDashboard();
  if (panelId === 'nav-draft-rankings' && !AppState._loaded.draftRank) loadDraftRankings();
  if (panelId === 'nav-draft-waiver') loadWaiverWire();
  if (panelId === 'nav-draft-roster') analyseRoster();
  if (panelId === 'nav-transfers-multigw') loadMultiGW();
  if (panelId === 'nav-transfers-chips') loadChipStrategy();
  if (panelId === 'nav-transfers-gain') loadTransferGain();
  if (panelId === 'nav-fixtures-swing') loadFixtureSwing();
  if (panelId === 'nav-news-ownership') loadOwnership();
  if (panelId === 'nav-news-ranksim') { /* manual button */ }

  // Keep demo banner visible when in demo mode
  if (AppState.isDemoMode) showDemoBanner();

  // Sticky optimize CTA on mobile
  const stickyOpt = $('sticky-optimize');
  if (stickyOpt) {
    if (panelId === 'nav-transfers-optimizer' && window.innerWidth <= 768) {
      stickyOpt.classList.add('visible');
    } else {
      stickyOpt.classList.remove('visible');
    }
  }
}

// ==================== DASHBOARD ====================
// Loaded flags now live in AppState._loaded

function loadDashboard() {
  if (!AppState.userId) return;

  // Show live dash, hide empty state
  $('dash-empty-state').classList.add('hidden');
  $('dash-live').classList.remove('hidden');

  // Avoid re-fetching if already loaded this session
  if (AppState._loaded.dash) return;

  // Show skeleton loading instead of plain spinner
  showSkeletonStats('dash-stats', 4);
  showSkeleton('dash-pitch-slot', 3);

  const loader = $('dash-loader');
  loader.classList.add('active');

  // Fire all requests in parallel
  Promise.all([
    fetch(`/api/live/${AppState.userId}`).then(r => r.json()),
    fetch('/api/price-changes').then(r => r.json()),
    fetch('/api/players?sort=total_points&dir=desc').then(r => r.json()),
    fetch('/api/fixtures').then(r => r.json()),
  ]).then(([liveData, priceData, playersData, fixturesResp]) => {

    // ---- TOP STATS ----
    if (!liveData.error) {
      $('dash-gw-pts').textContent = liveData.total_live_points ?? '--';
      $('dash-gw-label').textContent = liveData.gameweek_name || 'GW Points';
      $('dash-hits-sub').textContent = liveData.hits ? `(-${liveData.hits} hits)` : '';
      $('dash-rank').textContent = liveData.overall_rank ? liveData.overall_rank.toLocaleString() : '--';
      $('dash-total').textContent = liveData.total_points ? liveData.total_points.toLocaleString() : '--';
      $('dash-total-sub').textContent = liveData.team_value ? `Value: ${(liveData.team_value / 10).toFixed(1)}M` : '';
      $('dash-rank-sub').textContent = liveData.points_on_bench ? `${liveData.points_on_bench} on bench` : '';

      // ---- CAPTAIN ----
      const captain = liveData.picks.find(p => p.is_captain);
      if (captain) {
        const photoUrl = captain.photo ? `${PHOTO_BASE}${captain.photo}.png` : '';
        const photoHtml = photoUrl
          ? `<img src="${photoUrl}" alt="" style="width:100%;height:100%;object-fit:cover;object-position:top;border-radius:50%;" onerror="this.parentElement.innerHTML='C'">`
          : 'C';
        $('dash-captain-slot').innerHTML = `<div class="dash-captain">
          <div class="dc-badge">${photoHtml}</div>
          <div class="dc-info">
            <div class="dc-name">${captain.name}</div>
            <div class="dc-meta">${captain.team_name} &middot; ${captain.position_name} &middot; ${captain.multiplier}x</div>
          </div>
          <div class="dc-pts">${captain.live_points}</div>
        </div>`;
      }

      // ---- STARTING XI MINI PITCH ----
      const starting = liveData.picks.filter(p => p.multiplier > 0);
      const bench = liveData.picks.filter(p => p.multiplier === 0);
      const byPos = { 4: [], 3: [], 2: [], 1: [] };
      starting.forEach(p => { if (byPos[p.position]) byPos[p.position].push(p); });

      let pitchHtml = '<div class="pitch">';
      for (const pos of [4, 3, 2, 1]) {
        if (byPos[pos].length === 0) continue;
        pitchHtml += `<div class="pitch-row">${byPos[pos].map(p => liveCard(p, false)).join('')}</div>`;
      }
      pitchHtml += '</div>';
      $('dash-pitch-slot').innerHTML = pitchHtml;

      // ---- BONUS TRACKING ----
      const withBonus = liveData.picks.filter(p => p.bonus > 0).sort((a, b) => b.bonus - a.bonus);
      if (withBonus.length > 0) {
        $('dash-bonus-slot').innerHTML = withBonus.map(p =>
          `<div class="bonus-item"><span class="bi-pts">${p.bonus}B</span> ${p.name}</div>`
        ).join('');
      } else {
        $('dash-bonus-slot').innerHTML = '<div style="color:#555;font-size:0.82rem;">No bonus points yet this GW</div>';
      }

      // ---- BENCH ----
      if (bench.length > 0) {
        $('dash-bench-slot').innerHTML = bench.map(p => `<div class="bench-mini">
          <span class="bm-pos">${p.position_name}</span>
          <span class="bm-name">${p.name}</span>
          <span class="bm-pts">${p.live_points}</span>
        </div>`).join('');
      }
    }

    // ---- LEAGUE RANK ----
    // Fetch first league if available
    loadDashLeagueRank();

    // ---- INJURIES & NEWS (from players in user's squad) ----
    if (!liveData.error && playersData.players) {
      const myPlayerIds = new Set(liveData.picks.map(p => p.id));
      const injuredPlayers = playersData.players.filter(p =>
        myPlayerIds.has(p.id) && p.news && p.news.trim() !== ''
      );

      // Also show top flagged players not in squad
      const otherFlagged = playersData.players.filter(p =>
        !myPlayerIds.has(p.id) && p.news && p.news.trim() !== '' && p.chance_of_playing !== null && p.chance_of_playing < 100
      ).slice(0, 5);

      const allNews = [...injuredPlayers, ...otherFlagged].slice(0, 10);

      if (allNews.length > 0) {
        $('dash-injuries-slot').innerHTML = allNews.map(p => {
          const chance = p.chance_of_playing;
          let statusClass = 'red';
          let chanceText = '0%';
          if (chance === null || chance === undefined) { statusClass = 'yellow'; chanceText = '?'; }
          else if (chance >= 75) { statusClass = 'green'; chanceText = chance + '%'; }
          else if (chance >= 25) { statusClass = 'yellow'; chanceText = chance + '%'; }
          else { statusClass = 'red'; chanceText = chance + '%'; }
          const inSquad = myPlayerIds.has(p.id);
          return `<div class="dash-news-item">
            <div class="ni-status ${statusClass}"></div>
            <div class="ni-info">
              <div class="ni-name">${p.name}${inSquad ? ' <span style="color:#4da6ff;font-size:0.65rem;">MY TEAM</span>' : ''}</div>
              <div class="ni-text">${p.news}</div>
            </div>
            <div class="ni-chance" style="color:${statusClass === 'red' ? '#FF5252' : statusClass === 'yellow' ? '#FFB800' : '#51cf66'}">${chanceText}</div>
          </div>`;
        }).join('');
      } else {
        $('dash-injuries-slot').innerHTML = '<div style="color:#555;font-size:0.82rem;">No injuries in your squad</div>';
      }
    }

    // ---- PRICE CHANGES (top 5 risers + fallers) ----
    if (!priceData.error) {
      const topRisers = (priceData.risers || []).slice(0, 4);
      const topFallers = (priceData.fallers || []).slice(0, 4);
      let priceHtml = '';
      topRisers.forEach(p => {
        const change = p.cost_change_event !== 0 ? (p.cost_change_event / 10).toFixed(1) : '+?';
        priceHtml += `<div class="dash-price-item">
          <span class="pi-name">${p.name}</span>
          <span class="pi-change up">${change > 0 ? '+' : ''}${change}</span>
        </div>`;
      });
      topFallers.forEach(p => {
        const change = p.cost_change_event !== 0 ? (p.cost_change_event / 10).toFixed(1) : '-?';
        priceHtml += `<div class="dash-price-item">
          <span class="pi-name">${p.name}</span>
          <span class="pi-change down">${change}</span>
        </div>`;
      });
      $('dash-prices-slot').innerHTML = priceHtml || '<div style="color:#555;font-size:0.82rem;">No price changes</div>';
    }

    // ---- UPCOMING FIXTURES ----
    if (!fixturesResp.error && fixturesResp.gameweeks) {
      const upcoming = fixturesResp.gameweeks.filter(gw => gw.is_current || gw.is_next);
      const gw = upcoming[0];
      if (gw && gw.fixtures) {
        const fxHtml = gw.fixtures.slice(0, 6).map(f => {
          const mid = f.finished && f.home_score !== null
            ? `<span class="df-score">${f.home_score}-${f.away_score}</span>`
            : `<span class="df-time">vs</span>`;
          return `<div class="dash-fixture">
            <span class="df-teams">${f.home_team_name} ${mid} ${f.away_team_name}</span>
          </div>`;
        }).join('');
        $('dash-fixtures-slot').innerHTML = fxHtml;
      } else {
        $('dash-fixtures-slot').innerHTML = '<div style="color:#555;font-size:0.82rem;">No upcoming fixtures</div>';
      }
    }

    AppState._loaded.dash = true;
    initDashAccordions();
  }).catch(err => {
    console.error('Dashboard load error:', err);
  }).finally(() => {
    loader.classList.remove('active');
  });
}

function loadDashLeagueRank() {
  if (!AppState.userId) return;
  fetch(`/api/user/${AppState.userId}`).then(r => r.json()).then(data => {
    if (data.error || !data.leagues || data.leagues.length === 0) return;
    const league = data.leagues[0];
    $('dash-league-sub').textContent = league.name;
    fetch(`/api/league/${league.id}`).then(r => r.json()).then(lg => {
      if (lg.error) return;
      // Match user by entry ID
      const me = lg.standings.find(s => s.entry === AppState.userId);
      if (me) {
        $('dash-league-rank').textContent = '#' + me.rank;
      } else if (lg.standings.length > 0) {
        // Fallback: show '--' if user not found in top results
        $('dash-league-rank').textContent = '--';
      }
    }).catch(() => {});
  }).catch(() => {});
}

// ==================== RECENT USERS ====================
function getRecentUsers() {
  try { return JSON.parse(localStorage.getItem('fpl_recent_users') || '[]'); }
  catch { return []; }
}
function saveRecentUser(id, name, teamName) {
  let list = getRecentUsers().filter(u => u.id !== id);
  list.unshift({ id, name, teamName });
  if (list.length > 8) list = list.slice(0, 8);
  localStorage.setItem('fpl_recent_users', JSON.stringify(list));
  renderRecentUsers();
}
function removeRecentUser(id, evt) {
  evt.stopPropagation();
  let list = getRecentUsers().filter(u => u.id !== id);
  localStorage.setItem('fpl_recent_users', JSON.stringify(list));
  if (AppState.userId === id) {
    // If removed user is current, clear active user reference in storage
    const saved = localStorage.getItem('fpl_user_id');
    if (saved && parseInt(saved) === id) localStorage.removeItem('fpl_user_id');
  }
  renderRecentUsers();
}
function selectRecentUser(id) {
  $('user-id').value = id;
  loadUser();
}
function renderRecentUsers() {
  const list = getRecentUsers();
  const container = $('recent-user-list');
  const section = $('recent-users');
  if (!list.length) { section.style.display = 'none'; return; }
  section.style.display = '';
  container.innerHTML = list.map(u => {
    const isCurrent = AppState.userId === u.id ? ' current' : '';
    return `<div class="recent-user-item${isCurrent}" onclick="selectRecentUser(${u.id})">
      <span class="ru-name">${u.name}</span>
      <span class="ru-team">${u.teamName}</span>
      <span class="ru-id">#${u.id}</span>
      <span class="ru-remove" onclick="removeRecentUser(${u.id}, event)" title="Remove">&times;</span>
    </div>`;
  }).join('');
}
renderRecentUsers();

// ==================== PERSIST USER ID ====================
(function restoreUser() {
  const saved = localStorage.getItem('fpl_user_id');
  const cachedData = localStorage.getItem('fpl_user_data');

  // Show cached data instantly while fresh fetch runs
  if (saved && cachedData) {
    try {
      const cd = JSON.parse(cachedData);
      $('uhb-name').textContent = cd.manager_name || '';
      $('uhb-rank').textContent = cd.overall_rank ? cd.overall_rank.toLocaleString() : '-';
      $('uhb-points').textContent = cd.overall_points || '-';
      $('uhb-gw-pts').textContent = cd.gw_points || '-';
      $('uhb-value').textContent = cd.team_value ? cd.team_value + 'M' : '-';
      $('uhb-bank').textContent = cd.bank ? cd.bank + 'M' : '-';
      $('uhb-fts').textContent = cd.free_transfers || '1';
      $('user-header-bar').classList.add('active');
      if (cd.last_sync) {
        const ago = Math.round((Date.now() - cd.last_sync) / 60000);
        $('uhb-last-sync').textContent = ago < 1 ? 'Synced just now' : `Synced ${ago}m ago`;
      }
    } catch(e) {}
  }

  if (saved) {
    $('user-id').value = saved;
    setTimeout(async () => {
      await loadUser();
      const savedLeague = localStorage.getItem('fpl_league_id');
      if (savedLeague && AppState.userId) {
        const chip = document.querySelector(`.league-chip[data-id="${savedLeague}"]`);
        if (chip) loadLeague(parseInt(savedLeague), chip);
      }
    }, 100);
  } else {
    // No saved user  auto-activate demo mode and show mobile connect CTA
    setTimeout(() => activateDemo(), 300);
    if (window.innerWidth <= 768) {
      const stickyConnect = $('sticky-connect-cta');
      if (stickyConnect) stickyConnect.classList.add('visible');
    }
  }
})();

// Sync button handler
async function syncUser() {
  if (!AppState.userId) return;
  $('uhb-sync-spinner').classList.add('active');
  $('uhb-sync-btn').disabled = true;
  $('user-id').value = AppState.userId;
  try {
    await loadUser();
    AppState._loaded.dash = false;
    const activePanel = document.querySelector('.nav-panel.active');
    if (activePanel) switchNav(activePanel.id);
  } finally {
    $('uhb-sync-spinner').classList.remove('active');
    $('uhb-sync-btn').disabled = false;
  }
}

// ==================== FIXTURE TICKER ====================
async function loadTicker() {
  try {
    const resp = await fetch('/api/fixtures');
    const data = await resp.json();
    if (data.error || !data.gameweeks) return;

    const gw = data.gameweeks.find(g => g.is_current) || data.gameweeks.find(g => g.is_next);
    if (!gw) return;

    const track = $('ticker-track');
    let html = `<span class="ticker-gw">${gw.name}</span>`;
    gw.fixtures.forEach(f => {
      let middle;
      if (f.finished) {
        middle = `<span class="score-ft">${f.home_score} - ${f.away_score}</span>`;
      } else if (f.started) {
        middle = `<span class="score-live"><span class="live-pulse"></span>${f.home_score ?? 0} - ${f.away_score ?? 0}</span>`;
      } else if (f.kickoff_time) {
        const d = new Date(f.kickoff_time);
        const day = d.toLocaleDateString([], {weekday:'short'});
        const time = d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        middle = `<span class="kickoff">${day} ${time}</span>`;
      } else {
        middle = `<span class="kickoff">TBC</span>`;
      }
      html += `<div class="ticker-item"><span class="team-abbr">${f.home_team_name}</span>${middle}<span class="team-abbr">${f.away_team_name}</span></div>`;
    });
    track.innerHTML = html;
  } catch (e) { /* silent */ }
}
loadTicker();
setInterval(loadTicker, 60000);

// ==================== USER LOOKUP ====================
async function loadUser() {
  const idInput = $('user-id');
  const rawId = idInput.value.trim();
  if (!rawId) { idInput.focus(); return; }
  const uid = parseInt(rawId);
  if (isNaN(uid) || uid < 0) {
    showUserError('Please enter a valid numeric FPL User ID.');
    return;
  }
  AppState.isDemoMode = (uid === 0);

  const btn = $('load-user-btn');
  const spinner = $('user-spinner');
  btn.disabled = true;
  spinner.classList.add('active');
  hideUserError();
  $('user-info').classList.remove('active');
  $('leagues-section').classList.remove('active');
  $('league-standings').classList.remove('active');

  try {
    const resp = await fetch(`/api/user/${uid}`);
    const data = await resp.json();
    if (!resp.ok) { showUserError(data.error || 'Failed to load user'); return; }

    AppState.userId = uid;
    AppState.userData = data; // Cache user data centrally
    AppState._loaded.dash = false; // Reset so dashboard reloads with new user
    if (!AppState.isDemoMode) {
      localStorage.setItem('fpl_user_id', String(uid));
      saveRecentUser(uid, data.manager_name, data.team_name);
      hideDemoBanner();
    }
    $('manager-name').textContent = data.manager_name;
    $('team-name').textContent = data.team_name;
    $('user-info').classList.add('active');

    // Update persistent header bar
    if (AppState.isDemoMode) {
      $('uhb-name').innerHTML = 'Demo Manager <span class="demo-badge" style="font-size:0.6rem;vertical-align:middle;margin-left:4px;">DEMO</span>';
    } else {
      $('uhb-name').textContent = data.manager_name;
    }
    $('uhb-rank').textContent = data.overall_rank ? data.overall_rank.toLocaleString() : '-';
    $('uhb-points').textContent = data.overall_points || '-';
    $('uhb-gw-pts').textContent = data.gw_points || '-';
    $('uhb-value').textContent = data.team_value ? data.team_value + 'M' : '-';
    $('uhb-bank').textContent = data.bank ? data.bank + 'M' : '-';
    $('uhb-fts').textContent = data.free_transfers || '1';
    $('user-header-bar').classList.add('active');

    // Hide sticky connect CTA (user is now connected)
    const stickyConnect = $('sticky-connect-cta');
    if (stickyConnect) stickyConnect.classList.remove('visible');

    // Chips display  group by chip type, show remaining/total
    const chipNameMap = {wildcard: 'WC', freehit: 'FH', bboost: 'BB', '3xc': 'TC'};
    const chipOrder = ['wildcard', 'freehit', 'bboost', '3xc'];
    const availCount = {};
    const usedList = {};
    (data.chips_available || []).forEach(c => { availCount[c] = (availCount[c] || 0) + 1; });
    (data.chips_used || []).forEach(c => {
      if (!usedList[c.name]) usedList[c.name] = [];
      usedList[c.name].push(c);
    });
    let chipsHtml = '';
    chipOrder.forEach(chip => {
      const label = chipNameMap[chip] || chip;
      const avail = availCount[chip] || 0;
      const used = usedList[chip] || [];
      const total = avail + used.length;
      if (total === 0) return;
      const usedGws = used.map(u => `GW${u.event}`).join(', ');
      if (avail === 0) {
        chipsHtml += `<span class="chip-badge used" title="Used ${usedGws}">${label} (0/${total})</span>`;
      } else if (used.length === 0) {
        chipsHtml += `<span class="chip-badge available">${label} (${avail}/${total})</span>`;
      } else {
        chipsHtml += `<span class="chip-badge available" title="Used ${usedGws}">${label} (${avail}/${total})</span>`;
      }
    });
    $('uhb-chips').innerHTML = chipsHtml;
    $('settings-chips').innerHTML = chipsHtml;

    // Settings panel values
    $('settings-rank').textContent = data.overall_rank ? data.overall_rank.toLocaleString() : '-';
    $('settings-points').textContent = data.overall_points || '-';
    $('settings-value').textContent = data.team_value ? data.team_value + 'M' : '-';
    $('settings-bank').textContent = data.bank ? data.bank + 'M' : '-';
    $('settings-fts').textContent = data.free_transfers || '1';

    // Cache user data for instant restore (skip for demo)
    if (!AppState.isDemoMode) {
      localStorage.setItem('fpl_user_data', JSON.stringify({
        manager_name: data.manager_name, team_name: data.team_name,
        overall_rank: data.overall_rank, overall_points: data.overall_points,
        team_value: data.team_value, bank: data.bank, free_transfers: data.free_transfers,
        gw_points: data.gw_points, chips_available: data.chips_available,
        chips_used: data.chips_used, last_sync: Date.now(),
      }));
      $('uhb-last-sync').textContent = 'Synced just now';
    } else {
      $('uhb-last-sync').textContent = 'Demo mode';
    }

    // Update dashboard welcome
    $('dash-title').textContent = `Welcome, ${data.manager_name}`;
    $('dash-subtitle').textContent = data.team_name;

    if (data.leagues && data.leagues.length > 0) {
      $('league-list').innerHTML = data.leagues.map(lg =>
        `<div class="league-chip" data-id="${lg.id}" onclick="loadLeague(${lg.id}, this)">${lg.name}</div>`
      ).join('');
      $('leagues-section').classList.add('active');
    }

    // Hide "no user" messages
    $('live-no-user').classList.add('hidden');
    const leaguesNoUser = $('leagues-no-user');
    if (leaguesNoUser) leaguesNoUser.classList.add('hidden');

    // Load dashboard stats
    loadDashboard();
  } catch (err) {
    showUserError('Network error: ' + err.message);
  } finally {
    btn.disabled = false;
    spinner.classList.remove('active');
  }
}

function showUserError(msg) { const el = $('user-error'); el.textContent = msg; el.classList.add('active'); }
function hideUserError() { $('user-error').classList.remove('active'); }

// Demo mode helpers
function showDemoBanner() { $('demo-banner').classList.remove('hidden'); }
function hideDemoBanner() { $('demo-banner').classList.add('hidden'); }
async function activateDemo() {
  AppState.isDemoMode = true;
  $('user-id').value = '0';
  await loadUser();
  showDemoBanner();
  // Hide sticky connect CTA since user chose demo
  const stickyConnect = $('sticky-connect-cta');
  if (stickyConnect) stickyConnect.classList.remove('visible');
}

async function loadLeague(leagueId, chipEl) {
  document.querySelectorAll('.league-chip').forEach(c => c.classList.remove('active'));
  if (chipEl) chipEl.classList.add('active');
  localStorage.setItem('fpl_league_id', String(leagueId));

  const standings = $('league-standings');
  const spinnerEl = $('league-spinner');
  const tableEl = $('league-table');
  standings.classList.add('active');
  spinnerEl.classList.add('active');
  tableEl.classList.add('hidden');
  $('league-title-text').textContent = 'Loading...';

  try {
    const resp = await fetch(`/api/league/${leagueId}`);
    const data = await resp.json();
    if (!resp.ok) { $('league-title-text').textContent = data.error || 'Failed'; return; }

    $('league-title-text').textContent = data.league_name;
    $('league-body').innerHTML = data.standings.map(s => `<tr>
      <td>${s.rank}</td>
      <td>${s.manager_name}</td>
      <td>${s.team_name}</td>
      <td class="right">${s.gw_points}</td>
      <td class="right score">${s.total_points}</td>
      <td>${AppState.userId ? `<span class="btn-outline" onclick="loadRival(${s.rank}, '${s.manager_name.replace(/'/g, "\\'")}', event)" style="font-size:0.7rem;padding:0.15rem 0.4rem;">vs</span>` : ''}</td>
    </tr>`).join('');
    tableEl.classList.remove('hidden');
    applyCardLabels(tableEl);
  } catch (err) {
    $('league-title-text').textContent = 'Network error';
  } finally {
    spinnerEl.classList.remove('active');
  }
}

// ==================== METADATA ====================
let metadataLoaded = false, metadataPromise = null;
function loadMetadata() {
  if (metadataLoaded) return Promise.resolve();
  if (metadataPromise) return metadataPromise;
  metadataPromise = fetch('/api/data').then(r => r.json()).then(data => {
    if (data.error) throw new Error(data.error);
    const sel = $('player-team-filter');
    data.teams.forEach(t => { const o = document.createElement('option'); o.value = t.id; o.textContent = t.name; sel.appendChild(o); });
    data.teams.forEach(t => { teamsMap[t.id] = t; if (t.code) teamCodeMap[t.id] = t.code; });
    metadataLoaded = true;
  }).catch(err => { metadataPromise = null; console.error(err); });
  return metadataPromise;
}

// ==================== LIVE GW ====================
let liveLoaded = false;
let livePicksData = []; // Store picks data for captain/vice changes
let liveGameweek = null;
let captainMode = null; // null, 'captain', or 'vice'
const PHOTO_BASE = 'https://resources.premierleague.com/premierleague/photos/players/110x140/p';
const KIT_BASE = 'https://fantasy.premierleague.com/dist/img/shirts/standard/shirt_';
let teamCodeMap = {}; // team id -> team code (for kit URLs)

/** Get kit image HTML for a team. isGk: true for goalkeeper kit. */
function kitImg(teamId, isGk, size) {
  size = size || 20;
  const code = teamCodeMap[teamId];
  if (!code) return '';
  const suffix = isGk ? '_1-110.webp' : '-110.webp';
  return `<img src="${KIT_BASE}${code}${suffix}" alt="" style="width:${size}px;height:${size}px;vertical-align:middle;" onerror="this.style.display='none'">`;
}

const TEAM_COLORS = {
  'ARS': '#EF0107', 'AVL': '#670E36', 'BOU': '#DA291C', 'BRE': '#e30613',
  'BHA': '#0057B8', 'CHE': '#034694', 'CRY': '#1B458F', 'EVE': '#003399',
  'FUL': '#000000', 'IPS': '#0044AA', 'LEI': '#003090', 'LIV': '#C8102E',
  'MCI': '#6CABDD', 'MUN': '#DA291C', 'NEW': '#241F20', 'NFO': '#E53233',
  'SOU': '#D71920', 'TOT': '#132257', 'WHU': '#7A263A', 'WOL': '#FDB913',
};

const VALID_FORMATIONS = ['3-4-3','3-5-2','4-3-3','4-4-2','4-5-1','5-3-2','5-4-1','5-2-3','3-3-4','4-2-4'];

function getFormation() {
  const cards = document.querySelectorAll('#live-pitch .live-card:not(.bench)');
  let def = 0, mid = 0, fwd = 0;
  cards.forEach(c => {
    const pos = parseInt(c.dataset.position);
    if (pos === 2) def++;
    else if (pos === 3) mid++;
    else if (pos === 4) fwd++;
  });
  return `${def}-${mid}-${fwd}`;
}

function validateFormation() {
  const formation = getFormation();
  const badge = $('live-formation-badge');
  if (!badge) return;
  badge.textContent = formation;
  if (VALID_FORMATIONS.includes(formation)) {
    badge.classList.remove('formation-invalid');
  } else {
    badge.classList.add('formation-invalid');
  }
}

function saveLineup() {
  if (!AppState.userId || !liveGameweek) return;
  const cards = document.querySelectorAll('#live-pitch .live-card');
  const lineup = [];
  let benchIdx = 0;
  cards.forEach(c => {
    const isBench = c.dataset.isBench === 'true';
    lineup.push({
      id: parseInt(c.dataset.playerId),
      isBench: isBench,
      benchOrder: isBench ? ++benchIdx : 0,
      isCaptain: c.dataset.isCaptain === 'true',
      isVice: c.dataset.isVice === 'true',
    });
  });
  localStorage.setItem(`fpl_lineup_${AppState.userId}_${liveGameweek}`, JSON.stringify(lineup));
  // Flash saved indicator
  const ind = $('live-save-indicator');
  if (ind) { ind.classList.add('visible'); setTimeout(() => ind.classList.remove('visible'), 1500); }
}

function loadSavedLineup(picks) {
  if (!AppState.userId || !liveGameweek) return picks;
  const saved = localStorage.getItem(`fpl_lineup_${AppState.userId}_${liveGameweek}`);
  if (!saved) return picks;
  try {
    const lineup = JSON.parse(saved);
    const lineupMap = {};
    lineup.forEach(l => { lineupMap[l.id] = l; });
    // Only apply if all pick IDs match
    const pickIds = new Set(picks.map(p => p.id));
    const savedIds = new Set(lineup.map(l => l.id));
    if (pickIds.size !== savedIds.size || ![...pickIds].every(id => savedIds.has(id))) return picks;
    // Apply saved state
    picks.forEach(p => {
      const s = lineupMap[p.id];
      if (s) {
        p.multiplier = s.isBench ? 0 : (s.isCaptain ? 2 : 1);
        p.is_captain = s.isCaptain;
        p.is_vice_captain = s.isVice;
        p._benchOrder = s.benchOrder;
      }
    });
    // Sort bench by saved order
    const starting = picks.filter(p => p.multiplier > 0);
    const bench = picks.filter(p => p.multiplier === 0);
    bench.sort((a, b) => (a._benchOrder || 0) - (b._benchOrder || 0));
    return [...starting, ...bench];
  } catch { return picks; }
}

function enterCaptainMode(type) {
  if (captainMode) { exitCaptainMode(); return; }
  captainMode = type;
  const bar = $('live-captain-bar');
  const isVice = type === 'vice';
  bar.innerHTML = `<div class="captain-mode-bar${isVice ? ' vice-mode' : ''}">
    <span>Tap a starting player to set as ${isVice ? 'Vice Captain' : 'Captain'}</span>
    <button onclick="exitCaptainMode()">Cancel</button>
  </div>`;
  // Make starting cards clickable
  const cards = document.querySelectorAll('#live-pitch .live-card:not(.bench)');
  cards.forEach(c => {
    c.classList.add(isVice ? 'vice-selectable' : 'captain-selectable');
    c.setAttribute('draggable', 'false');
  });
}

function exitCaptainMode() {
  captainMode = null;
  $('live-captain-bar').innerHTML = '';
  const cards = document.querySelectorAll('#live-pitch .live-card');
  cards.forEach(c => {
    c.classList.remove('captain-selectable', 'vice-selectable');
    c.setAttribute('draggable', 'true');
  });
}

function handleCaptainClick(playerId) {
  if (!captainMode) return;
  const type = captainMode;
  const cards = document.querySelectorAll('#live-pitch .live-card');
  cards.forEach(c => {
    const pid = parseInt(c.dataset.playerId);
    if (type === 'captain') {
      if (pid === playerId) {
        c.dataset.isCaptain = 'true';
        // If this was vice captain, remove vice
        if (c.dataset.isVice === 'true') c.dataset.isVice = 'false';
      } else {
        c.dataset.isCaptain = 'false';
      }
    } else {
      if (pid === playerId) {
        c.dataset.isVice = 'true';
        // If this was captain, remove captain
        if (c.dataset.isCaptain === 'true') c.dataset.isCaptain = 'false';
      } else {
        c.dataset.isVice = 'false';
      }
    }
    // Update badge display
    const oldBadge = c.querySelector('.lp-captain, .lp-vice');
    if (oldBadge) oldBadge.remove();
    if (c.dataset.isCaptain === 'true') {
      c.insertAdjacentHTML('afterbegin', '<div class="lp-captain">C</div>');
    } else if (c.dataset.isVice === 'true') {
      c.insertAdjacentHTML('afterbegin', '<div class="lp-vice">V</div>');
    }
  });
  exitCaptainMode();
  saveLineup();
}

async function loadLive() {
  if (!AppState.userId) { $('live-no-user').classList.remove('hidden'); $('live-content').classList.add('hidden'); return; }
  $('live-no-user').classList.add('hidden');
  const loader = $('live-loader');
  loader.classList.add('active');
  $('live-content').classList.add('hidden');

  try {
    const resp = await fetch(`/api/live/${AppState.userId}`);
    const data = await resp.json();
    if (!resp.ok) { $('live-content').innerHTML = `<div class="error-msg">${data.error}</div>`; $('live-content').classList.remove('hidden'); return; }

    liveGameweek = data.gameweek;
    // Apply saved lineup if any
    data.picks = loadSavedLineup(data.picks);
    livePicksData = data.picks;

    // Recalculate bench points after applying saved lineup
    const benchPts = data.picks.filter(p => p.multiplier === 0).reduce((s, p) => s + p.raw_points, 0);
    const startPts = data.picks.filter(p => p.multiplier > 0).reduce((s, p) => s + p.raw_points * p.multiplier, 0);

    $('live-stats').innerHTML = `
      <div class="stat-card"><div class="label">${data.gameweek_name}</div><div class="value blue">${startPts}${data.hits ? `<span style="font-size:0.7rem;color:#FF5252"> (-${data.hits})</span>` : ''}</div></div>
      <div class="stat-card"><div class="label">On Bench</div><div class="value red">${benchPts}</div></div>
      ${data.overall_rank ? `<div class="stat-card"><div class="label">Overall Rank</div><div class="value">${data.overall_rank.toLocaleString()}</div></div>` : ''}
    `;

    const starting = data.picks.filter(p => p.multiplier > 0);
    const bench = data.picks.filter(p => p.multiplier === 0);

    const byPos = { 4: [], 3: [], 2: [], 1: [] };
    starting.forEach(p => { if (byPos[p.position]) byPos[p.position].push(p); });

    let pitchHtml = '';
    for (const pos of [4, 3, 2, 1]) {
      if (byPos[pos].length === 0) continue;
      pitchHtml += `<div class="pitch-row">${byPos[pos].map(p => liveCard(p, false)).join('')}</div>`;
    }
    pitchHtml += `<div class="pitch-row bench-row"><span class="bench-label">Bench</span>${bench.map((p, i) => liveCard(p, true, i + 1)).join('')}</div>`;

    $('live-pitch').innerHTML = pitchHtml;
    initLiveDragDrop();
    validateFormation();

    // BPS Ranking
    const allPicks = [...data.picks].sort((a, b) => (b.bps || 0) - (a.bps || 0));
    const hasBps = allPicks.some(p => p.bps > 0);
    if (hasBps) {
      let bpsHtml = '<div class="section" style="margin-top:1rem;"><div class="section-title blue">BPS Ranking (Projected Bonus)</div>';
      allPicks.forEach((p, i) => {
        let rankClass = 'none';
        let bonusPts = '';
        if (i === 0 && p.bps > 0) { rankClass = 'gold'; bonusPts = '+3'; }
        else if (i === 1 && p.bps > 0) { rankClass = 'silver'; bonusPts = '+2'; }
        else if (i === 2 && p.bps > 0) { rankClass = 'bronze'; bonusPts = '+1'; }
        bpsHtml += `<div class="bps-ranking-item">
          <div class="bps-rank ${rankClass}">${i + 1}</div>
          <span class="bps-name">${playerLink(p)} <span style="color:#8899AA;font-size:0.72rem;">${p.position_name}</span></span>
          <span class="bps-score">${p.bps || 0}</span>
          <span class="bps-bonus">${bonusPts}</span>
        </div>`;
      });
      bpsHtml += '</div>';
      $('live-bps-ranking').innerHTML = bpsHtml;
    } else {
      $('live-bps-ranking').innerHTML = '';
    }

    $('live-content').classList.remove('hidden');
    liveLoaded = true;
  } catch (err) {
    $('live-content').innerHTML = `<div class="error-msg">Failed to load: ${err.message}</div>`;
    $('live-content').classList.remove('hidden');
  } finally {
    loader.classList.remove('active');
  }
}

function liveCard(p, isBench, benchOrder) {
  let badge = '';
  if (p.is_captain) badge = '<div class="lp-captain">C</div>';
  else if (p.is_vice_captain) badge = '<div class="lp-vice">V</div>';
  const details = [];
  if (p.minutes > 0) details.push(`${p.minutes}'`);
  if (p.goals > 0) details.push(`${p.goals}G`);
  if (p.assists > 0) details.push(`${p.assists}A`);
  if (p.bonus > 0) details.push(`${p.bonus}B`);

  const photoUrl = p.photo ? `${PHOTO_BASE}${p.photo}.png` : '';
  const photoHtml = photoUrl
    ? `<img src="${photoUrl}" alt="${p.name}" onerror="this.parentElement.innerHTML='<span class=\\'lp-placeholder\\'>&#9917;</span>'">`
    : '<span class="lp-placeholder">&#9917;</span>';

  let upcomingHtml = '';
  if (p.upcoming && p.upcoming.length > 0) {
    upcomingHtml = '<div class="lp-upcoming">' + p.upcoming.map(fx =>
      `<span class="fdr-cell fdr-${fx.difficulty}" style="font-size:0.55rem;padding:0.1rem 0.2rem;margin:0 1px;" title="GW${fx.gw}: ${fx.opponent}${fx.is_home ? ' (H)' : ' (A)'}">${fx.opponent}</span>`
    ).join('') + '</div>';
  }

  // Injury flag
  let injuryHtml = '';
  const cop = p.chance_of_playing;
  if (p.news || (cop !== null && cop !== undefined && cop < 100)) {
    let injuryClass = 'injury-yellow';
    if (cop !== null && cop !== undefined && cop <= 25) injuryClass = 'injury-red';
    else if (p.news && (cop === null || cop === undefined)) injuryClass = 'injury-red';
    const tooltip = p.news || `${cop}% chance of playing`;
    injuryHtml = `<div class="lp-injury ${injuryClass}" title="${tooltip}"></div>`;
  }

  // Team color
  const teamColor = TEAM_COLORS[p.team_name] || '#333';

  // Bench order badge
  const benchBadge = isBench && benchOrder ? `<div class="bench-order">${benchOrder}</div>` : '';

  // Position name map for data attribute
  const posNames = {1:'GK', 2:'DEF', 3:'MID', 4:'FWD'};

  const kitHtml = kitImg(p.team, p.position === 1, 24);

  return `<div class="live-card${isBench ? ' bench' : ''}" draggable="true" data-player-id="${p.id}" data-is-bench="${isBench}" data-position="${p.position}" data-team="${p.team_name}" data-is-captain="${!!p.is_captain}" data-is-vice="${!!p.is_vice_captain}" style="--team-color:${teamColor}" onclick="handleCaptainClick(${p.id})">
    ${badge}${injuryHtml}
    <div class="lp-photo">${kitHtml || photoHtml}</div>
    <div class="lp-name"><span style="cursor:pointer;text-decoration:underline dotted;text-underline-offset:2px;" onclick="event.stopPropagation();openPlayerModal(${p.id})">${p.name}</span></div>
    <div class="lp-pts${p.live_points === 0 ? ' zero' : ''}">${p.live_points}</div>
    ${details.length ? `<div class="lp-detail">${details.join(' &middot; ')}</div>` : ''}
    ${upcomingHtml}${benchBadge}
    ${p.bps ? `<div class="lp-bps">${p.bps}</div>` : ''}
  </div>`;
}

function updateBenchOrders() {
  const benchCards = document.querySelectorAll('#live-pitch .live-card.bench');
  benchCards.forEach((c, i) => {
    let badge = c.querySelector('.bench-order');
    if (!badge) {
      c.insertAdjacentHTML('beforeend', `<div class="bench-order">${i + 1}</div>`);
    } else {
      badge.textContent = i + 1;
    }
  });
  // Remove bench-order from non-bench cards
  document.querySelectorAll('#live-pitch .live-card:not(.bench) .bench-order').forEach(b => b.remove());
}

function getFormationCounts() {
  const counts = {1:0, 2:0, 3:0, 4:0};
  document.querySelectorAll('#live-pitch .live-card:not(.bench)').forEach(c => {
    const pos = parseInt(c.dataset.position);
    if (counts[pos] !== undefined) counts[pos]++;
  });
  return counts;
}

function wouldFormationBeValid(draggedCard, targetCard) {
  const fromBench = draggedCard.dataset.isBench === 'true';
  const toBench = targetCard.dataset.isBench === 'true';
  if (fromBench === toBench) return true; // same zone swap always ok
  const fromPos = parseInt(draggedCard.dataset.position);
  const toPos = parseInt(targetCard.dataset.position);
  if (fromPos === toPos) return true; // same position swap always ok

  const counts = getFormationCounts();
  if (fromBench) {
    // bench player enters starting, target goes to bench
    counts[fromPos] = (counts[fromPos] || 0) + 1;
    counts[toPos] = (counts[toPos] || 0) - 1;
  } else {
    counts[fromPos] = (counts[fromPos] || 0) - 1;
    counts[toPos] = (counts[toPos] || 0) + 1;
  }
  const minMax = {1:[1,1], 2:[3,5], 3:[2,5], 4:[1,3]};
  for (const [pos, [min, max]] of Object.entries(minMax)) {
    const c = counts[parseInt(pos)] || 0;
    if (c < min || c > max) return false;
  }
  return true;
}

function initLiveDragDrop() {
  let draggedCard = null;
  const pitch = $('live-pitch');
  if (!pitch) return;

  // Touch drag support
  let touchStartX, touchStartY, touchClone, touchTarget;

  pitch.addEventListener('dragstart', e => {
    const card = e.target.closest('.live-card');
    if (!card || captainMode) { e.preventDefault(); return; }
    draggedCard = card;
    card.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
  });

  pitch.addEventListener('dragend', e => {
    if (draggedCard) draggedCard.classList.remove('dragging');
    draggedCard = null;
    pitch.querySelectorAll('.live-card').forEach(c => c.classList.remove('drag-over'));
  });

  pitch.addEventListener('dragover', e => {
    const card = e.target.closest('.live-card');
    if (!draggedCard || !card || draggedCard === card) return;

    const fromBench = draggedCard.dataset.isBench === 'true';
    const toBench = card.dataset.isBench === 'true';

    // Allow: bench<->starting, bench<->bench, starting<->starting
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    card.classList.add('drag-over');
  });

  pitch.addEventListener('dragleave', e => {
    const card = e.target.closest('.live-card');
    if (card) card.classList.remove('drag-over');
  });

  pitch.addEventListener('drop', e => {
    e.preventDefault();
    const card = e.target.closest('.live-card');
    if (!card) return;
    card.classList.remove('drag-over');
    if (!draggedCard || draggedCard === card) return;

    // Validate formation before swapping
    if (!wouldFormationBeValid(draggedCard, card)) {
      draggedCard.classList.remove('dragging');
      card.classList.add('drag-invalid');
      setTimeout(() => card.classList.remove('drag-invalid'), 500);
      draggedCard = null;
      return;
    }

    const fromBench = draggedCard.dataset.isBench === 'true';
    const toBench = card.dataset.isBench === 'true';

    // Swap the DOM positions
    const parentA = draggedCard.parentNode;
    const parentB = card.parentNode;
    const placeholderA = document.createElement('div');
    const placeholderB = document.createElement('div');
    parentA.insertBefore(placeholderA, draggedCard);
    parentB.insertBefore(placeholderB, card);
    parentB.insertBefore(draggedCard, placeholderB);
    parentA.insertBefore(card, placeholderA);
    placeholderA.remove();
    placeholderB.remove();

    // Update bench/starting status
    if (fromBench !== toBench) {
      if (fromBench) {
        draggedCard.classList.remove('bench');
        draggedCard.dataset.isBench = 'false';
        card.classList.add('bench');
        card.dataset.isBench = 'true';
      } else {
        card.classList.remove('bench');
        card.dataset.isBench = 'false';
        draggedCard.classList.add('bench');
        draggedCard.dataset.isBench = 'true';
      }
    }
    // If both bench, it's just a reorder (DOM positions already swapped)

    draggedCard = null;
    updateBenchOrders();
    validateFormation();
    saveLineup();
  });

  // --- Touch support for mobile ---
  pitch.addEventListener('touchstart', e => {
    const card = e.target.closest('.live-card');
    if (!card || captainMode) return;
    draggedCard = card;
    const touch = e.touches[0];
    touchStartX = touch.clientX;
    touchStartY = touch.clientY;
    touchClone = card.cloneNode(true);
    touchClone.style.cssText = 'position:fixed;z-index:9999;opacity:0.8;pointer-events:none;width:80px;';
    touchClone.style.left = (touch.clientX - 40) + 'px';
    touchClone.style.top = (touch.clientY - 40) + 'px';
    document.body.appendChild(touchClone);
    card.classList.add('dragging');
  }, { passive: true });

  pitch.addEventListener('touchmove', e => {
    if (!draggedCard || !touchClone) return;
    e.preventDefault();
    const touch = e.touches[0];
    touchClone.style.left = (touch.clientX - 40) + 'px';
    touchClone.style.top = (touch.clientY - 40) + 'px';
    // Highlight drop target
    pitch.querySelectorAll('.live-card').forEach(c => c.classList.remove('drag-over'));
    const el = document.elementFromPoint(touch.clientX, touch.clientY);
    const target = el ? el.closest('.live-card') : null;
    if (target && target !== draggedCard) target.classList.add('drag-over');
    touchTarget = target;
  }, { passive: false });

  pitch.addEventListener('touchend', e => {
    if (touchClone) { touchClone.remove(); touchClone = null; }
    if (!draggedCard) return;
    draggedCard.classList.remove('dragging');
    pitch.querySelectorAll('.live-card').forEach(c => c.classList.remove('drag-over'));

    if (touchTarget && touchTarget !== draggedCard) {
      // Validate formation before swapping
      if (!wouldFormationBeValid(draggedCard, touchTarget)) {
        touchTarget.classList.add('drag-invalid');
        setTimeout(() => touchTarget.classList.remove('drag-invalid'), 500);
        draggedCard = null; touchTarget = null;
        return;
      }

      const fromBench = draggedCard.dataset.isBench === 'true';
      const toBench = touchTarget.dataset.isBench === 'true';

      const parentA = draggedCard.parentNode;
      const parentB = touchTarget.parentNode;
      const placeholderA = document.createElement('div');
      const placeholderB = document.createElement('div');
      parentA.insertBefore(placeholderA, draggedCard);
      parentB.insertBefore(placeholderB, touchTarget);
      parentB.insertBefore(draggedCard, placeholderB);
      parentA.insertBefore(touchTarget, placeholderA);
      placeholderA.remove();
      placeholderB.remove();

      if (fromBench !== toBench) {
        if (fromBench) {
          draggedCard.classList.remove('bench');
          draggedCard.dataset.isBench = 'false';
          touchTarget.classList.add('bench');
          touchTarget.dataset.isBench = 'true';
        } else {
          touchTarget.classList.remove('bench');
          touchTarget.dataset.isBench = 'false';
          draggedCard.classList.add('bench');
          draggedCard.dataset.isBench = 'true';
        }
      }

      updateBenchOrders();
      validateFormation();
      saveLineup();
    }
    draggedCard = null;
    touchTarget = null;
  });
}

// ==================== FDR HEATMAP ====================
let fdrLoaded = false;
async function loadFDR() {
  if (fdrLoaded) return;
  const loader = $('fdr-loader');
  loader.classList.add('active');

  try {
    const resp = await fetch('/api/fdr?lookahead=8');
    const data = await resp.json();
    if (data.error) throw new Error(data.error);

    let html = '<table><thead><tr><th class="team-col">Team</th>';
    data.gw_ids.forEach(gw => { html += `<th>GW${gw}</th>`; });
    html += '</tr></thead><tbody>';

    data.rows.forEach(row => {
      html += `<tr><td class="team-col">${row.team_name}</td>`;
      row.gws.forEach(fxList => {
        if (fxList.length === 0) {
          html += '<td>-</td>';
        } else {
          const cells = fxList.map(fx => {
            const home = fx.is_home ? '<span class="fdr-home">(H)</span>' : '';
            return `<div class="fdr-cell fdr-${fx.difficulty}">${fx.opponent} ${home}</div>`;
          }).join('');
          html += `<td>${cells}</td>`;
        }
      });
      html += '</tr>';
    });
    html += '</tbody></table>';

    $('fdr-container').innerHTML = html;
    fdrLoaded = true;
  } catch (err) {
    $('fdr-container').innerHTML = `<div class="error-msg">${err.message}</div>`;
  } finally {
    loader.classList.remove('active');
  }
}

// ==================== CAPTAIN PICKS ====================
async function loadCaptainPicks() {
  if (AppState._loaded.captain) return;
  const loader = $('captain-loader');
  loader.classList.add('active');

  try {
    const resp = await fetch('/api/captain-picks');
    const data = await resp.json();
    if (data.error) throw new Error(data.error);

    $('captain-body').innerHTML = data.picks.map((p, i) => `<tr${i === 0 ? ' style="background:#1a2a1a"' : ''}>
      <td>${i === 0 ? '<span style="color:#FFB800;font-weight:bold">1</span>' : i + 1}</td>
      <td><strong>${playerLink(p)}</strong></td>
      <td>${p.team_name}</td>
      <td class="pos">${p.position_name}</td>
      <td class="right">${p.form.toFixed(1)}</td>
      <td class="right">${p.points_per_game.toFixed(1)}</td>
      <td class="right">${p.xG.toFixed(2)}</td>
      <td class="right">${p.xA.toFixed(2)}</td>
      <td class="right" style="color:#4da6ff">${(p.ep_next || 0).toFixed(1)}</td>
      <td class="right"><span class="fdr-cell fdr-${Math.round((1 - p.fixture_difficulty) * 4) + 1}" style="padding:0.15rem 0.4rem;">${p.fixture_difficulty.toFixed(2)}</span></td>
      <td class="right score">${p.composite_score.toFixed(3)}</td>
    </tr>`).join('');
    $('captain-table').classList.remove('hidden');
    applyCardLabels($('captain-table'));
    drawCaptainEVChart(data.picks);
    $('captain-ev-section').classList.remove('hidden');
    AppState._loaded.captain = true;
  } catch (err) {
    $('captain-table').parentElement.innerHTML += `<div class="error-msg">${err.message}</div>`;
  } finally {
    loader.classList.remove('active');
  }
}

function drawCaptainEVChart(picks) {
  const canvas = $('captain-ev-canvas');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const w = canvas.width, h = canvas.height;
  const pad = { top: 25, right: 15, bottom: 55, left: 45 };
  ctx.clearRect(0, 0, w, h);

  const items = picks.map(p => ({ name: p.name, ev: (p.ep_next || 0) * 2, score: p.composite_score }));
  const maxEV = Math.max(...items.map(i => i.ev)) || 1;
  const chartH = h - pad.top - pad.bottom;
  const gap = (w - pad.left - pad.right) / items.length;
  const barW = Math.min(gap * 0.65, 36);

  // Y axis gridlines
  for (let i = 0; i <= 4; i++) {
    const y = pad.top + chartH - (i / 4) * chartH;
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(w - pad.right, y);
    ctx.strokeStyle = '#1B2D45'; ctx.lineWidth = 1; ctx.stroke();
    ctx.fillStyle = '#555'; ctx.font = '10px sans-serif'; ctx.textAlign = 'right';
    ctx.fillText((maxEV * i / 4).toFixed(1), pad.left - 6, y + 3);
  }

  items.forEach((item, i) => {
    const barH = Math.max((item.ev / maxEV) * chartH, 2);
    const x = pad.left + i * gap + (gap - barW) / 2;
    const y = pad.top + chartH - barH;

    const grad = ctx.createLinearGradient(x, y, x, y + barH);
    if (i === 0) { grad.addColorStop(0, '#FFB800'); grad.addColorStop(1, '#b8860b'); }
    else { grad.addColorStop(0, '#00E676'); grad.addColorStop(1, '#007a42'); }
    ctx.fillStyle = grad;

    // Rounded top bar
    const r = Math.min(4, barW / 2);
    ctx.beginPath();
    ctx.moveTo(x + r, y); ctx.lineTo(x + barW - r, y);
    ctx.quadraticCurveTo(x + barW, y, x + barW, y + r);
    ctx.lineTo(x + barW, y + barH); ctx.lineTo(x, y + barH);
    ctx.lineTo(x, y + r); ctx.quadraticCurveTo(x, y, x + r, y);
    ctx.fill();

    // Value on top
    ctx.fillStyle = '#F0F0F0'; ctx.font = 'bold 11px sans-serif'; ctx.textAlign = 'center';
    ctx.fillText(item.ev.toFixed(1), x + barW / 2, y - 6);

    // Name at bottom (rotated)
    ctx.save();
    ctx.translate(x + barW / 2, h - pad.bottom + 8);
    ctx.rotate(-Math.PI / 5);
    ctx.fillStyle = '#888'; ctx.font = '10px sans-serif'; ctx.textAlign = 'right';
    ctx.fillText(item.name, 0, 0);
    ctx.restore();
  });

  // Y axis label
  ctx.save();
  ctx.translate(12, pad.top + chartH / 2);
  ctx.rotate(-Math.PI / 2);
  ctx.fillStyle = '#555'; ctx.font = '10px sans-serif'; ctx.textAlign = 'center';
  ctx.fillText('Captain EV (xPts x2)', 0, 0);
  ctx.restore();
}

// ==================== PRICE CHANGES ====================
async function loadPriceChanges() {
  if (AppState._loaded.prices) return;
  const loader = $('prices-loader');
  loader.classList.add('active');

  try {
    const resp = await fetch('/api/price-changes');
    const data = await resp.json();
    if (data.error) throw new Error(data.error);

    $('risers-container').innerHTML = data.risers.map(p => priceCard(p, true)).join('');
    $('fallers-container').innerHTML = data.fallers.map(p => priceCard(p, false)).join('');
    AppState._loaded.prices = true;
  } catch (err) {
    $('risers-container').innerHTML = `<div class="error-msg">${err.message}</div>`;
  } finally {
    loader.classList.remove('active');
  }
}

function priceCard(p, isRiser) {
  const net = p.net_transfers;
  const cls = net > 0 ? 'net-positive' : (net < 0 ? 'net-negative' : '');
  const changed = p.cost_change_event !== 0;
  return `<div class="price-card">
    <div class="player-info">
      <div class="player-name">${p.name}${changed ? ` <span style="font-size:0.75rem;color:${p.cost_change_event > 0 ? '#51cf66' : '#FF5252'}">(${p.cost_change_event > 0 ? '+' : ''}${(p.cost_change_event / 10).toFixed(1)})</span>` : ''}</div>
      <div class="player-meta">${p.team_name} &middot; ${p.position_name} &middot; ${p.cost.toFixed(1)}M &middot; ${p.selected_by_percent}%</div>
    </div>
    <div class="transfer-stat">
      <div class="${cls}" style="font-size:0.9rem;">${net > 0 ? '+' : ''}${net.toLocaleString()}</div>
      <div style="font-size:0.68rem;color:#8899AA;">${isRiser ? `+${p.transfers_in.toLocaleString()} in` : `${p.transfers_out.toLocaleString()} out`}</div>
    </div>
  </div>`;
}

// ==================== DIFFERENTIALS ====================
let diffLoaded = false;
async function loadDifferentials() {
  const loader = $('diff-loader');
  loader.classList.add('active');
  $('diff-table').classList.add('hidden');
  diffLoaded = false;

  try {
    const own = $('diff-ownership').value;
    const resp = await fetch(`/api/differentials?max_ownership=${own}`);
    const data = await resp.json();
    if (data.error) throw new Error(data.error);

    $('diff-body').innerHTML = data.differentials.map((p, i) => `<tr>
      <td>${i + 1}</td>
      <td><strong>${p.name}</strong></td>
      <td>${p.team_name}</td>
      <td class="pos">${p.position_name}</td>
      <td class="right cost">${p.cost.toFixed(1)}</td>
      <td class="right">${p.total_points}</td>
      <td class="right">${p.form.toFixed(1)}</td>
      <td class="right">${p.points_per_game.toFixed(1)}</td>
      <td class="right" style="color:#4da6ff">${p.selected_by_percent}%</td>
      <td class="right score">${p.composite_score.toFixed(3)}</td>
    </tr>`).join('');
    $('diff-table').classList.remove('hidden');
    applyCardLabels($('diff-table'));
    diffLoaded = true;
  } catch (err) {
    $('diff-table').parentElement.innerHTML += `<div class="error-msg">${err.message}</div>`;
  } finally {
    loader.classList.remove('active');
  }
}

// ==================== ROTATION RISK ====================
let rotationLoaded = false;
async function loadRotationRisk() {
  if (rotationLoaded) return;
  const loader = $('rotation-loader');
  loader.classList.add('active');
  $('rotation-table').classList.add('hidden');

  try {
    const resp = await fetch('/api/rotation-risk');
    const data = await resp.json();
    if (data.error) throw new Error(data.error);

    $('rotation-body').innerHTML = data.players.map(p => {
      const riskPct = (p.rotation_risk * 100).toFixed(0);
      const color = p.rotation_risk >= 0.6 ? '#FF5252' : p.rotation_risk >= 0.4 ? '#FFB800' : '#888';
      return `<tr>
        <td><strong>${p.name}</strong></td>
        <td>${p.team_name}</td>
        <td class="pos">${p.position_name}</td>
        <td class="right" style="color:${color};font-weight:bold">${riskPct}%</td>
        <td class="right">${p.starts}</td>
        <td class="right">${p.minutes}</td>
        <td class="right">${p.chance_of_playing !== null ? p.chance_of_playing + '%' : '-'}</td>
        <td class="right">${p.form.toFixed(1)}</td>
        <td class="right">${p.total_points}</td>
        <td style="font-size:0.72rem;color:#8899AA;max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${p.news || '-'}</td>
      </tr>`;
    }).join('');
    $('rotation-table').classList.remove('hidden');
    applyCardLabels($('rotation-table'));
    rotationLoaded = true;
  } catch (err) {
    $('rotation-body').innerHTML = `<tr><td colspan="10" style="text-align:center;color:#FF5252">${err.message}</td></tr>`;
    $('rotation-table').classList.remove('hidden');
  } finally {
    loader.classList.remove('active');
  }
}

// ==================== PLAYER COMPARISON ====================
function debouncedCompareSearch() {
  clearTimeout(compareTimer);
  compareTimer = setTimeout(compareSearch, 300);
}

async function compareSearch() {
  const q = $('compare-input').value.trim();
  if (q.length < 2) { $('compare-results').innerHTML = ''; return; }

  if (!allPlayersCache) {
    const resp = await fetch('/api/players?sort=total_points&dir=desc');
    const data = await resp.json();
    allPlayersCache = data.players;
  }

  const lower = q.toLowerCase();
  const matches = allPlayersCache.filter(p => p.name.toLowerCase().includes(lower)).slice(0, 8);
  $('compare-results').innerHTML = matches.map(p =>
    `<div class="compare-pick" onclick="addCompare(${p.id}, '${p.name.replace(/'/g, "\\'")}')">${p.name} <span style="color:#8899AA;font-size:0.72rem;">${p.team_name} ${p.position_name}</span></div>`
  ).join('');
}

function addCompare(pid, name) {
  if (compareIds.length >= 4 || compareIds.includes(pid)) return;
  compareIds.push(pid);
  renderCompareChips();
  $('compare-input').value = '';
  $('compare-results').innerHTML = '';
  if (compareIds.length >= 2) runComparison();
}

function removeCompare(pid) {
  compareIds = compareIds.filter(id => id !== pid);
  renderCompareChips();
  if (compareIds.length >= 2) runComparison();
  else $('compare-output').innerHTML = '';
}

function renderCompareChips() {
  if (!allPlayersCache) return;
  $('compare-chips').innerHTML = compareIds.map(pid => {
    const p = allPlayersCache.find(pl => pl.id === pid);
    return `<div class="compare-chip">${p ? p.name : pid} <span class="remove" onclick="removeCompare(${pid})">&times;</span></div>`;
  }).join('');
}

async function runComparison() {
  try {
    const resp = await fetch('/api/compare', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ player_ids: compareIds }),
    });
    const data = await resp.json();
    if (!resp.ok || data.error) { $('compare-output').innerHTML = `<div class="error-msg">${data.error}</div>`; return; }

    const ps = data.players;
    const colors = ['#00E676', '#4da6ff', '#FFB800', '#ff6b9d'];
    const chartMode = $('compare-chart-mode').value;

    const stats = ['form', 'points_per_game', 'xG', 'xA', 'ict_index', 'bonus', 'bps', 'composite_score'];
    const labels = ['Form', 'PPG', 'xG', 'xA', 'ICT', 'Bonus', 'BPS', 'Score'];
    const maxes = stats.map(s => Math.max(...ps.map(p => p[s])) || 1);

    let html = '<div class="compare-container">';
    if (chartMode === 'radar') {
      html += `<canvas id="radar-canvas" width="320" height="320"></canvas>`;
    } else {
      html += `<canvas id="bar-canvas" width="600" height="300"></canvas>`;
    }

    // Legend
    html += '<div class="compare-legend">';
    ps.forEach((p, i) => { html += `<span style="color:${colors[i]};margin-right:1rem;font-size:0.8rem;font-weight:600">\u25CF ${p.name}</span>`; });
    html += '</div>';

    html += '<div class="compare-table"><div class="table-wrap"><table><thead><tr><th>Stat</th>';
    ps.forEach((p, i) => { html += `<th style="color:${colors[i]}">${p.name}</th>`; });
    html += '</tr></thead><tbody>';

    const rows = [
      ['Position', ps.map(p => p.position_name)],
      ['Team', ps.map(p => p.team_name)],
      ['Cost', ps.map(p => p.cost.toFixed(1) + 'M')],
      ['Total Pts', ps.map(p => String(p.total_points))],
      ['Form', ps.map(p => p.form.toFixed(1))],
      ['PPG', ps.map(p => p.points_per_game.toFixed(1))],
      ['xG', ps.map(p => p.xG.toFixed(2))],
      ['xA', ps.map(p => p.xA.toFixed(2))],
      ['xGI', ps.map(p => p.expected_goal_involvements.toFixed(2))],
      ['Goals', ps.map(p => String(p.goals))],
      ['Assists', ps.map(p => String(p.assists))],
      ['Clean Sheets', ps.map(p => String(p.clean_sheets))],
      ['Bonus', ps.map(p => String(p.bonus))],
      ['BPS', ps.map(p => String(p.bps))],
      ['ICT', ps.map(p => p.ict_index.toFixed(1))],
      ['Influence', ps.map(p => p.influence.toFixed(1))],
      ['Creativity', ps.map(p => p.creativity.toFixed(1))],
      ['Threat', ps.map(p => p.threat.toFixed(1))],
      ['Saves', ps.map(p => String(p.saves))],
      ['xPts Next', ps.map(p => p.ep_next.toFixed(1))],
      ['Ownership', ps.map(p => p.selected_by_percent + '%')],
      ['Minutes', ps.map(p => String(p.minutes))],
      ['Starts', ps.map(p => String(p.starts))],
      ['Score', ps.map(p => p.composite_score.toFixed(3))],
    ];

    // Highlight best value per row
    rows.forEach(([label, vals]) => {
      html += `<tr><td style="color:#8899AA">${label}</td>`;
      const numVals = vals.map(v => parseFloat(v));
      const isBest = numVals.map((v, i) => !isNaN(v) && v === Math.max(...numVals.filter(n => !isNaN(n))));
      vals.forEach((v, i) => {
        const bold = isBest[i] && !['Position','Team'].includes(label) ? 'font-weight:600;color:#00E676' : '';
        html += `<td class="right" style="${bold}">${v}</td>`;
      });
      html += '</tr>';
    });

    html += '</tbody></table></div></div></div>';
    $('compare-output').innerHTML = html;

    if (chartMode === 'radar') {
      drawRadar(ps, stats, labels, maxes, colors);
    } else {
      drawBarChart(ps, stats, labels, maxes, colors);
    }
  } catch (err) {
    $('compare-output').innerHTML = `<div class="error-msg">${err.message}</div>`;
  }
}

function drawRadar(players, stats, labels, maxes, colors) {
  const canvas = $('radar-canvas');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const w = canvas.width, h = canvas.height;
  const cx = w/2, cy = h/2, r = Math.min(w, h)/2 - 30;
  const n = stats.length;
  ctx.clearRect(0, 0, w, h);

  for (let ring = 1; ring <= 4; ring++) {
    ctx.beginPath();
    const rr = r * ring / 4;
    for (let i = 0; i <= n; i++) {
      const angle = (Math.PI * 2 * i / n) - Math.PI / 2;
      const x = cx + rr * Math.cos(angle);
      const y = cy + rr * Math.sin(angle);
      i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
    }
    ctx.strokeStyle = 'rgba(255,255,255,0.1)';
    ctx.stroke();
  }

  for (let i = 0; i < n; i++) {
    const angle = (Math.PI * 2 * i / n) - Math.PI / 2;
    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.lineTo(cx + r * Math.cos(angle), cy + r * Math.sin(angle));
    ctx.strokeStyle = 'rgba(255,255,255,0.1)';
    ctx.stroke();

    const lx = cx + (r + 18) * Math.cos(angle);
    const ly = cy + (r + 18) * Math.sin(angle);
    ctx.fillStyle = '#888';
    ctx.font = '10px sans-serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(labels[i], lx, ly);
  }

  players.forEach((p, pi) => {
    ctx.beginPath();
    for (let i = 0; i <= n; i++) {
      const si = i % n;
      const val = maxes[si] > 0 ? p[stats[si]] / maxes[si] : 0;
      const angle = (Math.PI * 2 * si / n) - Math.PI / 2;
      const x = cx + r * val * Math.cos(angle);
      const y = cy + r * val * Math.sin(angle);
      i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
    }
    ctx.closePath();
    ctx.strokeStyle = colors[pi];
    ctx.lineWidth = 2;
    ctx.stroke();
    ctx.fillStyle = colors[pi] + '22';
    ctx.fill();
  });
}

function drawBarChart(players, stats, labels, maxes, colors) {
  const canvas = $('bar-canvas');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const w = canvas.width, h = canvas.height;
  const pad = { top: 20, right: 20, bottom: 40, left: 10 };
  ctx.clearRect(0, 0, w, h);

  const nGroups = stats.length;
  const nBars = players.length;
  const groupW = (w - pad.left - pad.right) / nGroups;
  const barW = Math.min(groupW / (nBars + 1), 24);
  const chartH = h - pad.top - pad.bottom;

  // Draw bars
  for (let g = 0; g < nGroups; g++) {
    const gx = pad.left + g * groupW + groupW / 2;
    const totalW = nBars * barW + (nBars - 1) * 2;
    const startX = gx - totalW / 2;

    for (let b = 0; b < nBars; b++) {
      const val = maxes[g] > 0 ? players[b][stats[g]] / maxes[g] : 0;
      const barH = Math.max(val * chartH, 2);
      const x = startX + b * (barW + 2);
      const y = pad.top + chartH - barH;

      ctx.fillStyle = colors[b];
      ctx.globalAlpha = 0.85;
      ctx.beginPath();
      const radius = 3;
      ctx.moveTo(x + radius, y);
      ctx.lineTo(x + barW - radius, y);
      ctx.quadraticCurveTo(x + barW, y, x + barW, y + radius);
      ctx.lineTo(x + barW, y + barH);
      ctx.lineTo(x, y + barH);
      ctx.lineTo(x, y + radius);
      ctx.quadraticCurveTo(x, y, x + radius, y);
      ctx.fill();
      ctx.globalAlpha = 1;
    }

    // Label
    ctx.fillStyle = '#888';
    ctx.font = '10px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText(labels[g], gx, h - pad.bottom + 16);
  }

  // Bottom line
  ctx.beginPath();
  ctx.moveTo(pad.left, pad.top + chartH);
  ctx.lineTo(w - pad.right, pad.top + chartH);
  ctx.strokeStyle = 'rgba(255,255,255,0.1)';
  ctx.lineWidth = 1;
  ctx.stroke();
}

// ==================== RIVAL COMPARISON ====================
async function loadRival(rank, name, event) {
  event.stopPropagation();
  if (!AppState.userId) return;

  const rivalId = prompt(`Enter FPL User ID for "${name}" to compare squads:`);
  if (!rivalId) return;
  const rid = parseInt(rivalId);
  if (isNaN(rid)) return;

  // Switch to rival panel
  switchNav('nav-leagues-rival');
  $('rival-output').innerHTML = '<div class="loader active"><div class="spinner"></div><div class="loader-text">Loading rival comparison...</div></div>';

  try {
    const resp = await fetch(`/api/rival/${rid}?user_id=${AppState.userId}`);
    const data = await resp.json();
    if (!resp.ok) { $('rival-output').innerHTML = `<div class="error-msg">${data.error}</div>`; return; }

    renderRivalOutput(data);
  } catch (err) {
    $('rival-output').innerHTML = `<div class="error-msg">${err.message}</div>`;
  }
}

async function loadRivalDirect() {
  if (!AppState.userId) {
    $('rival-output').innerHTML = '<div class="error-msg">Load your FPL ID in Settings first.</div>';
    return;
  }
  const rivalId = $('rival-id-input').value.trim();
  if (!rivalId) return;
  const rid = parseInt(rivalId);
  if (isNaN(rid)) return;

  $('rival-output').innerHTML = '<div class="loader active"><div class="spinner"></div><div class="loader-text">Loading rival comparison...</div></div>';

  try {
    const resp = await fetch(`/api/rival/${rid}?user_id=${AppState.userId}`);
    const data = await resp.json();
    if (!resp.ok) { $('rival-output').innerHTML = `<div class="error-msg">${data.error}</div>`; return; }

    renderRivalOutput(data);
  } catch (err) {
    $('rival-output').innerHTML = `<div class="error-msg">${err.message}</div>`;
  }
}

function renderRivalOutput(data) {
  let html = '<div class="section-title blue">Squad Comparison</div>';
  html += '<div class="stat-row">';
  html += `<div class="stat-card"><div class="label">${data.my_manager}</div><div class="value blue">${data.my_total_points}</div></div>`;
  html += `<div class="stat-card"><div class="label">${data.rival_manager}</div><div class="value" style="color:#FFB800">${data.rival_total_points}</div></div>`;
  html += `<div class="stat-card"><div class="label">Shared</div><div class="value">${data.shared.length}</div></div>`;
  html += '</div>';

  html += '<div class="rival-cols">';
  html += '<div class="rival-col"><div class="rival-header" style="color:#4da6ff">Only in My Team</div>';
  data.only_mine.forEach(p => { html += `<div class="rival-player"><span>${p.name} <span class="pos">${p.position_name}</span></span><span class="cost">${p.cost.toFixed(1)}</span></div>`; });
  html += '</div>';
  html += '<div class="rival-col"><div class="rival-header" style="color:#FFB800">Only in Rival\'s Team</div>';
  data.only_rival.forEach(p => { html += `<div class="rival-player"><span>${p.name} <span class="pos">${p.position_name}</span></span><span class="cost">${p.cost.toFixed(1)}</span></div>`; });
  html += '</div></div>';

  if (data.shared.length > 0) {
    html += '<div class="shared-list"><div class="shared-header">Shared Players</div>';
    data.shared.forEach(p => { html += `<div class="rival-player"><span>${p.name} <span class="pos">${p.position_name}</span></span><span class="score">${p.total_points}pts</span></div>`; });
    html += '</div>';
  }

  $('rival-output').innerHTML = html;
}

// ==================== PLAYERS TAB ====================
function debouncedLoadPlayers() {
  clearTimeout(debounceTimer);
  debounceTimer = setTimeout(loadPlayers, 300);
}

let lastPlayersData = [];

function switchPlayerView() {
  const mode = $('player-view-mode').value;
  const thead = $('players-thead');
  if (mode === 'advanced') {
    thead.innerHTML = `<tr>
      <th class="sortable ${playersSort.col==='total_points'?'sort-'+playersSort.dir:''}" data-sort="total_points" onclick="sortPlayers(this)">Pts</th>
      <th>Pos</th>
      <th class="sortable ${playersSort.col==='name'?'sort-'+playersSort.dir:''}" data-sort="name" onclick="sortPlayers(this)">Player</th>
      <th>Team</th>
      <th class="sortable right ${playersSort.col==='cost'?'sort-'+playersSort.dir:''}" data-sort="cost" onclick="sortPlayers(this)">Cost</th>
      <th class="sortable right ${playersSort.col==='xG'?'sort-'+playersSort.dir:''}" data-sort="xG" onclick="sortPlayers(this)">xG</th>
      <th class="sortable right ${playersSort.col==='xA'?'sort-'+playersSort.dir:''}" data-sort="xA" onclick="sortPlayers(this)">xA</th>
      <th class="sortable right ${playersSort.col==='expected_goal_involvements'?'sort-'+playersSort.dir:''}" data-sort="expected_goal_involvements" onclick="sortPlayers(this)">xGI</th>
      <th class="sortable right ${playersSort.col==='bps'?'sort-'+playersSort.dir:''}" data-sort="bps" onclick="sortPlayers(this)">BPS</th>
      <th class="sortable right ${playersSort.col==='bonus'?'sort-'+playersSort.dir:''}" data-sort="bonus" onclick="sortPlayers(this)">Bonus</th>
      <th class="sortable right ${playersSort.col==='ict_index'?'sort-'+playersSort.dir:''}" data-sort="ict_index" onclick="sortPlayers(this)">ICT</th>
      <th class="sortable right ${playersSort.col==='ep_next'?'sort-'+playersSort.dir:''}" data-sort="ep_next" onclick="sortPlayers(this)">xPts</th>
      <th class="sortable right ${playersSort.col==='selected_by_percent'?'sort-'+playersSort.dir:''}" data-sort="selected_by_percent" onclick="sortPlayers(this)">Own%</th>
    </tr>`;
  } else {
    thead.innerHTML = `<tr>
      <th class="sortable ${playersSort.col==='total_points'?'sort-'+playersSort.dir:''}" data-sort="total_points" onclick="sortPlayers(this)">Pts</th>
      <th>Pos</th>
      <th class="sortable ${playersSort.col==='name'?'sort-'+playersSort.dir:''}" data-sort="name" onclick="sortPlayers(this)">Player</th>
      <th>Team</th>
      <th class="sortable right ${playersSort.col==='cost'?'sort-'+playersSort.dir:''}" data-sort="cost" onclick="sortPlayers(this)">Cost</th>
      <th class="sortable right ${playersSort.col==='form'?'sort-'+playersSort.dir:''}" data-sort="form" onclick="sortPlayers(this)">Form</th>
      <th class="sortable right ${playersSort.col==='goals'?'sort-'+playersSort.dir:''}" data-sort="goals" onclick="sortPlayers(this)">G</th>
      <th class="sortable right ${playersSort.col==='assists'?'sort-'+playersSort.dir:''}" data-sort="assists" onclick="sortPlayers(this)">A</th>
      <th class="sortable right ${playersSort.col==='clean_sheets'?'sort-'+playersSort.dir:''}" data-sort="clean_sheets" onclick="sortPlayers(this)">CS</th>
      <th class="sortable right ${playersSort.col==='bonus'?'sort-'+playersSort.dir:''}" data-sort="bonus" onclick="sortPlayers(this)">Bonus</th>
      <th class="sortable right ${playersSort.col==='points_per_game'?'sort-'+playersSort.dir:''}" data-sort="points_per_game" onclick="sortPlayers(this)">PPG</th>
      <th class="sortable right ${playersSort.col==='minutes'?'sort-'+playersSort.dir:''}" data-sort="minutes" onclick="sortPlayers(this)">Min</th>
      <th class="sortable right ${playersSort.col==='selected_by_percent'?'sort-'+playersSort.dir:''}" data-sort="selected_by_percent" onclick="sortPlayers(this)">Own%</th>
    </tr>`;
  }
  renderPlayersBody(lastPlayersData);
}

function renderPlayersBody(players) {
  const mode = $('player-view-mode').value;
  if (mode === 'advanced') {
    $('players-body').innerHTML = players.map(p => `<tr>
      <td class="score">${p.total_points}</td>
      <td class="pos">${p.position_name}</td>
      <td>${playerLink(p)}</td>
      <td>${p.team_name}</td>
      <td class="right cost">${p.cost.toFixed(1)}</td>
      <td class="right">${p.xG.toFixed(2)}</td>
      <td class="right">${p.xA.toFixed(2)}</td>
      <td class="right">${p.expected_goal_involvements.toFixed(2)}</td>
      <td class="right">${p.bps}</td>
      <td class="right">${p.bonus}</td>
      <td class="right">${p.ict_index.toFixed(1)}</td>
      <td class="right">${p.ep_next.toFixed(1)}</td>
      <td class="right" style="color:#4da6ff">${p.selected_by_percent}%</td>
    </tr>`).join('');
  } else {
    $('players-body').innerHTML = players.map(p => `<tr>
      <td class="score">${p.total_points}</td>
      <td class="pos">${p.position_name}</td>
      <td>${playerLink(p)}</td>
      <td>${p.team_name}</td>
      <td class="right cost">${p.cost.toFixed(1)}</td>
      <td class="right">${p.form.toFixed(1)}</td>
      <td class="right">${p.goals}</td>
      <td class="right">${p.assists}</td>
      <td class="right">${p.clean_sheets}</td>
      <td class="right">${p.bonus}</td>
      <td class="right">${p.points_per_game.toFixed(1)}</td>
      <td class="right">${p.minutes}</td>
      <td class="right" style="color:#4da6ff">${p.selected_by_percent}%</td>
    </tr>`).join('');
  }
  applyCardLabels($('players-table'));
}

// ==================== COLUMN SELECTOR (Item 16) ====================
const PLAYER_COLUMNS = [
  { key: 'total_points', label: 'Pts', default: true },
  { key: 'position_name', label: 'Pos', default: true, locked: true },
  { key: 'name', label: 'Player', default: true, locked: true },
  { key: 'team_name', label: 'Team', default: true },
  { key: 'cost', label: 'Cost', default: true },
  { key: 'form', label: 'Form', default: true },
  { key: 'goals', label: 'G', default: true },
  { key: 'assists', label: 'A', default: true },
  { key: 'clean_sheets', label: 'CS', default: true },
  { key: 'bonus', label: 'Bonus', default: true },
  { key: 'points_per_game', label: 'PPG', default: true },
  { key: 'minutes', label: 'Min', default: false },
  { key: 'selected_by_percent', label: 'Own%', default: false },
  { key: 'xG', label: 'xG', default: false },
  { key: 'xA', label: 'xA', default: false },
  { key: 'ict_index', label: 'ICT', default: false },
  { key: 'ep_next', label: 'xPts', default: false },
];
let visibleColumns = JSON.parse(localStorage.getItem('fpl_columns_players') || 'null') || PLAYER_COLUMNS.filter(c => c.default).map(c => c.key);

function initColumnSelector() {
  const container = $('players-column-selector');
  if (!container) return;
  container.innerHTML = `<div class="column-selector">
    <button class="btn-outline" onclick="this.nextElementSibling.classList.toggle('open')" style="font-size:0.78rem;padding:0.3rem 0.7rem;">Columns &#9660;</button>
    <div class="column-popover" id="col-popover">
      ${PLAYER_COLUMNS.map(c => `<label><input type="checkbox" ${visibleColumns.includes(c.key) ? 'checked' : ''} ${c.locked ? 'disabled checked' : ''} onchange="toggleColumn('${c.key}', this.checked)"> ${c.label}</label>`).join('')}
    </div>
  </div>`;
}

function toggleColumn(key, visible) {
  if (visible && !visibleColumns.includes(key)) visibleColumns.push(key);
  else if (!visible) visibleColumns = visibleColumns.filter(k => k !== key);
  localStorage.setItem('fpl_columns_players', JSON.stringify(visibleColumns));
  if (lastPlayersData) { updatePlayersHeader(); renderPlayersBody(lastPlayersData); }
}

function loadPlayers() {
  const loader = $('players-loader');
  const table = $('players-table');
  loader.classList.add('active');
  table.classList.add('hidden');
  initColumnSelector();

  const params = new URLSearchParams();
  const search = $('player-search').value.trim();
  const pos = $('player-pos-filter').value;
  const team = $('player-team-filter').value;
  const priceMin = $('player-price-min').value;
  const priceMax = $('player-price-max').value;
  const formMin = $('player-form-min').value;
  const ownMax = $('player-own-max').value;
  if (search) params.set('search', search);
  if (pos) params.set('position', pos);
  if (team) params.set('team', team);
  if (priceMin) params.set('price_min', priceMin);
  if (priceMax) params.set('price_max', priceMax);
  if (formMin) params.set('form_min', formMin);
  if (ownMax) params.set('own_max', ownMax);
  params.set('sort', playersSort.col);
  params.set('dir', playersSort.dir);

  fetch('/api/players?' + params.toString())
    .then(r => r.json())
    .then(data => {
      if (data.error) throw new Error(data.error);
      lastPlayersData = data.players;
      renderPlayersBody(data.players);
      table.classList.remove('hidden');
      AppState._loaded.players = true;
    })
    .catch(err => {
      $('players-body').innerHTML = `<tr><td colspan="13" style="text-align:center;color:#FF5252">${err.message}</td></tr>`;
      table.classList.remove('hidden');
    })
    .finally(() => loader.classList.remove('active'));
}

function sortPlayers(th) {
  const col = th.dataset.sort;
  if (playersSort.col === col) playersSort.dir = playersSort.dir === 'desc' ? 'asc' : 'desc';
  else { playersSort.col = col; playersSort.dir = col === 'name' ? 'asc' : 'desc'; }
  document.querySelectorAll('#players-table th.sortable').forEach(h => h.classList.remove('sort-asc', 'sort-desc'));
  th.classList.add(playersSort.dir === 'asc' ? 'sort-asc' : 'sort-desc');
  loadPlayers();
}

// ==================== FIXTURES TAB ====================
function loadFixtures() {
  const loader = $('fixtures-loader');
  loader.classList.add('active');
  $('fixtures-container').innerHTML = '';

  fetch('/api/fixtures').then(r => r.json()).then(data => {
    if (data.error) throw new Error(data.error);
    fixturesData = data.gameweeks;
    const sel = $('gw-filter');
    sel.innerHTML = '<option value="current">Current / Next</option>';
    fixturesData.forEach(gw => {
      const opt = document.createElement('option');
      opt.value = gw.gameweek;
      let label = gw.name;
      if (gw.is_current) label += ' (Current)';
      else if (gw.is_next) label += ' (Next)';
      else if (gw.finished) label += ' (Finished)';
      opt.textContent = label;
      sel.appendChild(opt);
    });
    AppState._loaded.fixtures = true;
    renderFixtures();
  }).catch(err => {
    $('fixtures-container').innerHTML = `<div class="error-msg">${err.message}</div>`;
  }).finally(() => loader.classList.remove('active'));
}

function diffBadge(diff, extra) {
  return `<span class="fdr-cell fdr-${diff} ${extra || ''}" style="padding:0.15rem 0.4rem;border-radius:4px;font-size:0.75rem;">${diff}</span>`;
}

function renderFixtures() {
  if (!fixturesData) return;
  const filter = $('gw-filter').value;
  const container = $('fixtures-container');

  let gwsToShow;
  if (filter === 'current') {
    gwsToShow = fixturesData.filter(gw => gw.is_current || gw.is_next);
    if (!gwsToShow.length) gwsToShow = fixturesData.filter(gw => !gw.finished).slice(0, 1);
  } else {
    gwsToShow = fixturesData.filter(gw => gw.gameweek === parseInt(filter));
  }

  if (!gwsToShow.length) { container.innerHTML = '<p style="color:#8899AA;text-align:center;padding:2rem;">No fixtures.</p>'; return; }

  let html = '';
  for (const gw of gwsToShow) {
    let badge = gw.is_current ? '<span class="gw-badge current">Current</span>' : gw.is_next ? '<span class="gw-badge next">Next</span>' : gw.finished ? '<span class="gw-badge finished">Finished</span>' : '';
    html += `<div class="gw-header">${gw.name}${badge}</div>`;
    for (const f of gw.fixtures) {
      const mid = f.finished && f.home_score !== null
        ? `<div class="fixture-score">${f.home_score} - ${f.away_score}</div>`
        : '<div class="fixture-vs">vs</div>';
      html += `<div class="fixture-card">
        <div class="fixture-team home">${f.home_team_name} ${diffBadge(f.home_difficulty)}</div>
        ${mid}
        <div class="fixture-team away">${diffBadge(f.away_difficulty, 'away-badge')} ${f.away_team_name}</div>
      </div>`;
    }
  }
  container.innerHTML = html;
}

// ==================== OPTIMIZER ====================
$('budget').addEventListener('input', e => {
  $('budget-display').textContent = parseFloat(e.target.value).toFixed(1);
});

function switchTab(tab) {
  document.querySelectorAll('#tab-bar .tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('#nav-transfers-optimizer .tab-content').forEach(t => t.classList.remove('active'));
  document.querySelector(`#tab-bar .tab[data-tab="${tab}"]`).classList.add('active');
  $('tab-' + tab).classList.add('active');
}

function teamName(id) { const t = teamsMap[id]; return t ? t.short_name : id; }

/** Render an FDR badge with consistent color coding. diff: 1-5, opp: opponent short name, isHome: boolean */
function fdrBadge(diff, opp, isHome) {
  if (!diff || !opp) return '';
  const suffix = isHome ? ' (H)' : ' (A)';
  return `<span class="fdr-cell fdr-${diff}" style="font-size:0.7rem;padding:0.12rem 0.35rem;border-radius:4px;white-space:nowrap;">${opp}${suffix}</span>`;
}

function playerLink(p) {
  return `<span style="cursor:pointer;text-decoration:underline dotted;text-underline-offset:2px;" onclick="event.stopPropagation();openPlayerModal(${p.id})">${p.name}</span>`;
}
function playerRow(p, full) {
  if (full) return `<tr><td class="pos">${p.position_name}</td><td>${playerLink(p)}</td><td>${teamName(p.team)}</td><td class="right cost">${p.cost.toFixed(1)}</td><td class="right">${p.form.toFixed(1)}</td><td class="right">${p.points_per_game.toFixed(1)}</td><td class="right">${p.xG.toFixed(1)}</td><td class="right">${p.xA.toFixed(1)}</td><td class="right score">${p.composite_score.toFixed(3)}</td></tr>`;
  return `<tr><td class="pos">${p.position_name}</td><td>${playerLink(p)}</td><td>${teamName(p.team)}</td><td class="right cost">${p.cost.toFixed(1)}</td><td class="right score">${p.composite_score.toFixed(3)}</td></tr>`;
}

function transferRow(t, i) {
  const epGain = t.pts_gain != null ? t.pts_gain : 0;
  const epColor = epGain > 0 ? '#00E676' : epGain < 0 ? '#FF5252' : '#8899AA';
  return `<tr><td>${i+1}</td><td class="out">${playerLink(t.player_out)} (${t.player_out.cost.toFixed(1)})</td><td class="in">${playerLink(t.player_in)} (${t.player_in.cost.toFixed(1)})</td><td class="right score">+${t.score_gain.toFixed(3)}</td><td class="right" style="color:${epColor}" title="Expected points gain next GW">${epGain > 0 ? '+' : ''}${epGain.toFixed(1)} EP</td><td class="right">${t.cost_change >= 0 ? '+' : ''}${t.cost_change.toFixed(1)}</td></tr>`;
}

function renderSummary(el, sq) {
  el.innerHTML = `<div class="stat-card"><div class="label">Cost</div><div class="value">${sq.total_cost.toFixed(1)}M</div></div>
    <div class="stat-card"><div class="label">Remaining</div><div class="value">${sq.budget_remaining.toFixed(1)}M</div></div>
    <div class="stat-card"><div class="label">Score</div><div class="value">${sq.total_score.toFixed(3)}</div></div>`;
}

function renderPlayerCard(p) {
  const kit = kitImg(p.team, p.position === 1, 28);
  return `<div class="player-card" onclick="this.querySelector('.pc-expand')?.classList.toggle('open')">
    <div class="pc-kit">${kit || '<span style="font-size:1.2rem;">&#9917;</span>'}</div>
    <div class="pc-main">
      <div class="pc-name">${p.position_name} ${playerLink(p)}</div>
      <div class="pc-meta">${teamName(p.team)} &middot; ${p.cost.toFixed(1)}M</div>
      <div class="pc-stats">
        <span>Form: ${p.form.toFixed(1)}</span>
        <span>PPG: ${p.points_per_game.toFixed(1)}</span>
        <span>Score: ${p.composite_score.toFixed(3)}</span>
      </div>
      <div class="pc-expand">
        xG: ${p.xG.toFixed(1)} | xA: ${p.xA.toFixed(1)} | ICT: ${p.ict_index.toFixed(1)} | Rotation: ${(p.rotation_risk * 100).toFixed(0)}%
      </div>
    </div>
    <div class="pc-score">${p.composite_score.toFixed(2)}</div>
  </div>`;
}

function renderSquad(sEl, bEl, sq) {
  sEl.innerHTML = sq.starting.map(p => playerRow(p, true)).join('');
  bEl.innerHTML = sq.bench.map(p => playerRow(p, false)).join('');
  const sTable = sEl.closest('table');
  const bTable = bEl.closest('table');
  if (sTable) applyCardLabels(sTable);
  if (bTable) applyCardLabels(bTable);
  // Also render mobile cards
  const sCards = $('user-starting-cards');
  const bCards = $('user-bench-cards');
  if (sCards) sCards.innerHTML = sq.starting.map(p => renderPlayerCard(p)).join('');
  if (bCards) bCards.innerHTML = sq.bench.map(p => renderPlayerCard(p)).join('');
}

function renderTransfers(sec, body, tf) {
  if (tf && tf.length > 0) {
    sec.classList.remove('hidden');
    body.innerHTML = tf.map((t,i) => transferRow(t,i)).join('');
    const tbl = body.closest('table');
    if (tbl) applyCardLabels(tbl);
  } else sec.classList.add('hidden');
}

async function loadSquadAnalysis() {
  if (!AppState.userId) return;
  const el = $('squad-analysis');
  if (!el) return;
  try {
    const resp = await fetch(`/api/squad-analysis/${AppState.userId}`);
    const data = await resp.json();
    if (data.error) return;
    el.classList.remove('hidden');
    // Score with color
    const score = data.squad_score;
    const scoreColor = score >= 60 ? '#00E676' : score >= 40 ? '#FFB800' : '#FF5252';
    $('squad-score-value').textContent = score;
    $('squad-score-value').style.color = scoreColor;
    // Fixture outlook badge
    const outlookColors = { favorable: '#00E676', neutral: '#FFB800', tough: '#FF5252' };
    $('squad-fixture-badge').textContent = data.fixture_outlook.charAt(0).toUpperCase() + data.fixture_outlook.slice(1);
    $('squad-fixture-badge').style.background = outlookColors[data.fixture_outlook] || '#FFB800';
    $('squad-fixture-badge').style.color = '#0D1B2A';
    // Weaknesses
    const sevColors = { high: '#FF5252', medium: '#FFB800', low: '#4da6ff' };
    $('squad-weaknesses').innerHTML = data.weaknesses.map(w =>
      `<div style="border-left:3px solid ${sevColors[w.severity] || '#FFB800'};padding:0.2rem 0.5rem;margin:0.3rem 0;font-size:0.8rem;color:#AABBCC;">${w.description}</div>`
    ).join('');
    $('squad-strengths').innerHTML = data.strengths.map(s =>
      `<div style="border-left:3px solid #00E676;padding:0.2rem 0.5rem;margin:0.3rem 0;font-size:0.8rem;color:#AABBCC;">${s.description}</div>`
    ).join('');
  } catch(e) { /* silent */ }
}

async function runOptimizer() {
  const btn = $('run-btn');
  const loader = $('loader');
  const results = $('results');
  const errorEl = $('error');
  const userId = AppState.userId ? String(AppState.userId) : $('user-id').value.trim();

  btn.disabled = true;
  loader.classList.add('active');
  results.classList.add('hidden');
  errorEl.innerHTML = '';

  try {
    const resp = await fetch('/api/optimize', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ budget: parseFloat($('budget').value), lookahead: parseInt($('lookahead').value), user_id: userId || null, risk_mode: $('risk-mode').value }),
    });
    const data = await resp.json();
    if (!resp.ok) { errorEl.innerHTML = `<div class="error-msg">${data.error || 'Error'}</div>`; return; }

    for (const [tid, t] of Object.entries(data.teams)) teamsMap[tid] = t;

    renderSummary($('summary'), data.squad);
    renderSquad($('starting-body'), $('bench-body'), data.squad);

    // Render transfers in optimizer panel and suggestions panel
    if (data.transfers && data.transfers.length > 0) {
      $('transfers-body').innerHTML = data.transfers.map((t,i) => transferRow(t,i)).join('');
      applyCardLabels($('transfers-body').closest('table'));
      $('suggestions-content').classList.remove('hidden');
      $('suggestions-no-data').classList.add('hidden');
    }

    // Handle My Team tab in optimizer
    const myTeamTab = document.querySelector('#tab-bar .tab[data-tab="my-team"]');
    if (data.user_team && !data.user_team.error) {
      if (!myTeamTab) {
        const tab = document.createElement('div');
        tab.className = 'tab user-tab';
        tab.dataset.tab = 'my-team';
        tab.onclick = () => switchTab('my-team');
        tab.textContent = 'My Team';
        $('tab-bar').insertBefore(tab, document.querySelector('#tab-bar .tab[data-tab="top-players"]'));
      }

      // Also populate the dedicated My Team panel
      renderSummary($('user-summary'), data.user_team.squad);
      renderSquad($('user-starting-body'), $('user-bench-body'), data.user_team.squad);
      renderTransfers($('user-transfers-section'), $('user-transfers-body'), data.user_team.transfers);
      $('myteam-content').classList.remove('hidden');
      $('myteam-no-data').classList.add('hidden');
    } else if (myTeamTab) myTeamTab.remove();

    const tpc = $('top-players-container');
    tpc.innerHTML = '';
    for (const [posName, players] of Object.entries(data.top_by_position)) {
      tpc.innerHTML += `<div class="section"><div class="section-title">Top 10 ${posName}</div><div class="table-wrap"><table>
        <thead><tr><th>#</th><th>Player</th><th>Team</th><th class="right">Cost</th><th class="right">Form</th><th class="right">xG</th><th class="right">xA</th><th class="right">Score</th></tr></thead>
        <tbody>${players.map((p,i) => `<tr><td>${i+1}</td><td>${p.name}</td><td>${teamName(p.team)}</td><td class="right cost">${p.cost.toFixed(1)}</td><td class="right">${p.form.toFixed(1)}</td><td class="right">${p.xG.toFixed(1)}</td><td class="right">${p.xA.toFixed(1)}</td><td class="right score">${p.composite_score.toFixed(3)}</td></tr>`).join('')}</tbody>
        </table></div></div>`;
    }

    // Apply card labels to all rendered tables
    tpc.querySelectorAll('table').forEach(t => applyCardLabels(t));
    results.classList.remove('hidden');
    switchTab('optimal');
  } catch (err) {
    errorEl.innerHTML = `<div class="error-msg">Network error: ${err.message}</div>`;
  } finally {
    btn.disabled = false;
    loader.classList.remove('active');
  }
}

// ==================== TRANSFER PLANNER ====================
let tpData = null;  // raw API data
let tpTransfers = [];  // [{out: playerObj, in: playerObj}]
let tpSellingPlayer = null;  // player being sold (awaiting replacement pick)
let tpLoaded = false;

async function loadTransferPlanner() {
  if (!AppState.userId) { $('tp-no-user').classList.remove('hidden'); $('tp-content').classList.add('hidden'); return; }
  $('tp-no-user').classList.add('hidden');

  if (tpLoaded) { $('tp-content').classList.remove('hidden'); return; }

  const loader = $('tp-loader');
  loader.classList.add('active');
  $('tp-content').classList.add('hidden');

  try {
    const resp = await fetch(`/api/transfer-planner/${AppState.userId}`);
    const data = await resp.json();
    if (!resp.ok) { $('tp-content').innerHTML = `<div class="error-msg">${data.error}</div>`; $('tp-content').classList.remove('hidden'); return; }

    tpData = data;
    tpTransfers = [];
    tpSellingPlayer = null;
    renderTransferPlanner();
    $('tp-content').classList.remove('hidden');
    tpLoaded = true;
  } catch (err) {
    $('tp-content').innerHTML = `<div class="error-msg">Failed: ${err.message}</div>`;
    $('tp-content').classList.remove('hidden');
  } finally {
    loader.classList.remove('active');
  }
}

function renderTransferPlanner() {
  if (!tpData) return;

  const freeTransfers = tpData.free_transfers || 1;
  const numTransfers = tpTransfers.length;
  const hits = Math.max(0, numTransfers - freeTransfers) * 4;

  // Calculate budget
  let sellingTotal = 0;
  let buyingTotal = 0;
  tpTransfers.forEach(t => {
    sellingTotal += t.out.selling_price || t.out.cost;
    buyingTotal += t.in.cost;
  });
  const bank = tpData.bank;
  const remaining = bank + sellingTotal - buyingTotal;

  $('tp-bank').textContent = bank.toFixed(1) + 'M';
  $('tp-selling').textContent = sellingTotal.toFixed(1) + 'M';
  $('tp-buying').textContent = buyingTotal.toFixed(1) + 'M';
  $('tp-remaining').textContent = remaining.toFixed(1) + 'M';
  $('tp-remaining').style.color = remaining < 0 ? '#FF5252' : '#FFB800';
  $('tp-hits').textContent = hits > 0 ? `-${hits}` : '0';
  $('tp-hits').style.color = hits > 0 ? '#FF5252' : '#00E676';
  $('tp-free-label').textContent = `Free transfers: ${freeTransfers} | Used: ${numTransfers}`;

  // Enable/disable confirm button
  $('tp-confirm-btn').disabled = tpTransfers.length === 0 || remaining < 0;

  // Render transfer summary
  if (tpTransfers.length > 0) {
    $('tp-transfer-summary').innerHTML = tpTransfers.map((t, i) => `
      <div class="tp-transfer-item">
        <span class="out">${playerLink(t.out)} (${(t.out.selling_price || t.out.cost).toFixed(1)}M)</span>
        <span class="tp-arrow">&#8594;</span>
        <span class="in">${playerLink(t.in)} (${t.in.cost.toFixed(1)}M)</span>
        <span style="margin-left:auto;cursor:pointer;color:#FF5252;font-size:0.9rem;" onclick="undoTransfer(${i})" title="Remove">&times;</span>
      </div>
    `).join('');
  } else {
    $('tp-transfer-summary').innerHTML = '';
  }

  // Build current squad view (original minus sold, plus bought)
  const soldIds = new Set(tpTransfers.map(t => t.out.id));
  const boughtPlayers = tpTransfers.map(t => t.in);

  // Group by position
  const posOrder = [1, 2, 3, 4];
  const posNames = {1: 'GK', 2: 'DEF', 3: 'MID', 4: 'FWD'};

  let squadHtml = '';
  for (const pos of posOrder) {
    const origPlayers = tpData.squad.filter(p => p.position === pos);
    const newPlayers = boughtPlayers.filter(p => p.position === pos);

    squadHtml += `<div style="font-size:0.7rem;color:#8899AA;text-transform:uppercase;padding:0.3rem 0.6rem;margin-top:0.3rem;">${posNames[pos]}</div>`;

    for (const p of origPlayers) {
      const isSold = soldIds.has(p.id);
      const photoUrl = p.photo ? `${PHOTO_BASE}${p.photo}.png` : '';
      const photoHtml = photoUrl
        ? `<img src="${photoUrl}" onerror="this.parentElement.innerHTML='&#9917;'" style="width:100%;height:100%;object-fit:cover;object-position:top;">`
        : '&#9917;';

      let priceIndicator = '';
      if (p.cost_change_event && p.cost_change_event > 0) priceIndicator = '<span class="tp-price-indicator tp-price-up">&#9650;</span>';
      else if (p.cost_change_event && p.cost_change_event < 0) priceIndicator = '<span class="tp-price-indicator tp-price-down">&#9660;</span>';

      let injuryFlag = '';
      if (p.news || (p.chance_of_playing !== null && p.chance_of_playing !== undefined && p.chance_of_playing < 100)) {
        const cop = p.chance_of_playing;
        const color = (cop !== null && cop !== undefined && cop <= 25) ? '#FF5252' : '#E5A600';
        injuryFlag = `<span style="color:${color};font-size:0.65rem;font-weight:bold;" title="${p.news || cop + '% chance'}">!</span>`;
      }

      const btn = isSold
        ? `<button class="tp-undo-btn" onclick="undoSell(${p.id})">Undo</button>`
        : `<button class="tp-sell-btn" onclick="startSell(${p.id})">Sell</button>`;

      squadHtml += `<div class="tp-player${isSold ? ' tp-sold' : ''}">
        <div class="tp-photo">${photoHtml}</div>
        <div class="tp-info">
          <div class="tp-name">${playerLink(p)} ${injuryFlag} ${priceIndicator}</div>
          <div class="tp-meta">${p.team_name} &middot; ${p.cost.toFixed(1)}M &middot; ${p.selected_by_percent}% own &middot; Form: ${p.form}</div>
        </div>
        <div class="tp-stats">
          <span class="score">${p.composite_score}</span>
        </div>
        ${btn}
      </div>`;
    }

    // Show bought players for this position
    for (const p of newPlayers) {
      squadHtml += `<div class="tp-player tp-new">
        <div class="tp-photo">${p.photo ? `<img src="${PHOTO_BASE}${p.photo}.png" onerror="this.parentElement.innerHTML='&#9917;'" style="width:100%;height:100%;object-fit:cover;object-position:top;">` : '&#9917;'}</div>
        <div class="tp-info">
          <div class="tp-name">${playerLink(p)} <span style="color:#51cf66;font-size:0.65rem;">NEW</span></div>
          <div class="tp-meta">${p.team_name} &middot; ${p.cost.toFixed(1)}M &middot; ${p.selected_by_percent}% own &middot; Form: ${p.form}</div>
        </div>
        <div class="tp-stats"><span class="score">${p.composite_score}</span></div>
      </div>`;
    }
  }
  $('tp-squad').innerHTML = squadHtml;

  // Intelligence rail
  renderTransferIntel();
}

function renderTransferIntel() {
  if (!tpData) return;

  // Most transferred in
  $('tp-intel-in').innerHTML = tpData.most_transferred_in.map(p => {
    let priceInd = '';
    if (p.cost_change_event > 0) priceInd = '<span class="tp-price-indicator tp-price-up">&#9650;</span>';
    return `<div class="tp-intel-item">
      <span class="tp-intel-name">${playerLink(p)} ${priceInd}</span>
      <span class="tp-intel-val" style="color:#51cf66">+${p.transfers_in_event.toLocaleString()}</span>
    </div>`;
  }).join('');

  // Most transferred out
  $('tp-intel-out').innerHTML = tpData.most_transferred_out.map(p => {
    let priceInd = '';
    if (p.cost_change_event < 0) priceInd = '<span class="tp-price-indicator tp-price-down">&#9660;</span>';
    return `<div class="tp-intel-item">
      <span class="tp-intel-name">${playerLink(p)} ${priceInd}</span>
      <span class="tp-intel-val" style="color:#FF5252">${p.transfers_out_event.toLocaleString()}</span>
    </div>`;
  }).join('');

  // Form ranking of current squad
  const soldIds = new Set(tpTransfers.map(t => t.out.id));
  const currentSquad = [...tpData.squad.filter(p => !soldIds.has(p.id)), ...tpTransfers.map(t => t.in)];
  const byForm = [...currentSquad].sort((a, b) => b.form - a.form);
  $('tp-intel-form').innerHTML = byForm.map(p => {
    const isNew = tpTransfers.some(t => t.in.id === p.id);
    return `<div class="tp-intel-item">
      <span class="tp-intel-name">${playerLink(p)}${isNew ? ' <span style="color:#51cf66;font-size:0.6rem;">NEW</span>' : ''}</span>
      <span class="tp-intel-val" style="color:#4da6ff">${p.form}</span>
    </div>`;
  }).join('');
}

function startSell(playerId) {
  const player = tpData.squad.find(p => p.id === playerId);
  if (!player) return;

  // Check if already sold
  if (tpTransfers.some(t => t.out.id === playerId)) return;

  tpSellingPlayer = player;
  const posName = player.position_name;

  $('tp-rp-label').textContent = `Replace ${player.name} (${posName} - ${player.cost.toFixed(1)}M)`;
  $('tp-rp-search').value = '';

  const panel = $('tp-replacement-panel');
  panel.classList.add('active');

  filterReplacements();
  panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function filterReplacements() {
  if (!tpSellingPlayer || !tpData) return;

  const pos = tpSellingPlayer.position_name;
  let candidates = tpData.replacements[pos] || [];

  // Exclude already-bought players and current squad
  const squadIds = new Set(tpData.squad.map(p => p.id));
  const boughtIds = new Set(tpTransfers.map(t => t.in.id));
  candidates = candidates.filter(p => !squadIds.has(p.id) && !boughtIds.has(p.id));

  // Search filter
  const search = ($('tp-rp-search').value || '').trim().toLowerCase();
  if (search) {
    candidates = candidates.filter(p => p.name.toLowerCase().includes(search) || p.team_name.toLowerCase().includes(search));
  }

  // Sort
  const sortBy = $('tp-rp-sort').value;
  if (sortBy === 'cost') {
    candidates.sort((a, b) => a.cost - b.cost);
  } else {
    candidates.sort((a, b) => (b[sortBy] || 0) - (a[sortBy] || 0));
  }

  // Calculate available budget for this position
  const bank = tpData.bank;
  let sellingTotal = (tpSellingPlayer.selling_price || tpSellingPlayer.cost);
  tpTransfers.forEach(t => {
    sellingTotal += (t.out.selling_price || t.out.cost);
    sellingTotal -= t.in.cost;
  });
  const maxBudget = bank + sellingTotal;

  // Store candidates for click handler
  window._tpCandidates = candidates;

  $('tp-rp-list').innerHTML = candidates.map((p, idx) => {
    const affordable = p.cost <= maxBudget;
    let priceInd = '';
    if (p.cost_change_event > 0) priceInd = '<span class="tp-price-indicator tp-price-up" style="margin-left:0.3rem;">&#9650;</span>';
    else if (p.cost_change_event < 0) priceInd = '<span class="tp-price-indicator tp-price-down" style="margin-left:0.3rem;">&#9660;</span>';

    const netTransfers = p.transfers_in_event - p.transfers_out_event;
    const netColor = netTransfers > 0 ? '#51cf66' : netTransfers < 0 ? '#FF5252' : '#888';

    return `<div class="tp-buy-row" style="${affordable ? '' : 'opacity:0.4;'}">
      <span class="tp-buy-name">${playerLink(p)}${priceInd}</span>
      <span class="tp-buy-meta">${p.team_name} &middot; <span class="cost">${p.cost.toFixed(1)}M</span> &middot; ${p.selected_by_percent}% &middot; F:${p.form} &middot; <span style="color:${netColor}">${netTransfers > 0 ? '+' : ''}${netTransfers.toLocaleString()}</span></span>
      <span style="color:#00E676;font-size:0.72rem;font-weight:600;min-width:35px;text-align:right;">${p.composite_score}</span>
      ${affordable ? `<button class="tp-buy-btn" onclick="buyPlayerByIdx(${idx})">Buy</button>` : '<span style="color:#FF5252;font-size:0.68rem;">$$</span>'}
    </div>`;
  }).join('');
}

function buyPlayerByIdx(idx) {
  if (!window._tpCandidates || !window._tpCandidates[idx]) return;
  buyPlayer(window._tpCandidates[idx]);
}

function buyPlayer(player) {
  if (!tpSellingPlayer) return;

  tpTransfers.push({
    out: tpSellingPlayer,
    in: player,
  });

  tpSellingPlayer = null;
  closeReplacementPanel();
  renderTransferPlanner();
}

function closeReplacementPanel() {
  $('tp-replacement-panel').classList.remove('active');
  tpSellingPlayer = null;
}

function undoSell(playerId) {
  tpTransfers = tpTransfers.filter(t => t.out.id !== playerId);
  renderTransferPlanner();
}

function undoTransfer(index) {
  tpTransfers.splice(index, 1);
  renderTransferPlanner();
}

function resetTransfers() {
  tpTransfers = [];
  tpSellingPlayer = null;
  closeReplacementPanel();
  renderTransferPlanner();
}

function showTransferModal() {
  if (tpTransfers.length === 0) return;

  const freeTransfers = tpData.free_transfers || 1;
  const hits = Math.max(0, tpTransfers.length - freeTransfers) * 4;
  let sellingTotal = 0, buyingTotal = 0;
  tpTransfers.forEach(t => {
    sellingTotal += t.out.selling_price || t.out.cost;
    buyingTotal += t.in.cost;
  });
  const remaining = tpData.bank + sellingTotal - buyingTotal;

  $('tp-modal-transfers').innerHTML = tpTransfers.map(t => `
    <div class="tp-transfer-item">
      <span class="out">${t.out.name} (${(t.out.selling_price || t.out.cost).toFixed(1)}M)</span>
      <span class="tp-arrow">&#8594;</span>
      <span class="in">${t.in.name} (${t.in.cost.toFixed(1)}M)</span>
    </div>
  `).join('');

  $('tp-modal-cost').innerHTML = `
    <div class="tp-modal-row"><span>Bank before</span><span>${tpData.bank.toFixed(1)}M</span></div>
    <div class="tp-modal-row"><span>Total selling</span><span style="color:#51cf66">+${sellingTotal.toFixed(1)}M</span></div>
    <div class="tp-modal-row"><span>Total buying</span><span style="color:#FF5252">-${buyingTotal.toFixed(1)}M</span></div>
    ${hits > 0 ? `<div class="tp-modal-row"><span>Transfer hits</span><span style="color:#FF5252">-${hits} pts</span></div>` : ''}
    <div class="tp-modal-row total"><span>Bank after</span><span style="color:#FFB800">${remaining.toFixed(1)}M</span></div>
  `;

  $('tp-modal-overlay').classList.add('active');
}

function closeTransferModal() {
  $('tp-modal-overlay').classList.remove('active');
}

function confirmTransfers() {
  // This is a planning tool - save to localStorage for reference
  const plan = tpTransfers.map(t => ({
    out: { id: t.out.id, name: t.out.name, cost: t.out.selling_price || t.out.cost },
    in: { id: t.in.id, name: t.in.name, cost: t.in.cost },
  }));
  localStorage.setItem(`fpl_transfer_plan_${AppState.userId}`, JSON.stringify(plan));
  closeTransferModal();

  // Show confirmation message
  $('tp-transfer-summary').innerHTML += `<div style="color:#51cf66;font-size:0.82rem;margin-top:0.5rem;padding:0.5rem;background:#1a2a1a;border-radius:6px;">Transfer plan saved! Go to the FPL website to make these transfers.</div>`;
}

// ==================== OPTA STATS & BPS ====================
let optaTimer = null;
let optaLoaded = false;

function debouncedLoadOpta() {
  clearTimeout(optaTimer);
  optaTimer = setTimeout(loadOptaStats, 300);
}

async function loadOptaStats() {
  const loader = $('opta-loader');
  const table = $('opta-table');
  loader.classList.add('active');
  table.classList.add('hidden');

  const view = $('opta-view').value;
  const pos = $('opta-pos').value;
  const search = $('opta-search').value.trim();

  // Determine sort field based on view
  let sortField = 'bps';
  if (view === 'xpts') sortField = 'ep_next';
  else if (view === 'ict') sortField = 'ict_index';
  else if (view === 'expected') sortField = 'expected_goal_involvements';
  else if (view === 'per90') sortField = 'xGI_per90';
  else if (view === 'defensive') sortField = 'saves';
  else if (view === 'discipline') sortField = 'yellow_cards';

  const params = new URLSearchParams({ sort: sortField, dir: 'desc', limit: '100' });
  if (pos) params.set('position', pos);
  if (search) params.set('search', search);

  try {
    const resp = await fetch('/api/opta-stats?' + params.toString());
    const data = await resp.json();
    if (data.error) throw new Error(data.error);

    renderOptaTable(data.players, view);
    table.classList.remove('hidden');
    optaLoaded = true;
  } catch (err) {
    $('opta-body').innerHTML = `<tr><td colspan="12" style="text-align:center;color:#FF5252">${err.message}</td></tr>`;
    table.classList.remove('hidden');
  } finally {
    loader.classList.remove('active');
  }
}

function renderOptaTable(players, view) {
  const thead = $('opta-thead');
  const tbody = $('opta-body');

  // Define columns per view
  const views = {
    xpts: {
      headers: ['#', 'Player', 'Team', 'Pos', 'xPts Next', 'xPts This', 'PPG', 'xGI/90', 'Form', 'Cost', 'Own%'],
      row: (p, i) => `<tr${i < 3 ? ' style="background:rgba(0,230,118,0.05)"' : ''}>
        <td>${i + 1}</td>
        <td><strong>${p.name}</strong></td>
        <td>${p.team_name}</td>
        <td class="pos">${p.position_name}</td>
        <td class="right" style="color:#00E676;font-weight:bold;font-size:1rem;">${p.ep_next.toFixed(1)}</td>
        <td class="right" style="color:#4da6ff;font-weight:bold">${p.ep_this.toFixed(1)}</td>
        <td class="right">${p.points_per_game}</td>
        <td class="right">${p.xGI_per90.toFixed(2)}</td>
        <td class="right">${p.form}</td>
        <td class="right cost">${p.cost.toFixed(1)}</td>
        <td class="right">${p.selected_by_percent}%</td>
      </tr>`,
    },
    bps: {
      headers: ['#', 'Player', 'Team', 'Pos', 'BPS', 'Bonus', 'Pts', 'Form', 'Minutes', 'Starts'],
      row: (p, i) => `<tr>
        <td>${i + 1}</td>
        <td><strong>${p.name}</strong></td>
        <td>${p.team_name}</td>
        <td class="pos">${p.position_name}</td>
        <td class="right" style="color:#4da6ff;font-weight:bold">${p.bps}</td>
        <td class="right" style="color:#FFB800;font-weight:bold">${p.bonus}</td>
        <td class="right score">${p.total_points}</td>
        <td class="right">${p.form}</td>
        <td class="right">${p.minutes}</td>
        <td class="right">${p.starts}</td>
      </tr>`,
    },
    ict: {
      headers: ['#', 'Player', 'Team', 'Pos', 'ICT', 'Influence', 'Creativity', 'Threat', 'Form', 'Cost'],
      row: (p, i) => `<tr>
        <td>${i + 1}</td>
        <td><strong>${p.name}</strong></td>
        <td>${p.team_name}</td>
        <td class="pos">${p.position_name}</td>
        <td class="right" style="color:#00E676;font-weight:bold">${p.ict_index.toFixed(1)}</td>
        <td class="right" style="color:#FF5252">${p.influence.toFixed(1)}</td>
        <td class="right" style="color:#4da6ff">${p.creativity.toFixed(1)}</td>
        <td class="right" style="color:#FFB800">${p.threat.toFixed(1)}</td>
        <td class="right">${p.form}</td>
        <td class="right cost">${p.cost.toFixed(1)}</td>
      </tr>`,
    },
    expected: {
      headers: ['#', 'Player', 'Team', 'Pos', 'xGI', 'xG', 'xA', 'xGC', 'Goals', 'Assists', 'Cost'],
      row: (p, i) => {
        const xgi = p.expected_goal_involvements;
        const actualGI = p.goals + p.assists;
        const overPerform = actualGI > xgi;
        return `<tr>
          <td>${i + 1}</td>
          <td><strong>${p.name}</strong></td>
          <td>${p.team_name}</td>
          <td class="pos">${p.position_name}</td>
          <td class="right" style="color:#00E676;font-weight:bold">${xgi.toFixed(2)}</td>
          <td class="right">${p.xG.toFixed(2)}</td>
          <td class="right">${p.xA.toFixed(2)}</td>
          <td class="right" style="color:#FF5252">${p.expected_goals_conceded.toFixed(2)}</td>
          <td class="right">${p.goals} ${overPerform ? '<span style="color:#51cf66;font-size:0.65rem;">&#9650;</span>' : p.goals < Math.round(p.xG) ? '<span style="color:#FF5252;font-size:0.65rem;">&#9660;</span>' : ''}</td>
          <td class="right">${p.assists}</td>
          <td class="right cost">${p.cost.toFixed(1)}</td>
        </tr>`;
      },
    },
    per90: {
      headers: ['#', 'Player', 'Team', 'Pos', 'xGI/90', 'xG/90', 'xA/90', 'xGC/90', 'Minutes', 'Starts', 'Cost'],
      row: (p, i) => `<tr>
        <td>${i + 1}</td>
        <td><strong>${p.name}</strong></td>
        <td>${p.team_name}</td>
        <td class="pos">${p.position_name}</td>
        <td class="right" style="color:#00E676;font-weight:bold">${p.xGI_per90.toFixed(2)}</td>
        <td class="right">${p.xG_per90.toFixed(2)}</td>
        <td class="right">${p.xA_per90.toFixed(2)}</td>
        <td class="right" style="color:#FF5252">${p.xGC_per90.toFixed(2)}</td>
        <td class="right">${p.minutes}</td>
        <td class="right">${p.starts}</td>
        <td class="right cost">${p.cost.toFixed(1)}</td>
      </tr>`,
    },
    defensive: {
      headers: ['#', 'Player', 'Team', 'Pos', 'Saves', 'CS', 'GC', 'xGC', 'Pen Saved', 'Own Goals', 'Pts'],
      row: (p, i) => `<tr>
        <td>${i + 1}</td>
        <td><strong>${p.name}</strong></td>
        <td>${p.team_name}</td>
        <td class="pos">${p.position_name}</td>
        <td class="right" style="color:#4da6ff;font-weight:bold">${p.saves}</td>
        <td class="right" style="color:#00E676">${p.clean_sheets}</td>
        <td class="right" style="color:#FF5252">${p.goals_conceded}</td>
        <td class="right">${p.expected_goals_conceded.toFixed(2)}</td>
        <td class="right" style="color:#FFB800">${p.penalties_saved}</td>
        <td class="right" style="color:#FF5252">${p.own_goals}</td>
        <td class="right score">${p.total_points}</td>
      </tr>`,
    },
    discipline: {
      headers: ['#', 'Player', 'Team', 'Pos', 'Yellow', 'Red', 'Pen Missed', 'Own Goals', 'Minutes', 'Starts'],
      row: (p, i) => `<tr>
        <td>${i + 1}</td>
        <td><strong>${p.name}</strong></td>
        <td>${p.team_name}</td>
        <td class="pos">${p.position_name}</td>
        <td class="right" style="color:#FFB800;font-weight:bold">${p.yellow_cards}</td>
        <td class="right" style="color:#FF5252;font-weight:bold">${p.red_cards}</td>
        <td class="right">${p.penalties_missed}</td>
        <td class="right">${p.own_goals}</td>
        <td class="right">${p.minutes}</td>
        <td class="right">${p.starts}</td>
      </tr>`,
    },
  };

  const config = views[view] || views.bps;
  thead.innerHTML = `<tr>${config.headers.map((h, i) => `<th${i >= 4 ? ' class="right"' : ''}>${h}</th>`).join('')}</tr>`;
  tbody.innerHTML = players.map((p, i) => config.row(p, i)).join('');
  applyCardLabels($('opta-table'));
}

// ==================== FIXTURE SCHEDULE ====================
let schedData = null;
let schedLoaded = false;

async function loadSchedule() {
  if (schedLoaded) return;

  const loader = $('sched-loader');
  loader.classList.add('active');

  try {
    // Load metadata for team filter dropdown
    await loadMetadata();
    const teamSel = $('sched-team');
    if (teamSel.options.length <= 1) {
      Object.values(teamsMap).forEach(t => {
        const o = document.createElement('option');
        o.value = t.id;
        o.textContent = t.name || t.short_name;
        teamSel.appendChild(o);
      });
    }

    const resp = await fetch('/api/schedule');
    const data = await resp.json();
    if (data.error) throw new Error(data.error);

    schedData = data;
    renderSchedule();
    schedLoaded = true;
  } catch (err) {
    $('sched-container').innerHTML = `<div class="error-msg">${err.message}</div>`;
  } finally {
    loader.classList.remove('active');
  }
}

function renderSchedule() {
  if (!schedData) return;

  const range = $('sched-range').value;
  const highlightTeam = $('sched-team').value;
  const showCS = $('sched-show-cs').checked;

  // Determine which GWs to show
  const allGWs = schedData.gw_info;
  const currentIdx = allGWs.findIndex(g => g.is_current || g.is_next);
  let gwsToShow;

  if (range === 'next6') {
    const start = currentIdx >= 0 ? currentIdx : allGWs.findIndex(g => !g.finished);
    gwsToShow = allGWs.slice(Math.max(0, start), start + 6);
  } else if (range === 'next10') {
    const start = currentIdx >= 0 ? currentIdx : allGWs.findIndex(g => !g.finished);
    gwsToShow = allGWs.slice(Math.max(0, start), start + 10);
  } else if (range === 'all') {
    gwsToShow = allGWs.filter(g => !g.finished);
  } else {
    gwsToShow = allGWs;
  }

  if (gwsToShow.length === 0) {
    $('sched-container').innerHTML = '<p style="color:#8899AA;text-align:center;">No fixtures to display.</p>';
    return;
  }

  // Header row
  let html = '<table><thead><tr><th class="team-col">Team</th>';
  for (const gw of gwsToShow) {
    let cls = '';
    if (gw.is_current) cls = ' sched-gw-current';
    else if (gw.is_next) cls = ' sched-gw-next';
    let tag = '';
    if (gw.has_double) tag = '<span class="gw-tag double">DGW</span>';
    else if (gw.has_blank) tag = '<span class="gw-tag blank">BGW</span>';
    else if (gw.is_current) tag = '<span class="gw-tag" style="color:#00E676">NOW</span>';
    else if (gw.is_next) tag = '<span class="gw-tag" style="color:#4da6ff">NEXT</span>';
    html += `<th class="${cls}">GW${gw.id}${tag}</th>`;
  }
  html += '</tr></thead><tbody>';

  // Team rows
  for (const team of schedData.schedule) {
    const isHighlight = highlightTeam && parseInt(highlightTeam) === team.team_id;
    html += `<tr class="${isHighlight ? 'sched-highlight' : ''}">`;
    html += `<td class="team-col">${team.team_name}${showCS ? `<br><span class="cs-rate">CS: ${(team.cs_rate * 100).toFixed(0)}%</span>` : ''}</td>`;

    for (const gw of gwsToShow) {
      const gwData = team.gameweeks[gw.id];
      if (!gwData || gwData.is_blank) {
        html += `<td class="sched-cell blank-gw"><span class="sched-blank-text">-</span></td>`;
        continue;
      }

      const cellClass = gwData.is_double ? 'sched-cell double-gw' : 'sched-cell';
      const fxHtml = gwData.fixtures.map(fx => {
        const ha = fx.is_home ? '(H)' : '(A)';
        // Format date
        let dateStr = '';
        if (fx.kickoff_time) {
          const d = new Date(fx.kickoff_time);
          const day = d.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short' });
          const time = d.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
          dateStr = `${day} ${time}`;
        }

        // CS probability: we use the team's own CS rate adjusted by opponent difficulty
        // Simple heuristic: team's CS rate * difficulty factor
        const diffFactor = { 1: 1.4, 2: 1.2, 3: 1.0, 4: 0.7, 5: 0.5 }[fx.difficulty] || 1;
        const csProb = Math.min(0.99, team.cs_rate * diffFactor);
        const csPctText = (csProb * 100).toFixed(0) + '%';
        const csColor = csProb >= 0.4 ? '#51cf66' : csProb >= 0.25 ? '#FFB800' : '#FF5252';

        // Score for finished matches
        let scoreHtml = '';
        if (fx.finished && fx.home_score !== null) {
          const score = fx.is_home ? `${fx.home_score}-${fx.away_score}` : `${fx.away_score}-${fx.home_score}`;
          scoreHtml = `<span class="sched-score">${score}</span> `;
        }

        return `<div class="sched-fx fdr-${fx.difficulty}">
          <span class="sched-opp">${scoreHtml}${fx.opponent_name} <span class="sched-ha">${ha}</span></span>
          ${dateStr ? `<span class="sched-date">${dateStr}</span>` : ''}
          ${showCS ? `<span class="sched-cs" style="color:${csColor}">CS: ${csPctText}</span>` : ''}
        </div>`;
      }).join('');

      html += `<td class="${cellClass}">${fxHtml}</td>`;
    }

    html += '</tr>';
  }

  html += '</tbody></table>';
  $('sched-container').innerHTML = html;
}

// ==================== DRAFT RANKINGS ====================
async function loadDraftRankings() {
  const loader = $('draft-rank-loader');
  const section = $('draft-rank-section');
  const errDiv = $('draft-rank-error');
  loader.classList.add('active');
  section.style.display = 'none';
  errDiv.innerHTML = '';

  const pos = $('draft-rank-pos').value;
  const rostered = getDraftRostered().join(',');
  let url = `/api/draft/rankings?rostered=${rostered}`;
  if (pos) url += `&position=${pos}`;

  try {
    const resp = await fetch(url);
    const data = await resp.json();
    if (data.error) { errDiv.innerHTML = `<div class="error-msg">${data.error}</div>`; return; }

    const body = $('draft-rank-body');
    body.innerHTML = data.players.map(p => `<tr>
      <td>${p.rank}</td>
      <td><strong>${p.name}</strong></td>
      <td>${p.team_name}</td>
      <td><span class="pos">${p.position_name}</span></td>
      <td class="right">${p.total_points}</td>
      <td class="right">${p.form}</td>
      <td class="right">${p.points_per_game}</td>
      <td class="right">${p.xG}</td>
      <td class="right">${p.xA}</td>
      <td class="right">${p.ict_index}</td>
      <td class="right">${fdrBadge(p.fixture_difficulty)}</td>
      <td class="right">${p.projected_minutes}</td>
      <td class="right">${rotBadge(p.rotation_risk)}</td>
      <td class="right score">${p.draft_score}</td>
    </tr>`).join('');
    applyCardLabels(body.closest('table'));

    section.style.display = '';
    AppState._loaded.draftRank = true;
  } catch (e) {
    errDiv.innerHTML = `<div class="error-msg">${e.message}</div>`;
  } finally {
    loader.classList.remove('active');
  }
}

function fdrBadge(val) {
  const pct = Math.round(val * 100);
  const color = val >= 0.7 ? '#00E676' : val >= 0.4 ? '#FFB800' : '#FF5252';
  return `<span style="color:${color};font-weight:600;">${pct}%</span>`;
}
function rotBadge(val) {
  if (val <= 0.1) return `<span style="color:#00E676;">${Math.round(val*100)}%</span>`;
  if (val <= 0.3) return `<span style="color:#FFB800;">${Math.round(val*100)}%</span>`;
  return `<span style="color:#FF5252;">${Math.round(val*100)}%</span>`;
}

function getDraftRostered() {
  try { return JSON.parse(localStorage.getItem('draft_roster') || '[]'); }
  catch { return []; }
}
function saveDraftRostered(ids) {
  localStorage.setItem('draft_roster', JSON.stringify(ids));
}

// ==================== WAIVER WIRE ====================
let waiverData = null;
async function loadWaiverWire() {
  const loader = $('waiver-loader');
  const content = $('waiver-content');
  const errDiv = $('waiver-error');
  loader.classList.add('active');
  content.style.display = 'none';
  errDiv.innerHTML = '';

  const rostered = getDraftRostered().join(',');

  try {
    const resp = await fetch(`/api/draft/waiver-wire?rostered=${rostered}`);
    const data = await resp.json();
    if (data.error) { errDiv.innerHTML = `<div class="error-msg">${data.error}</div>`; return; }

    waiverData = data;

    // Top picks cards
    const cardsHtml = data.top_picks.map(p => {
      const posClass = p.position_name.toLowerCase();
      return `<div class="waiver-card">
        <div class="wc-header">
          <span class="wc-name">${p.name}</span>
          <span class="wc-pos ${posClass}">${p.position_name}</span>
        </div>
        <div class="wc-meta">${p.team_name} &middot; Fix: ${fdrBadge(p.fixture_difficulty)}</div>
        <div class="wc-stats">
          <div class="wc-stat"><div class="label">Form</div><div class="val green">${p.form}</div></div>
          <div class="wc-stat"><div class="label">EP</div><div class="val">${p.ep_next}</div></div>
          <div class="wc-stat"><div class="label">PPG</div><div class="val">${p.points_per_game}</div></div>
        </div>
        <div class="wc-stats" style="margin-top:0.3rem;">
          <div class="wc-stat"><div class="label">Min&#x0302;</div><div class="val">${p.projected_minutes}</div></div>
          <div class="wc-stat"><div class="label">Rot</div><div class="val">${rotBadge(p.rotation_risk)}</div></div>
          <div class="wc-stat"><div class="label">Score</div><div class="val green">${p.waiver_score}</div></div>
        </div>
      </div>`;
    }).join('');
    $('waiver-top-cards').innerHTML = cardsHtml;

    // Default to GK tab
    switchWaiverPos('GK', document.querySelector('#waiver-pos-tabs .tab'));

    content.style.display = '';
  } catch (e) {
    errDiv.innerHTML = `<div class="error-msg">${e.message}</div>`;
  } finally {
    loader.classList.remove('active');
  }
}

function switchWaiverPos(pos, el) {
  document.querySelectorAll('#waiver-pos-tabs .tab').forEach(t => t.classList.remove('active'));
  if (el) el.classList.add('active');

  if (!waiverData) return;
  const players = waiverData.by_position[pos] || [];

  $('waiver-pos-body').innerHTML = players.map(p => `<tr>
    <td><strong>${p.name}</strong></td>
    <td>${p.team_name}</td>
    <td class="right">${p.form}</td>
    <td class="right">${p.points_per_game}</td>
    <td class="right">${p.ep_next}</td>
    <td class="right">${p.xG}</td>
    <td class="right">${p.xA}</td>
    <td class="right">${fdrBadge(p.fixture_difficulty)}</td>
    <td class="right">${p.projected_minutes}</td>
    <td class="right">${rotBadge(p.rotation_risk)}</td>
    <td class="right score">${p.waiver_score}</td>
  </tr>`).join('');
  applyCardLabels($('waiver-pos-body').closest('table'));
}

// ==================== MY DRAFT ROSTER ====================
let draftRosterIds = getDraftRostered();

async function ensurePlayersCache() {
  if (allPlayersCache) return;
  const resp = await fetch('/api/players?sort=total_points&dir=desc');
  const data = await resp.json();
  allPlayersCache = data.players || [];
}

async function searchRosterPlayer(query) {
  const container = $('roster-search-results');
  if (query.length < 2) { container.innerHTML = ''; return; }

  await ensurePlayersCache();
  const q = query.toLowerCase();
  const matches = allPlayersCache
    .filter(p => p.name.toLowerCase().includes(q) && !draftRosterIds.includes(p.id))
    .slice(0, 8);

  container.innerHTML = matches.map(p =>
    `<div class="compare-pick" onclick="addToRoster(${p.id}, '${p.name.replace(/'/g, "\\'")}')">
      <span class="pos">${p.position_name}</span> ${p.name} <span style="color:#8899AA;">${p.team_name}</span>
    </div>`
  ).join('');
}

function addToRoster(id, name) {
  if (draftRosterIds.includes(id) || draftRosterIds.length >= 15) return;
  draftRosterIds.push(id);
  saveDraftRostered(draftRosterIds);
  $('roster-search').value = '';
  $('roster-search-results').innerHTML = '';
  analyseRoster();
}

function removeFromRoster(id) {
  draftRosterIds = draftRosterIds.filter(x => x !== id);
  saveDraftRostered(draftRosterIds);
  analyseRoster();
}

async function analyseRoster() {
  const analysis = $('roster-analysis');
  if (draftRosterIds.length === 0) { analysis.style.display = 'none'; return; }

  try {
    const resp = await fetch('/api/draft/my-roster', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ roster_ids: draftRosterIds }),
    });
    const data = await resp.json();
    if (data.error) return;

    // Summary cards
    const bd = data.position_breakdown;
    $('roster-summary').innerHTML = `
      <div class="rs-item"><div class="rs-label">Players</div><div class="rs-value">${data.roster_size}/15</div></div>
      <div class="rs-item"><div class="rs-label">GK</div><div class="rs-value">${bd.GK || 0}</div></div>
      <div class="rs-item"><div class="rs-label">DEF</div><div class="rs-value">${bd.DEF || 0}</div></div>
      <div class="rs-item"><div class="rs-label">MID</div><div class="rs-value">${bd.MID || 0}</div></div>
      <div class="rs-item"><div class="rs-label">FWD</div><div class="rs-value">${bd.FWD || 0}</div></div>
      <div class="rs-item"><div class="rs-label">Avg Form</div><div class="rs-value">${data.avg_form}</div></div>
      <div class="rs-item"><div class="rs-label">Total Score</div><div class="rs-value">${data.total_draft_score}</div></div>
    `;

    // Player grid
    $('roster-player-grid').innerHTML = data.roster.map(p => {
      const posClass = p.position_name.toLowerCase();
      return `<div class="roster-player">
        <span class="rp-pos ${posClass}">${p.position_name}</span>
        <div class="rp-info">
          <div class="rp-name">${p.name}</div>
          <div class="rp-team">${p.team_name} &middot; Form ${p.form} &middot; Min&#x0302; ${p.projected_minutes}</div>
        </div>
        <span class="rp-score">${p.draft_score}</span>
        <span class="rp-remove" onclick="removeFromRoster(${p.id})" title="Remove">&times;</span>
      </div>`;
    }).join('');

    // Weakness
    $('roster-weakness-text').textContent = `Your ${data.weakest_position} position is the weakest area  consider targeting this in your next waiver claim or trade.`;

    analysis.style.display = '';
  } catch (e) { /* silent */ }
}

// Restore roster on load
if (draftRosterIds.length > 0) {
  setTimeout(analyseRoster, 300);
}

// ==================== #1 AUTO FPL URL DETECT ====================
// ==================== PLAYER DRILLDOWN MODAL (Item 17) ====================
async function openPlayerModal(playerId) {
  const overlay = $('player-modal-overlay');
  const content = $('player-modal-content');
  overlay.classList.remove('hidden');
  content.innerHTML = '<div style="text-align:center;padding:2rem;"><div class="spinner active" style="display:inline-block;"></div><div style="color:#8899AA;font-size:0.82rem;margin-top:0.5rem;">Loading player data...</div></div>';

  try {
    const resp = await fetch(`/api/player/${playerId}`);
    const data = await resp.json();
    if (data.error) { closePlayerModal(); return; }

    const p = data.player;
    const kit = data.team_code ? `<img src="${KIT_BASE}${data.team_code}${p.position === 1 ? '_1' : ''}-110.webp" style="width:48px;" onerror="this.style.display='none'">` : '';
    const photoHtml = p.photo ? `<img src="${PHOTO_BASE}${p.photo}.png" onerror="this.parentElement.innerHTML='&#9917;'">` : '&#9917;';

    const fixturesHtml = data.fixture_ticker.map(fx =>
      `<div class="pm-fixture fdr-cell fdr-${fx.difficulty}">
        ${fx.opponent}${fx.is_home ? ' (H)' : ' (A)'}
        <span class="gw-label">GW${fx.gw}</span>
      </div>`
    ).join('');

    const bd = data.composite_breakdown;
    const breakdownRows = [
      { label: 'Form', value: bd.form, max: 10 },
      { label: 'PPG', value: bd.ppg, max: 10 },
      { label: 'xG', value: bd.xG, max: 15 },
      { label: 'xA', value: bd.xA, max: 10 },
      { label: 'Fixture Ease', value: bd.fixture_ease, max: 1 },
      { label: 'Rotation Risk', value: bd.rotation_risk, max: 1 },
    ].map(r => {
      const pct = Math.min(100, (r.value / r.max) * 100);
      const color = r.label === 'Rotation Risk' ? (pct > 50 ? '#FF5252' : '#00E676') : '#00E676';
      return `<div class="pm-breakdown-row">
        <div class="pm-breakdown-label">${r.label}</div>
        <div class="pm-breakdown-bar"><div class="pm-breakdown-fill" style="width:${pct}%;background:${color}"></div></div>
        <div class="pm-breakdown-val">${r.value}</div>
      </div>`;
    }).join('');

    content.innerHTML = `
      <div class="pm-header">
        <div class="pm-photo">${kit || photoHtml}</div>
        <div>
          <div class="pm-name">${p.name}</div>
          <div class="pm-meta">${data.team_name} &middot; ${p.position_name} &middot; ${p.cost.toFixed(1)}M</div>
        </div>
      </div>
      <div style="font-size:0.75rem;color:#8899AA;margin-bottom:0.3rem;font-weight:600;">Upcoming Fixtures</div>
      <div class="pm-fixtures">${fixturesHtml || '<span style="color:#555">No fixture data</span>'}</div>
      <div class="pm-stats">
        <div class="pm-stat"><div class="label">Total Pts</div><div class="value score">${p.total_points}</div></div>
        <div class="pm-stat"><div class="label">Form</div><div class="value">${p.form}</div></div>
        <div class="pm-stat"><div class="label">PPG</div><div class="value">${p.points_per_game}</div></div>
        <div class="pm-stat"><div class="label">xGI</div><div class="value">${(p.xG + p.xA).toFixed(1)}</div></div>
        <div class="pm-stat"><div class="label">ICT</div><div class="value">${p.ict_index}</div></div>
        <div class="pm-stat"><div class="label">Bonus</div><div class="value">${p.bonus}</div></div>
        <div class="pm-stat"><div class="label">Own%</div><div class="value" style="color:#4da6ff">${p.selected_by_percent}%</div></div>
        <div class="pm-stat"><div class="label">Proj Min</div><div class="value">${bd.projected_minutes}</div></div>
      </div>
      ${p.news ? `<div style="background:rgba(255,82,82,0.1);border:1px solid rgba(255,82,82,0.3);border-radius:8px;padding:0.4rem 0.6rem;font-size:0.78rem;color:#FFAAAA;margin-bottom:0.8rem;">${p.news}</div>` : ''}
      <div style="font-size:0.75rem;color:#8899AA;margin-bottom:0.3rem;font-weight:600;">Score Breakdown</div>
      <div class="pm-breakdown">${breakdownRows}</div>
      <div style="margin-top:0.8rem;display:flex;gap:0.3rem;flex-wrap:wrap;font-size:0.72rem;">
        <span style="color:#8899AA">Price change:</span>
        <span style="color:${p.cost_change_event > 0 ? '#00E676' : p.cost_change_event < 0 ? '#FF5252' : '#8899AA'}">${p.cost_change_event > 0 ? '+' : ''}${(p.cost_change_event / 10).toFixed(1)}M</span>
        <span style="color:#8899AA;margin-left:0.5rem;">Transfers:</span>
        <span class="in">+${p.transfers_in_event.toLocaleString()}</span>
        <span class="out">-${p.transfers_out_event.toLocaleString()}</span>
      </div>
    `;
  } catch(e) {
    content.innerHTML = `<div class="error-msg">${e.message}</div>`;
  }
}

function closePlayerModal() {
  $('player-modal-overlay').classList.add('hidden');
  $('player-modal-content').innerHTML = '';
}
document.addEventListener('keydown', e => { if (e.key === 'Escape') closePlayerModal(); });

let autoDetectTimer = null;
function autoDetectFplId(input) {
  const val = input.value.trim();
  if (!val) return;
  // Match FPL URLs: /entry/12345/..., full URLs, or bare numeric IDs (3-10 digits)
  const match = val.match(/entry\/(\d+)/) || val.match(/^(\d{3,10})$/);
  if (match) {
    const detectedId = match[1];
    input.value = detectedId;
    input.style.borderColor = '#00E676';
    // Show detection feedback
    const helpEl = $('user-id-help');
    if (helpEl) helpEl.textContent = `Team ID ${detectedId} detected`;
    setTimeout(() => { input.style.borderColor = ''; if (helpEl) helpEl.textContent = ''; }, 2500);
    // Auto-load after debounce if URL was pasted (not bare number typed)
    if (val.includes('/')) {
      clearTimeout(autoDetectTimer);
      autoDetectTimer = setTimeout(() => loadUser(), 500);
    }
  }
}

// ==================== #2 MULTI-GW PLANNER ====================
async function loadMultiGW() {
  if (!AppState.userId) { $('multigw-error').innerHTML = '<div class="error-msg">Load your FPL ID in Settings first.</div>'; return; }
  const loader = $('multigw-loader'), content = $('multigw-content'), err = $('multigw-error');
  loader.classList.add('active'); content.style.display = 'none'; err.innerHTML = '';
  const horizon = $('multigw-horizon').value;
  try {
    const resp = await fetch(`/api/multi-gw/${AppState.userId}?horizon=${horizon}`);
    const data = await resp.json();
    if (data.error) { err.innerHTML = `<div class="error-msg">${data.error}</div>`; return; }
    $('multigw-summary').innerHTML = `
      <div class="stat-card"><div class="label">Bank</div><div class="value">${data.bank}M</div></div>
      <div class="stat-card"><div class="label">Horizon</div><div class="value">${data.horizon} GWs</div></div>
      <div class="stat-card"><div class="label">Total Gain</div><div class="value">${data.plan.length ? data.plan[data.plan.length-1].cumulative_gain : 0}</div></div>
    `;
    $('multigw-body').innerHTML = data.plan.map(gw => {
      const out = gw.transfer_out ? `<span class="out">${gw.transfer_out.name}</span> <span style="color:#8899AA">(${gw.transfer_out.position_name})</span>` : '<span style="color:#555"> Hold </span>';
      const inn = gw.transfer_in ? `<span class="in">${gw.transfer_in.name}</span> <span style="color:#8899AA">(${gw.transfer_in.position_name})</span>` : '';
      const hitColor = gw.hit_cost > 0 ? 'color:#FF5252' : '';
      return `<tr>
        <td><strong>GW${gw.gameweek}</strong></td>
        <td>${gw.free_transfers}</td>
        <td>${out}</td><td>${inn}</td>
        <td class="right score">${gw.expected_points_gain > 0 ? '+' : ''}${gw.expected_points_gain}</td>
        <td class="right" style="${hitColor}">${gw.hit_cost ? '-' + gw.hit_cost : '0'}</td>
        <td class="right" style="font-weight:600">${gw.cumulative_gain > 0 ? '+' : ''}${gw.cumulative_gain}</td>
      </tr>`;
    }).join('');
    applyCardLabels($('multigw-body').closest('table'));
    content.style.display = '';
  } catch(e) { err.innerHTML = `<div class="error-msg">${e.message}</div>`; }
  finally { loader.classList.remove('active'); }
}

// ==================== #3 CHIP STRATEGY ====================
async function loadChipStrategy() {
  if (!AppState.userId) { $('chips-error').innerHTML = '<div class="error-msg">Load your FPL ID in Settings first.</div>'; return; }
  const loader = $('chips-loader'), content = $('chips-content'), err = $('chips-error');
  loader.classList.add('active'); content.style.display = 'none'; err.innerHTML = '';
  try {
    const resp = await fetch(`/api/chip-strategy/${AppState.userId}`);
    const data = await resp.json();
    if (data.error) { err.innerHTML = `<div class="error-msg">${data.error}</div>`; return; }
    const chips = [
      { key: 'bench_boost', apiName: 'bboost', name: 'Bench Boost', icon: '', color: '#51cf66' },
      { key: 'triple_captain', apiName: '3xc', name: 'Triple Captain', icon: '', color: '#FFB800' },
      { key: 'free_hit', apiName: 'freehit', name: 'Free Hit', icon: '', color: '#4da6ff' },
      { key: 'wildcard', apiName: 'wildcard', name: 'Wildcard', icon: '', color: '#FF5252' },
    ];
    // Cross-reference chips: count available and used per chip type
    const chipAvailCount = {};
    const chipUsedCount = {};
    const chipUsedGws = {};
    (AppState.userData?.chips_available || []).forEach(c => { chipAvailCount[c] = (chipAvailCount[c] || 0) + 1; });
    (AppState.userData?.chips_used || []).forEach(c => {
      chipUsedCount[c.name] = (chipUsedCount[c.name] || 0) + 1;
      if (!chipUsedGws[c.name]) chipUsedGws[c.name] = [];
      chipUsedGws[c.name].push('GW' + c.event);
    });
    $('chips-cards').innerHTML = chips.map(c => {
      const d = data[c.key] || {};
      const avail = chipAvailCount[c.apiName] || 0;
      const used = chipUsedCount[c.apiName] || 0;
      const total = avail + used;
      const allUsed = avail === 0 && used > 0;
      const opacity = allUsed ? 'opacity:0.4;' : '';
      const usedGws = chipUsedGws[c.apiName] || [];
      let statusLabel = '';
      if (allUsed) statusLabel = `<span style="color:#FF5252;font-size:0.72rem;font-weight:600;margin-left:0.5rem;">USED (${used}/${total})</span>`;
      else if (used > 0) statusLabel = `<span style="color:#FFB800;font-size:0.72rem;font-weight:600;margin-left:0.5rem;">${avail}/${total} left</span>`;
      else if (total > 1) statusLabel = `<span style="color:#51cf66;font-size:0.72rem;margin-left:0.5rem;">${avail}/${total}</span>`;
      return `<div class="waiver-card" style="border-top:3px solid ${c.color};${opacity}">
        <div class="wc-header">
          <span class="wc-name">${c.icon} ${c.name}${statusLabel}</span>
          <span style="color:${c.color};font-weight:700;font-size:0.9rem;">${allUsed ? '' : d.gw ? 'GW' + d.gw : 'N/A'}</span>
        </div>
        <div class="wc-meta">${allUsed ? `Played ${usedGws.join(' & ')}` : d.reason || 'No recommendation available'}</div>
        ${!allUsed && d.player ? `<div style="color:#F0F0F0;font-size:0.82rem;margin-top:0.3rem;">Player: <strong>${d.player}</strong></div>` : ''}
        ${!allUsed && d.dgw_teams ? `<div style="color:#8899AA;font-size:0.78rem;margin-top:0.2rem;">DGW players: ${d.dgw_teams}</div>` : ''}
      </div>`;
    }).join('');
    content.style.display = '';
  } catch(e) { err.innerHTML = `<div class="error-msg">${e.message}</div>`; }
  finally { loader.classList.remove('active'); }
}

// ==================== #4 OWNERSHIP & EO ====================
let eoMode = 'shield';
function toggleEoMode(mode) {
  eoMode = mode;
  const shieldBtn = $('eo-shield-btn'), attackBtn = $('eo-attack-btn');
  if (mode === 'shield') {
    shieldBtn.style.background = '#4da6ff'; shieldBtn.style.color = '#0D1B2A'; shieldBtn.className = 'btn';
    attackBtn.style.background = ''; attackBtn.style.color = ''; attackBtn.className = 'btn-outline';
  } else {
    attackBtn.style.background = '#FF5252'; attackBtn.style.color = '#0D1B2A'; attackBtn.className = 'btn';
    shieldBtn.style.background = ''; shieldBtn.style.color = ''; shieldBtn.className = 'btn-outline';
  }
  $('eo-mode-text').textContent = mode === 'shield'
    ? 'Showing players you MUST own to protect rank. Missing these = risk.'
    : 'Showing differential opportunities. Owning these when they haul = big rank gain.';
}

async function loadOwnership() {
  const loader = $('eo-loader'), content = $('eo-content'), err = $('eo-error');
  loader.classList.add('active'); content.style.display = 'none'; err.innerHTML = '';
  $('eo-personal').style.display = 'none';
  $('eo-chart-section').style.display = 'none';
  $('eo-league-section').style.display = 'none';

  let url = '/api/ownership';
  const params = [];
  if (AppState.userId) params.push(`user_id=${AppState.userId}`);
  const savedLeague = localStorage.getItem('fpl_league_id');
  if (savedLeague && AppState.userId) params.push(`league_id=${savedLeague}`);
  if (params.length) url += '?' + params.join('&');

  try {
    const resp = await fetch(url);
    const data = await resp.json();
    if (data.error) { err.innerHTML = `<div class="error-msg">${data.error}</div>`; return; }

    // Main table with status column
    $('eo-body').innerHTML = data.players.map((p, i) => {
      const statusCol = p.user_owns !== undefined
        ? (p.user_owns
          ? `<td style="color:#00E676">${p.user_captains ? '(C) Owned' : 'Owned'}</td>`
          : `<td style="color:#FF5252">Missing</td>`)
        : '<td>-</td>';
      return `<tr${p.user_owns === false ? ' style="background:rgba(255,82,82,0.06)"' : ''}>
        <td>${i + 1}</td>
        <td><strong>${p.name}</strong></td>
        <td>${p.team_name}</td>
        <td><span class="pos">${p.position_name}</span></td>
        <td class="right">${p.ownership}%</td>
        <td class="right" style="color:#FFB800">${p.captain_rate}%</td>
        <td class="right" style="color:#4da6ff;font-weight:600">${p.effective_ownership}%</td>
        <td class="right">${p.ep_next}</td>
        <td class="right" style="color:#51cf66">+${p.haul_swing_own}</td>
        <td class="right" style="color:#FF5252">${p.haul_swing_miss}</td>
        ${statusCol}
      </tr>`;
    }).join('');
    applyCardLabels($('eo-body').closest('table'));

    // Personal risk cards
    if (data.personal_risk) {
      const pr = data.personal_risk;
      $('eo-risk-cards').innerHTML = `
        <div class="stat-card"><div class="label">Shield Score</div><div class="value blue">${pr.shield_score}%</div></div>
        <div class="stat-card"><div class="label">Attack Score</div><div class="value" style="color:#FF5252">${pr.attack_score}%</div></div>
        <div class="stat-card"><div class="label">Recommendation</div><div class="value" style="color:${pr.recommendation === 'SHIELD' ? '#4da6ff' : '#FF5252'}">${pr.recommendation}</div></div>
        <div class="stat-card"><div class="label">Owned EO Total</div><div class="value">${pr.owned_eo_total}%</div></div>
      `;
      $('eo-mode-text').textContent = pr.recommendation_text;
      $('eo-personal').style.display = '';
      toggleEoMode(pr.recommendation === 'SHIELD' ? 'shield' : 'attack');
    }

    // Captain EO chart
    if (data.captain_chart && data.captain_chart.length) {
      drawEoCaptainChart(data.captain_chart);
      $('eo-chart-section').style.display = '';
    }

    // League comparison
    if (data.league_comparison) {
      const lc = data.league_comparison;
      $('eo-league-body').innerHTML = lc.player_grid.map(p => {
        const globalEo = data.players.find(dp => dp.id === p.id);
        return `<tr>
          <td><strong>${p.name}</strong></td>
          <td class="right" style="color:#4da6ff">${globalEo ? globalEo.effective_ownership : '?'}%</td>
          <td class="right">${p.rivals_owning} / ${p.total_rivals}</td>
          <td class="right" style="color:#FFB800">${p.league_ownership_pct}%</td>
        </tr>`;
      }).join('');
      applyCardLabels($('eo-league-body').closest('table'));
      $('eo-league-section').style.display = '';
    }

    content.style.display = '';
  } catch(e) { err.innerHTML = `<div class="error-msg">${e.message}</div>`; }
  finally { loader.classList.remove('active'); }
}

function drawEoCaptainChart(captainData) {
  const canvas = $('eo-captain-chart');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const w = canvas.width, h = canvas.height;
  const pad = { top: 20, right: 15, bottom: 60, left: 50 };
  ctx.clearRect(0, 0, w, h);
  const chartW = w - pad.left - pad.right, chartH = h - pad.top - pad.bottom;
  const n = captainData.length;
  const gap = chartW / n;
  const barW = Math.min(gap * 0.35, 24);
  const maxEO = Math.max(...captainData.map(d => d.eo), 50);

  // Gridlines
  for (let gi = 0; gi <= 4; gi++) {
    const gy = pad.top + chartH - (gi / 4) * chartH;
    ctx.beginPath(); ctx.moveTo(pad.left, gy); ctx.lineTo(w - pad.right, gy);
    ctx.strokeStyle = '#1B2D45'; ctx.lineWidth = 1; ctx.stroke();
    ctx.fillStyle = '#555'; ctx.font = '10px sans-serif'; ctx.textAlign = 'right';
    ctx.fillText(Math.round(maxEO * gi / 4) + '%', pad.left - 6, gy + 3);
  }

  captainData.forEach((d, ci) => {
    const cx = pad.left + ci * gap + gap / 2;
    // EO bar (blue)
    const eoH = (d.eo / maxEO) * chartH;
    const eoY = pad.top + chartH - eoH;
    ctx.fillStyle = '#4da6ff88';
    ctx.fillRect(cx - barW, eoY, barW, eoH);
    // Captain rate bar (gold)
    const capH = (d.captain_rate / maxEO) * chartH;
    const capY = pad.top + chartH - capH;
    ctx.fillStyle = '#FFB800aa';
    ctx.fillRect(cx, capY, barW, capH);
    // Value labels
    ctx.fillStyle = '#F0F0F0'; ctx.font = 'bold 10px sans-serif'; ctx.textAlign = 'center';
    ctx.fillText(d.eo + '%', cx - barW / 2, eoY - 5);
    ctx.fillStyle = '#FFB800'; ctx.fillText(d.captain_rate + '%', cx + barW / 2, capY - 5);
    // Player name (rotated)
    ctx.save(); ctx.translate(cx, h - pad.bottom + 8); ctx.rotate(-Math.PI / 5);
    ctx.fillStyle = '#888'; ctx.font = '10px sans-serif'; ctx.textAlign = 'right';
    ctx.fillText(d.name, 0, 0); ctx.restore();
  });

  // Legend
  ctx.fillStyle = '#4da6ff'; ctx.fillRect(w - 150, 8, 12, 12);
  ctx.fillStyle = '#888'; ctx.font = '10px sans-serif'; ctx.textAlign = 'left';
  ctx.fillText('EO%', w - 134, 18);
  ctx.fillStyle = '#FFB800'; ctx.fillRect(w - 80, 8, 12, 12);
  ctx.fillStyle = '#888'; ctx.fillText('Capt%', w - 64, 18);
}

// ==================== #6 TRANSFER GAIN VS HIT ====================
async function loadTransferGain() {
  if (!AppState.userId) { $('gain-error').innerHTML = '<div class="error-msg">Load your FPL ID in Settings first.</div>'; return; }
  const loader = $('gain-loader'), content = $('gain-content'), err = $('gain-error');
  loader.classList.add('active'); content.style.display = 'none'; err.innerHTML = '';
  try {
    const resp = await fetch(`/api/transfer-gain/${AppState.userId}`);
    const data = await resp.json();
    if (data.error) { err.innerHTML = `<div class="error-msg">${data.error}</div>`; return; }
    // Table
    $('gain-body').innerHTML = data.transfers.map(t => {
      const beColor = t.breakeven_gws <= 2 ? '#00E676' : t.breakeven_gws <= 4 ? '#FFB800' : '#FF5252';
      return `<tr>
        <td><span class="out" style="cursor:pointer;text-decoration:underline dotted;text-underline-offset:2px;" onclick="event.stopPropagation();openPlayerModal(${t.out_id})">${t.out_name}</span> <span style="color:#555">${t.out_team}</span></td>
        <td><span class="in" style="cursor:pointer;text-decoration:underline dotted;text-underline-offset:2px;" onclick="event.stopPropagation();openPlayerModal(${t.in_id})">${t.in_name}</span> <span style="color:#555">${t.in_team}</span></td>
        <td><span class="pos">${t.position_name}</span></td>
        <td class="right score">+${t.pts_gain}</td>
        <td class="right" style="color:#51cf66">${t.net_gain_free > 0 ? '+' : ''}${t.net_gain_free}</td>
        <td class="right" style="color:${t.net_gain_hit >= 0 ? '#51cf66' : '#FF5252'}">${t.net_gain_hit > 0 ? '+' : ''}${t.net_gain_hit}</td>
        <td class="right" style="color:${beColor};font-weight:600">${t.breakeven_gws < 99 ? t.breakeven_gws + ' GWs' : ''}</td>
        <td class="right">${t.worth_hit ? '<span style="color:#00E676;font-weight:700">YES</span>' : '<span style="color:#FF5252">NO</span>'}</td>
      </tr>
      ${t.reasoning ? `<tr><td colspan="8" style="color:#8899AA;font-size:0.78rem;padding:0.15rem 0.6rem 0.4rem;border-top:none;">${t.reasoning}</td></tr>` : ''}`;
    }).join('');
    applyCardLabels($('gain-body').closest('table'));
    // Chart
    drawGainChart(data.transfers.slice(0, 15), data.hit_cost);
    content.style.display = '';
  } catch(e) { err.innerHTML = `<div class="error-msg">${e.message}</div>`; }
  finally { loader.classList.remove('active'); }
}

function drawGainChart(transfers, hitCost) {
  const canvas = $('gain-chart');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const w = canvas.width, h = canvas.height;
  const pad = { top: 25, right: 15, bottom: 60, left: 50 };
  ctx.clearRect(0, 0, w, h);
  const chartW = w - pad.left - pad.right, chartH = h - pad.top - pad.bottom;
  const maxGain = Math.max(...transfers.map(t => t.pts_gain), hitCost + 1);
  const gap = chartW / transfers.length;
  const barW = Math.min(gap * 0.6, 30);

  // Hit cost line
  const hitY = pad.top + chartH - (hitCost / maxGain) * chartH;
  ctx.setLineDash([6, 4]); ctx.strokeStyle = '#FF5252'; ctx.lineWidth = 2;
  ctx.beginPath(); ctx.moveTo(pad.left, hitY); ctx.lineTo(w - pad.right, hitY); ctx.stroke();
  ctx.setLineDash([]);
  ctx.fillStyle = '#FF5252'; ctx.font = 'bold 11px sans-serif'; ctx.textAlign = 'left';
  ctx.fillText(`-${hitCost} hit cost`, pad.left + 4, hitY - 6);

  // Gridlines
  for (let i = 0; i <= 4; i++) {
    const y = pad.top + chartH - (i / 4) * chartH;
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(w - pad.right, y);
    ctx.strokeStyle = '#1B2D45'; ctx.lineWidth = 1; ctx.stroke();
    ctx.fillStyle = '#555'; ctx.font = '10px sans-serif'; ctx.textAlign = 'right';
    ctx.fillText((maxGain * i / 4).toFixed(1), pad.left - 6, y + 3);
  }

  transfers.forEach((t, i) => {
    const barH = Math.max((t.pts_gain / maxGain) * chartH, 2);
    const x = pad.left + i * gap + (gap - barW) / 2;
    const y = pad.top + chartH - barH;
    const color = t.worth_hit ? '#00E676' : '#FFB800';
    const grad = ctx.createLinearGradient(x, y, x, y + barH);
    grad.addColorStop(0, color); grad.addColorStop(1, color + '44');
    ctx.fillStyle = grad;
    const r = Math.min(3, barW / 2);
    ctx.beginPath(); ctx.moveTo(x+r,y); ctx.lineTo(x+barW-r,y); ctx.quadraticCurveTo(x+barW,y,x+barW,y+r);
    ctx.lineTo(x+barW,y+barH); ctx.lineTo(x,y+barH); ctx.lineTo(x,y+r); ctx.quadraticCurveTo(x,y,x+r,y);
    ctx.fill();
    ctx.fillStyle = '#F0F0F0'; ctx.font = 'bold 10px sans-serif'; ctx.textAlign = 'center';
    ctx.fillText('+' + t.pts_gain, x + barW/2, y - 5);
    ctx.save(); ctx.translate(x + barW/2, h - pad.bottom + 8); ctx.rotate(-Math.PI/5);
    ctx.fillStyle = '#888'; ctx.font = '9px sans-serif'; ctx.textAlign = 'right';
    ctx.fillText(t.in_name.split(' ').pop(), 0, 0); ctx.restore();
  });
  ctx.save(); ctx.translate(14, pad.top + chartH/2); ctx.rotate(-Math.PI/2);
  ctx.fillStyle = '#555'; ctx.font = '10px sans-serif'; ctx.textAlign = 'center';
  ctx.fillText('EP Gain per GW', 0, 0); ctx.restore();
}

// ==================== #8 FIXTURE SWING & ROTATION ====================
async function loadFixtureSwing() {
  const loader = $('swing-loader'), content = $('swing-content'), err = $('swing-error');
  loader.classList.add('active'); content.style.display = 'none'; err.innerHTML = '';
  try {
    const resp = await fetch('/api/fixture-swing?lookahead=8');
    const data = await resp.json();
    if (data.error) { err.innerHTML = `<div class="error-msg">${data.error}</div>`; return; }
    // Rotation pairs
    $('swing-pairs').innerHTML = data.rotation_pairs.map(p =>
      `<div class="waiver-card">
        <div class="wc-header"><span class="wc-name">${p.team_a} + ${p.team_b}</span></div>
        <div class="wc-meta">Combined avg difficulty: <strong style="color:#00E676">${p.combined_avg}</strong></div>
        <div style="display:flex;gap:0.3rem;margin-top:0.4rem;">${p.combined_per_gw.map((d,i) =>
          `<span class="fdr-cell fdr-${Math.round(d)}" style="flex:1;text-align:center;font-size:0.7rem;">${d}</span>`
        ).join('')}</div>
      </div>`
    ).join('') || '<p style="color:#8899AA">No strong rotation pairs found.</p>';
    // Table
    const gws = data.gw_ids;
    $('swing-thead').innerHTML = `<tr><th>Team</th>${gws.map(g => `<th>GW${g}</th>`).join('')}<th class="right">Avg</th><th class="right">Swing</th></tr>`;
    $('swing-body').innerHTML = data.teams.map(t =>
      `<tr><td><strong>${t.team_name}</strong></td>${t.gw_difficulties.map(d => {
        const fdr = Math.round(d);
        return `<td><span class="fdr-cell fdr-${fdr}" style="display:inline-block;min-width:28px;text-align:center;">${d}</span></td>`;
      }).join('')}<td class="right">${t.avg_difficulty}</td><td class="right" style="color:${t.swing >= 2 ? '#FF5252' : '#00E676'}">${t.swing}</td></tr>`
    ).join('');
    applyCardLabels($('swing-body').closest('table'));
    content.style.display = '';
  } catch(e) { err.innerHTML = `<div class="error-msg">${e.message}</div>`; }
  finally { loader.classList.remove('active'); }
}

// ==================== #9 RANK SIMULATOR ====================
function populateRankSimCaptains(players) {
  const sel1 = $('ranksim-captain'), sel2 = $('ranksim-alt-captain');
  sel1.innerHTML = '<option value="">Auto (best EP)</option>';
  sel2.innerHTML = '<option value="">None</option>';
  if (!players) return;
  players.forEach(p => {
    const opt = `<option value="${p.id}">${p.name} (${p.ep_next})</option>`;
    sel1.innerHTML += opt;
    sel2.innerHTML += opt;
  });
}

async function loadRankSim() {
  if (!AppState.userId) { $('ranksim-error').innerHTML = '<div class="error-msg">Load your FPL ID in Settings first.</div>'; return; }
  const loader = $('ranksim-loader'), content = $('ranksim-content'), err = $('ranksim-error');
  loader.classList.add('active'); content.style.display = 'none'; err.innerHTML = '';

  const horizon = $('ranksim-horizon').value;
  const captainId = $('ranksim-captain').value;
  const altCaptainId = $('ranksim-alt-captain').value;
  const hits = $('ranksim-hits').value;

  let url = `/api/rank-simulation/${AppState.userId}?horizon=${horizon}&sims=2000&hits=${hits}`;
  if (captainId) url += `&captain_id=${captainId}`;
  if (altCaptainId) url += `&alt_captain_id=${altCaptainId}`;

  try {
    const resp = await fetch(url);
    const data = await resp.json();
    if (data.error) { err.innerHTML = `<div class="error-msg">${data.error}</div>`; return; }
    const pp = data.projected_points;
    const sc = data.scenarios;

    // Scenario cards
    $('ranksim-scenarios').innerHTML = `
      <div class="stat-card" style="border-top:3px solid #FF5252">
        <div class="label">Pessimistic (P10)</div>
        <div class="value" style="color:#FF5252">${sc.pessimistic.rank.toLocaleString()}</div>
        <div style="color:#8899AA;font-size:0.75rem">${sc.pessimistic.points} pts</div>
      </div>
      <div class="stat-card" style="border-top:3px solid #4da6ff">
        <div class="label">Expected (P50)</div>
        <div class="value blue">${sc.expected.rank.toLocaleString()}</div>
        <div style="color:#8899AA;font-size:0.75rem">${sc.expected.points} pts</div>
      </div>
      <div class="stat-card" style="border-top:3px solid #00E676">
        <div class="label">Optimistic (P90)</div>
        <div class="value" style="color:#00E676">${sc.optimistic.rank.toLocaleString()}</div>
        <div style="color:#8899AA;font-size:0.75rem">${sc.optimistic.points} pts</div>
      </div>
    `;

    // Summary stats
    const rankDir = data.projected_rank_change <= 0 ? 'color:#00E676' : 'color:#FF5252';
    const rankArrow = data.projected_rank_change <= 0 ? '\u2191' : '\u2193';
    $('ranksim-summary').innerHTML = `
      <div class="stat-card"><div class="label">Current Rank</div><div class="value blue">${data.current_rank.toLocaleString()}</div></div>
      <div class="stat-card"><div class="label">Captain</div><div class="value" style="color:#FFB800;font-size:0.9rem">${data.captain_name || 'Auto'}</div></div>
      <div class="stat-card"><div class="label">Squad EP/GW</div><div class="value">${data.squad_ep_per_gw}</div></div>
      <div class="stat-card"><div class="label">Hits Cost</div><div class="value" style="color:#FF5252">-${data.hits * 4}</div></div>
      <div class="stat-card"><div class="label">P10\u2013P90 Range</div><div class="value" style="font-size:0.9rem">${pp.p10} \u2013 ${pp.p90}</div></div>
    `;

    // Decision comparison
    if (data.comparison) {
      const c = data.comparison;
      const winner = c.recommendation;
      $('ranksim-comparison-content').innerHTML = `
        <div class="stat-row">
          <div class="stat-card" style="border-top:3px solid ${winner === 'A' ? '#00E676' : 'rgba(255,255,255,0.1)'}">
            <div class="label">Option A: ${c.option_a.captain_name} (C)</div>
            <div class="value" style="color:${winner === 'A' ? '#00E676' : '#4da6ff'}">${c.option_a.projected_rank.toLocaleString()}</div>
            <div style="color:#8899AA;font-size:0.75rem">Median: ${c.option_a.median_points} | Range: ${c.option_a.p10}\u2013${c.option_a.p90}</div>
          </div>
          <div class="stat-card" style="border-top:3px solid ${winner === 'B' ? '#00E676' : 'rgba(255,255,255,0.1)'}">
            <div class="label">Option B: ${c.option_b.captain_name} (C)</div>
            <div class="value" style="color:${winner === 'B' ? '#00E676' : '#4da6ff'}">${c.option_b.projected_rank.toLocaleString()}</div>
            <div style="color:#8899AA;font-size:0.75rem">Median: ${c.option_b.median_points} | Range: ${c.option_b.p10}\u2013${c.option_b.p90}</div>
          </div>
        </div>
        <div style="text-align:center;color:#8899AA;font-size:0.85rem;margin-top:0.5rem;">
          Median difference: <strong style="color:#00E676">${Math.abs(c.median_diff)} pts</strong> in favour of
          <strong style="color:#FFB800">Option ${c.recommendation}</strong>
        </div>
      `;
      $('ranksim-comparison').style.display = '';
    } else {
      $('ranksim-comparison').style.display = 'none';
    }

    // Player contributions
    if (data.player_contributions) {
      $('ranksim-players').innerHTML = data.player_contributions.map(p => `<tr>
        <td><strong>${p.name}</strong></td>
        <td>${p.team_name}</td>
        <td><span class="pos">${p.position_name}</span></td>
        <td class="right">${p.ep_next}</td>
        <td class="right score">${p.ep_contribution}</td>
        <td class="right">${p.eo}%</td>
        <td>${p.is_captain ? '<span style="color:#FFB800;font-weight:700">(C)</span>' : ''}</td>
      </tr>`).join('');
      populateRankSimCaptains(data.player_contributions);
    }

    drawRankHistogram(data.histogram);
    content.style.display = '';
  } catch(e) { err.innerHTML = `<div class="error-msg">${e.message}</div>`; }
  finally { loader.classList.remove('active'); }
}

function drawRankHistogram(buckets) {
  const canvas = $('ranksim-chart');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const w = canvas.width, h = canvas.height;
  const pad = { top: 15, right: 15, bottom: 40, left: 45 };
  ctx.clearRect(0, 0, w, h);
  const chartW = w - pad.left - pad.right, chartH = h - pad.top - pad.bottom;
  const maxCount = Math.max(...buckets.map(b => b.count)) || 1;
  const gap = chartW / buckets.length;
  const barW = Math.max(gap - 2, 3);

  buckets.forEach((b, i) => {
    const barH = Math.max((b.count / maxCount) * chartH, 1);
    const x = pad.left + i * gap;
    const y = pad.top + chartH - barH;
    const grad = ctx.createLinearGradient(x, y, x, y + barH);
    grad.addColorStop(0, '#4da6ff'); grad.addColorStop(1, '#1a3a5c');
    ctx.fillStyle = grad;
    ctx.fillRect(x, y, barW, barH);
    if (i % 4 === 0) {
      ctx.fillStyle = '#555'; ctx.font = '9px sans-serif'; ctx.textAlign = 'center';
      ctx.fillText(Math.round(b.min), x + barW/2, h - pad.bottom + 14);
    }
  });
  ctx.fillStyle = '#555'; ctx.font = '10px sans-serif'; ctx.textAlign = 'center';
  ctx.fillText('Projected Total Points', pad.left + chartW/2, h - 5);
}

// ==================== #10 PERFORMANCE: PROGRESSIVE LOADING ====================
// Prefetch core data on first load for faster tab switches
let _prefetchDone = false;
function prefetchCoreData() {
  if (_prefetchDone) return;
  _prefetchDone = true;
  // Warm the server cache with a lightweight call
  fetch('/api/data').catch(() => {});
}
setTimeout(prefetchCoreData, 2000);
</script>

<!-- ==================== BOTTOM NAVIGATION (MOBILE) ==================== -->
<!-- Sticky Connect CTA (mobile only, visible when no user connected) -->
<div class="sticky-connect-cta" id="sticky-connect-cta">
  <span>Connect your FPL team for personalized insights</span>
  <button class="btn btn-sm" onclick="switchNav('nav-settings');setTimeout(()=>$('user-id').focus(),100);">Connect</button>
</div>

<!-- Sticky Optimize CTA (mobile only, visible on optimizer tab) -->
<div class="sticky-optimize" id="sticky-optimize">
  <button class="btn" onclick="runOptimizer()">Optimize Squad</button>
</div>

<nav class="bottom-nav" id="bottom-nav">
  <button class="active" data-nav="nav-dashboard" onclick="switchNav('nav-dashboard')">
    <span class="bn-icon">&#9733;</span><span class="bn-label">Home</span>
  </button>
  <button data-nav="nav-transfers-planner" onclick="switchNav('nav-transfers-planner')">
    <span class="bn-icon">&#8644;</span><span class="bn-label">Transfers</span>
  </button>
  <button data-nav="nav-fixtures-fdr" onclick="switchNav('nav-fixtures-fdr')">
    <span class="bn-icon">&#128197;</span><span class="bn-label">Fixtures</span>
  </button>
  <button data-nav="nav-playerstats-table" onclick="switchNav('nav-playerstats-table')">
    <span class="bn-icon">&#128202;</span><span class="bn-label">Stats</span>
  </button>
  <button id="bn-more-btn" onclick="toggleMoreMenu()">
    <span class="bn-icon">&#8943;</span><span class="bn-label">More</span>
  </button>
</nav>

<div class="more-menu-overlay" id="more-menu-overlay" onclick="toggleMoreMenu()"></div>
<div class="more-menu-mobile" id="more-menu">
  <div class="mm-header">
    <span>More</span>
    <button class="mm-close" onclick="toggleMoreMenu()">&times;</button>
  </div>

  <div class="mm-group-title">Team</div>
  <div class="mm-item" onclick="switchNav('nav-team-live')"><span class="mm-icon">&#9889;</span> Live GW</div>
  <div class="mm-item" onclick="switchNav('nav-team-myteam')"><span class="mm-icon">&#9917;</span> My Team</div>
  <div class="mm-divider"></div>

  <div class="mm-group-title">Transfers</div>
  <div class="mm-item" onclick="switchNav('nav-transfers-suggestions')"><span class="mm-icon">&#128161;</span> Suggestions</div>
  <div class="mm-item" onclick="switchNav('nav-transfers-optimizer')"><span class="mm-icon">&#128736;</span> Squad Optimizer</div>
  <div class="mm-item" onclick="switchNav('nav-transfers-multigw')"><span class="mm-icon">&#128197;</span> Multi-GW Planner</div>
  <div class="mm-item" onclick="switchNav('nav-transfers-chips')"><span class="mm-icon">&#127183;</span> Chip Strategy</div>
  <div class="mm-item" onclick="switchNav('nav-transfers-gain')"><span class="mm-icon">&#128200;</span> Gain vs Hit</div>
  <div class="mm-divider"></div>

  <div class="mm-group-title">Leagues</div>
  <div class="mm-item" onclick="switchNav('nav-leagues-standings')"><span class="mm-icon">&#127942;</span> Standings</div>
  <div class="mm-item" onclick="switchNav('nav-leagues-rival')"><span class="mm-icon">&#9876;</span> Rival Comparison</div>
  <div class="mm-divider"></div>

  <div class="mm-group-title">Fixtures</div>
  <div class="mm-item" onclick="switchNav('nav-fixtures-schedule')"><span class="mm-icon">&#128197;</span> Schedule & CS%</div>
  <div class="mm-item" onclick="switchNav('nav-fixtures-list')"><span class="mm-icon">&#128203;</span> Fixture List</div>
  <div class="mm-item" onclick="switchNav('nav-fixtures-swing')"><span class="mm-icon">&#128260;</span> Swing & Rotation</div>
  <div class="mm-divider"></div>

  <div class="mm-group-title">Player Stats</div>
  <div class="mm-item" onclick="switchNav('nav-playerstats-opta')"><span class="mm-icon">&#128202;</span> Opta Stats & BPS</div>
  <div class="mm-item" onclick="switchNav('nav-playerstats-compare')"><span class="mm-icon">&#8596;</span> Compare</div>
  <div class="mm-divider"></div>

  <div class="mm-group-title">News & Analysis</div>
  <div class="mm-item" onclick="switchNav('nav-news-captain')"><span class="mm-icon">&#169;</span> Captain Picks</div>
  <div class="mm-item" onclick="switchNav('nav-news-prices')"><span class="mm-icon">&#128176;</span> Price Changes</div>
  <div class="mm-item" onclick="switchNav('nav-news-differentials')"><span class="mm-icon">&#128142;</span> Differentials</div>
  <div class="mm-item" onclick="switchNav('nav-news-rotation')"><span class="mm-icon">&#128260;</span> Rotation Risk</div>
  <div class="mm-item" onclick="switchNav('nav-news-ownership')"><span class="mm-icon">&#128101;</span> Ownership & EO</div>
  <div class="mm-item" onclick="switchNav('nav-news-ranksim')"><span class="mm-icon">&#128200;</span> Rank Simulator</div>
  <div class="mm-divider"></div>

  <div class="mm-group-title">Draft</div>
  <div class="mm-item" onclick="switchNav('nav-draft-rankings')"><span class="mm-icon">&#128221;</span> Draft Rankings</div>
  <div class="mm-item" onclick="switchNav('nav-draft-waiver')"><span class="mm-icon">&#128260;</span> Waiver Wire</div>
  <div class="mm-item" onclick="switchNav('nav-draft-roster')"><span class="mm-icon">&#128203;</span> My Roster</div>
  <div class="mm-divider"></div>

  <div class="mm-item" onclick="switchNav('nav-settings')"><span class="mm-icon">&#9881;</span> Settings</div>
</div>

<!-- Player Drilldown Modal (Item 17) -->
<div class="player-modal-overlay hidden" id="player-modal-overlay" onclick="closePlayerModal()">
  <div class="player-modal" onclick="event.stopPropagation()">
    <button class="modal-close" onclick="closePlayerModal()">&times;</button>
    <div id="player-modal-content"></div>
  </div>
</div>

</body>
</html>
